<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>【MQTT】为什么我收不到“遗嘱消息”呢？ | Luat doc 社区文章静态页面镜像</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="&lt;p&gt;日前，有开发者在交流群中提问：&lt;&#x2F;p&gt;&lt;blockquote&gt;&lt;p&gt;&lt;span style&#x3D;&quot;color: rgb(0, 0, 0); font-family: 微软雅黑, &#39;MS Sans Serif&#39;, sans-serif; font-size: 13.333">
<meta property="og:type" content="article">
<meta property="og:title" content="【MQTT】为什么我收不到“遗嘱消息”呢？">
<meta property="og:url" content="https://doc.luatos.wiki/2020/02/04/686/index.html">
<meta property="og:site_name" content="Luat doc 社区文章静态页面镜像">
<meta property="og:description" content="&lt;p&gt;日前，有开发者在交流群中提问：&lt;&#x2F;p&gt;&lt;blockquote&gt;&lt;p&gt;&lt;span style&#x3D;&quot;color: rgb(0, 0, 0); font-family: 微软雅黑, &#39;MS Sans Serif&#39;, sans-serif; font-size: 13.333">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-02-04T00:47:59.000Z">
<meta property="article:modified_time" content="2021-01-27T16:09:27.360Z">
<meta property="article:author" content="chenxuuu">
<meta property="article:tag" content="lua">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Luat doc 社区文章静态页面镜像" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Luat doc 社区文章静态页面镜像</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://doc.luatos.wiki"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-686" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/04/686/" class="article-date">
  <time class="dt-published" datetime="2020-02-04T00:47:59.000Z" itemprop="datePublished">2020-02-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      【MQTT】为什么我收不到“遗嘱消息”呢？
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <pre><code>                        &lt;p&gt;日前，有开发者在交流群中提问：&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(0, 0, 0); font-family: 微软雅黑, &#39;MS Sans Serif&#39;, sans-serif; font-size: 13.3333330154419px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; display: inline !important; float: none; background-color: rgb(255, 237, 196);&quot;&gt;我按官方的MQTT api,&amp;nbsp; “遗嘱”效果是反的：掉线时没有消息，上线时反而有消息。&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;本文就来讲解一下，什么情况使用遗嘱消息，什么情况下会触发遗嘱，以及如何避免它产生的误判。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h2&gt;什么是遗嘱&lt;/h2&gt;&lt;p&gt;顾名思义，就是dying message。该“内定”的消息，是MQTT Client 连接 MQTT Broker 时定义的，Broker 记录下该消息。&lt;/p&gt;&lt;p&gt;其后，不论任何情况下，MQTT Client 与 MQTT Broker 之间的连接发生错误，MQTT Broker都会自动发出该消息到对应的主题。&lt;/p&gt;&lt;p&gt;典型的“异常情况”有：&lt;/p&gt;&lt;ol&gt;&lt;li&gt;MQTT Client 没有上报 close 就和 MQTT Broker 断开连接；&lt;/li&gt;&lt;li&gt;多个 keepalive 周期内没有心跳包上报；&lt;/li&gt;&lt;li&gt;其他相同 ClientID 登录 MQTT Broker 时。&lt;br&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;也就是说，灵活的使用遗嘱，可以更方便的应对设备通信时发生的各种异常情况（如模块掉线、设备被盗、流量卡欠费、网咯信号差等等）。&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h2&gt;如何启用MQTT遗嘱&lt;/h2&gt;&lt;p&gt;默认的MQTT例程中，没有遗嘱的相关内容。不过不用担心，MQTT 已有相关API，敬请查阅：&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://wiki.openluat.com/doc/luatApi/#mqttclientclientid-keepalive-username-password-cleansession-will-version&quot;&gt;https://wiki.openluat.com/doc/luatApi/#mqttclientclientid-keepalive-username-password-cleansession-will-version&lt;/a&gt;&lt;/p&gt;&lt;p&gt;示例代码：&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;require &quot;mqtt&quot;&lt;br&gt;module(..., package.seeall)&lt;br&gt;&lt;br&gt;-- 这里请填写修改为自己的IP和端口&lt;br&gt;local host, port = &quot;lbsmqtt.airm2m.com&quot;, 1884&lt;br&gt;&lt;/p&gt;&lt;p&gt;sys.taskInit(function()&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; while true do&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; while not socket.isReady() do sys.wait(1000) end&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; local mqttc = &lt;b&gt;mqtt.client(misc.getImei(), 300, &quot;username&quot;, &quot;password&quot;, nil, &lt;span style=&quot;color: rgb(255, 0, 0);&quot;&gt;
</code></pre>
<p><span style="background-color: rgb(255, 255, 0);">{qos=0, retain=0, topic=”/willmsg”, payload=misc.getImei()..”device_conn_err”}</span></span>, “3.1”)</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while not mqttc:connect(host, port) do sys.wait(2000) end<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if mqttc:subscribe(string.format(“/device/%s/req”, misc.getImei())) then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if mqttc:publish(string.format(“/device/%s/report”, misc.getImei()), “test publish “ .. os.time()) then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while true do<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; local r, data, param = mqttc:receive(120000, “pub_msg”)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if r then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log.info(“这是收到了服务器下发的消息:”, data.payload or “nil”)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; elseif data == “pub_msg” then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log.info(“这是收到了订阅的消息和参数显示:”, data, param)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mqttc:publish(string.format(“/device/%s/resp”, misc.getImei()), “response “ .. param)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; elseif data == “timeout” then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log.info(“这是等待超时主动上报数据的显示!”)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mqttc:publish(string.format(“/device/%s/report”, misc.getImei()), “test publish “ .. os.time())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mqttc:disconnect()<br>&nbsp;&nbsp;&nbsp; end<br>end)</p><p>– 测试代码,用于发送消息给socket<br>sys.taskInit(function()<br>&nbsp;&nbsp;&nbsp; while true do<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.publish(“pub_msg”, “11223344556677889900AABBCCDDEEFF” .. os.time())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.wait(180000)<br>&nbsp;&nbsp;&nbsp; end<br>end)<br></p></blockquote><p>后端程序的 MQTT Client 订阅 “/willmsg” 这个主题。</p><p>当该某 MQTT Client 和 MQTT Broker 连接出错时，Broker 就会自动向 “/willmsg” 主题下发内容为 “868570000000000device_conn_err”（例） 的消息。</p><p><br></p><h2>为什么我没有收到遗嘱<br></h2><p>通常，这是因为测试时，MQTT Client “掉线”时间不够长造成的。测试中，至少要等3个 Keepalive 周期，才会收到 MQTT Broker 下发的内容。</p><p>如果长时间测试仍没有收到，那么可能是如下原因：</p><ol><li>模块代码错误，或者网络错误等其他情况，或者没有成功连接到 MQTT Broker；</li><li>后台订阅的主题，和模块的遗嘱不是同一个主题；</li><li>MQTT Broker 不支持遗嘱；</li></ol><p><br></p><h2>为什么我收到了好多次遗嘱</h2><p>通常是因为模块端频繁掉线或者重连，MQTT Broker 认为上一个 MQTT Client 已经阵亡了，所以向既定主题发布了对应的消息。<br></p><p>开发者需要根据自己的需求，使用不同的主题和payload，区分遗嘱消息和正常消息，并做好对应的处理。<br></p><p><br></p><p><br></p></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2020/02/04/686/" data-id="ckkfmdgd300agvkcg81u370th" data-title="【MQTT】为什么我收不到“遗嘱消息”呢？" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/02/04/14/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          协程的简单实现(C/C++)
        
      </div>
    </a>
  
  
    <a href="/2020/01/20/685/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">onenet 新版MQTTS 连接代码分享</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2032/01/">一月 2032</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2032/01/01/608/">【置顶】合宙模块资料汇总</a>
          </li>
        
          <li>
            <a href="/2022/12/31/638/">Air系列模块常见问题列表</a>
          </li>
        
          <li>
            <a href="/2021/01/27/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2021/01/27/2420/">ECMAScript(ES6)基本语法介绍（一）</a>
          </li>
        
          <li>
            <a href="/2021/01/26/2417/">Air720S系列_luat二次开发固件（ 底层软件+上层脚本）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 chenxuuu<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>