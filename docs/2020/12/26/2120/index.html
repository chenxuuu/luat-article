<!DOCTYPE html>

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <title>编写三轴加速度传感器KXTJ3-1057 for LuaTask 驱动 [ Luat doc 社区文章静态页面镜像 ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/iLiKE.css">
    
  
  
  
  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
    <script id="leancloud">
      AV.init({
          appId: "6E5zTbTljdUbVW2WkXPsXGJk-gzGzoHsz",
          appKey: "0vsyDKfNpeSECAI70J794ugv"
      });
    </script>

<meta name="generator" content="Hexo 5.3.0"></head>
<body>
    <div class="header">
        <div class="container">
    <div class="menu">
      <div class="menu-left">
        <a href="/">
          <img src="/favicon.ico"></img>
        </a>
      </div>
      <div class="menu-right">
        
          
          
          
          
          
          
          <a href="/">首页</a>
        
          
          
          
          
          
          
          <a href="/archives">归档</a>
        
          
          
          
          
          
          
          <a href="/about">关于</a>
        
      </div>
    </div>
</div>
    </div>
    <div class="container">
        <h1 class="post-title">编写三轴加速度传感器KXTJ3-1057 for LuaTask 驱动</h1>
<article class="post markdown-style">
  <h1 id="三轴加速度传感器KXTJ3-1057-for-LuaTask-驱动-手把手教程"><a href="#三轴加速度传感器KXTJ3-1057-for-LuaTask-驱动-手把手教程" class="headerlink" title="三轴加速度传感器KXTJ3-1057 for LuaTask 驱动 手把手教程"></a>三轴加速度传感器KXTJ3-1057 for LuaTask 驱动 手把手教程</h1><h2 id="KXTJ3-1057简介"><a href="#KXTJ3-1057简介" class="headerlink" title="KXTJ3-1057简介"></a>KXTJ3-1057简介</h2><p>KXTJ3-1057和KXTJ2-1009 pin to pin 兼容，驱动也兼容。原是Kionix出品的一款手机上非常常用的三轴加速度传感器，后被ROHM收购。产品数据手册: <a target="_blank" rel="noopener" href="https://atta.szlcsc.com/upload/public/pdf/source/20191031/C442603_12AC3C8489586CE5186C5DB6A78C43C5.pdf?Expires=4070880000&amp;OSSAccessKeyId=LTAIJDIkh7KmGS1H&amp;Signature=xO+7CeKnGRDmRCYs1IojjqVATtw=&amp;response-content-disposition=attachment;filename=C442603_KXTJ3-1057_2019-10-31.PDF">https://atta.szlcsc.com/upload/public/pdf/source/20191031/C442603_12AC3C8489586CE5186C5DB6A78C43C5.pdf?Expires=4070880000&amp;OSSAccessKeyId=LTAIJDIkh7KmGS1H&amp;Signature=xO%2B7CeKnGRDmRCYs1IojjqVATtw%3D&amp;response-content-disposition=attachment%3Bfilename%3DC442603_KXTJ3-1057_2019-10-31.PDF</a></p>
<h3 id="概述："><a href="#概述：" class="headerlink" title="概述："></a>概述：</h3><p>ROHM Semiconductor 的 KXTJ3-1057 是三轴 ±2g、±4g、±8g 或 ±16g 微加工硅晶加速计。这些元件采用 Kionix 的专有等离子微加工工艺技术制造。加速度使这些元件运动，进而产生电容器差是这些元件的加速度检测的基本原理，而且使用共模消除法减少由于工艺变化、温度和环境影响造成的误差。利用玻璃浆料将另一片盖形晶圆与该器件粘结在一起，使这些元件实现晶圆级密封。独立的 ASIC 器件与感测元件封装在一起，用于进行信号调节和数字化通讯。<br>这种加速计采用 2 mm x 2 mm x 0.9 mm LGA 塑料封装，由 1.71 VDC 至 3.6 VDC  电源供电。稳压器用于在输入电源电压范围内保持内部工作电压恒定。这样就能在输入电压范围内保持稳定的工作特性，而且实现几乎检测不到的比率误差。I2C 数字协议用于与芯片进行通讯，以便对该部件进行配置并监视输出。</p>
<ul>
<li><p>内部结构图：<br><img src="http://openluat-luatcommunity.oss-cn-hangzhou.aliyuncs.com/attachment/20201226100322256_5b6d0bd743136.jpg" alt="Alt text"></p>
</li>
<li><p>参考电路图：<br><img src="http://openluat-luatcommunity.oss-cn-hangzhou.aliyuncs.com/attachment/20201226100335732_5b6d0be82f5be.jpg" alt="Alt text"></p>
</li>
</ul>
<h3 id="特性："><a href="#特性：" class="headerlink" title="特性："></a>特性：</h3><ul>
<li>体积小：2 mm x 2 mm x 0.9 mm LGA 封装</li>
<li>低电流消耗：待机状态 0.9 µA，低功耗状态 10 µA，高分辨率模式 155 µA</li>
<li>电源电压范围宽：1.71 V 至 3.6 V，且内置稳压器</li>
<li>更宽用户可宽展配置 g 范围：±2 g、±4 g、±8 g 或 ±16 g</li>
<li>I2C 数字通讯接口，高达 3.4 MHz</li>
<li>高分辨率环形功能，阈值可配置，低至 3.9 mg</li>
<li>用户可配置输出数据速率：0.781 Hz 至 1600 Hz</li>
<li>采用改进型设计，几乎消除了回流焊后偏移和灵敏度漂移</li>
<li>高度可配置的中断控制功能</li>
<li>符合 RoHS/REACH 规范</li>
</ul>
<h2 id="编写KXTJ3-1057-for-LuaTask-驱动"><a href="#编写KXTJ3-1057-for-LuaTask-驱动" class="headerlink" title="编写KXTJ3-1057 for LuaTask 驱动"></a>编写KXTJ3-1057 for LuaTask 驱动</h2><h3 id="抽象驱动所用到的函数"><a href="#抽象驱动所用到的函数" class="headerlink" title="抽象驱动所用到的函数"></a>抽象驱动所用到的函数</h3><ul>
<li>I2C 通信自检函数</li>
<li>KXTJ3-1057 寄存器定义</li>
<li>KXTJ3-1057 读寄存器函数</li>
<li>KXTJ3-1057 写寄存器函数</li>
<li>KXTJ3-1057 读中断状态函数</li>
<li>KXTJ3-1057 清中断函数</li>
<li>KXTJ3-1057 初始化函数</li>
<li>KXTJ3-1057 功能自检函数</li>
</ul>
<h3 id="KXTJ3-1057-的寄存器地址"><a href="#KXTJ3-1057-的寄存器地址" class="headerlink" title="KXTJ3-1057 的寄存器地址"></a>KXTJ3-1057 的寄存器地址</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> KXTJ3_ADDR = <span class="number">0x0E</span> <span class="comment">--KXTJ3 的地址</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_DCST_RESP = <span class="number">0x0C</span> <span class="comment">-- KXTJ3 的数字通自检寄存器</span></span><br><span class="line"><span class="comment">-- 加速度输出寄存器</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_XOUT_L  = <span class="number">0x06</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_XOUT_H = <span class="number">0x07</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_YOUT_L = <span class="number">0x08</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_YOUT_H = <span class="number">0x09</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_ZOUT_L = <span class="number">0x0A</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_ZOUT_H = <span class="number">0x0B</span></span><br><span class="line"><span class="comment">-- 中断寄存器</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_INT_SOURCE1 = <span class="number">0x16</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_INT_SOURCE2 = <span class="number">0x17</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_STATUS_REG = <span class="number">0x18</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_INT_REL = <span class="number">0x1A</span></span><br><span class="line"><span class="comment">-- 控制寄存器</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_CTRL_REG1 = <span class="number">0x1B</span> <span class="comment">-- KXTJ3的CTRL_REG1地址</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_CTRL_REG2 = <span class="number">0x1D</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_INT_CTRL_REG1 = <span class="number">0x1E</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_INT_CTRL_REG2 = <span class="number">0x1F</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_DATA_CTRL_REG = <span class="number">0x21</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_WAKEUP_COUNTER = <span class="number">0x29</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_WAKEUP_THRESHOLD_H = <span class="number">0x6A</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_WAKEUP_THRESHOLD_L = <span class="number">0x6B</span></span><br></pre></td></tr></table></figure>
<p>KXTJ3 的7位从机地址，请参阅你购买的产品手册给的规格书，通常是0x0E 或 0x0F 。</p>
<h3 id="KXTJ3-1057-读写寄存器函数"><a href="#KXTJ3-1057-读写寄存器函数" class="headerlink" title="KXTJ3-1057 读写寄存器函数"></a>KXTJ3-1057 读写寄存器函数</h3><p>LuaTask 的I2C 调用的是内部的硬件I2C，所以core给了几个API：<a target="_blank" rel="noopener" href="https://wiki.openluat.com/doc/luatApi4G/#i2c">https://wiki.openluat.com/doc/luatApi4G/#i2c</a></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 初始化并打开I2C操作</span></span><br><span class="line"><span class="comment">-- @param I2C 内部ID</span></span><br><span class="line"><span class="comment">-- @return number ,I2C的速率</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">i2c_open</span><span class="params">(id, speed)</span></span></span><br><span class="line">    <span class="keyword">if</span> i2c.setup(id, speed <span class="keyword">or</span> i2c.SLOW) ~= i2c.SLOW <span class="keyword">then</span></span><br><span class="line">        i2c.<span class="built_in">close</span>(id)</span><br><span class="line">        <span class="keyword">return</span> i2c.setup(id, speed <span class="keyword">or</span> i2c.SLOW)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> i2c.SLOW</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 读取寄存器值</span></span><br><span class="line"><span class="comment">-- @number id： I2C端口号</span></span><br><span class="line"><span class="comment">-- @number addr:KXTJ3-1057的从机地址</span></span><br><span class="line"><span class="comment">-- @number reg: KXTJ3-1057的寄存器地址</span></span><br><span class="line"><span class="comment">-- @return number: 寄存器当前值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readRegister</span><span class="params">(id, addr, reg)</span></span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;I2C OPEN Result:&quot;</span>, i2c_open(id))</span><br><span class="line">    i2c.send(id, addr, reg)</span><br><span class="line">    <span class="keyword">local</span> _, val = pack.<span class="built_in">unpack</span>(i2c.recv(id, addr, <span class="number">1</span>), <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    i2c.<span class="built_in">close</span>(id)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;读取&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;寄存器:0x%02x 当前值:0x%02x&quot;</span>, reg, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 写寄存器方法</span></span><br><span class="line"><span class="comment">-- @number  id: I2C端口号</span></span><br><span class="line"><span class="comment">-- @number addr:KXTJ3-1057的从机地址</span></span><br><span class="line"><span class="comment">-- @number reg: KXTJ3-1057的寄存器地址</span></span><br><span class="line"><span class="comment">-- @number ...: 要写入寄存器其他值</span></span><br><span class="line"><span class="comment">-- @return number:  寄存当前值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeReg</span><span class="params">(id, addr, reg, ...)</span></span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;I2C OPEN Result:&quot;</span>, i2c_open(id))</span><br><span class="line">    i2c.send(id, addr, &#123;reg, ...&#125;)</span><br><span class="line">    <span class="keyword">local</span> _, val = pack.<span class="built_in">unpack</span>(i2c.recv(id, addr, <span class="number">1</span>), <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;重读&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;寄存器:0x%02x 当前值:0x%02x&quot;</span>, reg, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line">    i2c.<span class="built_in">close</span>(id)</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>为了规避I2C异常，提高I2C抗干扰能力，建议I2C使用完后就立刻关闭。如上代码，每次读取寄存器1个字节。读写寄存器的函数可以根据实际情况，一次读取或写入两个字节，写寄存器函数每次写完后，会重读当前寄存器，方便调试。</p>
<h3 id="I2C-数字通信自检函数"><a href="#I2C-数字通信自检函数" class="headerlink" title="I2C 数字通信自检函数"></a>I2C 数字通信自检函数</h3><p>参考KXTJ3-1057 数据手册，可以找到寄存器“DCST_RESP” 专门用来做 KXTJ3-1057 数字通信验证的，如果接线正常，I2C工作正常, 那么读取该寄存器 KXTJ3-1057 会返回0x55，依据这个可以判断LuaTask的I2C和KXTJ3-1057的数字接线、数字通信是否正常，如果不返回0x55，要检查硬件和I2C端口号是否正确。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 数字通信自检验证</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- return number 正常返回0x55,其他值为异常</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dcst</span><span class="params">(id)</span></span></span><br><span class="line">    <span class="keyword">local</span> val = readRegister(id, KXTJ3_ADDR, DCST_RESP)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;KXTJ3C DCST Result:&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;0x%02x&quot;</span>, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="读取和复位状态寄存器"><a href="#读取和复位状态寄存器" class="headerlink" title="读取和复位状态寄存器"></a>读取和复位状态寄存器</h3><p>当中断源寄存器1的DRDY和WUFS位被置位时,该寄存器Bit4置位，表示有位移或者加速度变化产生。当读取加速度数据或读取中断释放寄存器(INT_REL)时，Bit4复位。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 读中断状态</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- return number 返回状态寄存器当前值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readStatus</span><span class="params">(id)</span></span></span><br><span class="line">    <span class="keyword">local</span> val = readRegister(id, KXTJ3_ADDR, KXTJ3_STATUS_REG)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;KXTJ3C read interrupt status:&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;0x%02x&quot;</span>, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 清中断状态</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- return nil</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clearStatus</span><span class="params">(id)</span></span></span><br><span class="line">    readRegister(id, KXTJ3_ADDR, KXTJ3_INT_REL)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;Clear Interrupt status register：&quot;</span>, <span class="string">&quot;OK&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="读取中断源寄存器"><a href="#读取中断源寄存器" class="headerlink" title="读取中断源寄存器"></a>读取中断源寄存器</h3><p>实际上读取寄存器的操作可以直接用readRegister函数直接实现，这里演示的是二次封装该方法，方便跨页面调用。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 读取中断源寄存器</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- @number src: 1 读中断源1寄存器, 2读中断源2寄存器</span></span><br><span class="line"><span class="comment">-- @return number: 返中断源寄存器的值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readInterrupt</span><span class="params">(id, src)</span></span></span><br><span class="line">    <span class="keyword">local</span> val = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> src == <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">        val = readRegister(id, KXTJ3_ADDR, KXTJ3_INT_SOURCE2)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        val = readRegister(id, KXTJ3_ADDR, KXTJ3_INT_SOURCE1)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;readInterrupt register：&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%02x&quot;</span>, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="KXTJ3-1057-工作模式切换"><a href="#KXTJ3-1057-工作模式切换" class="headerlink" title="KXTJ3-1057 工作模式切换"></a>KXTJ3-1057 工作模式切换</h3><p>KXTJ3-1057 部分寄存器写入数据必须在准备模式才能写入，工作模式写入无效。配置CTRL_REG1寄存器Bit7的值可切换工作模式：</p>
<ul>
<li>0 = stand-by mode</li>
<li>1 = operating mode</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 配置 KXTJ3工作模式</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- @number mode: 0 准备模式, 1工作模式</span></span><br><span class="line"><span class="comment">-- @return number: 返中断源寄存器的值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setMode</span><span class="params">(id, mode)</span></span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;--------&gt;I2C OPEN Result:&quot;</span>, i2c_open(id))</span><br><span class="line">    i2c.send(id, KXTJ3_ADDR, KXTJ3_CTRL_REG1)</span><br><span class="line">    <span class="keyword">local</span> _, val = pack.<span class="built_in">unpack</span>(i2c.recv(id, KXTJ3_ADDR, <span class="number">1</span>), <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    i2c.send(id, KXTJ3_ADDR, &#123;KXTJ3_CTRL_REG1, mode == <span class="number">0</span> <span class="keyword">and</span> bit.clear(val, <span class="number">7</span>) <span class="keyword">or</span> bit.set(val, <span class="number">7</span>)&#125;)</span><br><span class="line">    val = readRegister(id, KXTJ3_ADDR, KXTJ3_CTRL_REG1)</span><br><span class="line">    i2c.<span class="built_in">close</span>(id)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;读取CTRL_REG1寄存器:&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;当前值:0x%02x&quot;</span>, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>实际应用中，也可以在准备模式配置玩寄存器后，配置CTRL_REG1的同时切换KXTJ3为工作模式。</p>
<h3 id="读取三轴加速度数据"><a href="#读取三轴加速度数据" class="headerlink" title="读取三轴加速度数据"></a>读取三轴加速度数据</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 读取三轴输出值,注意结果是 Tri-axis 数字量</span></span><br><span class="line"><span class="comment">-- @param  axis: &#x27;x&#x27;,&#x27;y&#x27;,&#x27;z&#x27; 分别表示x,y,z轴</span></span><br><span class="line"><span class="comment">-- @number n: 分辨率,可选值8,12,14(CTRL_REG1配置)</span></span><br><span class="line"><span class="comment">-- @return number: Tri-axis Digital</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readAxis</span><span class="params">(id, axis, n)</span></span></span><br><span class="line">    <span class="keyword">local</span> val, recv, reg = <span class="number">0</span>, &#123;&#125;, &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> axis == <span class="string">&#x27;x&#x27;</span> <span class="keyword">then</span></span><br><span class="line">        reg[<span class="number">1</span>] = KXTJ3_XOUT_L</span><br><span class="line">        reg[<span class="number">2</span>] = KXTJ3_XOUT_H</span><br><span class="line">    <span class="keyword">elseif</span> axis == <span class="string">&#x27;y&#x27;</span> <span class="keyword">then</span></span><br><span class="line">        reg[<span class="number">1</span>] = KXTJ3_YOUT_L</span><br><span class="line">        reg[<span class="number">2</span>] = KXTJ3_YOUT_H</span><br><span class="line">    <span class="keyword">elseif</span> axis == <span class="string">&#x27;z&#x27;</span> <span class="keyword">then</span></span><br><span class="line">        reg[<span class="number">1</span>] = KXTJ3_ZOUT_L</span><br><span class="line">        reg[<span class="number">2</span>] = KXTJ3_ZOUT_H</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    recv[<span class="number">1</span>] = readRegister(id, KXTJ3_ADDR, reg[<span class="number">1</span>])</span><br><span class="line">    recv[<span class="number">2</span>] = readRegister(id, KXTJ3_ADDR, reg[<span class="number">2</span>])</span><br><span class="line">    val = recv[<span class="number">2</span>] * <span class="number">256</span> + recv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">8</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> recv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">elseif</span> n == <span class="number">12</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> (recv[<span class="number">2</span>] &gt; <span class="number">0x7F</span>) <span class="keyword">and</span> bit.bor(bit.rshift(val, <span class="number">4</span>), <span class="number">0xF000</span>) <span class="keyword">or</span> bit.band(bit.rshift(val, <span class="number">4</span>), <span class="number">0x0FFF</span>)</span><br><span class="line">    <span class="keyword">elseif</span> n == <span class="number">14</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> (recv[<span class="number">2</span>] &gt; <span class="number">0x7F</span>) <span class="keyword">and</span> bit.bor(bit.rshift(val, <span class="number">4</span>), <span class="number">0xC000</span>) <span class="keyword">or</span> bit.band(bit.rshift(val, <span class="number">4</span>), <span class="number">0x3FFF</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这部分没啥好说的，就是读取加速度三轴的高低位寄存器的值，根据CTRL_REG1寄存器配置的分辨率，然后换算成Tri-axis 数字量。</p>
<h3 id="KXTJ3-1057-三轴功能自检函数"><a href="#KXTJ3-1057-三轴功能自检函数" class="headerlink" title="KXTJ3-1057 三轴功能自检函数"></a>KXTJ3-1057 三轴功能自检函数</h3><p>KXTJ3-1057 提供了一套功能自检逻辑，帮助用户判断三轴传感器是否正常工作。当写入0xCA到SELF_TEST寄存器,内部测量自检方法被启用, 加速度的静电驱动会让X,Y,Z三轴产生偏移，对该寄存器写入0x00，则关闭自建并恢复正常工作。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- KXTJ3-1057 功自检</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- @return nil</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selfTest</span><span class="params">(id)</span></span></span><br><span class="line">    setMode(id, <span class="number">0</span>)</span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_SELF_TEST, <span class="number">0xCA</span>)</span><br><span class="line">    setMode(id, <span class="number">1</span>)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;on self test axis-x: &quot;</span>, readAxis(id, <span class="string">&#x27;x&#x27;</span>, <span class="number">8</span>))</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;on self test axis-y: &quot;</span>, readAxis(id, <span class="string">&#x27;y&#x27;</span>, <span class="number">8</span>))</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;on self test axis-z: &quot;</span>, readAxis(id, <span class="string">&#x27;z&#x27;</span>, <span class="number">8</span>))</span><br><span class="line">    setMode(id, <span class="number">0</span>)</span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_SELF_TEST, <span class="number">0x00</span>)</span><br><span class="line">    setMode(id, <span class="number">1</span>)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;out self test axis-x: &quot;</span>, readAxis(id, <span class="string">&#x27;x&#x27;</span>, <span class="number">8</span>))</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;out self test axis-y: &quot;</span>, readAxis(id, <span class="string">&#x27;y&#x27;</span>, <span class="number">8</span>))</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;out self test axis-z: &quot;</span>, readAxis(id, <span class="string">&#x27;z&#x27;</span>, <span class="number">8</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="KXTJ3-1057-初始化示例"><a href="#KXTJ3-1057-初始化示例" class="headerlink" title="KXTJ3-1057 初始化示例"></a>KXTJ3-1057 初始化示例</h3><p>下面介绍 KXTJ3-1057 初始化的例子, 读者可根据自己的实际情况和项目需求进行更改，其中一些直接用writeRegister写寄存器的方法, 大家可以自己动手封装成方法，方便在其他页面调用。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 初始化配置</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- @return nil</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(id)</span></span></span><br><span class="line">    <span class="comment">-- 进入配置模式</span></span><br><span class="line">    setMode(id, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">-- 复位控制寄存器2</span></span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_CTRL_REG2, <span class="number">0x86</span>)</span><br><span class="line">    <span class="comment">-- 配置控制寄存器2 为50HZ</span></span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_CTRL_REG2, <span class="number">0x06</span>)</span><br><span class="line">    <span class="comment">-- 配置唤醒延时和唤阈值</span></span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_WAKEUP_COUNTER, <span class="number">50</span>)</span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_WAKEUP_THRESHOLD_H, (<span class="number">1500</span> - (<span class="number">1500</span> % <span class="number">256</span>)) / <span class="number">256</span>)</span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_WAKEUP_THRESHOLD_L, <span class="number">1500</span> % <span class="number">256</span>)</span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_DATA_CTRL_REG, <span class="number">0x02</span>)</span><br><span class="line">    <span class="comment">-- 配置控制寄存器1 配置唤中断,(B0010 0010)</span></span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_CTRL_REG1, <span class="number">0x82</span>)</span><br><span class="line">    <span class="comment">-- 清中断</span></span><br><span class="line">    clearStatus(id)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;KXTJ3C init done: &quot;</span>, <span class="string">&quot;ok!&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">Author: 稀饭放姜</span></span><br><span class="line"><span class="comment">Date: 2020-12-18 15:50:05</span></span><br><span class="line"><span class="comment">LastEditors: 稀饭放姜</span></span><br><span class="line"><span class="comment">LastEditTime: 2020-12-25 12:24:25</span></span><br><span class="line"><span class="comment">FilePath: \HeFeiYunShi-Air724\user\sensor.lua</span></span><br><span class="line"><span class="comment">--]]</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;utils&quot;</span></span><br><span class="line"><span class="built_in">module</span>(..., <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"><span class="comment">-- 初始化并打开I2C操作</span></span><br><span class="line"><span class="comment">-- @param I2C 内部ID</span></span><br><span class="line"><span class="comment">-- @return number ,I2C的速率</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">i2c_open</span><span class="params">(id, speed)</span></span></span><br><span class="line">    <span class="keyword">if</span> i2c.setup(id, speed <span class="keyword">or</span> i2c.SLOW) ~= i2c.SLOW <span class="keyword">then</span></span><br><span class="line">        i2c.<span class="built_in">close</span>(id)</span><br><span class="line">        <span class="keyword">return</span> i2c.setup(id, speed <span class="keyword">or</span> i2c.SLOW)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> i2c.SLOW</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 读取寄存器值</span></span><br><span class="line"><span class="comment">-- @number id： I2C端口号</span></span><br><span class="line"><span class="comment">-- @number addr:从机地址</span></span><br><span class="line"><span class="comment">-- @number reg: 寄存器地址</span></span><br><span class="line"><span class="comment">-- @return number: 寄存器当前值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readRegister</span><span class="params">(id, addr, reg)</span></span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;--------&gt;I2C OPEN Result:&quot;</span>, i2c_open(id))</span><br><span class="line">    i2c.send(id, addr, reg)</span><br><span class="line">    <span class="keyword">local</span> _, val = pack.<span class="built_in">unpack</span>(i2c.recv(id, addr, <span class="number">1</span>), <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    i2c.<span class="built_in">close</span>(id)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;读取&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;寄存器:0x%02x 当前值:0x%02x&quot;</span>, reg, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 写寄存器方法</span></span><br><span class="line"><span class="comment">-- @number  id: I2C端口号</span></span><br><span class="line"><span class="comment">-- @number addr:从机地址</span></span><br><span class="line"><span class="comment">-- @number reg: 寄存器地址</span></span><br><span class="line"><span class="comment">-- @number ...: 要写入寄存器其他值</span></span><br><span class="line"><span class="comment">-- @return number:  寄存当前值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeRegister</span><span class="params">(id, addr, reg, ...)</span></span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;--------&gt;I2C OPEN Result:&quot;</span>, i2c_open(id))</span><br><span class="line">    i2c.send(id, addr, &#123;reg, ...&#125;)</span><br><span class="line">    <span class="keyword">local</span> _, val = pack.<span class="built_in">unpack</span>(i2c.recv(id, addr, <span class="number">1</span>), <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;重读&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;寄存器:0x%02x 当前值:0x%02x&quot;</span>, reg, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line">    i2c.<span class="built_in">close</span>(id)</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-------------------------------------- KXTJ3-1057 驱动代码开始 --------------------------------------</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_ADDR = <span class="number">0x0E</span> <span class="comment">--KXTJ3 的地址</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_DCST_RESP = <span class="number">0x0C</span> <span class="comment">-- KXTJ3 的数字通自检寄存器</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_SELF_TEST = <span class="number">0x3A</span> <span class="comment">-- KXTJ3 的功自检寄存器</span></span><br><span class="line"><span class="comment">-- 加速度输出寄存器</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_XOUT_L = <span class="number">0x06</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_XOUT_H = <span class="number">0x07</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_YOUT_L = <span class="number">0x08</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_YOUT_H = <span class="number">0x09</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_ZOUT_L = <span class="number">0x0A</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_ZOUT_H = <span class="number">0x0B</span></span><br><span class="line"><span class="comment">-- 中断寄存器</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_INT_SOURCE1 = <span class="number">0x16</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_INT_SOURCE2 = <span class="number">0x17</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_STATUS_REG = <span class="number">0x18</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_INT_REL = <span class="number">0x1A</span></span><br><span class="line"><span class="comment">-- 控制寄存器</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_CTRL_REG1 = <span class="number">0x1B</span> <span class="comment">-- KXTJ3的CTRL_REG1地址</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_CTRL_REG2 = <span class="number">0x1D</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_INT_CTRL_REG1 = <span class="number">0x1E</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_INT_CTRL_REG2 = <span class="number">0x1F</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_DATA_CTRL_REG = <span class="number">0x21</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_WAKEUP_COUNTER = <span class="number">0x29</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_WAKEUP_THRESHOLD_H = <span class="number">0x6A</span></span><br><span class="line"><span class="keyword">local</span> KXTJ3_WAKEUP_THRESHOLD_L = <span class="number">0x6B</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 数字通信自检验证</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- return number 正常返回0x55,其他值为异常</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dcst</span><span class="params">(id)</span></span></span><br><span class="line">    <span class="keyword">local</span> val = readRegister(id, KXTJ3_ADDR, KXTJ3_DCST_RESP)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;KXTJ3C DCST Result:&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;0x%02x&quot;</span>, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 读中断状态</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- return number 返回状态寄存器当前值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readStatus</span><span class="params">(id)</span></span></span><br><span class="line">    <span class="keyword">local</span> val = readRegister(id, KXTJ3_ADDR, KXTJ3_STATUS_REG)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;KXTJ3C read interrupt status:&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;0x%02x&quot;</span>, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 清中断状态</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- return nil</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clearStatus</span><span class="params">(id)</span></span></span><br><span class="line">    readRegister(id, KXTJ3_ADDR, KXTJ3_INT_REL)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;Clear Interrupt status register：&quot;</span>, <span class="string">&quot;OK&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 读取中断源寄存器</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- @number src: 1 读中断源1寄存器, 2读中断源2寄存器</span></span><br><span class="line"><span class="comment">-- @return number: 返中断源寄存器的值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readInterrupt</span><span class="params">(id, src)</span></span></span><br><span class="line">    <span class="keyword">local</span> val = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> src == <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">        val = readRegister(id, KXTJ3_ADDR, KXTJ3_INT_SOURCE2)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        val = readRegister(id, KXTJ3_ADDR, KXTJ3_INT_SOURCE1)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;readInterrupt register：&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%02x&quot;</span>, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 配置 KXTJ3工作模式</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- @number mode: 0 准备模式, 1工作模式</span></span><br><span class="line"><span class="comment">-- @return number: 返中断源寄存器的值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setMode</span><span class="params">(id, mode)</span></span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;--------&gt;I2C OPEN Result:&quot;</span>, i2c_open(id))</span><br><span class="line">    i2c.send(id, KXTJ3_ADDR, KXTJ3_CTRL_REG1)</span><br><span class="line">    <span class="keyword">local</span> _, val = pack.<span class="built_in">unpack</span>(i2c.recv(id, KXTJ3_ADDR, <span class="number">1</span>), <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    i2c.send(id, KXTJ3_ADDR, &#123;KXTJ3_CTRL_REG1, mode == <span class="number">0</span> <span class="keyword">and</span> bit.clear(val, <span class="number">7</span>) <span class="keyword">or</span> bit.set(val, <span class="number">7</span>)&#125;)</span><br><span class="line">    val = readRegister(id, KXTJ3_ADDR, KXTJ3_CTRL_REG1)</span><br><span class="line">    i2c.<span class="built_in">close</span>(id)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;读取CTRL_REG1寄存器:&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;当前值:0x%02x&quot;</span>, val <span class="keyword">or</span> <span class="number">0</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 读取三轴输出值,注意结果是 Tri-axis 数字量</span></span><br><span class="line"><span class="comment">-- @param  axis: &#x27;x&#x27;,&#x27;y&#x27;,&#x27;z&#x27; 分别表示x,y,z轴</span></span><br><span class="line"><span class="comment">-- @number n: 分辨率,可选值8,12,14(CTRL_REG1配置)</span></span><br><span class="line"><span class="comment">-- @return number: Tri-axis Digital</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readAxis</span><span class="params">(id, axis, n)</span></span></span><br><span class="line">    <span class="keyword">local</span> val, recv, reg = <span class="number">0</span>, &#123;&#125;, &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> axis == <span class="string">&#x27;x&#x27;</span> <span class="keyword">then</span></span><br><span class="line">        reg[<span class="number">1</span>] = KXTJ3_XOUT_L</span><br><span class="line">        reg[<span class="number">2</span>] = KXTJ3_XOUT_H</span><br><span class="line">    <span class="keyword">elseif</span> axis == <span class="string">&#x27;y&#x27;</span> <span class="keyword">then</span></span><br><span class="line">        reg[<span class="number">1</span>] = KXTJ3_YOUT_L</span><br><span class="line">        reg[<span class="number">2</span>] = KXTJ3_YOUT_H</span><br><span class="line">    <span class="keyword">elseif</span> axis == <span class="string">&#x27;z&#x27;</span> <span class="keyword">then</span></span><br><span class="line">        reg[<span class="number">1</span>] = KXTJ3_ZOUT_L</span><br><span class="line">        reg[<span class="number">2</span>] = KXTJ3_ZOUT_H</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    recv[<span class="number">1</span>] = readRegister(id, KXTJ3_ADDR, reg[<span class="number">1</span>])</span><br><span class="line">    recv[<span class="number">2</span>] = readRegister(id, KXTJ3_ADDR, reg[<span class="number">2</span>])</span><br><span class="line">    val = recv[<span class="number">2</span>] * <span class="number">256</span> + recv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">8</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> recv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">elseif</span> n == <span class="number">12</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> (recv[<span class="number">2</span>] &gt; <span class="number">0x7F</span>) <span class="keyword">and</span> bit.bor(bit.rshift(val, <span class="number">4</span>), <span class="number">0xF000</span>) <span class="keyword">or</span> bit.band(bit.rshift(val, <span class="number">4</span>), <span class="number">0x0FFF</span>)</span><br><span class="line">    <span class="keyword">elseif</span> n == <span class="number">14</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> (recv[<span class="number">2</span>] &gt; <span class="number">0x7F</span>) <span class="keyword">and</span> bit.bor(bit.rshift(val, <span class="number">4</span>), <span class="number">0xC000</span>) <span class="keyword">or</span> bit.band(bit.rshift(val, <span class="number">4</span>), <span class="number">0x3FFF</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- KXTJ3-1057 功自检</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- @return nil</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selfTest</span><span class="params">(id)</span></span></span><br><span class="line">    setMode(id, <span class="number">0</span>)</span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_SELF_TEST, <span class="number">0xCA</span>)</span><br><span class="line">    setMode(id, <span class="number">1</span>)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;on self test axis-x: &quot;</span>, readAxis(id, <span class="string">&#x27;x&#x27;</span>, <span class="number">8</span>))</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;on self test axis-y: &quot;</span>, readAxis(id, <span class="string">&#x27;y&#x27;</span>, <span class="number">8</span>))</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;on self test axis-z: &quot;</span>, readAxis(id, <span class="string">&#x27;z&#x27;</span>, <span class="number">8</span>))</span><br><span class="line">    setMode(id, <span class="number">0</span>)</span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_SELF_TEST, <span class="number">0x00</span>)</span><br><span class="line">    setMode(id, <span class="number">1</span>)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;out self test axis-x: &quot;</span>, readAxis(id, <span class="string">&#x27;x&#x27;</span>, <span class="number">8</span>))</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;out self test axis-y: &quot;</span>, readAxis(id, <span class="string">&#x27;y&#x27;</span>, <span class="number">8</span>))</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;out self test axis-z: &quot;</span>, readAxis(id, <span class="string">&#x27;z&#x27;</span>, <span class="number">8</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-------------------------------------- KXTJ3-1057 驱动代码结束 --------------------------------------</span></span><br><span class="line"><span class="comment">--- 初始化配置</span></span><br><span class="line"><span class="comment">-- number id: I2C端口号</span></span><br><span class="line"><span class="comment">-- @return nil</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(id)</span></span></span><br><span class="line">    <span class="comment">-- 进入配置模式</span></span><br><span class="line">    setMode(id, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">-- 复位控制寄存器2</span></span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_CTRL_REG2, <span class="number">0x86</span>)</span><br><span class="line">    <span class="comment">-- 配置控制寄存器2 为50HZ</span></span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_CTRL_REG2, <span class="number">0x06</span>)</span><br><span class="line">    <span class="comment">-- 配置唤醒延时和唤阈值</span></span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_WAKEUP_COUNTER, <span class="number">50</span>)</span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_WAKEUP_THRESHOLD_H, (<span class="number">1500</span> - (<span class="number">1500</span> % <span class="number">256</span>)) / <span class="number">256</span>)</span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_WAKEUP_THRESHOLD_L, <span class="number">1500</span> % <span class="number">256</span>)</span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_DATA_CTRL_REG, <span class="number">0x02</span>)</span><br><span class="line">    <span class="comment">-- 配置控制寄存器1 配置唤中断,(B0010 0010)</span></span><br><span class="line">    writeRegister(id, KXTJ3_ADDR, KXTJ3_CTRL_REG1, <span class="number">0x82</span>)</span><br><span class="line">    <span class="comment">-- 清中断</span></span><br><span class="line">    clearStatus(id)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;KXTJ3C init done: &quot;</span>, <span class="string">&quot;ok!&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

</article>

    <div class="pagenator post-pagenator">
    
    
        <a class="extend prev post-prev" href="/2020/12/27/2129/">上一篇</a>
    

    
    <p>上次更新 2021-01-28</p>
    
    
        <a class="extend next post-next" href="/2020/12/24/2113/">下一篇</a>
    
    </div>

    </div>
    <div class="footer">
        <div class="container">
    <div class="social">
	<ul class="social-list">
		
			
				
				
				<li>
					<a href="mailto:1178752402@qq.com" title="email" target="_blank">
					<i class="fa fa-email"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
				
				<li>
					<a href="https://github.com/CaiChenghan" title="github" target="_self">
					<i class="fa fa-github"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
				
				<li>
					<a href="https://www.jianshu.com/u/565c8e790605" title="jianshu" target="_self">
					<i class="fa fa-jianshu"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
	</ul>
</div>
    <div class="copyright">
        <span>
            
            
            
                © chenxuuu 2017 - 2021
            
        </span>
    </div>
    <div class="power">
        <span>
            Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/CaiChenghan/iLiKE">iLiKE Theme</a>
        </span>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <!--page counter part-->
<script>
function addCount (Counter) {
    url=$('.article-date').attr('href').trim();
    title = $('.article-title').text().trim();
    var query = new AV.Query(Counter);
    //use url as unique idnetfication
    query.equalTo("url",url);
    query.find({
        success: function(results) {
            if (results.length>0) {
                var counter=results[0];
                counter.fetchWhenSave(true); //get recent result
                counter.increment("time");
                counter.save();
            } else {
                var newcounter=new Counter();
                newcounter.set("title",title);
                newcounter.set("url",url);
                newcounter.set("time",1);
                newcounter.save(null,{
                    success: function(newcounter) {
                        //alert('New object created');
                    }, error: function(newcounter,error) {
                        alert('Failed to create');
                    }
                })
            }
        },
        error: function(error) {
            //find null is not a error
            alert('Error:'+error.code+" "+error.message);
        }
    });
}
$(function() {
    var Counter=AV.Object.extend("Counter");
    //only increse visit counting when intering a page
    if ($('.article-title').length == 1) {
       addCount(Counter);
    }
    var query=new AV.Query(Counter);
    query.descending("time");
    // the sum of popular posts
    query.limit(10); 
    query.find({
        success: function(results) {
                for(var i=0;i<results.length;i++) {
                    var counter=results[i];
                    title=counter.get("title");
                    url=counter.get("url");
                    time=counter.get("time");
                    // add to the popularlist widget
                    showcontent=title+" ("+time+")";
                    //notice the "" in href
                    $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                }
            },
        error: function(error) {
            alert("Error:"+error.code+" "+error.message);
        }
    });
});
</script>
</div>
    </div>
</body>
</html>
