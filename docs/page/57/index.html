<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Luat doc 社区文章静态页面镜像</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Luat doc 社区文章静态页面镜像">
<meta property="og:type" content="website">
<meta property="og:title" content="Luat doc 社区文章静态页面镜像">
<meta property="og:url" content="https://doc.luatos.wiki/page/57/index.html">
<meta property="og:site_name" content="Luat doc 社区文章静态页面镜像">
<meta property="og:description" content="Luat doc 社区文章静态页面镜像">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="chenxuuu">
<meta property="article:tag" content="lua">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Luat doc 社区文章静态页面镜像" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Luat doc 社区文章静态页面镜像</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://doc.luatos.wiki"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-414" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/30/414/" class="article-date">
  <time class="dt-published" datetime="2018-08-29T23:10:22.000Z" itemprop="datePublished">2018-08-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/30/414/">什么是GPS的冷启动、温启动和热启动？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>很多开发者对于GPS多种启动方式的概念还很模糊的，尤其是冷启动、热启动、温启动各种专业术语铺天盖地，使得开发者眼花缭乱。</p>

<p>所以，我们简单从定义上了解一下几种GPS启动的方式——GPS开机启动分为<b><span style="background-color:inherit;"><font color="#FF0000">热启动、温启动、冷启动</font></span></b>三种情况。</p>

<p><span style="background-color:inherit;"><font color="#FF0000"><b>热启动</b></font></span>：指在上次关机的地方没有过多移动过，且距离上次定位时间小于2个小时。再次定位时，GPS芯片通过软件的方式，可以继续使用之前的星历快速搜星，实现秒定位。</p>

<p>PS：普通的GPS芯片，星历最长有效期为12小时，故此星历过期后，GPS芯片无法使用星历实现快速定位。</p>

<p>Air8xx 系列模块使用的GK9501 GPS芯片，拥有自动生成星历的特性，即：3D FIX 10分钟，内部自动生成星历，只要维持RTC供电，星历有效期长达72小时。<br /></p>

<p><br /></p>

<p><span style="background-color:inherit;"><font color="#FF0000"><b>温启动</b></font></span>：指距离上次定位时间超过2个小时的启动，搜星定位时间介于冷启动和热启动之间的情况。</p>

<p>譬如某时间使用过GPS定位实现3D FIX，GPS芯片内部生成星历（或者外部灌入AGPS数据），那么在2小时内启动GPS芯片进行定位的行为就属于温启动。启动后，GPS芯片首先会输出上次的位置信息。因为上次关机前的经纬度和高度已知，但由于关机时间过长，卫星状态发生了变化，之前3D FIX时的卫星接受不到了，所以星历中参数中的若干颗卫星已经和GPS接收机失去了联系，GPS芯片需要继续搜星补充位置信息，所以搜星的时间要长于热启动，短于冷启动。</p>

<p><br /></p>

<p><font color="#FF0000"><span style="background-color:inherit;"><b>冷启动</b></span></font>：指在一个陌生的环境下启动GPS，直到GPS芯片和可用卫星联系并且计算出坐标的过程。以下几种情况开机均属冷启动：<br /></p>

<ol><li>初次开机使用时；</li><li>电池耗尽导致GPS芯片内星历信息丢失时；</li><li>关机状态下将接收机移动1000公里以上距离。</li></ol>

<p>也就是说，冷启动是通过硬件方式的强制性启动，因为物理距离较远，或者时间间隔很久，GPS芯片已经把内部的星历信息清除掉，或者内部的星历信息完全失效。GPS接收机失去卫星参数，或者已经存在的参数和实际接收到卫星参数相差太多，导致GPS芯片无法靠星历快速搜星，所以必须从新获得卫星提供的坐标数据。</p>

<p>这也是很多定位器（譬如车载定位器）启动后，搜星时间长、定位耗时久的原因。</p>

<p><br /></p>

<p>有的开发者使用APGS后，发现实现3D FIX仍然耗时较久，这可能是由于以下原因造成的：</p>

<ol><li>GPRS信号差，导致附着时间过长，或者通信质量差，甚至比GPS 3D FIX耗时更久；</li><li>AGPS服务器不可用；</li><li>错误的AGPS数据；</li><li>GPS信号差（AGPS仅辅助定位，本身没有定位功能。就像是N2O仅能让汽车加速，但是不能代替汽油）；</li><li>GPS芯片工作状态异常；</li></ol>

<p>有的地方（譬如室内、峡谷、高架桥下等）GPS信号极弱，定位效果差，开发者应该使用GPS + LBS（基站定位）等方式进行互补，实现定位。<br /></p>

<p>开发者可以根据自己的实际情况，对定位的方式进行修改，实现效果最优，功耗最小。<br /></p>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/30/414/" data-id="ckkfmdgb6004xvkcg85f21q9k" data-title="什么是GPS的冷启动、温启动和热启动？" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-413" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/29/413/" class="article-date">
  <time class="dt-published" datetime="2018-08-29T01:44:09.000Z" itemprop="datePublished">2018-08-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/29/413/">GPRS如何防范掉线</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>由于博客系统迁移，所以有一些文章无法找到，故此在此贴出，以帮助有需要的开发者。</p>

<p>-----------</p>

<p>应用场景：物联网洗衣机项目
</p>

<p>传输机制：TCP透传
</p>

<p>开发板：     Air202 S5</p>

<p><br /></p>

<p>GPRS通信出现的问题：</p>

<ol><li>模块TCP连接状态为已连接，但是无法传送数据</li><li>铁皮干扰GPRS信号</li></ol>

<p>解决方案：</p>

<p>      对于问题(1)，由于GPRS连接蜂窝网络，长时间没有数据传送蜂窝网络会认为是断开，此时模块的TCP连接没有收到FIN的帧。所以air202模块认为网络还是连接着，但是实际是无法传输数据的；需要做个心跳功能定时发送数据，我现在用的是90秒（官方的说是10分钟，但是我在宁波的网络测试3分钟有的时候都不行），在福州和宁波的网络测试都正常。
</p>

<p>      对于问题(2)，天线需要远离环形的铁皮
</p>

<p>      为了确保模块运行可靠，应增添容错机制
——在tcp透传demo的基础上面添加了一个4分钟没有检测到心跳信号就重启模块的检测程序。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/29/413/" data-id="ckkfmdgb6004wvkcgbxjefrwb" data-title="GPRS如何防范掉线" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-412" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/28/412/" class="article-date">
  <time class="dt-published" datetime="2018-08-28T12:45:16.000Z" itemprop="datePublished">2018-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/28/412/">同步时模块时钟的N种方法</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><span style="font-family:'宋体';">很多场景中，由于业务需要，模块需要保持正确的系统时钟，才能正常工作。但是模块上电后的初试时间戳是</span><span style="font-size:9pt;font-family:'Segoe UI', sans-serif;">1338516000</span><span style="font-family:'宋体';">（即</span><span style="font-size:9pt;font-family:'Segoe UI', sans-serif;">2012/06/01,10:00:00</span><span style="font-family:'宋体';">），所以同步时钟成为了开发者要解决的重要问题。</span></p>

<p><span style="font-family:'宋体';">首先我们捋一下思路——模块要如何执行动作，执行何种动作，才可以同步时钟呢？基于这个疑问，我们先做一个定义：</span></p>

<p style="text-align:center;"><span style="font-family:'宋体';">只有当模块和外界以某种方式产生数据交互，且模块收到完整数据并正确解析时，才可以完成对应操作。</span></p>

<p><span style="font-family:'宋体';">定义中指的“某种方式”是没有局限性的，也就是说开发者可以自由发挥想象力，只有你想不到，没有它做不到。接下来为大家介绍一些常见的和不常见的方式，方便开发者根据不同场景选择合适的方式。</span></p>

<p><span style="font-family:'宋体';">（下文中，如无额外说明，均指</span><span>Lua</span><span style="font-family:'宋体';">方式的二次开发）</span></p>

<h3><span style="font-family:'宋体';">一、常见且常用的</span><span>NTP</span></h3>

<p><span>NTP</span><span style="font-family:'宋体';">是大家众所周知的、广泛使用的、精确可靠的时钟同步方式。具有高效、准确、流量少，易实现的特点。</span><span>NTP</span><span style="font-family:'宋体';">这种方式，就是使用“定义”中的蜂窝网络，和远端</span><span>NTP</span><span style="font-family:'宋体';">服务器交互数据，收到服务器的回应并解析，重新设定系统时钟，完成同步。</span></p>

<p><span style="font-family:'宋体';">我司的</span><span>lua</span><span style="font-family:'宋体';">代码也提供了相应的基础库，开发者只需要简单的调用相应的函数，即可实现同步时钟：</span></p>

<p><span>luaScript:</span></p>

<p><span>require”ntp”<span>                                         </span>--</span><span style="font-family:'宋体';">对，就这一行代码即可哦</span></p>

<p></p>

<p><br /></p>

<p><span>luaTask:</span></p>

<p><span>require”ntp”</span></p>

<p><span>ntp.timeSync()<span>                                      </span>--</span><span style="font-family:'宋体';">只同步一次</span></p>

<p><span>--ntp.timeSync(1)<span>                                 </span>--</span><span style="font-family:'宋体';">每</span><span>1</span><span style="font-family:'宋体';">小时同步一次</span></p>

<p><span style="font-family:'宋体';">实际运行一下，看看效果如何：</span></p>

<p></p>

<p><img style="width:355px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-dnuA9feY5b854314ec6ea.png" class="img-responsive" alt="attachments-2018-08-dnuA9feY5b854314ec6ea.png" /></p>

<p></p>

<p><br /></p>

<p><span style="font-family:'宋体';">需要注意的是，</span><span>NTP</span><span style="font-family:'宋体';">使用的是多个免费公共的</span><span>NTP</span><span style="font-family:'宋体';">服务器来同步时钟，所以不能保证任何时间任何地点都能百分百同步到正确的时间。如果开发者项目中的业务逻辑严格依赖于时钟同步功能，建议使用开发者自己的服务器进行同步。</span></p>

<h3><span style="font-family:'宋体';">二、精确到纳秒的</span><span>GPS</span></h3>

<p><span style="font-family:'宋体';">如果开发者使用的是</span><span>Air8xx</span><span style="font-family:'宋体';">系列模块，或者是其他挂载</span><span>GPS</span><span style="font-family:'宋体';">模块的</span><span>Air2xx</span><span style="font-family:'宋体';">系列产品，那么可以是用这个方式进行同步。</span></p>

<p><span style="font-family:'宋体';">由于卫星定位系统的特性，每颗卫星都有精确到纳秒级的铯原子钟，才能实现全球的精确定位。故此，当开发者使用含</span><span>GPS</span><span style="font-family:'宋体';">功能的模块时，可以使用</span><span>GPS</span><span style="font-family:'宋体';">授时特性实现同步时钟。此种方式，就是使用“定义”中的</span><span>GPS</span><span style="font-family:'宋体';">卫星信号，解析数据，设定模块系统时钟，完成同步。</span></p>

<p><span style="font-family:'宋体';">实现原理并不复杂，只要解析</span><span>GPS</span><span style="font-family:'宋体';">模块上报</span><span>GGA</span><span style="font-family:'宋体';">即可：</span></p>

<p><span style="font-family:'宋体';">格式：</span><span>$--GGA,hhmmss.ss,llll.ll,a,yyyyy.yy,a,x,xx,x.x,x.x,M,x.x,M,x.x,xxxx*hh</span></p>

<p><span style="font-family:'宋体';">示例：</span><span>$GPGGA,065545.789,2109.9551,N,12023.4047,E,1,9,0.85,18.1,M,8.0,M,,*5E</span></p>

<table class="MsoTableGrid" width="568"><tr><td>
  <p><span style="font-family:'宋体';">名称</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">样例</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">单位</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">描述</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">消息</span><span>ID</span></p>
  </td>
  <td>
  <p><span>$GPGGA</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>GGA </span><span style="font-family:'宋体';">协议头</span></p>
  </td>
 </tr><tr><td>
  <p><span>UTC </span><span style="font-family:'宋体';">时间</span></p>
  </td>
  <td>
  <p><span>065545.789</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>hhmmss.sss</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">纬度</span></p>
  </td>
  <td>
  <p><span>2109.9551</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>ddmm.mmmm</span></p>
  </td>
 </tr><tr><td>
  <p><span>N/S</span></p>
  </td>
  <td>
  <p><span>N</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>N=</span><span style="font-family:'宋体';">北，</span><span>S=</span><span style="font-family:'宋体';">南</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">经度</span></p>
  </td>
  <td>
  <p><span>12023.4047</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>dddmm.mmmm</span></p>
  </td>
 </tr><tr><td>
  <p><span>E/W</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>W=</span><span style="font-family:'宋体';">西，</span><span>E=</span><span style="font-family:'宋体';">东</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">定位指示</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>0:</span><span style="font-family:'宋体';">未定位</span></p>
  <p><span>1:SPS </span><span style="font-family:'宋体';">模式，定位有效</span></p>
  <p><span>2:</span><span style="font-family:'宋体';">差分，</span><span>SPS </span><span style="font-family:'宋体';">模式，定位有效</span></p>
  <p><span>3:PPS </span><span style="font-family:'宋体';">模式，定位有效</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">卫星数目</span></p>
  </td>
  <td>
  <p><span>9</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">范围</span><span> 0 </span><span style="font-family:'宋体';">到</span><span> 12</span></p>
  </td>
 </tr><tr><td>
  <p><span>HDOP</span></p>
  </td>
  <td>
  <p><span>0.85</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">水平精度</span></p>
  </td>
 </tr><tr><td>
  <p><span>MSL </span><span style="font-family:'宋体';">幅度</span></p>
  </td>
  <td>
  <p><span>18.1</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">米</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">单位</span></p>
  </td>
  <td>
  <p><span>M</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">米</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">大地</span></p>
  </td>
  <td>
  <p><span>-2.2</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">米</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">单位</span></p>
  </td>
  <td>
  <p><span>M</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>-</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">差分时间</span></p>
  </td>
  <td>
  <p><span>8.0</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">秒</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">当没有</span><span> DGPS </span><span style="font-family:'宋体';">时，无效</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">差分</span><span> ID</span></p>
  </td>
  <td>
  <p><span>0000</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">校验和</span></p>
  </td>
  <td>
  <p><span>*5E</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>&lt;CR&gt;&lt;LF&gt;</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">消息结束</span></p>
  </td>
 </tr></table>

<p><span style="font-family:'宋体';"> </span></p>

<p><span style="font-family:'宋体';">当然，解析</span><span>RMC</span><span style="font-family:'宋体';">亦可哦：</span></p>

<p><span style="font-family:'宋体';">格式：</span><span>$--RMC,hhmmss.ss,A,llll.ll,a,yyyyy.yy,a,x.x,x.x,xxxx,x.x,a*hh</span></p>

<p><span style="font-family:'宋体';">例句：</span><span>$GPRMC,100646.000,A,3109.9704,N,12123.4219,E,0.257,335.62,291216,,,A*59</span></p>

<p><span> </span></p>

<table class="MsoTableGrid" width="568"><tr><td>
  <p><span style="font-family:'宋体';">名称</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">样例</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">单位</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">描述</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">消息</span><span>ID</span></p>
  </td>
  <td>
  <p><span>$GPRMC</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>RMC </span><span style="font-family:'宋体';">协议头</span></p>
  </td>
 </tr><tr><td>
  <p><span>UTC </span><span style="font-family:'宋体';">时间</span></p>
  </td>
  <td>
  <p><span>100646.000</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>hhmmss.sss</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">状态</span></p>
  </td>
  <td>
  <p><span>A</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>A=</span><span style="font-family:'宋体';">数据有效；</span><span>V=</span><span style="font-family:'宋体';">数据无效</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">纬度</span></p>
  </td>
  <td>
  <p><span>2109.9704</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>ddmm.mmmm</span></p>
  </td>
 </tr><tr><td>
  <p><span>N/S</span></p>
  </td>
  <td>
  <p><span>N</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>N=</span><span style="font-family:'宋体';">北，</span><span>S=</span><span style="font-family:'宋体';">南</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">经度</span></p>
  </td>
  <td>
  <p><span>11123.4219</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>dddmm.mmmm</span></p>
  </td>
 </tr><tr><td>
  <p><span>E/W</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>W=</span><span style="font-family:'宋体';">西，</span><span>E=</span><span style="font-family:'宋体';">东</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">地面速度</span></p>
  </td>
  <td>
  <p><span>0.257</span></p>
  </td>
  <td>
  <p><span>Knot</span><span style="font-family:'宋体';">（节）</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">方位</span></p>
  </td>
  <td>
  <p><span>335.62</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">度</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">日期</span></p>
  </td>
  <td>
  <p><span>291216</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>ddmmyy</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">磁变量</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span>-</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">校验和</span></p>
  </td>
  <td>
  <p><span>*59</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>&lt;CR&gt;&lt;LF&gt;</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">消息结束</span></p>
  </td>
 </tr></table>

<p><span> </span></p>

<p><span style="font-family:'宋体';">我司的</span><span>lua</span><span style="font-family:'宋体';">代码也提供了相应的基础库，开发者只需要简单的调用相应的函数，即可实现同步时钟：</span></p>

<p><span>luaScript:</span></p>

<p><span>require"gps"</span></p>

<p><span>gps.init()<span>                                                                             </span>--</span><span style="font-family:'宋体';">初始化</span></p>

<p><span>gps.setfixmode(0)<span>                                                            </span>--GPS+BD</span><span style="font-family:'宋体';">定位</span></p>

<p><span>gps.settimezone(gps.GPS_BEIJING_TIME)<span>                </span>--</span><span style="font-family:'宋体';">设置时区为北京</span></p>

<p><span>gps.open(gps.DEFAULT,{cause="time_sync"})<span>          </span>--</span><span style="font-family:'宋体';">打开</span><span>gps</span></p>

<p><span>--</span><span style="font-family:'宋体';">剩下的</span><span>gps.lua</span><span style="font-family:'宋体';">都会自动处理好了</span></p>

<p></p>

<p><img style="width:485.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-9dN9W6V25b854359764d4.png" class="img-responsive" alt="attachments-2018-08-9dN9W6V25b854359764d4.png" /></p>

<p></p>

<p><br /></p>

<p><span>luaTask:</span></p>

<p><span>require"gps"</span></p>

<p><span>require”sys”</span></p>

<p><span>require”misc”</span></p>

<p><span>gps.open(gps.DEFAULT,{tag="time_sync"})</span></p>

<p><span>sys.timeLoopStart(<span>   </span>function()</span></p>

<p><span>If gps.isFix then</span></p>

<p><span>misc.setClock(gps.getUtcTime())</span></p>

<p><span>end</span></p>

<p><span>end, 60000)</span></p>

<p></p>

<p><br /></p>

<p><span style="font-family:'宋体';">相对于使用</span><span>NTP</span><span style="font-family:'宋体';">等方式，此方法不受蜂窝网络限制，即使无卡或者卡欠费，也可以准确校时。但是需要注意的是，此种方法略有局限性：</span></p>

<ol><li><span style="font-family:'宋体';">必须使用有</span><span>GPS</span><span style="font-family:'宋体';">芯片的模块，或者挂在</span><span>GPS</span><span style="font-family:'宋体';">模块，且必须可以搜到</span><span>1</span><span style="font-family:'宋体';">颗以上卫星才能获取时间；</span></li><li><span style="font-family:'宋体';">卫星播发的时间是</span><span>UTC</span><span style="font-family:'宋体';">，所以开发者还需要根据经度判断时区做对应的加减才可以；</span><span><br /></span></li><li><span style="font-family:'宋体';">要注意定位数据的有效性。</span></li></ol>

<h3><span style="font-family:'宋体';">三、薅基站羊毛的</span><span>AT+CLTS</span></h3>

<p><span style="font-family:'宋体';">如果我告诉你，基站也有授时服务哦，惊不惊喜，意不意外？</span></p>

<p><span style="font-family:'宋体';">模块首次搜到基站的时候，即可获得基站下发的时间信息。发</span><span>AT+CLTS</span><span style="font-family:'宋体';">即可。</span></p>

<p><span style="font-family:'宋体';">由于此方法通用性并不是非常强，所以仅贴出</span><span>AT</span><span style="font-family:'宋体';">交互流程，有能力的开发者请自行改写</span><span>lua</span><span style="font-family:'宋体';">代码吧：</span></p>

<p></p>

<p><img style="width:266.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-UVPu8pBv5b85439ad292a.png" class="img-responsive" alt="attachments-2018-08-UVPu8pBv5b85439ad292a.png" /></p>

<p></p>

<p><br /></p>

<p><span style="font-family:'宋体';">需要注意的是，此方法存在一定局限性：</span><span>1</span><span style="font-family:'宋体';">、不是所有的基站都会下发，存在返回是</span><span>nil</span><span style="font-family:'宋体';">的情况（具体要看基站的配置）；</span><span>2</span><span style="font-family:'宋体';">、只有附着的那一刻是准确的，随后再发</span><span>AT+CLTS</span><span style="font-family:'宋体';">都是恒定值（即附着时），除非进入飞行模式后再离开飞行模式，重新获取一次；</span><span>3</span><span style="font-family:'宋体';">、需要有卡才能使用。</span></p>

<h3><span style="font-family:'宋体';">四、让运营商来给你打工的</span><span>SMS</span></h3>

<p><span style="font-family:'宋体';">有什么办法让运营商来给你打工吗？当然啦，今天就让运营商来出一次血——利用运营商下行短信的时间同步模块时钟。</span></p>

<p><span>luaScript &amp; luaTask:</span></p>

<p><span>require”sms”</span></p>

<p><span>local function
procnewsms(num, data, datetime)</span></p>

<p><span><span>         </span>print("procnewsms", num, data,
datetime)</span></p>

<p><span>end</span></p>

<p><span>sms.regnewsmscb(procnewsms)</span></p>

<p><span>sms.send("10086",
"hi, china mobile")</span></p>

<p><span>--</span><span style="font-family:'宋体';">给</span><span>10068</span><span style="font-family:'宋体';">发一条内容为“</span><span>hi, china mobile</span><span style="font-family:'宋体';">”的短信，等他返回短信的时候，就自带</span><span>datetime</span><span style="font-family:'宋体';">啦，开发者可以根据</span><span>datetime</span><span style="font-family:'宋体';">同步时系统时钟。</span></p>

<p><span style="font-family:'宋体';">此种方法基本上百试百灵，而且给运营商发短信时双向免费的哦；不过一定要注意使用的</span><span>SIM</span><span style="font-family:'宋体';">卡是否又短信功能。如果没有，是无法使用这个方法同步时钟的。</span></p>

<h2><span style="font-family:'宋体';">结束语</span></h2>

<p><span style="font-family:'宋体';">不论是直接去访问</span><span>time.123cha.com</span><span style="font-family:'宋体';">这种提时钟的网页，抓取关键数据；还是通过</span><span>mqtt</span><span style="font-family:'宋体';">传输时间字符串；哪怕打电话给模块，通过</span><span>DTMF</span><span style="font-family:'宋体';">设置时间，都是完全没问题的。</span><span><br /></span></p>

<p><span><br /></span><span style="font-family:'宋体';">正如“定义”所言，只要能产生数据交互，一切就皆有可能。</span></p>

<p></p>

<p><br /></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/28/412/" data-id="ckkfmdged00ctvkcg4b4l12v0" data-title="同步时模块时钟的N种方法" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-411" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/28/411/" class="article-date">
  <time class="dt-published" datetime="2018-08-28T12:39:12.000Z" itemprop="datePublished">2018-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/28/411/">Air系列模块重启原因分析及应对策略（三）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p></p>

<p><span style="font-family:'宋体';">前两篇文章我们分别从软件、硬件角度讲述了模块重启的原因和解决方法。本文作为该系列的终篇，将详细说一下如何应对，让重启损失减到最低。</span></p>

<h2><span style="font-family:'黑体';">鲁棒性</span></h2>

<p></p>

<p><br /></p>

<p><b><span style="font-family:'宋体';">提高鲁棒性</span></b><span style="font-family:'宋体';">才是最根本目标。为了达到这一点，应对代码进行反复测试，才能把大多数隐患解决掉（某哲人说过，当你发现一个</span><span>bug</span><span style="font-family:'宋体';">，那么还有</span><span>10</span><span style="font-family:'宋体';">个隐含</span><span>bug</span><span style="font-family:'宋体';">未被发现）。只有通过各种极端环境下的测试，才能确保上线无忧。</span></p>

<p><span style="font-family:'宋体';">发个</span><span>GPRS DTU</span><span style="font-family:'宋体';">的测试表，大家体会一下：</span></p>

<table class="MsoTableGrid" width="568"><tr><td>
  <p><span style="font-family:'宋体';">项目</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">测试目的</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">测试方法</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">评测标准</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">结果判断标准</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">在线空闲测试</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">测试</span><span>GPRS DTU</span><span style="font-family:'宋体';">维持已建链路的能力。</span><span>GPRS DTU</span><span style="font-family:'宋体';">通过心跳保持连接</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">连上数据中心后不发任何数据，观察它能维持链路多久</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">应至少能维持平均</span><span>1</span><span style="font-family:'宋体';">小时以上的链路持续时间，不发生断线重连</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">如果</span><span>DTU</span><span style="font-family:'宋体';">或数据中心任何一方无法收到对方的数据包，则为不合格</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">数据中心关闭后恢复测试</span>
  </p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">测试</span><span>GPRS DTU</span><span style="font-family:'宋体';">在数据中心中断服务并恢复后的快速响应、恢复能力</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">数据中心短时间关闭（如</span><span>1</span><span style="font-family:'宋体';">分钟）；数据中心长短时间关闭（如</span><span>1</span><span style="font-family:'宋体';">小时）；</span></p>
  </td>
  <td>
  <p><span>DTU</span><span style="font-family:'宋体';">是否能快速连接上来，恢复时间应该在</span><span>5</span><span style="font-family:'宋体';">分钟内，越快越好，（重复多次该项测试）</span></p>
  </td>
  <td>
  <p><span>DTU</span><span style="font-family:'宋体';">必须能</span><span>100%</span><span style="font-family:'宋体';">恢复连接，否则为不合格</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">频繁双向小数据量测试</span>
  </p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">测试</span><span>GPRS DTU</span><span style="font-family:'宋体';">频繁收发小数据包的能力</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">在数据中心和</span><span>DTU</span><span style="font-family:'宋体';">端，每</span><span>10</span><span style="font-family:'宋体';">秒向对方发送一个</span><span>100</span><span style="font-family:'宋体';">字节左右的数据包，持续</span><span>10</span><span style="font-family:'宋体';">分钟</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">没有发生断线重连，也没有丢失任何数据包</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">如果出现</span><span>DTU</span><span style="font-family:'宋体';">断线后再也不上线，或上线后无法继续双向收发数据，出现丢包，内容错误，即为不合格；</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">双向大数据压力测试</span>
  </p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">测试</span><span>GPRS DTU</span><span style="font-family:'宋体';">频繁收发大数据包的能力</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">在数据中心和</span><span>DTU</span><span style="font-family:'宋体';">端，每</span><span>2</span><span style="font-family:'宋体';">秒都向对方发送一个</span><span>1000</span><span style="font-family:'宋体';">字节左右的数据包，持续</span><span>30</span><span style="font-family:'宋体';">分钟</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">没有发生断线重连，也没有丢失任何数据包</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">如果出现</span><span>DTU</span><span style="font-family:'宋体';">断线后再也不上线，或上线后无法继续双向收发数据，出现丢包，内容错误，传输过慢，即为不合格；</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">重复上电测试</span>
  </p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">某些时候，现场会出现临时断电然后恢复的情况，</span><span>GPRS DTU</span><span style="font-family:'宋体';">应能保证可靠的登录数据中心</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">上电，然后等待</span><span>GPRS DTU</span><span style="font-family:'宋体';">连接上数据中心，每次</span><span>DTU</span><span style="font-family:'宋体';">都能在</span><span>2</span><span style="font-family:'宋体';">分钟内登录到数据中心</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">重复进行</span><span>20</span><span style="font-family:'宋体';">次测试</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">一旦发现有一次</span><span>DTU</span><span style="font-family:'宋体';">始终无法连接到数据中心，则为不合格</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">拨号及短信干扰测试</span></p>
  </td>
  <td>
  <p><span>DTU</span><span style="font-family:'宋体';">登录或在线运行过程中，可能会收到一些不明短信或电话呼叫</span><span>, GPRS DTU</span><span style="font-family:'宋体';">应能保证这些情况不影响其正常工作</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">将</span><span>DTU</span><span style="font-family:'宋体';">上电，然后等待</span><span>10</span><span style="font-family:'宋体';">秒左右，开始向</span><span>DTU</span><span style="font-family:'宋体';">发送</span><span>2</span><span style="font-family:'宋体';">条短信，以及</span><span>2</span><span style="font-family:'宋体';">次呼叫，</span></p>
  </td>
  <td>
  <p><span>DTU</span><span style="font-family:'宋体';">应能正确的连接上数据中心，重复进行</span><span>20</span><span style="font-family:'宋体';">次测试</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">一旦发现有一次</span><span>DTU</span><span style="font-family:'宋体';">始终无法连接到数据中心，则为不合格</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">看门狗测试</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">有良好看门狗机制的产品，在</span><span>DTU</span><span style="font-family:'宋体';">死机时，能使其</span><span>CPU</span><span style="font-family:'宋体';">复位</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">瞬间短路几个管脚，让其程序跑飞，或者</span><span>RAM</span><span style="font-family:'宋体';">数据错乱，使看门狗介入工作，复位</span><span>CPU</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">重复多次测试该项，</span><span>DTU</span><span style="font-family:'宋体';">必须能</span><span>100%</span><span style="font-family:'宋体';">复位</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">如果不能复位则不合格</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">去卡测试</span></p>
  </td>
  <td>
  <p><span>SIM</span><span style="font-family:'宋体';">卡短时接触不良，</span><span>GPRS DTU</span><span style="font-family:'宋体';">应能自动恢复</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">在</span><span>GPRS DTU</span><span style="font-family:'宋体';">连接数据中心时，短时、长时取卡，然后再插卡，看</span><span>GPRS DTU</span><span style="font-family:'宋体';">是否会掉线及正常收发数据</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">应可连接到数据中心，正常收发数据</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">如果不能连接到数据中心，或者收发数据，则不合格</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">电源波动测试</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">可能出现较大范围的电源波动，</span><span>GPRS DTU</span><span style="font-family:'宋体';">应能适应这种电源波动</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">模拟允许值范围内的电压波动，和低压情况</span></p>
  </td>
  <td>
  <p><span>GPRS DTU</span><span style="font-family:'宋体';">是否会出现再也无法连接数据中心的情况</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">如果不能连接到数据中心，或者收发数据，则不合格</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">欠费测试</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">常年运行过程中，很可能会出现因</span><span>SIM</span><span style="font-family:'宋体';">卡欠费，导致无法使用</span><span>GPRS</span><span style="font-family:'宋体';">业务，在进行充值后，</span><span>GPRS DTU</span><span style="font-family:'宋体';">应自动恢复与中心的连接</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">找一张欠费的</span><span>SIM</span><span style="font-family:'宋体';">卡插入</span><span>GPRS DTU</span><span style="font-family:'宋体';">，等待</span><span>10</span><span style="font-family:'宋体';">分钟，给</span><span>SIM</span><span style="font-family:'宋体';">卡充值，看</span><span>DTU</span><span style="font-family:'宋体';">是否能自动连接到数据中心</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">如果</span><span>DTU</span><span style="font-family:'宋体';">始终无法自行连接数据中心，并且必须要人工复位一次才能恢复连接到数据中心，则视为不合格</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">域名解析测试</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">由于域名解析服务存在临时失效的情况，因此在使用域名解析时，需要加测这个项目</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">域名失效模拟，恢复域名的指向，然后观察</span><span>DTU</span><span style="font-family:'宋体';">是否能自动连接到数据中心</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">恢复时间越短越好</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">如果</span><span>DTU</span><span style="font-family:'宋体';">始终无法自动连接数据中心，则为不合格</span></p>
  </td>
 </tr><tr><td>
  <p><span style="font-family:'宋体';">去天线测试</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">常年运行过程中，很可能会因信号问题（基站或天线）导致无法使用</span><span>GPRS</span><span style="font-family:'宋体';">业务，在信号恢复后，</span><span>GPRS DTU</span><span style="font-family:'宋体';">应自动恢复与中心的连接</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">去掉天线，模拟信号丢失情况。等待</span><span>10</span><span style="font-family:'宋体';">分钟，重新插入天线，看</span><span>DTU</span><span style="font-family:'宋体';">是否能自动连接到数据中心</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">如果</span><span>DTU</span><span style="font-family:'宋体';">始终无法自行连接数据中心，并且必须要人工复位一次才能恢复连接到数据中心，则视为不合格</span></p>
  </td>
 </tr></table>

<p><span style="font-family:'宋体';">一个</span><span> GPRS DTU </span><span style="font-family:'宋体';">的测试尚且如此，更复杂的项目，需要测试的内容也更多。只有通过了测试，代码稳定运行不出错，才能顺利上线。</span></p>

<p><span style="font-family:'宋体';">关于这方面呢，开发者可以阅读一下《</span><span>Unix</span><span style="font-family:'宋体';">编程艺术》、《人月神话》、《黑客与画家》、《程序员修炼之道》、《软件随想录》等书籍。</span></p>

<h2><span>LED</span></h2>

<p><span style="font-family:'宋体';">毕竟，有些时候的测试环境还是偏于理想化，而实际场景千差万别。会有很多意想不到的</span><span>bug</span><span style="font-family:'宋体';">出现，而现场往往是没有调试的机会，甚至只能“<b>盲·</b></span><b><span>Debug</span></b><span style="font-family:'宋体';">”，这种情况下怎么办呢？</span></p>

<p><span style="font-family:'宋体';">开发者可以在写代码时，定制</span><span>LED</span><span style="font-family:'宋体';">闪烁规则，使用</span><span>GPIO</span><span style="font-family:'宋体';">控制</span><span>LED</span><span style="font-family:'宋体';">闪烁。如此一来即便是完全不懂的人，通过观察</span><span>LED</span><span style="font-family:'宋体';">情况，查表也能知晓当前设备的状态了。譬如：</span></p>

<p><span style="font-family:'宋体';">绿灯频闪——未附着；</span></p>

<p><span style="font-family:'宋体';">绿灯慢闪——正在附着；</span></p>

<p><span style="font-family:'宋体';">绿灯爆闪——系统错误；</span></p>

<p><span style="font-family:'宋体';">绿灯常亮——附着成功，可以正常通信；</span></p>

<p><span style="font-family:'宋体';">绿灯熄灭——无卡；</span></p>

<p><span style="font-family:'宋体';">绿灯呼吸——正在通信；</span></p>

<p><span> </span></p>

<p><span style="font-family:'宋体';">实际上，通过控制电压域，甚至还可以实现不同亮度。</span></p>

<p><span style="font-family:'宋体';">根据</span><span>LED</span><span style="font-family:'宋体';">闪烁情况和现场实际环境，开发者大致可以锁定问题所在，后续使用</span><span>OTA</span><span style="font-family:'宋体';">升级修复</span><span>bug</span><span style="font-family:'宋体';">。</span></p>

<p><span> </span></p>

<h2><span style="font-family:'黑体';">不得不重启</span></h2>

<p><span style="font-family:'宋体';">某些极为特殊的情况下，模块“不得不重启”（比如人工断电），那么如何记录运行状态，并保证启动继续运行，就成了研究的重点。</span></p>

<p><span style="font-family:'宋体';">如果有电池，切换到电池供电的情况下，立即上报工作状态到云端。等待再次开机后，从云端获取工作状态并继续。如果没有电池，那么定期保存工作状态到配置文件似乎成了唯一的选项（请参考</span><span>nvm demo</span><span style="font-family:'宋体';">）。</span></p>

<p><span style="font-family:'宋体';">工作时，定时保存工作状态到模块内（</span><span>10w</span><span style="font-family:'宋体';">次擦写</span><span>+</span><span style="font-family:'宋体';">均衡磨损技术，不需要担心寿命问题），意外掉电时，至多损失某定时保存前的数据；模块上电开机后，首先读取配置文件，恢复工作状态，不会影响模块继续运行。</span></p>

<p><span style="font-family:'宋体';">不过这里还有几个坑：</span></p>

<p><span>1</span><span style="font-family:'宋体';">、读写中，意外掉电导致的文件损坏；</span></p>

<p><span>2</span><span style="font-family:'宋体';">、计时器的时间戳变动；</span></p>

<p><span>3</span><span style="font-family:'宋体';">、待处理的数据。</span></p>

<p><span style="font-family:'宋体';">关于“坑</span><span>1</span><span style="font-family:'宋体';">”，</span><span>nvm.lua </span><span style="font-family:'宋体';">已经最大限度规避了。大致思路如下：</span></p>

<p><b><span style="font-family:'宋体';">更新参数时：</span></b></p>

<p><span>1.</span><span style="font-family:'宋体';">新建一个</span><span>param.temp</span><span style="font-family:'宋体';">的文件，将</span><span>nvm_para.lua</span><span style="font-family:'宋体';">的文件内容与更新的内容合并好，写入</span><span>param.temp</span></p>

<p><span>2.</span><span style="font-family:'宋体';">删除</span><span>nvm_para.lua</span></p>

<p><span>3.</span><span style="font-family:'宋体';">将</span><span>param.temp</span><span style="font-family:'宋体';">更名为</span><span>nvm_para.lua</span></p>

<p><b><span style="font-family:'宋体';">开机时的处理：</span></b></p>

<p><span>1.</span><span style="font-family:'宋体';">如果</span><span>nvm_para.lua</span><span style="font-family:'宋体';">存在，而</span><span>param.temp</span><span style="font-family:'宋体';">不存在，不用做特殊处理；</span></p>

<p><span>2.</span><span style="font-family:'宋体';">如果</span><span>nvm_para.lua</span><span style="font-family:'宋体';">存在，而</span><span>param.temp</span><span style="font-family:'宋体';">也存在，删除</span><span>param.temp</span><span style="font-family:'宋体';">；</span></p>

<p><span>3.</span><span style="font-family:'宋体';">如果</span><span>nvm_para.lua</span><span style="font-family:'宋体';">不存在，</span> <span style="font-family:'宋体';">而</span><span>param.temp</span><span style="font-family:'宋体';">存在，将</span><span>param.temp</span><span style="font-family:'宋体';">更名为</span><span>nvm_para.lua</span><span style="font-family:'宋体';">；</span></p>

<p><span>4.</span><span style="font-family:'宋体';">如果两者都不存在，恢复默认值；</span></p>

<p><span style="font-family:'宋体';">感兴趣的童鞋可以去阅读</span><span>nvm.lua</span><span style="font-family:'宋体';">的代码。</span></p>

<p><span style="font-family:'宋体';">关于“坑</span><span>2</span><span style="font-family:'宋体';">”，此计时器是指“基于时间戳的延迟</span><span>N</span><span style="font-family:'宋体';">秒开启关闭某业务”。必须由配置文件的</span><span>3</span><span style="font-family:'宋体';">个参数进行控制，即开始时间、持续时间、关闭时间、当前状态。其中，“持续时间”和“关闭时间”是互斥的。</span></p>

<p><span style="font-family:'宋体';">例如，我要设置一个当前立即开始，延迟</span><span>5</span><span style="font-family:'宋体';">分钟关闭</span><span>gpio0</span><span style="font-family:'宋体';">输出的计时器，那么这四个变量应如下设定：</span></p>

<p><span style="font-family:'宋体';">当前时间</span><span> = ???<span>                                            </span>--</span><span style="font-family:'宋体';">当前模块时间戳，应定期更新</span></p>

<p><span style="font-family:'宋体';">开始时间</span><span> = os.time()<span>                                  </span>--</span><span style="font-family:'宋体';">根据当前时间戳设定数值</span></p>

<p><span style="font-family:'宋体';">持续时间</span><span> = os.time() + 300<span>                      </span>--</span><span style="font-family:'宋体';">当前时间戳</span><span> + </span><span style="font-family:'宋体';">持续时间，设定数值</span></p>

<p><span style="font-family:'宋体';">关闭时间</span><span> = 0<span>                                                </span>--</span><span style="font-family:'宋体';">因“持续时间”已设定，所以“关闭时间”置</span><span>0</span></p>

<p><span style="font-family:'宋体';">当前状态</span><span> = True<span>                                          </span>--</span><span style="font-family:'宋体';">当前的状态，开启</span><span>/</span><span style="font-family:'宋体';">关闭</span></p>

<p><span style="font-family:'宋体';">随后代码轮询是否到达“持续时间”的设定值。如果到达，则执行对应操作（如果设定“关闭时间”，则“持续时间”应为</span><span>0</span><span style="font-family:'宋体';">）。</span></p>

<p><span style="font-family:'宋体';">一切看似很美好，但是问题来了：一旦意外重启，模块的</span><span>os.time()</span><span style="font-family:'宋体';">返回值必然出错，那么如何处理？答案并不复杂：上电开机后先根据“当前状态”参数去执行对应操作，打开</span><span>gpio</span><span style="font-family:'宋体';">输出；然后重新设定</span><span>:</span></p>

<p><span style="font-family:'宋体';">当前时间</span><span> = ???<span>                                            </span>--</span><span style="font-family:'宋体';">当前模块时间戳，应定期更新</span></p>

<p><span style="font-family:'宋体';">开始时间</span><span> = os.time()<span>                                  </span>--</span><span style="font-family:'宋体';">根据当前时间戳设定数值</span></p>

<p><span style="font-family:'宋体';">持续时间</span><span> = os.time() + </span><span style="font-family:'宋体';">“持续时间”</span><span>-</span><span style="font-family:'宋体';">“当前时间”</span></p>

<p><span><span>                            </span>--</span><span style="font-family:'宋体';">重新设定持续时间</span></p>

<p><span style="font-family:'宋体';">关闭时间</span><span> = 0<span>                                                </span>--</span><span style="font-family:'宋体';">因“持续时间”已设定，所以“关闭时间”置</span><span>0</span></p>

<p><span style="font-family:'宋体';">当前状态</span><span> = True<span>                                          </span>--</span><span style="font-family:'宋体';">当前的状态，开启</span><span>/</span><span style="font-family:'宋体';">关闭</span><span><br /></span></p>

<p><span><br /></span><span style="font-family:'宋体';">随后代码轮询是否到达“持续时间”的设定值即可。当然，更稳妥的方式是把计时交给服务端，完全受控即可避免计时出错的尴尬。</span></p>

<p><span style="font-family:'宋体';">关于“坑</span><span>3</span><span style="font-family:'宋体';">”，就是未发出的数据（</span><span>uart</span><span style="font-family:'宋体';">、</span><span>socket</span><span style="font-family:'宋体';">、</span><span>mqtt</span><span style="font-family:'宋体';">等），如果是非重要数据，丢就丢了吧……如果是比较重要的数据，同样可以使用</span><span>nvm</span><span style="font-family:'宋体';">保存，上电后读取并继续处理。</span></p>

<p><span style="font-family:'宋体';">最后，送给大家一个法宝，放在代码里，保证无</span><span>bug</span><span style="font-family:'宋体';">哦：</span></p>

<p><img style="width:247px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-kQXPkFaG5b854242690f9.png" class="img-responsive" alt="attachments-2018-08-kQXPkFaG5b854242690f9.png" /></p>

<p><span style="font-family:'宋体';"><br /></span></p>

<p><span style="font-family:'宋体';">神马？你看到的是乱码？好吧，bug太多，佛祖已瘫……<br /></span></p>

<p><span>--[[<span>               </span>_ooOoo_ </span></p>

<p><span><span>                  </span>o8888888o </span></p>

<p><span><span>                  </span>88" . "88 </span></p>

<p><span><span>                  </span>(| -_- |) </span></p>

<p><span><span>                  </span>O\<span>  </span>=<span>  </span>/O </span></p>

<p><span><span>               </span>____/`---'\____ </span></p>

<p><span><span>            
</span>.'<span>  </span>\\|<span>     </span>|//<span> 
</span>`. </span></p>

<p><span><span>           
</span>/<span>  </span>\\|||<span>  </span>:<span> 
</span>|||//<span>  </span>\ </span></p>

<p><span><span>          
</span>/<span>  </span>_||||| -:- |||||-<span>  </span>\ </span></p>

<p><span><span>          
</span>|<span>   </span>| \\\<span>  </span>-<span>  </span>///
|<span>   </span>| </span></p>

<p><span><span>          
</span>| \_|<span>  </span>''\---/''<span>  </span>|<span>   </span>| </span></p>

<p><span><span>          
</span>\<span>  </span>.-\__<span>  </span>`-`<span> 
</span>___/-. / </span></p>

<p><span><span>        
</span>___`. .'<span>  </span>/--.--\<span>  </span>`. . __ </span></p>

<p><span><span>     
</span>."" '&lt;<span> 
</span>`.___\_&lt;|&gt;_/___.'<span> 
</span>&gt;'"". </span></p>

<p><span><span>    
</span>| | :<span>  </span>`- \`.;`\ _ /`;.`/ - ` : |
| </span></p>

<p><span><span>    
</span>\<span>  </span>\ `-.<span>   </span>\_ __\ /__ _/<span>   </span>.-` /<span> 
</span>/ </span></p>

<p><span>======`-.____`-.___\_____/___.-`____.-'======
</span></p>

<p><span><span>                   </span>`=---=' </span></p>

<p><span>^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span></p>

<p><span><span>        
</span></span><span style="font-family:'宋体';">佛祖保佑</span><span><span>       </span></span><span style="font-family:'宋体';">永无</span><span>BUG<span>                                     </span>]]</span></p>

<p><span> </span></p>

<p></p>

<p><br /></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/28/411/" data-id="ckkfmdged00csvkcg0m1z1dmy" data-title="Air系列模块重启原因分析及应对策略（三）" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-410" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/28/410/" class="article-date">
  <time class="dt-published" datetime="2018-08-28T06:02:34.000Z" itemprop="datePublished">2018-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/28/410/">Air系列模块重启原因分析及应对策略（二）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p></p>

<p><span style="font-family:'宋体';">书接上文，本文说一下“<b>闻</b>”字诀。首先让我们回顾一下</span><span>poweron reason</span><span style="font-family:'宋体';">表：</span></p>

<table class="MsoTableGrid" width="568"><tr><td>
  <p><span>POWERON </span><span style="font-family:'宋体';">事件</span></p>
  </td>
  <td>
  <p><span>POWERON </span><span style="font-family:'宋体';">代码</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">解释</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_KEY</span></p>
  </td>
  <td>
  <p><span>0</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">按键开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_CHARGER</span></p>
  </td>
  <td>
  <p><span>1</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">充电开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_ALARM</span></p>
  </td>
  <td>
  <p><span>2</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">闹钟开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_RESTART</span></p>
  </td>
  <td>
  <p><span>3</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">软件重启开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_EXCEPTION</span></p>
  </td>
  <td>
  <p><span>6</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">异常开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_HOST</span></p>
  </td>
  <td>
  <p><span>7</span></p>
  </td>
  <td>
  <p><span>HOST</span><span style="font-family:'宋体';">工具控制重启开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_WATCHDOG</span></p>
  </td>
  <td>
  <p><span>8</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">其他原因</span></p>
  </td>
 </tr></table>

<p><span> </span></p>

<p><span style="font-family:'宋体';">如果说“<b>望</b>”字诀关注的是</span><span>poweron reason 0</span><span style="font-family:'宋体';">，那么“闻”字诀需要重点关注的是</span><span>poweron reason 3</span><span style="font-family:'宋体';">、</span><span>6</span><span style="font-family:'宋体';">、</span><span>8</span><span style="font-family:'宋体';">：</span></p>

<p><span style="font-family:'宋体';">当</span><span>poweron reason</span><span style="font-family:'宋体';">为</span><span>3</span><span style="font-family:'宋体';">时，通常有两种情况：代码主动执行</span><span>rtos.restart()</span><span style="font-family:'宋体';">或者</span><span>sys.restart()</span><span style="font-family:'宋体';">实现软重启；代码运行出错（语法错误，内存不足、</span><span>AT</span><span style="font-family:'宋体';">执行超时等多种可能性），底层自动重启；</span></p>

<p><span style="font-family:'宋体';">当</span><span>poweron reason</span><span style="font-family:'宋体';">为</span><span>6</span><span style="font-family:'宋体';">时，只有这一种情况：底层出错，请上报</span><span>bug</span><span style="font-family:'宋体';">；</span></p>

<p><span style="font-family:'宋体';">当</span><span>poweron reason</span><span style="font-family:'宋体';">为</span><span>8</span><span style="font-family:'宋体';">时，通常是这种情况：</span><span>Lua</span><span style="font-family:'宋体';">代码跑飞，底层亦无响应时，由外部看门狗芯片重启模块。</span></p>

<p><span style="font-family:'宋体';">小提示：</span></p>

<p><span style="font-family:'宋体';">为了调试方便，建议开发者首先在任意</span><span>lua</span><span style="font-family:'宋体';">文件中加入如下代码：</span></p>

<p><span>For luaTask:</span></p>

<p><span>require”sys”</span></p>

<p><span>require”log”</span></p>

<p><span>sys.timerLoopStart(function()<span>  </span>log.info("RAM free size:", 1024 -
collectgarbage("count"), "KB")</span></p>

<p><span><span>                                                                           </span>log.info("ROM
free size:", rtos.get_fs_free_size(), "KB") </span><span>end, 5000)</span></p>

<p><span> </span></p>

<p><span>For luaScript:</span></p>

<p><span>require”sys”</span></p>

<p><span>sys.timer_loop_start(function()<span>        </span>print("RAM free size:", 1024 -
collectgarbage("count"), "KB")</span></p>

<p><span><span>                                                                           </span>print("ROM
free size:", rtos.get_fs_free_size(), "KB") end, 5000)</span></p>

<p><span> </span></p>

<p><span style="font-family:'宋体';">加入如上代码后，模块在运行时，即可间隔</span><span>5</span><span style="font-family:'宋体';">秒打印一次</span><span>RAM</span><span style="font-family:'宋体';">、</span><span>ROM</span><span style="font-family:'宋体';">使用情况。</span></p>

<p><span style="font-size:10.5pt;font-family:'宋体';">通常情况下，如果</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">Lua</span><span style="font-size:10.5pt;font-family:'宋体';">代码语法错误，或者出现其他问题，</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">Trace</span><span style="font-size:10.5pt;font-family:'宋体';">中会有如下提示：</span></p>

<p><img style="width:250px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-PQ4ymGXz5b84e39a35a59.png" class="img-responsive" alt="attachments-2018-08-PQ4ymGXz5b84e39a35a59.png" /><span style="font-size:10.5pt;font-family:'宋体';"><br /></span></p>

<p><span style="font-family:'宋体';">报错格式为：</span></p>

<p style="text-align:center;"><b><span style="font-family:'宋体';">路径</span><span>/</span></b><b><span style="font-family:'宋体';">源码文件名：出错行：调用的方法</span><span>/</span></b><b><span style="font-family:'宋体';">函数（出错的原因）</span></b></p>

<p style="text-align:center;"><b><span style="font-family:'宋体';">堆栈回溯</span></b></p>

<p><span style="font-family:'宋体';">如图所示，第一行内容提示开发者：</span><b><span>/lua/wblist.lua</span></b><b><span style="font-family:'宋体';">这个文件的</span><span>121</span></b><b><span style="font-family:'宋体';">行出错</span><span>:</span></b><b><span style="font-family:'宋体';">调用</span><span>fileSize</span></b><b><span style="font-family:'宋体';">失败（空值）</span></b><span style="font-family:'宋体';">；</span></p>

<p><span style="font-family:'宋体';">后边是堆栈回溯，告知开发者错误函数是如何被调用的。途径是</span><b><span>main.lua --&gt; sys.lua run() --&gt; sys.lua saferun() --&gt;
device.lua --&gt; wblist.lua writecard()</span></b></p>

<p><span style="font-family:'宋体';">如此一来，开发者就可以根据错误提示和堆栈回溯去追根溯源，查找代码错误。</span></p>

<p><span style="font-family:'宋体';">下表是一些常见的错误提示和解决方法：</span></p>

<table class="MsoTableGrid" width="568"><tr><td>
  <p><span style="font-family:'宋体';">序号</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">错误提示</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">错误原因</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">解决方法</span></p>
  </td>
 </tr><tr><td>
  <p><span>1</span></p>
  </td>
  <td>
  <p><span>attempt to index %s</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">变量</span><span>/</span><span style="font-family:'宋体';">函数</span> <span style="font-family:'宋体';">索引错误</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">修改代码</span></p>
  </td>
 </tr><tr><td>
  <p><span>2</span></p>
  </td>
  <td>
  <p><span>attempt to call %s</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">变量</span><span>/</span><span style="font-family:'宋体';">函数</span> <span style="font-family:'宋体';">引用错误</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">修改代码</span></p>
  </td>
 </tr><tr><td>
  <p><span>3</span></p>
  </td>
  <td>
  <p><span>disp.init: error param width(%d)
  height(%d)</span></p>
  </td>
  <td>
  <p><span>disp</span><span style="font-family:'宋体';">初始化时，设置了错误的宽、高</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">修改为正确数值</span></p>
  </td>
 </tr><tr><td>
  <p><span>4</span></p>
  </td>
  <td>
  <p><span>disp.init: pixel depth must be 16</span></p>
  </td>
  <td>
  <p><span>disp</span><span style="font-family:'宋体';">像素色深必须是</span><span>16</span><span style="font-family:'宋体';">位</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">修改代码</span></p>
  </td>
 </tr><tr><td>
  <p><span>6</span></p>
  </td>
  <td>
  <p><span>i2c.write: data must be
  number,string,table</span></p>
  </td>
  <td>
  <p><span>i2c</span><span style="font-family:'宋体';">数据必须是数值、字符串或</span><span>table</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">修改数据类型</span></p>
  </td>
 </tr><tr><td>
  <p><span>7</span></p>
  </td>
  <td>
  <p><span>i2c.read: size must &lt; %d</span></p>
  </td>
  <td>
  <p><span>i2c</span><span style="font-family:'宋体';">读取错误，数据长度超限</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>8</span></p>
  </td>
  <td>
  <p><span>bad argument #%d (%s)</span></p>
  </td>
  <td>
  <p><span>audio</span><span style="font-family:'宋体';">错误的参数</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">修改传入的参数</span></p>
  </td>
 </tr><tr><td>
  <p><span>9</span></p>
  </td>
  <td>
  <p><span>calling " LUA_QS " on bad self
  (%s)</span></p>
  </td>
  <td>
  <p><span>audio</span><span style="font-family:'宋体';">错误的调用</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>10</span></p>
  </td>
  <td>
  <p><span>name conflict for module " LUA_QS,
  libname</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">命名冲突</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">修改名称</span></p>
  </td>
 </tr><tr><td>
  <p><span>11</span></p>
  </td>
  <td>
  <p><span>too many results to unpack</span></p>
  </td>
  <td>
  <p><span>unpack</span><span style="font-family:'宋体';">方法传参错误</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>12</span></p>
  </td>
  <td>
  <p><span>attempt to use a closed file</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">文件已关闭，无法调用</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">打开文件</span></p>
  </td>
 </tr><tr><td>
  <p><span>13</span></p>
  </td>
  <td>
  <p><span>file is already closed</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">文件已关闭</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">打开文件</span></p>
  </td>
 </tr><tr><td>
  <p><span>14</span></p>
  </td>
  <td>
  <p><span>wrong number of arguments</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">传参</span> <span style="font-family:'宋体';">参数</span> <span style="font-family:'宋体';">个数错误</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">检查传参内容</span></p>
  </td>
 </tr><tr><td>
  <p><span>15</span></p>
  </td>
  <td>
  <p><span>string slice too long</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">字符串过长</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>16</span></p>
  </td>
  <td>
  <p><span>attempt to use an invalid<span>  </span>ICONV_TYPENAME</span></p>
  </td>
  <td>
  <p><span>Iconv</span><span style="font-family:'宋体';">不支持的类型</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>17</span></p>
  </td>
  <td>
  <p><span>BUG: Unable to fetch CJSON configuration</span></p>
  </td>
  <td>
  <p><span>cjson</span><span style="font-family:'宋体';">配置错误</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>18</span></p>
  </td>
  <td>
  <p><span>JSON parser does not support UTF-16 or
  UTF-32</span></p>
  </td>
  <td>
  <p><span>JSON</span><span style="font-family:'宋体';">不支持</span><span>utf-16</span><span style="font-family:'宋体';">或</span><span>utf-32</span><span style="font-family:'宋体';">字符编码</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>19</span></p>
  </td>
  <td>
  <p><span>Memory allocation error in CJSON
  protected call</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">无法为</span><span>CJSON</span><span style="font-family:'宋体';">分配内存</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>20</span></p>
  </td>
  <td>
  <p><span>invalid pin</span></p>
  </td>
  <td>
  <p><span>GPIO</span><span style="font-family:'宋体';">配置错误，不存在该</span><span>pin</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">检查代码和硬件设计手册</span></p>
  </td>
 </tr><tr><td>
  <p><span>21</span></p>
  </td>
  <td>
  <p><span>invalid PIO operation</span></p>
  </td>
  <td>
  <p><span>GPIO</span><span style="font-family:'宋体';">非法操作</span></p>
  </td>
  <td>
  <p><span> </span></p>
  </td>
 </tr><tr><td>
  <p><span>22</span></p>
  </td>
  <td>
  <p><span>uart.setup can't be called on virtual
  UARTs</span></p>
  </td>
  <td>
  <p><span>UART</span><span style="font-family:'宋体';">无法初始化</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">检查代码，</span><span>uart.setup</span><span style="font-family:'宋体';">相关配置</span></p>
  </td>
 </tr><tr><td>
  <p><span>23</span></p>
  </td>
  <td>
  <p><span>invalid number</span></p>
  </td>
  <td>
  <p><span>UART</span><span style="font-family:'宋体';">错误的端口号</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">检查代码，</span><span>uart.setup</span><span style="font-family:'宋体';">相关配置</span></p>
  </td>
 </tr><tr><td>
  <p><span>24</span></p>
  </td>
  <td>
  <p><span>invalid format</span></p>
  </td>
  <td>
  <p><span>Uart.setup</span><span style="font-family:'宋体';">错误的配置参数</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">检查代码，</span><span>uart.setup</span><span style="font-family:'宋体';">相关配置</span></p>
  </td>
 </tr></table>

<p><span> </span></p>

<p><span style="font-family:'宋体';">除了</span><span>poweron reason</span><span style="font-family:'宋体';">外，我们还可以检查重启后打印的上次重启原因，分析问题所在（</span><span>luaTask</span><span style="font-family:'宋体';">）：</span></p>

<p><img style="width:249px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-B1733YJo5b84e3bf35ba0.png" class="img-responsive" alt="attachments-2018-08-B1733YJo5b84e3bf35ba0.png" /><span style="font-size:10.5pt;font-family:'宋体';"><br /></span></p>

<p><span style="font-family:'宋体';"><br /></span></p>

<p><span style="font-family:'宋体';">通常情况下，如果重启后不存在记录文件，则提示</span><span>no open</span><span style="font-family:'宋体';">（意外掉电导致重启，代码未主动调用接口保存，都可能有这个提示）：</span></p>

<p></p>

<p><img style="width:316.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-1cpRZhQZ5b84e3d032664.png" class="img-responsive" alt="attachments-2018-08-1cpRZhQZ5b84e3d032664.png" /></p>

<p><span style="font-family:'宋体';"><br /></span></p>

<p><span style="font-family:'宋体';">如果存在错误文件，则打开该文件，显示内容后，删除该记录文件：</span></p>

<p></p>

<p><img style="width:401px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-d0XSg0Li5b84e3e6112b2.png" class="img-responsive" alt="attachments-2018-08-d0XSg0Li5b84e3e6112b2.png" /></p>

<p></p>

<p><br /></p>

<p><span style="font-family:'宋体';">如此一来，我们就能根据记录文件的内容分析啦（上图所示，即软狗引发的重启）。</span></p>

<p><span style="font-family:'宋体';">接下来，我们分析几个典型的具体案例，希望对开发者</span><span>Debug</span><span style="font-family:'宋体';">有所帮助。</span></p>

<h1>

<p>一、混用LIB</h1></p>
<p><img style="width:274.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-kk0GVWcU5b84e411e91cc.png" class="img-responsive" alt="attachments-2018-08-kk0GVWcU5b84e411e91cc.png" /><span style="font-size:10.5pt;font-family:Calibri, sans-serif;"><br /></span><img style="width:325.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-fyQFo5vk5b84e41c9f1ae.png" class="img-responsive" alt="attachments-2018-08-fyQFo5vk5b84e41c9f1ae.png" /></p>

<p><span style="font-family:'宋体';">众所周知，目前</span><span>Luat</span><span style="font-family:'宋体';">的</span><span>LIB</span><span style="font-family:'宋体';">库目前有两个版本：第一版名为</span><b><span>luaScript</span></b><span style="font-family:'宋体';">，它不含协程，代码也较为陈旧；第二版名为</span><b><span>luaTask</span></b><span style="font-family:'宋体';">，它实现了</span><span>lua</span><span style="font-family:'宋体';">的协程，架构更合理，运行也更稳定高效。</span></p>

<p><span> </span></p>

<p><span style="font-family:'宋体';">第二版</span><span>LIB</span><span style="font-family:'宋体';">使用了<b>驼峰命名法</b>。故此，所有函数均和第一版</span><span>luaScript</span><span style="font-family:'宋体';">的</span><span>LIB</span><b><span style="font-family:'宋体';">不兼容（划重点）</span></b><span style="font-family:'宋体';">。如果开发者如果使用的是第一版的</span><span>LIB</span><span style="font-family:'宋体';">进行开发，但是下载的时候却选择第二版</span><span>luaTask</span><span style="font-family:'宋体';">的</span><span>LIB</span><span style="font-family:'宋体';">，必然会出现错误（反之亦然哦）。</span></p>

<p><span> </span></p>

<p><span style="font-family:'宋体';">例如图中的代码，报错文件是</span><span>”socketOutMsg.lua”</span><span style="font-family:'宋体';">，从文件名的命名法分析，这是一个</span><span>luaTask</span><span style="font-family:'宋体';">的</span><span>LIB</span><span style="font-family:'宋体';">，但是开发者调用的函数名称是</span><span>misc.getclockstr()</span><span style="font-family:'宋体';">，这明显是第一版</span><span>luaScript LIB </span><span style="font-family:'宋体';">的函数（非驼峰命名法）。所以此处正确的调用方法应是：</span><span>misc.getClock()</span><span style="font-family:'宋体';">。</span></p>

<p><span> </span></p>

<p><span style="font-family:'宋体';">开发者如果选择了某个版本的</span><span>LIB</span><span style="font-family:'宋体';">，就要自始至终、始终如一、至死不渝、地老天荒的使用它。不同</span><span>LIB</span><span style="font-family:'宋体';">版本混用就会出现问题。</span></p>

<p><span> </span></p>

<h1>

<p>二、语法错误</h1></p>
<p><img style="width:355px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-FdLkZGJg5b84e432a18d7.png" class="img-responsive" alt="attachments-2018-08-FdLkZGJg5b84e432a18d7.png" /><span style="font-size:10.5pt;font-family:'宋体';"><br /></span></p>

<p><span style="font-family:'宋体';">有的时候碰到这种没头没脑的报错，的确非常头痛。这种情况下建议检查条目：</span></p>

<p><span>1</span><span style="font-family:'宋体';">、是否存在语法错误：代码块缺少</span><span>”<b>end</b>”</span><span style="font-family:'宋体';">、缺少</span><span>”<b>)</b>”</span><span style="font-family:'宋体';">等；</span></p>

<p><span>2</span><span style="font-family:'宋体';">、是否存在隐含的逻辑错误；</span></p>

<p><span>3</span><span style="font-family:'宋体';">、源码文件字符编码是否为</span><span>gb2312</span><span style="font-family:'宋体';">？</span></p>

<p><span>4</span><span style="font-family:'宋体';">、源码文件结尾处是否缺少一个新行（所有源码文件尾部必须包含一个内容为空的新行）。</span></p>

<p><span style="font-family:'宋体';">最后一种情况（</span><span>4</span><span style="font-family:'宋体';">），因为报错比较含糊，有可能是最难排查的。所以建议开发者养成一个“结尾随手加上几个新行”的习惯，避免这种情况。</span></p>

<p><span style="font-family:'宋体';">如果以上的</span><span>1~4</span><span style="font-family:'宋体';">都不奏效，那么只能使用“排除法”，依此删减“嫌疑度”最高的代码，下载运行，直到排查出问题所在，再进行分析、修改。</span></p>

<p><br /></p>

<h1>三、“代码跑飞了”？</h1>

<p><img style="width:366px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-RYmo13cs5b84e47ce217f.png" class="img-responsive" alt="attachments-2018-08-RYmo13cs5b84e47ce217f.png" /><span style="font-size:10.5pt;font-family:'宋体';"><br /></span></p>

<p><span style="font-family:'宋体';">实际上，图中的问题部分涉及“问题一、混用</span><span>LIB</span><span style="font-family:'宋体';">”。看过上文的读者，应该很轻松就能发现问题所在。</span></p>

<p><span style="font-family:'宋体';">基于</span><span>lua</span><span style="font-family:'宋体';">的协程，使得</span><span>luaTask</span><span style="font-family:'宋体';">更灵活，更稳定，也更强大。所以当协程出现错误时，<b>并不会表现为重启，而是输出错误信息</b></span><b><span> [E]-[coroutine.resume] xxxx</span></b><b><span style="font-family:'宋体';">，然后继续执行</span></b><span style="font-family:'宋体';">。由于</span><span>Trace</span><span style="font-family:'宋体';">打印速度极快，而且没有很明显的重启迹象，开发者很容易忽略这个错误。</span></p>

<p><span style="font-family:'宋体';">故此，使用</span><span>luaTask</span><span style="font-family:'宋体';">，模块没有因错重启，</span><span>Trace</span><span style="font-family:'宋体';">也正常打印，但是函数被调用后，却没有正确执行时，开发者应仔细分析</span><span>LOG</span><span style="font-family:'宋体';">有没有出现上述错误。根据错误提示再去</span><span>Debug</span><span style="font-family:'宋体';">。</span></p>

<h1>四、内存不足</h1>

<p></p>

<p><br /></p>

<p><span style="font-family:'宋体';">模块可供</span><span>lua</span><span style="font-family:'宋体';">使用的内存是</span><span>1024KB</span><span style="font-family:'宋体';">，通常情况下是足够使用的。但是如果开发者不小心写了</span><span>bug</span><span style="font-family:'宋体';">，会造成内存不足：</span></p>

<p></p>

<p><img style="width:425.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-YcAlCFjH5b84e4a82860c.png" class="img-responsive" alt="attachments-2018-08-YcAlCFjH5b84e4a82860c.png" /></p>

<p><span style="font-family:'宋体';"><br /></span></p>

<p><span style="font-family:'宋体';">通常情况下，内存不足后，底层会自动重启。</span></p>

<p><span style="font-family:'宋体';">但是某些时候（如图所示），内存不足，但是</span><span>luaTask</span><span style="font-family:'宋体';">没有直接重启，而是继续恢复运行。直到最后彻底失去响应，才会让外部看门狗芯片引导模块重启（</span><span>poweron reason</span><span style="font-family:'宋体';">为</span><span>8</span><span style="font-family:'宋体';">）：</span></p>

<p></p>

<p><img style="width:320px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-vbAczr1f5b84e4ba4f68f.png" class="img-responsive" alt="attachments-2018-08-vbAczr1f5b84e4ba4f68f.png" /></p>

<p></p>

<p><br /></p>

<p><span style="font-family:'宋体';">为了杜绝内存不足这种情况，开发者首先要养成良好的习惯：</span></p>

<p><span style="font-family:'宋体';">·</span>
<span style="font-family:'宋体';">不要所有函数、变量都写成全局的。开发者应在适当的时候，才使用全局变量，其他情况一律使用</span><span>local</span><span style="font-family:'宋体';">约束；</span></p>

<p><span style="font-family:'宋体';">·</span>
<span style="font-family:'宋体';">串口收到的数据、</span><span>http</span><span style="font-family:'宋体';">下载的内容等，不要全部放到变量中；如果内容过多，应保存为文件；</span></p>

<p><span style="font-family:'宋体';">·</span>
<span style="font-family:'宋体';">如果使用变量储存</span><span>str</span><span style="font-family:'宋体';">，不要忘记清空变量；</span></p>

<p><span style="font-family:'宋体';">·</span>
<span style="font-family:'宋体';">尽量减少全局变量的使用，如果是运行时的常量，可以使用读取配置文件代替变量（请参考</span><span>nvm demo</span><span style="font-family:'宋体';">）</span></p>

<p><span style="font-family:'宋体';">·</span>
<span style="font-family:'宋体';">优化代码逻辑。</span></p>

<p><span style="font-family:'宋体';">排查内存不足的情况，首先要在代码中加入前文提到的打印</span><span>RAM</span><span style="font-family:'宋体';">和</span><span>ROM</span><span style="font-family:'宋体';">的代码，然后观察</span><span>Trace</span><span style="font-family:'宋体';">打印过程中</span><span>RAM</span><span style="font-family:'宋体';">动态减少的情况。</span></p>

<p><span style="font-family:'宋体';">如果模块在执行某个函数后，内存骤降，那么证明该函数存在问题，需要分析、修改；如果内存缓慢减少，那么应该按照前文所述的方法去更改代码，减少全局变量的使用。</span></p>

<p><span style="font-family:'宋体';">如果开发者遇到底层库报错导致的内存不足，请把</span><span>Trace</span><span style="font-family:'宋体';">文件提供给我司：</span></p>

<p></p>

<p><img style="width:394.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-BSOmBn1F5b84e4de25224.png" class="img-responsive" alt="attachments-2018-08-BSOmBn1F5b84e4de25224.png" /></p>

<p></p>

<p><br /></p>

<h1>五、死循环</h1>

<p><span style="font-family:'宋体';">由于模块的</span><span>CPU</span><span style="font-family:'宋体';">、</span><span>RAM</span><span style="font-family:'宋体';">资源有限，所以任何空循环，死循环都会吃尽所有资源。底层发现资源不足是，会自动重启。所以任何时候，都要避免空循环、死循环的情况。</span></p>

<p><span> </span></p>

<p><span style="font-family:'宋体';">由于</span><span>luaTask</span><span style="font-family:'宋体';">的特性，更需要额外注意。如：</span></p>

<p><span>require”sys”</span></p>

<p><span>require”log”</span></p>

<p><span>sys.taskInit(</span></p>

<p><span>function()</span></p>

<p><span>while true do</span></p>

<p><span>--</span><span style="font-family:'宋体';">此处如果执行的操作很短完成时间内完成（非阻塞等待），可视为死循环</span></p>

<p><span>log.info(“loop”, ”test”)</span></p>

<p><span> </span></p>

<p><span>--</span><span style="font-family:'宋体';">为了避免循环吃尽所有资源，可以使用</span><span>wait</span><span style="font-family:'宋体';">，实现</span><span>1000ms</span><span style="font-family:'宋体';">循环一次</span></p>

<p><span>sys.wait(1000)</span></p>

<p><span>end</span></p>

<p><span>end</span></p>

<p><span>)</span></p>

<p><span> </span></p>

<h1>六、AT命令执行超时</h1>

<p></p>

<p><span style="font-size:10.5pt;font-family:'宋体';">这种情况较为罕见，通常是</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">lua</span><span style="font-size:10.5pt;font-family:'宋体';">和底层交互是，底层没有及时的、正确的返回，</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">lua</span><span style="font-size:10.5pt;font-family:'宋体';">判断</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">AT</span><span style="font-size:10.5pt;font-family:'宋体';">命令执行超时（通常是</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">60s</span><span style="font-size:10.5pt;font-family:'宋体';">），自动重启：</span></p>

<p><img style="width:278px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-tuPqHe5b5b84e506448dd.png" class="img-responsive" alt="attachments-2018-08-tuPqHe5b5b84e506448dd.png" /><span style="font-size:10.5pt;font-family:'宋体';"><br /></span></p>

<p><span style="font-family:'宋体';">这种情况无须担心，是极为罕见的。重启后即可恢复正常运行。如有条件，建议更新到最新底层。</span></p>

<h1>七、无法运行</h1>

<p><span style="font-family:'宋体';">很多时候，由于开发者一时疏忽，下载</span><span>lod</span><span style="font-family:'宋体';">后忘记下载</span><span>lua</span><span style="font-family:'宋体';">，所以导致无法运行，异常重启。</span></p>

<p><img style="width:260.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-oS2urOXx5b84e549c70cf.png" class="img-responsive" alt="attachments-2018-08-oS2urOXx5b84e549c70cf.png" /></p>

<p><span style="font-family:'宋体';"><br /></span></p>

<p><span style="font-family:'宋体';">解决方法也很简单，记得下载</span><span>lod</span><span style="font-family:'宋体';">后，下载</span><span>lua</span><span style="font-family:'宋体';">即可。</span></p>

<h2><span style="font-family:'黑体';">结束语</span></h2>

<p><span style="font-family:'宋体';">研读</span><span>Trace</span><span style="font-family:'宋体';">输出的内容，是开发者用以</span><span>Debug</span><span style="font-family:'宋体';">的最高效方式，一定要认真分析输出的内容，才能事半功倍。</span></p>

<p><span style="font-size:10.5pt;font-family:'宋体';"><br /></span></p>

<p><br /></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/28/410/" data-id="ckkfmdged00crvkcg75y0299h" data-title="Air系列模块重启原因分析及应对策略（二）" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-409" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/28/409/" class="article-date">
  <time class="dt-published" datetime="2018-08-28T01:51:35.000Z" itemprop="datePublished">2018-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/28/409/">Air系列模块重启原因分析及应对策略（一）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p></p>

<p><span style="font-family:'宋体';">如果要问开发者，什么情况最让其崩溃，估计异常重启能排到前三。模块稳定运行不重启，是所有开发者的梦想。然而总会有一些意外情况导致模块异常重启。本文将对一些常见的重启情况进行分析，同时探讨其对应策略，希望可以为模块的稳定运行提供一些帮助。</span></p>

<p><span style="font-family:'宋体';">通常，重启是由<b>硬件原因</b>或者<b>软件原因</b>造成的。虽然病因不同，但是表象极为相似，咱们就使用“<b>望闻问切</b>”的方法，剖析病因，对症下药，直达病灶，快速起效（嘿，请认准了，</span><span>Luat</span><span style="font-family:'宋体';">大法好！）。</span></p>

<p><span style="font-family:'宋体';">“<b>望</b>”字诀——检查硬件环境：仔细排查接线，外围设备，供电等是否存在问题；</span></p>

<p><span style="font-family:'宋体';">“<b>闻</b>”字诀——检查软件代码：查看模块输出的</span><span>Trace</span><span style="font-family:'宋体';">。通常，我们可以通过分析重启前后的输出</span><span>Trace</span><span style="font-family:'宋体';">判断错误所在；</span></p>

<p><span style="font-family:'宋体';">“<b>问</b>”字诀——初步发现问题所在，尝试复现。当可以准确复现后，分析对应逻辑存在的问题（找到相关责任人，让他请客！）。</span></p>

<p><span style="font-family:'宋体';">“<b>切</b>”字诀——根据问题去修改代码（打样），反复测试是否还会出现此问题，是否引入新问题，是否干扰到原有逻辑的运行。</span></p>

<p><span style="font-family:'宋体';">重复上述步骤，直到模块可以稳定运行为止。</span></p>

<p><span style="font-family:'宋体';">本文今天就先说一下“<b>望</b>”字诀。</span></p>

<p></p>

<p><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">Air</span><span style="font-size:10.5pt;font-family:'宋体';">系列模块对电源的要求较为严格，以</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">Air202</span><span style="font-size:10.5pt;font-family:'宋体';">模块为例：</span><img style="width:529.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-3wvZbyYL5b84aa11dbbd3.png" class="img-responsive" alt="attachments-2018-08-3wvZbyYL5b84aa11dbbd3.png" /></p>

<p></p>

<p><br /></p>

<p><span style="font-family:'宋体';">如图所示，根据硬件设计手册的要求，模块瞬时电流在</span><span>1.6A</span><span style="font-family:'宋体';">时，</span><span>VBAT</span><span style="font-family:'宋体';">电压不应跌落</span><span>3.4V</span><span style="font-family:'宋体';">，否则必然出现异常（在频繁通信时，电流要求更高，最好可以满足</span><span>2A</span><span style="font-family:'宋体';">）。</span></p>

<p><span style="font-family:'宋体';">如果模块的</span><span>PWRKEY</span><span style="font-family:'宋体';">未接地，</span><span>VBAT</span><span style="font-family:'宋体';">电压低于</span><span>3.4V</span><span style="font-family:'宋体';">时模块会自动关机；</span></p>

<p><span style="font-family:'宋体';">如果模块的</span><span>PWRKEY</span><span style="font-family:'宋体';">已接地，电压低于</span><span>3.4V</span><span style="font-family:'宋体';">时模块会表现为先自动关机。后因电流减小，供电端恢复正常，</span><span>VBAT</span><span style="font-family:'宋体';">电压升至</span><span>3.4V</span><span style="font-family:'宋体';">以上，模块重新走上电开机流程。此种情况表现为异常重启，输出的</span><span>Trace</span><span style="font-family:'宋体';">中</span><span>poweron reason</span><span style="font-family:'宋体';">为</span><span>0</span><span style="font-family:'宋体';">：</span></p>

<p><span>[2018-06-12
12:40:03,311.311]: host trace poweron reason:<span>        </span>0<span>       </span>Air800<span>      </span>A9321<span>       </span>1.1.1<span>         </span>1.1.0<span>         </span>Luat_V0014_8955</span></p>

<p><span style="font-family:'宋体';">附</span><span>poweron reason</span><span style="font-family:'宋体';">表：</span></p>

<table class="MsoTableGrid" width="568"><tr><td>
  <p><span>POWERON </span><span style="font-family:'宋体';">事件</span></p>
  </td>
  <td>
  <p><span>POWERON </span><span style="font-family:'宋体';">代码</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">解释</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_KEY</span></p>
  </td>
  <td>
  <p><span>0</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">按键开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_CHARGER</span></p>
  </td>
  <td>
  <p><span>1</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">充电开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_ALARM</span></p>
  </td>
  <td>
  <p><span>2</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">闹钟开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_RESTART</span></p>
  </td>
  <td>
  <p><span>3</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">软件重启开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_EXCEPTION</span></p>
  </td>
  <td>
  <p><span>6</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">异常开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_HOST</span></p>
  </td>
  <td>
  <p><span>7</span></p>
  </td>
  <td>
  <p><span>HOST</span><span style="font-family:'宋体';">工具控制重启开机</span></p>
  </td>
 </tr><tr><td>
  <p><span>rtos. POWERON_WATCHDOG</span></p>
  </td>
  <td>
  <p><span>8</span></p>
  </td>
  <td>
  <p><span style="font-family:'宋体';">其他原因</span></p>
  </td>
 </tr></table>

<p></p>

<p><br /></p>

<p><span style="font-family:'宋体';">所以，如果模块重启前有频繁的通信操作，且没有固定的语句报错（无规律性），重启后上报的</span><span>poweron reason</span><span style="font-family:'宋体';">为</span><span>0</span><span style="font-family:'宋体';">，此时应该重点排查供电问题。</span></p>

<p><span style="font-family:'宋体';">如果存在瞬间电压跌落，可能会导致模块出现异常。</span></p>

<p><span style="font-family:'宋体';">下边，试举一例：</span></p>

<p><span style="font-family:'宋体';">某客户使用开关电源将市电</span><span>220V AC</span><span style="font-family:'宋体';">降压至</span><span>12V DC</span><span style="font-family:'宋体';">，然后</span><span>PCB</span><span style="font-family:'宋体';">使用</span><span>DCDC</span><span style="font-family:'宋体';">将</span><span>12V</span><span style="font-family:'宋体';">降到</span><span>4V</span><span style="font-family:'宋体';">给模块</span><span>VBAT</span><span style="font-family:'宋体';">供电。模块的</span><span>PWRKEY</span><span style="font-family:'宋体';">已经接地，实现上电自动开机。</span></p>

<p><span style="font-family:'宋体';">模块在频繁通信时工作正常，但是闲暇时发心跳包却无规律性重启。分析日志发现，重启后</span><span>Trace</span><span style="font-family:'宋体';">输出的</span><b><span>poweron reason</span></b><b><span style="font-family:'宋体';">是</span><span>0</span></b><span style="font-family:'宋体';">，初步判断并非代码错误，而是供电问题导致的异常重启。</span></p>

<p><span style="font-family:'宋体';">（请注意，任何情况下，</span><span>poweron reason</span><span style="font-family:'宋体';">为</span><span>0</span><span style="font-family:'宋体';">，都应首先检查</span><span>VBAT</span><span style="font-family:'宋体';">端供电电压跌落问题）</span></p>

<p></p>

<p><span style="font-size:10.5pt;font-family:'宋体';">首先，在全负荷情况下使用功率计测量，查看是否超过电源的额定输出值：</span><br /></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-YFC4pPTE5b84aa3a3633d.jpg" class="img-responsive" alt="attachments-2018-08-YFC4pPTE5b84aa3a3633d.jpg" /><br /></p>

<p><span style="font-family:'宋体';">负载不到</span><span>10w</span><span style="font-family:'宋体';">，远未达到</span><span>12V 2A</span><span style="font-family:'宋体';">的上限要求；接下来测量电源输出情况：</span></p>

<p><span style="font-family:'宋体';">（这是一个很考验耐心的事情，因为是无规律性重启，所以很可能一直盯着，一直没事儿；稍稍走神一下，它就重启了……还有一个需要注意的是，绝对不要用“万用表”，一定要用示波器，因为万用表不够灵敏，很容易导致误判）</span></p>

<p></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-HVDjPuxa5b84aa4c77f59.jpg" class="img-responsive" alt="attachments-2018-08-HVDjPuxa5b84aa4c77f59.jpg" /></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-JLXyeiHd5b84aa56a4f29.jpg" class="img-responsive" alt="attachments-2018-08-JLXyeiHd5b84aa56a4f29.jpg" /></p>

<p><span style="font-family:'宋体';">如上图所示，经过长久的等待，终于抓到异常。某种特殊情况下，电源可能会瞬间跌落至</span><span>0V</span><span style="font-family:'宋体';">，随后恢复正常输出；这一个瞬间的跌落，导致模块</span><span>VBAT</span><span style="font-family:'宋体';">端电压直接跌破</span><span>3.4V</span><span style="font-family:'宋体';">，最终异常重启。</span></p>

<p><span style="font-family:'宋体';">和电源厂家沟通后了解到，这个问题并非过热、电流过大的自保护，而是电源动态响应速度跟不上，负载很小的时候，电源本身进入待机模式导致。更换新电源后问题得以解决，模块不再异常重启。</span></p>

<p></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-gIl61D8J5b84aa6f16490.jpg" class="img-responsive" alt="attachments-2018-08-gIl61D8J5b84aa6f16490.jpg" /></p>

<p><span style="font-family:'宋体';">很多时候，并不能和电源厂商沟通，而供电不稳时有发生，只能“硬抗”这种波动怎么办呢？简单有效的方法就是使用电容、电池，让他们稳定输出电压。</span></p>

<p><span style="font-family:'宋体';">如果无法改善供电（如风能、太阳能），也无法使用电池、电容，那么只能优化代码逻辑。例如，尽量减少通信频率和时常，减少通信包大小，使瞬时电流不超过阈值以至于引起压降。</span></p>

<p><span style="font-family:'宋体';">所以说呢，只要保证任何情况下，模块</span><span>VBAT</span><span style="font-family:'宋体';">的电压在《硬件设计手册》规定范围内，模块就不会因为供电问题出现异常啦！</span></p>

<p><br /></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/28/409/" data-id="ckkfmdgb5004vvkcg63qigp69" data-title="Air系列模块重启原因分析及应对策略（一）" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-408" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/28/408/" class="article-date">
  <time class="dt-published" datetime="2018-08-28T01:35:24.000Z" itemprop="datePublished">2018-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/28/408/">1拖N下载夹具使用指南</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><span style="font-family:'微软雅黑', sans-serif;">Air202</span><span style="font-family:'微软雅黑', sans-serif;">、<span>Air800</span>等模块，自从面世以来，因质优价廉、开发便捷、稳定性强等特点颇受开发者欢迎。诸位开发者各显其能，围绕这些模块，开发了各种牛逼又给力的应用（据说还有卖套套的？小编我是佩服得不要不要的）。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;"><br /></span><span style="font-family:'微软雅黑', sans-serif;">软件写的是很嗨皮了，然而量产时才发现，一个一个模块进行下载，插拔串口线，简直是要累吐血的节奏。而且效率极其低下。所以各位小伙伴再次脑洞大开，用了各种招数，比如下边这个：</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;"><br /></span><img src="http://oldask.openluat.com/image/show/attachments-2018-08-aGRK0GYD5b84a1c80a1c1.jpg" alt="attachments-2018-08-aGRK0GYD5b84a1c80a1c1.jpg" /></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">以小编的猜测，未来可能还要“鞭尸”很久，毕竟太经典了。</span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-m1CpZItc5b84a1e1d289b.png" alt="attachments-2018-08-m1CpZItc5b84a1e1d289b.png" /><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">画反了，<span>host_uart</span>也没有预留，一切靠飞线，大写的服！</span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">但是，如果已经把模块贴在<span>PCB</span>上了，忽然惊觉没有下载怎么办呢？动手能力强的小伙伴不甘示弱，做出了非常牛逼的东东：</span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-h0xoGgCo5b84a1fa04500.png" alt="attachments-2018-08-h0xoGgCo5b84a1fa04500.png" /></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-MPtR1XGI5b84a20a59081.jpg" alt="attachments-2018-08-MPtR1XGI5b84a20a59081.jpg" /><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">如图所示，用亚克力做了一个刚好适合板子大小的凹槽，然后把板子放进去。串口线接好插针，针搭在<span>host_uart</span>的焊盘上，<span>ok</span>，开撸！</span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">小编叹服之余，不禁问道，如果板子摆放不平，焊盘接触不良怎么样？对方邪魅一笑：针是有弹性的。</span></p>

<p><img style="width:48px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-WfZjZH3r5b84a220d801f.png" alt="attachments-2018-08-WfZjZH3r5b84a220d801f.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">好吧，这才是真高手，厉害。</span><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">那么，究竟有没有靠谱又高效的下载方式呢？答案是肯定的！为了解决这种窘况，我们专门为开发者提供了<span> 1</span>拖<span>N</span>下载夹具，支持<span>Luat</span>多种模块的批量下载；最多可<span>8</span>个模块同时下载，怎么样，霸气吧？先来一睹为快：</span><br /></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-WwhdjRaK5b84a25fd083c.png" alt="attachments-2018-08-WwhdjRaK5b84a25fd083c.png" /><br /></p>

<p><br /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">实际上呢，它和那个亚克力做的下载器有异曲同工之妙。配合专用的软件，可以实现<span>1</span>（<span>1</span>台电脑）拖<span>N</span>（<span>N</span>个模块）同时批量下载的目的。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">因为每个模块引脚各有不同，所以家具也有多种型号。目前夹具支持如下模块：</span></p>

<p style="text-align:center;"></p>

<p><span style="font-family:'微软雅黑', sans-serif;">Air201<span>          </span></span><span style="font-family:'微软雅黑', sans-serif;">一拖一、四、八夹具<span><span>           </span>GPRS</span></span></p>

<p style="text-align:center;"><span style="font-family:'微软雅黑', sans-serif;">Air202<span>          </span></span><span style="font-family:'微软雅黑', sans-serif;">一拖一、四、八夹具<span><span>           </span>GPRS</span></span></p>

<p style="text-align:center;"><span style="font-family:'微软雅黑', sans-serif;">Air208S<span>        </span></span><span style="font-family:'微软雅黑', sans-serif;">一拖一、四、八夹具<span><span>           </span>GPRS</span></span></p>

<p style="text-align:center;"><span style="font-family:'微软雅黑', sans-serif;">Air208M<span>              </span></span><span style="font-family:'微软雅黑', sans-serif;">一拖一、四、八夹具<span><span>           </span>GPRS</span></span></p>

<p style="text-align:center;"><span style="font-family:'微软雅黑', sans-serif;">Air800<span>          </span></span><span style="font-family:'微软雅黑', sans-serif;">一拖一、四、八夹具<span><span>           </span>GNSS+GPRS</span></span></p>

<p style="text-align:center;"><span style="font-family:'微软雅黑', sans-serif;">Air801<span>          </span></span><span style="font-family:'微软雅黑', sans-serif;">一拖一、四、八夹具<span><span>           </span>GNSS+GPRS</span></span></p>

<p style="text-align:center;"><span style="font-family:'微软雅黑', sans-serif;">Air200<span>          </span></span><span style="font-family:'微软雅黑', sans-serif;">一拖一、四、八夹具<span><span>           </span>GPRS</span></span></p>

<p style="text-align:center;"><span style="font-family:'微软雅黑', sans-serif;">Air200S<span>        </span></span><span style="font-family:'微软雅黑', sans-serif;">一拖一、四、八夹具<span><span>           </span>GPRS</span></span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">接下来，小编手把手教您如何使用这个神器。</span></p>

<p></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">首先需要使用<span>luaTools
</span>生成量产用的<span>LOD</span>文件。如果您还没有<span> luaTools </span>呢，请到我们的产品中心（<span>http://www.openluat.com/Product</span>）下载哦。</span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">打开<span>luaTools.exe</span>，点击“生成量产文件”按钮：</span></p>

<p><img style="width:223.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-rlsTTrEq5b84a5233f9f7.png" class="img-responsive" alt="attachments-2018-08-rlsTTrEq5b84a5233f9f7.png" /><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">随后在弹出的新窗口中，先选择正确的<span>LOD</span>文件（<span>1</span>），然后<b>添加所有<span>lua</span>文件</b>和<b>资源文件</b>（图片、<span>mp3</span>等）（<span>2</span>）：</span><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span><img style="width:393.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-gFdoJqgH5b84a536c1d9f.png" class="img-responsive" alt="attachments-2018-08-gFdoJqgH5b84a536c1d9f.png" /></p>

<p></p>

<p><br /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">添加完脚本后，点击“浏览文件”按钮（<span>3</span>），选择量产用<span>LOD</span>保存的文件夹；最后点击“合并生成量产用文件”（<span>4</span>）即可啦。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">合并完成后，状态栏会有如下提示：</span></p>

<p></p>

<p><img style="width:395.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-SDJV8chZ5b84a54c12dca.png" class="img-responsive" alt="attachments-2018-08-SDJV8chZ5b84a54c12dca.png" /></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">表示量产用文件生成完毕。</span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">如果合并过程中，出现如下错误：</span></p>

<p><img style="width:398px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-6bNbUPuN5b84a560023cd.png" class="img-responsive" alt="attachments-2018-08-6bNbUPuN5b84a560023cd.png" /><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">请检查路径是否过于复杂，文件名是否过长，<span>cpu/</span>内存是否够用。强烈建议在合并过程中，停止运行任何耗费<span>cpu</span>和内存的程序。</span></p>

<div>

<p><span style="font-family:'微软雅黑', sans-serif;"> </span></p>

</div>

<p><span style="font-family:'微软雅黑', sans-serif;"> </span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">在实际量产下载前，建议开发者使用生成的量产用<span>LOD</span>文件进行测试（点击<span>luaTools</span>的“下载<span>lod</span>按钮”，将该量产用<span>LOD</span>下载到模块内），测试该量产用<span>LOD</span>文件可以正常工作（资源调用是否正常，代码运行是否正确等）。</span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">如果通过测试，那么现在就可以开始准备批量下载啦！</span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">首先，请准备一个可外接供电的<span>usb-hub</span>（建议选择质量过硬的品牌，这样可以保证下载过程中稳定运行），然后将<span>usb-hub</span>接到电脑上，待电脑自动安装好该<span>usb-hub</span>驱动后，把下载夹具的所有<span>usb</span>线插到<span>usb-hub</span>上：</span></p>

<p><img style="width:504px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-nWTRvk705b84a59160983.png" class="img-responsive" alt="attachments-2018-08-nWTRvk705b84a59160983.png" /><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">接下来，打开电脑的“设备管理器”，查看是否发现串口线。如果正确识别，则无需安装驱动。如果出现下图所示的“叹号”，则需要安装串口线<span>PL2303</span>驱动。下载地址：</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;"><a target="_blank" rel="noopener" href="http://www.openluat.com/Product/others/batdl.html">http://www.openluat.com/Product/others/batdl.html</a>
</span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><img style="width:387.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-VXBwL9nf5b84a5a8d6c93.png" class="img-responsive" alt="attachments-2018-08-VXBwL9nf5b84a5a8d6c93.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">成功安装后，电脑端的“设备管理器”即可识别所有的串口线（如果未识别，请检查连线是否正确）。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;"> </span></p>

<p><b><span style="font-family:'微软雅黑', sans-serif;">夹具的<span>gnd</span>和<span>vbat</span>需要接<span>3.4~4.2v</span>直流供电</span></b><span style="font-family:'微软雅黑', sans-serif;">，以给模块供电；然后将夹具的开关拨到“<span>ON</span>”位置：</span></p>

<p></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-suUrROX75b84a5c9013a1.png" class="img-responsive" alt="attachments-2018-08-suUrROX75b84a5c9013a1.png" /></p>

<p></p>

<p><br /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">下一步，打开“<span>RDA</span>平台<span>lod</span>升级工具”所在目录，把刚刚生成的量产用<span>LOD</span>文件拷贝进去。如果您还没有“<span>RDA</span>平台<span>lod</span>升级工具”呢，请到我们的产品中心（<span>http://www.openluat.com/Product</span>）下载哦。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">如图所示，将文件拷贝到该目录：</span></p>

<p><img style="width:193.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-q7u5utTP5b84a5e136f52.png" class="img-responsive" alt="attachments-2018-08-q7u5utTP5b84a5e136f52.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">继续，修改<span>config</span>目录下的<span>param.ini</span>文件：</span></p>

<p></p>

<p><img style="width:227px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-rJhLzSQh5b84a5eec73be.png" class="img-responsive" alt="attachments-2018-08-rJhLzSQh5b84a5eec73be.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">其中，<span>lod </span>参数应该修改为量产用<span>LOD</span>的名称；</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">auto_restart</span><span style="font-family:'微软雅黑', sans-serif;">参数可修改为<span>true</span>（大小写不敏感）。如果<span>aut_restart</span>修改为<span>true</span>，则下载完成后重启模块。参数不为<span>true</span>，则下载完成不重启模块。如果希望下载完成后，放入新模块自动开始下载，则请留空此参数。</span></p>

<p></p>

<p><br /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">双击<span>main.exe</span>，点击“设置”按钮。随后弹出的窗口中，勾选复选框，并选择正确的对应串口（可以从“设备管理器”查看哦）。设置完成后，点击“<span>ok</span>”按钮：</span></p>

<p></p>

<p><img style="width:156.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-l9KDpBL15b84a6038da5a.png" class="img-responsive" alt="attachments-2018-08-l9KDpBL15b84a6038da5a.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">现在<span>,</span>，将模块正确的放置在夹具中，使<span>host_tx /
host_rx / gnd </span>和夹具准确接触：</span></p>

<p></p>

<p><img style="width:504px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-oXRZ2KhJ5b84a61d59b1f.png" class="img-responsive" alt="attachments-2018-08-oXRZ2KhJ5b84a61d59b1f.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">最后，点击软件的“开始”按钮，就可以愉快的进行批量下载啦！</span></p>

<p></p>

<p><img style="width:144px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-NsFe8deL5b84a62c2399f.png" class="img-responsive" alt="attachments-2018-08-NsFe8deL5b84a62c2399f.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">提示“等待模块放入”，此时将模块放入夹具正确位置，即可自动开始下载：</span></p>

<p><img style="width:301.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-xa0ltL0d5b84a6447cb24.png" class="img-responsive" alt="attachments-2018-08-xa0ltL0d5b84a6447cb24.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">下载<span>ing</span>：</span></p>

<p></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-61qkX9OW5b84a653036c0.png" class="img-responsive" alt="attachments-2018-08-61qkX9OW5b84a653036c0.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">下载完毕：</span></p>

<p></p>

<p><img style="width:317px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-wJCWNZfB5b84a6619dbaa.png" class="img-responsive" alt="attachments-2018-08-wJCWNZfB5b84a6619dbaa.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">如果<span> param.ini </span>设置<span> auto_restart </span>为非<span>True</span>，直接把模块取下，换上新的模块，软件即可自动开始下载，无需人工干预。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;"><b><br /></b></span></p>

<p><span style="font-family:'微软雅黑', sans-serif;"><b>请注意：</b></span></p>

<p></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">1</span><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">、如果下载过程中出现错误，文本框内会有相应提示：</span></p>

<p><img style="width:634px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-SfG8cKqT5b84a67d4a060.png" class="img-responsive" alt="attachments-2018-08-SfG8cKqT5b84a67d4a060.png" /><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">请根据提示进行故障排除。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">2</span><span style="font-family:'微软雅黑', sans-serif;">、请尽量使用最新版的<span> luaTools </span>生成量产用<span>LOD</span>文件，使用最新版<span> RDA</span>平台<span>lod</span>升级工具进行批量下载。如果二者不是最新版，则生成的量产用<span>LOD</span>文件可能存在兼容性问题，导致“<span>RDA</span>平台<span>lod</span>升级工具”下载失败，或者出现下载后模块无法正常工作的情况。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">3</span><span style="font-family:'微软雅黑', sans-serif;">、如果更改配置文件<span>param.ini</span>的<span>auto_restart</span>参数为<b>非<span>True</span></b>时，则无需再点击“开始”按钮，对应串口的模块下载好后，直接手动替换为新的待下载模块，即可自动开始下载。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">4</span><span style="font-family:'微软雅黑', sans-serif;">、外接供电的<span>usb-hub</span>，可以保证下载过程稳定性，避免因<span>usb</span>口供电不足导致的异常情况，推荐使用。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">5</span><span style="font-family:'微软雅黑', sans-serif;">、不同模块间的<span>host_uart</span>不同，所以夹具并不通用，望悉知。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">6</span><span style="font-family:'微软雅黑', sans-serif;">、<span>luaTools</span>、<span>RDA</span>平台<span>lod</span>升级工具、串口线驱动，均可从<span>
http://www.openluat.com/Product</span>下载。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">7</span><span style="font-family:'微软雅黑', sans-serif;">、夹具的<span>vbat</span>和<span>gnd</span>电压应为<span>3.4~4.2v</span>，反接、电压超高可能导致模块烧毁；电压过低则模块无法正常开机下载。</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">8</span><span style="font-family:'微软雅黑', sans-serif;">、下载任务进行时，无法关闭软件，只有点击“停止”按钮，才能关闭软件（为防止意外关闭软件，导致下载中断）</span></p>

<p><span style="font-family:'微软雅黑', sans-serif;">9</span><span style="font-family:'微软雅黑', sans-serif;">、如果模块放入夹具，却始终提示“等待模块放入”，请检查模块摆放是否正确，触点是否接触良好。</span></p>

<p><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;">10、如果<span>param.ini</span>中的<span>lod</span>参数存在问题，则会提示：</span><span style="font-size:10.5pt;font-family:'微软雅黑', sans-serif;"><br /></span></p>

<p><img style="width:147.5px;" src="http://oldask.openluat.com/image/show/attachments-2018-08-jOITBvz05b84a6aed71af.png" class="img-responsive" alt="attachments-2018-08-jOITBvz05b84a6aed71af.png" /></p>

<p><span style="font-family:'微软雅黑', sans-serif;">请确认<span>lod</span>文件是否<span>main.exe</span>目录中，文件名是否正确。</span></p>

<p></p>

<p><br /></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/28/408/" data-id="ckkfmdged00cqvkcgc8v89p8w" data-title="1拖N下载夹具使用指南" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-407" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/27/407/" class="article-date">
  <time class="dt-published" datetime="2018-08-27T10:26:01.000Z" itemprop="datePublished">2018-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/27/407/">Luat系列教程：7、串口收发</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>阅读本文需要具有的技能：<br>看过该系列前几篇文章或明白前几篇文章内容的<br>可以明白字符串、字节码之间的区别<br>了解串口的原理和使用</p>
</blockquote>
<p>其实串口这个部分，我觉得挺简单的，看demo都能看懂吧。。</p>
<h1 id="官方demo代码"><a href="#官方demo代码" class="headerlink" title="官方demo代码"></a>官方demo代码</h1><p>官方代码可以在github(<a target="_blank" rel="noopener" href="https://github.com/openLuat/Luat_2G_RDA_8955/)%E7%9A%84%60Luat_2G_RDA_8955/script_LuaTask/demo/uart%60%E7%9B%AE%E5%BD%95%E6%88%96luatools%E7%9A%84%60LuaTools">https://github.com/openLuat/Luat_2G_RDA_8955/)的`Luat_2G_RDA_8955/script_LuaTask/demo/uart`目录或luatools的`LuaTools</a> 1.x.x\script\script_LuaTask\demo\uart`目录找到</p>
<p>如果你能看懂官方例程，<strong>那么可以直接去使用，不需要再看本文了</strong></p>
<h1 id="先定义一个假装能用来测试的串口收发规则"><a href="#先定义一个假装能用来测试的串口收发规则" class="headerlink" title="先定义一个假装能用来测试的串口收发规则"></a>先定义一个假装能用来测试的串口收发规则</h1><ul>
<li>串口通讯使用9600波特率，3.3V ttl电平</li>
<li>模块开机第10秒后，向设备发送<code>0x01 0x02 0x03</code>三个字节</li>
<li>模块收到<code>qwerty</code>字符串后，回复<code>asdfgh</code>字符串</li>
<li>模块收到<code>0xaa 0xbb 0xcc</code>三个字节后，回复<code>0xdd 0xee 0xff</code>三个字节</li>
<li>模块收到<code>abcdefghijklmnopqrstuvwxyz</code>字符串后，回复<code>ok</code>字符串</li>
</ul>
<h1 id="建立文件结构"><a href="#建立文件结构" class="headerlink" title="建立文件结构"></a>建立文件结构</h1><p>测试需要新建两个文件，<code>main.lua</code>和<code>testuart.lua</code></p>
<p><code>main.lua</code>在前面的文章中，已经新建过大概不下四次了，所以这里不再举例。<code>main.lua</code>需要<code>require&quot;testuart&quot;</code></p>
<p>testuart.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(...,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;utils&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;pm&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--串口ID,1对应uart1</span></span><br><span class="line"><span class="comment">--如果要修改为uart2，把UART_ID赋值为2即可</span></span><br><span class="line"><span class="keyword">local</span> UART_ID = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--保持系统处于唤醒状态，此处只是为了测试需要，所以此模块没有地方调用pm.sleep(&quot;testUart&quot;)休眠，不会进入低功耗休眠状态</span></span><br><span class="line"><span class="comment">--在开发“要求功耗低”的项目时，一定要想办法保证pm.wake(&quot;testUart&quot;)后，在不需要串口时调用pm.sleep(&quot;testUart&quot;)</span></span><br><span class="line">pm.wake(<span class="string">&quot;testUart&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--配置并且打开串口</span></span><br><span class="line">uart.setup(UART_ID,<span class="number">9600</span>,<span class="number">8</span>,uart.PAR_NONE,uart.STOP_1)</span><br></pre></td></tr></table></figure>
<p>可以看到，uart文件中已经配置好了串口</p>
<h1 id="发送串口信息"><a href="#发送串口信息" class="headerlink" title="发送串口信息"></a>发送串口信息</h1><p>发送接口特别简单，只需要调用<code>uart.write()</code>函数即可，我们可以在设置唤醒状态代码前面加上发送函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--发送串口数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(s)</span></span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;testuart.write&quot;</span>,s:toHex(),s)</span><br><span class="line">    uart.<span class="built_in">write</span>(UART_ID,s)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h1 id="接收串口信息"><a href="#接收串口信息" class="headerlink" title="接收串口信息"></a>接收串口信息</h1><p>为了能接收到串口消息，我们在<code>配置并且打开串口</code>函数的上方注册串口接收函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--注册串口的数据接收函数，串口收到数据后，会以中断方式，调用read接口读取数据</span></span><br><span class="line">uart.on(UART_ID,<span class="string">&quot;receive&quot;</span>,<span class="built_in">read</span>)</span><br></pre></td></tr></table></figure>
<p>并在发送函数上方新建接收函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--接收串口数据</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> data = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="comment">--底层core中，串口收到数据时：</span></span><br><span class="line">    <span class="comment">--如果接收缓冲区为空，则会以中断方式通知Lua脚本收到了新数据；</span></span><br><span class="line">    <span class="comment">--如果接收缓冲器不为空，则不会通知Lua脚本</span></span><br><span class="line">    <span class="comment">--所以Lua脚本中收到中断读串口数据时，每次都要把接收缓冲区中的数据全部读出，这样才能保证底层core中的新数据中断上来，此read函数中的while语句中就保证了这一点</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        data = uart.<span class="built_in">read</span>(UART_ID,<span class="string">&quot;*l&quot;</span>)</span><br><span class="line">        <span class="comment">--数据不存在时停止接收数据</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> <span class="built_in">string</span>.<span class="built_in">len</span>(data) == <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="comment">--打开下面的打印会耗时</span></span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">&quot;testUart.read bin&quot;</span>,data)</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">&quot;testUart.read hex&quot;</span>,data:toHex())</span><br><span class="line"></span><br><span class="line">        <span class="comment">--真正的串口数据处理函数</span></span><br><span class="line">        proc(data)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到，所有串口数据都交给了<code>proc()</code>函数进行处理，我们可以在接收函数上方新建一个<code>proc()</code>函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--处理串口数据</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">proc</span><span class="params">(data)</span></span></span><br><span class="line">    <span class="comment">--todo</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h1 id="实现功能"><a href="#实现功能" class="headerlink" title="实现功能"></a>实现功能</h1><h2 id="模块开机第10秒后，向设备发送0x01-0x02-0x03三个字节"><a href="#模块开机第10秒后，向设备发送0x01-0x02-0x03三个字节" class="headerlink" title="模块开机第10秒后，向设备发送0x01 0x02 0x03三个字节"></a>模块开机第10秒后，向设备发送<code>0x01 0x02 0x03</code>三个字节</h2><p>实现这个功能，我们只需要在文件末尾加上一个定时器即可：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--模块开机第10秒后，向设备发送`0x01 0x02 0x03`三个字节</span></span><br><span class="line">sys.timerStart(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">write</span>(<span class="built_in">string</span>.fromHex(<span class="string">&quot;010203&quot;</span>))</span><br><span class="line"><span class="keyword">end</span>,<span class="number">10000</span>)</span><br></pre></td></tr></table></figure>
<h2 id="模块收到qwerty字符串后，回复asdfgh字符串"><a href="#模块收到qwerty字符串后，回复asdfgh字符串" class="headerlink" title="模块收到qwerty字符串后，回复asdfgh字符串"></a>模块收到<code>qwerty</code>字符串后，回复<code>asdfgh</code>字符串</h2><p>处理这个信息，可以去<code>proc()</code>函数里进行修改，将函数更改为如下形式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--处理串口数据</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">proc</span><span class="params">(data)</span></span></span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">&quot;qwerty&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--模块收到`qwerty`字符串后，回复`asdfgh`字符串</span></span><br><span class="line">        <span class="built_in">write</span>(<span class="string">&quot;asdfgh&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="剩下两个需求"><a href="#剩下两个需求" class="headerlink" title="剩下两个需求"></a>剩下两个需求</h2><p>剩下两个需求处理起来和前面一样，我们直接仿照着改就行：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--处理串口数据</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">proc</span><span class="params">(data)</span></span></span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">&quot;qwerty&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--模块收到`qwerty`字符串后，回复`asdfgh`字符串</span></span><br><span class="line">        <span class="built_in">write</span>(<span class="string">&quot;asdfgh&quot;</span>)</span><br><span class="line">    <span class="keyword">elseif</span> data == <span class="built_in">string</span>.fromHex(<span class="string">&quot;AABBCC&quot;</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--模块收到`0xaa 0xbb 0xcc`三个字节后，回复`0xdd 0xee 0xff`三个字节</span></span><br><span class="line">        <span class="built_in">write</span>(<span class="built_in">string</span>.fromHex(<span class="string">&quot;DDEEFF&quot;</span>))</span><br><span class="line">    <span class="keyword">elseif</span> data == <span class="string">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--模块收到`abcdefghijklmnopqrstuvwxyz`字符串后，回复`ok`字符串</span></span><br><span class="line">        <span class="built_in">write</span>(<span class="string">&quot;ok&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>这个测试需要大家自己去测试了</p>
<p>测试结果会发现，第三条指令无法完成。为什么呢？因为串口会有截断现象。</p>
<h1 id="处理串口数据截断问题"><a href="#处理串口数据截断问题" class="headerlink" title="处理串口数据截断问题"></a>处理串口数据截断问题</h1><p>串口数据接收经常会出现的一个问题：数据被截断<br>这个现象很常见，你可以像普通单片机一样一个字节一个字节去解析，也可以加一个缓冲区定时清空处理</p>
<p>我们首先在<code>proc()</code>函数上方，新建一个缓冲区：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> buf = <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>然后可以把<code>proc()</code>函数改造成下面这样：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--缓存数据</span></span><br><span class="line"><span class="keyword">local</span> buf = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">--处理串口数据</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">proc</span><span class="params">(data)</span></span></span><br><span class="line">    data = buf..data</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;testUart.read proc&quot;</span>,data)</span><br><span class="line">    <span class="keyword">local</span> used = <span class="literal">true</span><span class="comment">--数据是否被处理？</span></span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">&quot;qwerty&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--模块收到`qwerty`字符串后，回复`asdfgh`字符串</span></span><br><span class="line">        <span class="built_in">write</span>(<span class="string">&quot;asdfgh&quot;</span>)</span><br><span class="line">    <span class="keyword">elseif</span> data == <span class="built_in">string</span>.fromHex(<span class="string">&quot;AABBCC&quot;</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--模块收到`0xaa 0xbb 0xcc`三个字节后，回复`0xdd 0xee 0xff`三个字节</span></span><br><span class="line">        <span class="built_in">write</span>(<span class="built_in">string</span>.fromHex(<span class="string">&quot;DDEEFF&quot;</span>))</span><br><span class="line">    <span class="keyword">elseif</span> data == <span class="string">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--模块收到`abcdefghijklmnopqrstuvwxyz`字符串后，回复`ok`字符串</span></span><br><span class="line">        <span class="built_in">write</span>(<span class="string">&quot;ok&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">--数据没匹配上任何东西，没被使用</span></span><br><span class="line">        used = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> used <span class="keyword">then</span><span class="comment">--数据没被使用</span></span><br><span class="line">        <span class="keyword">if</span> buf == <span class="string">&quot;&quot;</span> <span class="keyword">then</span><span class="comment">--如果缓冲区是空的</span></span><br><span class="line">            sys.timerStart(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">                buf = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">end</span>,<span class="number">500</span>)<span class="comment">--500ms后清空缓冲区</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        buf = data<span class="comment">--数据追加到缓存区</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        buf = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>函数中首先判断数据是否被使用，如果没被使用，就将数据追加到缓冲区，如果已被使用，缓冲区内容会被清除</p>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p>经过一系列修改，<code>testuart.lua</code>整体代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(...,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;utils&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;pm&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--串口ID,1对应uart1</span></span><br><span class="line"><span class="comment">--如果要修改为uart2，把UART_ID赋值为2即可</span></span><br><span class="line"><span class="keyword">local</span> UART_ID = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--缓存数据</span></span><br><span class="line"><span class="keyword">local</span> buf = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">--处理串口数据</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">proc</span><span class="params">(data)</span></span></span><br><span class="line">    data = buf..data</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;testUart.read proc&quot;</span>,data)</span><br><span class="line">    <span class="keyword">local</span> used = <span class="literal">true</span><span class="comment">--数据是否被处理？</span></span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">&quot;qwerty&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--模块收到`qwerty`字符串后，回复`asdfgh`字符串</span></span><br><span class="line">        <span class="built_in">write</span>(<span class="string">&quot;asdfgh&quot;</span>)</span><br><span class="line">    <span class="keyword">elseif</span> data == <span class="built_in">string</span>.fromHex(<span class="string">&quot;AABBCC&quot;</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--模块收到`0xaa 0xbb 0xcc`三个字节后，回复`0xdd 0xee 0xff`三个字节</span></span><br><span class="line">        <span class="built_in">write</span>(<span class="built_in">string</span>.fromHex(<span class="string">&quot;DDEEFF&quot;</span>))</span><br><span class="line">    <span class="keyword">elseif</span> data == <span class="string">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--模块收到`abcdefghijklmnopqrstuvwxyz`字符串后，回复`ok`字符串</span></span><br><span class="line">        <span class="built_in">write</span>(<span class="string">&quot;ok&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">--数据没匹配上任何东西，没被使用</span></span><br><span class="line">        used = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> used <span class="keyword">then</span><span class="comment">--数据没被使用</span></span><br><span class="line">        <span class="keyword">if</span> buf == <span class="string">&quot;&quot;</span> <span class="keyword">then</span><span class="comment">--如果缓冲区是空的</span></span><br><span class="line">            sys.timerStart(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">                buf = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">end</span>,<span class="number">500</span>)<span class="comment">--500ms后清空缓冲区</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        buf = data<span class="comment">--数据追加到缓存区</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        buf = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--接收串口数据</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> data = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="comment">--底层core中，串口收到数据时：</span></span><br><span class="line">    <span class="comment">--如果接收缓冲区为空，则会以中断方式通知Lua脚本收到了新数据；</span></span><br><span class="line">    <span class="comment">--如果接收缓冲器不为空，则不会通知Lua脚本</span></span><br><span class="line">    <span class="comment">--所以Lua脚本中收到中断读串口数据时，每次都要把接收缓冲区中的数据全部读出，这样才能保证底层core中的新数据中断上来，此read函数中的while语句中就保证了这一点</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        data = uart.<span class="built_in">read</span>(UART_ID,<span class="string">&quot;*l&quot;</span>)</span><br><span class="line">        <span class="comment">--数据不存在时停止接收数据</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> <span class="built_in">string</span>.<span class="built_in">len</span>(data) == <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="comment">--打开下面的打印会耗时</span></span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">&quot;testUart.read bin&quot;</span>,data)</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">&quot;testUart.read hex&quot;</span>,data:toHex())</span><br><span class="line"></span><br><span class="line">        <span class="comment">--真正的串口数据处理函数</span></span><br><span class="line">        proc(data)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--发送串口数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(s)</span></span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;testuart.write&quot;</span>,s:toHex(),s)</span><br><span class="line">    uart.<span class="built_in">write</span>(UART_ID,s)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--保持系统处于唤醒状态，此处只是为了测试需要，所以此模块没有地方调用pm.sleep(&quot;testUart&quot;)休眠，不会进入低功耗休眠状态</span></span><br><span class="line"><span class="comment">--在开发“要求功耗低”的项目时，一定要想办法保证pm.wake(&quot;testUart&quot;)后，在不需要串口时调用pm.sleep(&quot;testUart&quot;)</span></span><br><span class="line">pm.wake(<span class="string">&quot;testUart&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--注册串口的数据接收函数，串口收到数据后，会以中断方式，调用read接口读取数据</span></span><br><span class="line">uart.on(UART_ID,<span class="string">&quot;receive&quot;</span>,<span class="built_in">read</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--配置并且打开串口</span></span><br><span class="line">uart.setup(UART_ID,<span class="number">9600</span>,<span class="number">8</span>,uart.PAR_NONE,uart.STOP_1)</span><br><span class="line"></span><br><span class="line"><span class="comment">--模块开机第10秒后，向设备发送`0x01 0x02 0x03`三个字节</span></span><br><span class="line">sys.timerStart(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">write</span>(<span class="built_in">string</span>.fromHex(<span class="string">&quot;010203&quot;</span>))</span><br><span class="line"><span class="keyword">end</span>,<span class="number">10000</span>)</span><br></pre></td></tr></table></figure>
<h1 id="最终测试"><a href="#最终测试" class="headerlink" title="最终测试"></a>最终测试</h1><h2 id="开机后发送第10秒后，向设备发送0x01-0x02-0x03三个字节"><a href="#开机后发送第10秒后，向设备发送0x01-0x02-0x03三个字节" class="headerlink" title="开机后发送第10秒后，向设备发送0x01 0x02 0x03三个字节"></a>开机后发送第10秒后，向设备发送<code>0x01 0x02 0x03</code>三个字节</h2><p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-h6c1Ry575b83d1f881377.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-h6c1Ry575b83d1f881377.png"></a></p>
<h2 id="模块收到qwerty字符串后，回复asdfgh字符串-1"><a href="#模块收到qwerty字符串后，回复asdfgh字符串-1" class="headerlink" title="模块收到qwerty字符串后，回复asdfgh字符串"></a>模块收到<code>qwerty</code>字符串后，回复<code>asdfgh</code>字符串</h2><p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-8C3gKORM5b83d20424635.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-8C3gKORM5b83d20424635.png"></a></p>
<h2 id="模块收到0xaa-0xbb-0xcc三个字节后，回复0xdd-0xee-0xff三个字节"><a href="#模块收到0xaa-0xbb-0xcc三个字节后，回复0xdd-0xee-0xff三个字节" class="headerlink" title="模块收到0xaa 0xbb 0xcc三个字节后，回复0xdd 0xee 0xff三个字节"></a>模块收到<code>0xaa 0xbb 0xcc</code>三个字节后，回复<code>0xdd 0xee 0xff</code>三个字节</h2><p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-BHAKGyl75b83d2113fe0c.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-BHAKGyl75b83d2113fe0c.png"></a></p>
<h2 id="模块收到abcdefghijklmnopqrstuvwxyz字符串后，回复ok字符串"><a href="#模块收到abcdefghijklmnopqrstuvwxyz字符串后，回复ok字符串" class="headerlink" title="模块收到abcdefghijklmnopqrstuvwxyz字符串后，回复ok字符串"></a>模块收到<code>abcdefghijklmnopqrstuvwxyz</code>字符串后，回复<code>ok</code>字符串</h2><p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-3zcu6OmM5b83d21d27912.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-3zcu6OmM5b83d21d27912.png"></a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/27/407/" data-id="ckkfmdgb5004uvkcghu1k7ovj" data-title="Luat系列教程：7、串口收发" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-406" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/27/406/" class="article-date">
  <time class="dt-published" datetime="2018-08-27T10:24:14.000Z" itemprop="datePublished">2018-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/27/406/">Luat系列教程：6、mqtt代码详解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>写在前面：<br>由于本人并未学习过具体原理，所以本文可能会有多处常识性错误，如有发现请留言指出，谢谢！</p>
</blockquote>
<hr>
<blockquote>
<p>阅读本文需要具有的技能：<br>看过该系列前几篇文章或明白前几篇文章内容的<br>熟悉lua语法，尤其是数组部分<br>可以明白字符串、字节码之间的区别<br>可以自己实践操作<br>对mqtt通讯有基本的了解<br>用过这东西</p>
</blockquote>
<h2 id="官方demo代码"><a href="#官方demo代码" class="headerlink" title="官方demo代码"></a>官方demo代码</h2><p>官方代码可以在github(<a target="_blank" rel="noopener" href="https://github.com/openLuat/Luat_2G_RDA_8955/)%E7%9A%84%60Luat_2G_RDA_8955/script_LuaTask/demo/mqtt%60%E7%9B%AE%E5%BD%95%E6%88%96luatools%E7%9A%84%60LuaTools">https://github.com/openLuat/Luat_2G_RDA_8955/)的`Luat_2G_RDA_8955/script_LuaTask/demo/mqtt`目录或luatools的`LuaTools</a> 1.x.x\script\script_LuaTask\demo\mqtt`目录找到</p>
<p>如果你能看懂官方例程，<strong>那么可以直接去使用，不需要再看本文了</strong></p>
<h1 id="先定义一个假装能用来测试的mqtt需求"><a href="#先定义一个假装能用来测试的mqtt需求" class="headerlink" title="先定义一个假装能用来测试的mqtt需求"></a>先定义一个假装能用来测试的mqtt需求</h1><p>客户端订阅主题：<br>/d/test/#</p>
<p>设备订阅主题：<br>/s/test/设备的imei值</p>
<ul>
<li>设备联网后向<code>/d/test/设备的imei值</code>的topic发送payload为当前设备ICCID的字符串</li>
<li>服务器收到后向<code>/s/test/设备的imei值</code>的topic发送payload为<code>ok</code>两个字节的字符串</li>
<li>设备收到topic为<code>/s/test/设备的imei值</code>，payload为<code>ok</code>的数据后，再次向<code>/d/test/设备的imei值</code>的topic发送payload为<code>done</code>四个字节的字符串</li>
</ul>
<p>需求十分简单：</p>
<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-Iyg9g3vU5b83d12d58d3d.png"></p>
<p>如果你知道mqtt是什么，肯定能明白</p>
<h1 id="建立文件"><a href="#建立文件" class="headerlink" title="建立文件"></a>建立文件</h1><p>首先先新建两个文件，用于测试这个工程</p>
<p>main.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PROJECT = <span class="string">&quot;MQTT-TEST&quot;</span></span><br><span class="line">VERSION = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--根据固件判断模块类型</span></span><br><span class="line">moduleType = <span class="built_in">string</span>.<span class="built_in">find</span>(rtos.get_version(),<span class="string">&quot;8955&quot;</span>) <span class="keyword">and</span> <span class="number">2</span> <span class="keyword">or</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">LOG_LEVEL = <span class="built_in">log</span>.LOGLEVEL_TRACE</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;sys&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--每1分钟查询一次GSM信号强度,每1分钟查询一次基站信息</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;net&quot;</span></span><br><span class="line">net.startQueryAll(<span class="number">60000</span>, <span class="number">60000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载硬件看门狗功能模块</span></span><br><span class="line"><span class="comment">--如果用的是720 4g模块，请注释掉这两行</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;wdt&quot;</span></span><br><span class="line">wdt.setup(pio.P0_30, pio.P0_31)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载网络指示灯功能模块</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;netLed&quot;</span></span><br><span class="line">netLed.setup(<span class="literal">true</span>,moduleType == <span class="number">2</span> <span class="keyword">and</span> pio.P1_1 <span class="keyword">or</span> pio.P2_0,moduleType == <span class="number">2</span> <span class="keyword">and</span> <span class="literal">nil</span> <span class="keyword">or</span> pio.P2_1)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;mqttTest&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动系统框架</span></span><br><span class="line">sys.init(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">sys.run()</span><br></pre></td></tr></table></figure>
<p>mqttTest.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(...,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;misc&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;mqtt&quot;</span></span><br><span class="line"><span class="comment">--下面代码一会儿写</span></span><br></pre></td></tr></table></figure>

<h1 id="建立mqtt线程"><a href="#建立mqtt线程" class="headerlink" title="建立mqtt线程"></a>建立mqtt线程</h1><p>一般来说，mqtt连接都是异步运行的，何时应该发送数据，何时应该接收数据，这些逻辑应该让mqtt收发的进程自己进行控制</p>
<p>所以我们在<code>mqttTest.lua</code>中添加一个新的线程（看不懂的回去看前几篇文章），文件改成如下（<code>注意改一下测试服务器信息</code>）：</p>
<p>mqttTest.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(...,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;misc&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;mqtt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--测试用的服务器信息，按需求自己改</span></span><br><span class="line"><span class="keyword">local</span> mqttip,mqttport,mqttuser,mqttpassword,mqttheartbeat = <span class="string">&quot;x.x.x.x&quot;</span>,<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;user&quot;</span>,<span class="string">&quot;password&quot;</span>,<span class="number">600</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="comment">--该区域的代码会永久循环运行（除非出现语法错误）</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h1 id="进行mqtt连接"><a href="#进行mqtt连接" class="headerlink" title="进行mqtt连接"></a>进行mqtt连接</h1><p>一般来说，我们会在模块成功获取基站分配的ip后，才会进行网络的连接操作，所以我们需要使用<code>socket.isReady()</code>函数来判断是否连接网络，然后再进行网络操作</p>
<p>在成功获取ip后，我们才能新建一个mqtt对象，对其进行联网操作，mqtt客户端线程代码改为如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)</span><br><span class="line">                <span class="comment">--连接失败</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网，原地等待一秒，一秒后会循环回去重试</span></span><br><span class="line">            sys.wait(<span class="number">1000</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h1 id="对连接失败的处理"><a href="#对连接失败的处理" class="headerlink" title="对连接失败的处理"></a>对连接失败的处理</h1><p>上述代码只是一个简单的连接服务器的代码，并且连上之后没有进行任何的其他操作</p>
<p>为了增加代码的稳健性，我们可以利用<code>sys.waitUntil()</code>函数，设置五分钟内没有获取到ip就开启飞行模式几秒，再关闭，让模块重新去获取GPRS连接：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)</span><br><span class="line">                <span class="comment">--连接失败</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<p>同样，我们也可以给<code>mqttClient:connect(mqttip,mqttport,&quot;tcp&quot;)</code>的连接加上错误次数的判断，连接错误超过五次，强制断开socket连接,等待五秒后重试：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)<span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--断开MQTT连接</span></span><br><span class="line">            mqttClient:disconnect()</span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">                link.shut()</span><br><span class="line">                retryConnectCnt=<span class="number">0</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h1 id="添加发送-接收处理函数，订阅主题"><a href="#添加发送-接收处理函数，订阅主题" class="headerlink" title="添加发送/接收处理函数，订阅主题"></a>添加发送/接收处理函数，订阅主题</h1><p>到了这一步，整个的mqtt线程只剩下<code>循环处理接收和发送的数据</code>这一部分和订阅topic部分与demo不同了，我们直接把这两部分加到mqtt线程的代码中吧：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line">                <span class="comment">--订阅主题</span></span><br><span class="line">                <span class="keyword">if</span> mqttClient:subscribe(&#123;[<span class="string">&quot;/s/test/&quot;</span>..imei]=<span class="number">0</span>&#125;) <span class="keyword">then</span></span><br><span class="line">                    <span class="comment">--循环处理接收和发送的数据</span></span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttInMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttInMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttOutMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttOutMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)<span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--断开MQTT连接</span></span><br><span class="line">            mqttClient:disconnect()</span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">                link.shut()</span><br><span class="line">                retryConnectCnt=<span class="number">0</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到，在接收和发送函数不返回false的情况下，接收和发送循环会一直进行下去；只有当两个函数之一返回false时，才会触发break导致退出该接收和发送循环</p>
<h1 id="mqttInMsgProc-mqttClient-函数"><a href="#mqttInMsgProc-mqttClient-函数" class="headerlink" title="mqttInMsgProc(mqttClient)函数"></a>mqttInMsgProc(mqttClient)函数</h1><p>这段的代码相对来说比较简单，我们可以直接使用<code>mqttClient:receive(毫秒数)</code>来接收我们的tcp消息。<br>我们在合适的地方，新建一个<code>mqttInMsgProc(mqttClient)</code>函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttInMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = mqttClient:receive(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttInMsgProc&quot;</span>,data.topic,<span class="built_in">string</span>.toHex(data.payload))</span><br><span class="line">            <span class="comment">--TODO：根据需求自行处理data.payload</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这段代码就是循环获取mqtt消息，如果没获取到，<code>mqttClient:receive(2000)</code>就会返回<code>false,&quot;timeout&quot;</code>；如果获取到了，就会返回<code>true,获取到的数据字符串</code>；如果返回了<code>false,不为&quot;timeout&quot;</code>，则表示数据处理出错，说明mqtt连接有了什么问题</p>
<p>细心的读者可能看出来了，如果接收函数一直在2秒内有接收到数据，那么这段函数会永远无限循环下去，没办法到达<code>mqttOutMsgProc(mqttClient)</code>函数进行发送数据的操作，所以我们先去讲<code>mqttOutMsgProc(mqttClient)</code>函数的实现过程，再回来改进<code>mqttInMsgProc(mqttClient)</code>函数</p>
<h1 id="mqttOutMsgProc-mqttClient-函数"><a href="#mqttOutMsgProc-mqttClient-函数" class="headerlink" title="mqttOutMsgProc(mqttClient)函数"></a>mqttOutMsgProc(mqttClient)函数</h1><p>由于发送函数在mqtt线程中是一个循环的小部分，所以我们要建立一个消息发送的队列：有要发送的发数据时，将数据放到这个队列中；等运行到<code>mqttOutMsgProc(mqttClient)</code>函数时，将队列中的数据一个一个发出去</p>
<p>首先我们要建一个放这种队列的数组，在合适位置声明一下这个数组：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--数据发送的消息队列</span></span><br><span class="line"><span class="keyword">local</span> msgQuene = &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>接着我们构造一个可以往数组里插入数据的函数，<code>table.insert()</code>可以向数组添加数据，所以我们新建一个<code>insertMsg</code>函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">insertMsg</span><span class="params">(topic,payload,qos,user)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(msgQuene,&#123;t=topic,p=payload,q=qos,user=user&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>还记得上面说过的<code>消息接收函数函数会永远无限循环下去</code>的问题吗？我们在合适的地方新建一个判断发送消息队列是否为空的函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waitForSend</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> #msgQuene &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在数组有数据时，这个函数会返回true，我们可以将<code>mqttInMsgProc(mqttClient)</code>接收到数据后的代码添加一行判断发送队列是否有数据的代码，当检测到发送队列有数据时，就立即退出接收函数，转而去进行发送动作，接收函数最终改为了这样：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttInMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = mqttClient:receive(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttInMsgProc&quot;</span>,data.topic,<span class="built_in">string</span>.toHex(data.payload))</span><br><span class="line">            <span class="comment">--TODO：根据需求自行处理data.payload</span></span><br><span class="line">            <span class="comment">--如果msgQuene中有等待发送的数据，则立即退出本循环</span></span><br><span class="line">            <span class="keyword">if</span> waitForSend() <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>最后我们终于可以开始写消息发送函数了，整体的函数就是检查队列是否为空，不为空的话就发一条消息并将其从队列中删除，然后重复这一操作，函数代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttOutMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">while</span> #msgQuene&gt;<span class="number">0</span> <span class="keyword">do</span>    <span class="comment">--数组大于零？</span></span><br><span class="line">        <span class="keyword">local</span> outMsg = <span class="built_in">table</span>.<span class="built_in">remove</span>(msgQuene,<span class="number">1</span>)<span class="comment">--取出并删除一个元素</span></span><br><span class="line">        <span class="keyword">local</span> result = mqttClient:publish(outMsg.t,outMsg.p,outMsg.q)<span class="comment">--推送对应的mqtt消息</span></span><br><span class="line">        <span class="keyword">if</span> outMsg.user <span class="keyword">and</span> outMsg.user.cb <span class="keyword">then</span>  <span class="comment">--如果存在回调函数</span></span><br><span class="line">            outMsg.user.cb(result,outMsg.user.para)<span class="comment">--执行回调函数</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>outMsg.user</code>即为消息队列数组中的，消息数组中的，包含了回调函数的，数组（反正挺绕的）</p>
</blockquote>
<blockquote>
<p>具体就像下面这样用：</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">insertMsg(<span class="string">&quot;/d/test/123&quot;</span>,<span class="string">&quot;done&quot;</span>,&#123;cb=testcb&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">testcb</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;test.testcb&quot;</span>,<span class="string">&quot;test message sent&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样，该条消息发送后就会执行指定的回调函数</p>
</blockquote>
<h1 id="完成基本的mqtt线程"><a href="#完成基本的mqtt线程" class="headerlink" title="完成基本的mqtt线程"></a>完成基本的mqtt线程</h1><p>经过上述的更改，最终，<code>mqttTest.lua</code>已经实现了连接服务器并自动处理错误的功能，并且预留了消息接收以及向发送队列添加数据的接口，文件的所有代码如下：</p>
<p>mqttTest.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;misc&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;mqtt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--测试用的服务器信息，按需求自己改</span></span><br><span class="line"><span class="keyword">local</span> mqttip,mqttport,mqttuser,mqttpassword,mqttheartbeat = <span class="string">&quot;x.x.x.x&quot;</span>,<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;user&quot;</span>,<span class="string">&quot;password&quot;</span>,<span class="number">600</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--数据发送的消息队列</span></span><br><span class="line"><span class="keyword">local</span> msgQuene = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">insertMsg</span><span class="params">(topic,payload,qos,user)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(msgQuene,&#123;t=topic,p=payload,q=qos,user=user&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waitForSend</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> #msgQuene &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttOutMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">while</span> #msgQuene&gt;<span class="number">0</span> <span class="keyword">do</span>    <span class="comment">--数组大于零？</span></span><br><span class="line">        <span class="keyword">local</span> outMsg = <span class="built_in">table</span>.<span class="built_in">remove</span>(msgQuene,<span class="number">1</span>)<span class="comment">--取出并删除一个元素</span></span><br><span class="line">        <span class="keyword">local</span> result = mqttClient:publish(outMsg.t,outMsg.p,outMsg.q)<span class="comment">--推送对应的mqtt消息</span></span><br><span class="line">        <span class="keyword">if</span> outMsg.user <span class="keyword">and</span> outMsg.user.cb <span class="keyword">then</span>  <span class="comment">--如果存在回调函数</span></span><br><span class="line">            outMsg.user.cb(result,outMsg.user.para)<span class="comment">--执行回调函数</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttInMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = mqttClient:receive(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttInMsgProc&quot;</span>,data.topic,<span class="built_in">string</span>.toHex(data.payload))</span><br><span class="line">            <span class="comment">--TODO：根据需求自行处理data.payload</span></span><br><span class="line">            <span class="comment">--如果msgQuene中有等待发送的数据，则立即退出本循环</span></span><br><span class="line">            <span class="keyword">if</span> waitForSend() <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line">                <span class="comment">--订阅主题</span></span><br><span class="line">                <span class="keyword">if</span> mqttClient:subscribe(&#123;[<span class="string">&quot;/s/test/&quot;</span>..imei]=<span class="number">0</span>&#125;) <span class="keyword">then</span></span><br><span class="line">                    <span class="comment">--循环处理接收和发送的数据</span></span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttInMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttInMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttOutMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttOutMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)<span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--断开MQTT连接</span></span><br><span class="line">            mqttClient:disconnect()</span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">                link.shut()</span><br><span class="line">                retryConnectCnt=<span class="number">0</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h1 id="实现协议需求"><a href="#实现协议需求" class="headerlink" title="实现协议需求"></a>实现协议需求</h1><h2 id="设备联网后向-d-test-设备的imei值的topic发送payload为当前设备ICCID的字符串"><a href="#设备联网后向-d-test-设备的imei值的topic发送payload为当前设备ICCID的字符串" class="headerlink" title="设备联网后向/d/test/设备的imei值的topic发送payload为当前设备ICCID的字符串"></a>设备联网后向<code>/d/test/设备的imei值</code>的topic发送payload为当前设备ICCID的字符串</h2><p>我们只需要在连接成功处添加代码即可，在<code>if mqttClient:subscribe(&#123;[&quot;/s/test/&quot;..imei]=0&#125;) then</code>所在代码下一行添加：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insertMsg(<span class="string">&quot;/d/test/&quot;</span>..misc.getImei(),sim.getIccid())</span><br></pre></td></tr></table></figure>
<h2 id="设备收到topic为-s-test-设备的imei值，payload为ok的数据后，再次向-d-test-设备的imei值的topic发送payload为done四个字节的字符串"><a href="#设备收到topic为-s-test-设备的imei值，payload为ok的数据后，再次向-d-test-设备的imei值的topic发送payload为done四个字节的字符串" class="headerlink" title="设备收到topic为/s/test/设备的imei值，payload为ok的数据后，再次向/d/test/设备的imei值的topic发送payload为done四个字节的字符串"></a>设备收到topic为<code>/s/test/设备的imei值</code>，payload为<code>ok</code>的数据后，再次向<code>/d/test/设备的imei值</code>的topic发送payload为<code>done</code>四个字节的字符串</h2><p>我们只需要在接收处理消息处添加代码即可，在<code>--TODO：根据需求自行处理data.payload</code>所在代码下一行添加：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> data.topic == <span class="string">&quot;/s/test/&quot;</span>..misc.getImei() <span class="keyword">and</span> data.payload == <span class="string">&quot;ok&quot;</span> <span class="keyword">then</span></span><br><span class="line">    insertMsg(<span class="string">&quot;/d/test/&quot;</span>..misc.getImei(),<span class="string">&quot;done&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p>经过上面的删删改改，功能以及基本实现了，整个文件的代码如下：</p>
<p>mqttTest.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;misc&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;mqtt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--测试用的服务器信息，按需求自己改</span></span><br><span class="line"><span class="keyword">local</span> mqttip,mqttport,mqttuser,mqttpassword,mqttheartbeat = <span class="string">&quot;x.x.x.x&quot;</span>,<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;user&quot;</span>,<span class="string">&quot;password&quot;</span>,<span class="number">600</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--数据发送的消息队列</span></span><br><span class="line"><span class="keyword">local</span> msgQuene = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">insertMsg</span><span class="params">(topic,payload,qos,user)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(msgQuene,&#123;t=topic,p=payload,q=qos,user=user&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waitForSend</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> #msgQuene &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttOutMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">while</span> #msgQuene&gt;<span class="number">0</span> <span class="keyword">do</span>    <span class="comment">--数组大于零？</span></span><br><span class="line">        <span class="keyword">local</span> outMsg = <span class="built_in">table</span>.<span class="built_in">remove</span>(msgQuene,<span class="number">1</span>)<span class="comment">--取出并删除一个元素</span></span><br><span class="line">        <span class="keyword">local</span> result = mqttClient:publish(outMsg.t,outMsg.p,outMsg.q)<span class="comment">--推送对应的mqtt消息</span></span><br><span class="line">        <span class="keyword">if</span> outMsg.user <span class="keyword">and</span> outMsg.user.cb <span class="keyword">then</span>  <span class="comment">--如果存在回调函数</span></span><br><span class="line">            outMsg.user.cb(result,outMsg.user.para)<span class="comment">--执行回调函数</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttInMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = mqttClient:receive(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttInMsgProc&quot;</span>,data.topic,<span class="built_in">string</span>.toHex(data.payload))</span><br><span class="line">            <span class="comment">--TODO：根据需求自行处理data.payload</span></span><br><span class="line">            <span class="keyword">if</span> data.topic == <span class="string">&quot;/s/test/&quot;</span>..misc.getImei() <span class="keyword">and</span> data.payload == <span class="string">&quot;ok&quot;</span> <span class="keyword">then</span></span><br><span class="line">                insertMsg(<span class="string">&quot;/d/test/&quot;</span>..misc.getImei(),<span class="string">&quot;done&quot;</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--如果msgQuene中有等待发送的数据，则立即退出本循环</span></span><br><span class="line">            <span class="keyword">if</span> waitForSend() <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line">                <span class="comment">--订阅主题</span></span><br><span class="line">                <span class="keyword">if</span> mqttClient:subscribe(&#123;[<span class="string">&quot;/s/test/&quot;</span>..imei]=<span class="number">0</span>&#125;) <span class="keyword">then</span></span><br><span class="line">                    insertMsg(<span class="string">&quot;/d/test/&quot;</span>..misc.getImei(),sim.getIccid())</span><br><span class="line">                    <span class="comment">--循环处理接收和发送的数据</span></span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttInMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttInMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttOutMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttOutMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)<span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--断开MQTT连接</span></span><br><span class="line">            mqttClient:disconnect()</span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">                link.shut()</span><br><span class="line">                retryConnectCnt=<span class="number">0</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h1 id="验证功能"><a href="#验证功能" class="headerlink" title="验证功能"></a>验证功能</h1><p>我没条件测试这玩意儿。。。谁有空帮我测试下的？</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/27/406/" data-id="ckkfmdgec00cpvkcg43bpb8wy" data-title="Luat系列教程：6、mqtt代码详解" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-405" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/27/405/" class="article-date">
  <time class="dt-published" datetime="2018-08-26T16:18:39.000Z" itemprop="datePublished">2018-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/27/405/">Air720模块硬件设计手册V1.03</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1><span style="font-family:Arial;font-weight:bold;font-size:15pt;">1. </span><b><span style="font-family:Calibri;font-size:15pt;"><font>绪论</font></span></b></h1>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>本文档定义了</font>Air720<font>模块及其硬件接口规范，电气特性和机械细节，通过此文档的帮助，结合我们的应用手册和用户指导书，客户可以快速应用</font><font>Air720</font><font>模块于无线应用。</font></span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">1.1. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>文档</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10pt;"><a><font>表格</font></a></span><span style="font-family:Calibri;font-size:10pt;">1</span><span style="font-family:Calibri;font-size:10pt;"><font>：相关文档</font></span></p>

<table class="MsoNormalTable"><tr><td><p><span style="font-family:Calibri;font-size:11pt;">编号</span></p></td><td><p><span style="font-family:Calibri;font-size:11pt;">文件名</span></p></td><td><p><span style="font-family:Calibri;font-size:11pt;">注释</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">1</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">Air720_AT<font>指令集详解</font></span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">已开放</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">2</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">Air720<font>参考设计</font></span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">已开放</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">3</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">Air720</span><span style="font-family:'宋体';font-size:10.5pt;"> PCB<font>封装</font></span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">已开放</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">4</span></p></td><td><p><span style="font-family:'宋体';font-size:11pt;">Luat<font>下载调试工具</font></span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">已开放</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">5</span></p></td><td><p><span style="font-family:Calibri;font-size:11pt;">L</span><span style="font-family:'宋体';font-size:11pt;">uat</span><span style="font-family:Calibri;font-size:11pt;">模块阻抗线及天线设计建议</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">已开放</span></p></td></tr></table>

<p><span style="font-family:Calibri;font-size:9pt;"><font>注意：所有文档均可在</font></span><span style="font-family:'宋体';font-size:9pt;"> </span><a target="_blank" rel="noopener" href="http://www.openluat.com/Product/Index.html"><span style="font-family:'宋体';color:rgb(128,0,128);">http://www.openluat.com/Product/Index.html</span><span style="font-family:'宋体';color:rgb(128,0,128);"> </span></a><span style="font-family:Calibri;font-size:9pt;"><font>下载</font></span></p>



<p> </p>



<p> </p>

<h1><span style="font-family:Arial;font-weight:bold;font-size:15pt;">2. </span><b><span style="font-family:Calibri;font-size:15pt;"><a><font>综述</font></a></span></b></h1>



<p><span style="font-family:Calibri;font-size:10.5pt;">Air720<font>模块是</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>一款</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>带分集接收功能的</font></span><span style="font-family:'宋体';font-size:10.5pt;">LTE-TDD/GSM<font>无线通信模块，支持</font><font>LTE-TDD</font></span><span style="font-family:'宋体';font-size:10.5pt;">/</span><span style="font-family:'宋体';font-size:10.5pt;">GPRS<font>网络连接，</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>几乎能够满足所有的</font>M2M<font>的需求，包括汽车及个人追踪服务、无线</font><font>POS</font><font>机、智能计量、工业级</font><font>PDA</font><font>以及其它</font><font>M2M</font><font>的应用。</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;">Air720<font>支持两种开发模式</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>：</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;">1. </span><span style="font-family:'宋体';font-size:10.5pt;"><font>传统的</font>AT<font>指令模式：</font><font>MCU</font><font>通过</font><font>AT</font><font>指令控制</font><font>Air720</font><font>进行网络数据传输或其他各种应用；</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;">2. </span><span style="font-family:Calibri;font-size:10.5pt;"><font>合宙特有的</font>Lua</span><span style="font-family:'宋体';font-size:10.5pt;"><font>脚本</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>二次开发模式：</font>Air720<font>拥有丰富的硬件接口及</font><font>GPIO</font><font>，可以通过</font></span><span style="font-family:'宋体';font-size:10.5pt;">L</span><span style="font-family:'宋体';font-size:10.5pt;">ua<font>脚本调用</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>由合宙官方提供的</font></span><span style="font-family:'宋体';font-size:10.5pt;">API<font>接口对外设或</font><font>GPIO</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>进行</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>编程设计，省</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>掉主控</font></span><span style="font-family:'宋体';font-size:10.5pt;">MCU<font>，</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>极大的</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>减少了客户的开发周期和成本</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>；</font></span></p>

<p><span style="font-family:'宋体';font-size:10.5pt;"><font><br /></font></span></p>



<p> </p>

<p><span style="font-family:Calibri;font-size:10pt;"><a><font>表格</font></a></span><span style="font-family:Calibri;font-size:10pt;">2</span><span style="font-family:Calibri;font-size:10pt;"><font>：模块主要特征</font></span></p>

<table class="MsoNormalTable"><tr><td><p><span style="font-family:Calibri;font-size:11pt;">特征</span></p></td><td><p><span style="font-family:Calibri;font-size:11pt;">说明</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">频段</span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">LET-TDD:B38/B39/B40/B41</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">GSM:900/1800MHZ</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">发射功率</span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">GSM900: </span><span style="font-family:Calibri;font-size:10.5pt;">Class 4 (</span><span style="font-family:'宋体';font-size:10.5pt;">33dBm+-3dB</span><span style="font-family:Calibri;font-size:10.5pt;">)</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">DCS1800:</span><span style="font-family:Calibri;font-size:10.5pt;"> Class </span><span style="font-family:'宋体';font-size:10.5pt;">1</span><span style="font-family:Calibri;font-size:10.5pt;">(</span><span style="font-family:'宋体';font-size:10.5pt;">30dBm+-3dB</span><span style="font-family:Calibri;font-size:10.5pt;">)</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">GSM900 8-PSK:</span><span style="font-family:Calibri;font-size:10.5pt;"> Class </span><span style="font-family:'宋体';font-size:10.5pt;">E2</span><span style="font-family:Calibri;font-size:10.5pt;">(</span><span style="font-family:'宋体';font-size:10.5pt;">27dBm+-3dB</span><span style="font-family:Calibri;font-size:10.5pt;">)</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">DCS1800 8-PSK:</span><span style="font-family:Calibri;font-size:10.5pt;"> Class </span><span style="font-family:'宋体';font-size:10.5pt;">E2</span><span style="font-family:Calibri;font-size:10.5pt;">(</span><span style="font-family:'宋体';font-size:10.5pt;">26dBm+-3dB</span><span style="font-family:Calibri;font-size:10.5pt;">)</span></p><p><span style="font-family:Symbol;font-size:11pt;">¨ </span><span style="font-family:'宋体';font-size:11pt;">LTE-TDD:</span><span style="font-family:'宋体';font-size:10.5pt;"> Class3(23dBm+-2dB)</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">供电</span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">VBAT 3.</span><span style="font-family:'宋体';font-size:10.5pt;">3</span><span style="font-family:Calibri;font-size:10.5pt;">V ~ 4.</span><span style="font-family:Calibri;font-size:10.5pt;">2</span><span style="font-family:Calibri;font-size:10.5pt;">V<font>，典型值</font></span><span style="font-family:Calibri;font-size:10.5pt;">3.8</span><span style="font-family:Calibri;font-size:10.5pt;">V</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:11pt;">LTE<font>特性</font></span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">最大支持<font>non-CA CAT4</font></span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">支持<font>1.4~20MHz</font><font>射频带宽</font></span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">下行支持多</span><span style="font-family:'宋体';font-size:10.5pt;">入多出</span><span style="font-family:'宋体';font-size:10.5pt;">MIMO</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">最大上行速率<font>30Mbps</font><font>，最大下行速率</font><font>110Mbps</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:11pt;">GSM<font>特性</font></span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">R99:</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">CSD<font>传输速率：</font><font>9.6kbps</font><font>，</font><font>14.4kbps</font></span></p><p><span style="font-family:'宋体';font-size:10.5pt;">GPRS:</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">支持</span><span style="font-family:Calibri;font-size:10.5pt;">GPRS multi-slot class 12</span><span style="font-family:'宋体';font-size:10.5pt;">（默认为</span><span style="font-family:Calibri;font-size:10.5pt;">12</span><span style="font-family:'宋体';font-size:10.5pt;">）</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">编码格式：</span><span style="font-family:Calibri;font-size:10.5pt;">CS-1/CS-2/CS-3</span><span style="font-family:'宋体';font-size:10.5pt;">和</span><span style="font-family:Calibri;font-size:10.5pt;">CS-4 </span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">每帧最大<font>4</font><font>个</font><font>Rx</font><font>时隙</font></span></p><p><span style="font-family:'宋体';font-size:10.5pt;">EDGE:</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">支持<font>EDGE multi-slot class 12(</font><font>默认为</font><font>12)</font></span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">支持<font>GMSK</font><font>和</font><font>8-PSK</font></span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">下行编码格式：<font>CS 1-4</font><font>和</font><font>MCS 1-9</font></span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">上行编码格式：<font>CS 1-4</font><font>和</font><font>MCS 1-9</font></span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">网路协议特性</span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">支持<font>TCP/UDP/MQTT/PPP</font><font>协议</font></span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">FTP/FTPS/NDIS/HTTP/HTTPS/SMTP/SMTPS/MMS/NTP/PING/DTMF/FILE/ NITZ/CMUX</span><span style="font-family:'宋体';font-size:10.5pt;">开发中</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:11pt;">USIM<font>卡接口</font></span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">支持</span><span style="font-family:'宋体';font-size:10.5pt;">USIM/SIM<font>卡：</font><font>1.8V</font><font>和</font><font>3V</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:11pt;">PCM<font>接口</font></span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">支持</span><span style="font-family:'宋体';font-size:10.5pt;">8<font>位</font><font>A-LAW,U-LAW</font><font>和</font><font>16</font><font>位线性编码格式</font></span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">支持长帧和短帧</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">支持主模式和从模式</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:11pt;">USB<font>接口</font></span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">兼容</span><span style="font-family:'宋体';font-size:10.5pt;">USB2.0</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">用于<font>AT</font><font>指令，数据传输，软件调试，软件升级</font></span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">串口</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">主串口：</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">由于<font>AT</font><font>命令和数据传输</font></span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">最大波特率<font>3000000bps</font><font>，默认</font><font>115200bps</font></span></p><p><span style="font-family:'宋体';font-size:10.5pt;">调试串口</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">由于调试信息输出，软件下载</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">波特率<font>115200bps</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:11pt;">RX<font>分集</font></span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">支持<font>LTE Rx</font><font>分集</font></span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">天线接口</span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">主天线</span><span style="font-family:'宋体';font-size:10.5pt;">、</span><span style="font-family:Calibri;font-size:10.5pt;">分集天线</span><span style="font-family:'宋体';font-size:10.5pt;">，</span><span style="font-family:Calibri;font-size:10.5pt;">特性阻抗</span><span style="font-family:'宋体';font-size:10.5pt;">50<font>欧姆</font></span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">物理特性</span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">尺寸</span><span style="font-family:'宋体';font-size:10.5pt;">：<font>32</font></span><span style="font-family:'宋体';font-size:10.5pt;">mm*</span><span style="font-family:'宋体';font-size:10.5pt;">29</span><span style="font-family:'宋体';font-size:10.5pt;">mm*</span><span style="font-family:'宋体';font-size:10.5pt;">2.4mm</span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">重量：约<font>5g</font></span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">温度范围</span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">正常工作温度</span><span style="font-family:'宋体';font-size:10.5pt;">:-35<font>°</font><font>C~+75</font><font>°</font><font>C</font></span></p><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">极限工作稳定<font>: -40</font><font>°</font><font>C~+85</font><font>°</font><font>C</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:11pt;">R</span><span style="font-family:'宋体';font-size:11pt;">oHS</span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">所有器件完全符合<font>R</font></span><span style="font-family:'宋体';font-size:10.5pt;">oHS</span><span style="font-family:'宋体';font-size:10.5pt;">标准</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">封装</span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">144<font>个管脚，其中</font><font>80</font><font>个为</font><font>LCC</font><font>管脚，</font><font>64</font><font>个为</font><font>LGA</font><font>管脚</font></span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">省电模式耗流</span></p></td><td><p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">TBD</span></p></td></tr></table>

<p><b> </b></p>





<p> </p>



<p> </p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">2.1. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>功能图</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>下图为</font>Air720<font>功能框图，阐述了其主要功能：</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>存储器</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>射频</font></span><span style="font-family:'宋体';font-size:11pt;"><font>部分</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>电源管理</font></span></p>



<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>接口部分</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font><br /></font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-kTN7AxwA5b82d2d342597.png" class="img-responsive" style="width:468.5px;" alt="attachments-2018-08-kTN7AxwA5b82d2d342597.png" /><span style="font-family:Calibri;font-size:10.5pt;"><font><br /></font></span></p>

<p><br /></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">2.2. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>评估板</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>为了有助于测试及使用</font>Air720<font>，合宙提供一套评估板。评估板包括</font><font>Air720</font><font>模块、</font><font>EVB</font></span><span style="font-family:Calibri;font-size:10.5pt;">_</span><span style="font-family:Calibri;font-size:10.5pt;">Air720<font>、</font><font>UART</font><font>转</font><font>USB</font><font>线等。</font></span></p>

<h1><span style="font-family:Arial;font-weight:bold;font-size:15pt;">3. </span><b><span style="font-family:Calibri;font-size:15pt;"><font>应用接口</font></span></b></h1>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>模块采用</font>LCC<font>封装，</font></span><span style="font-family:Calibri;font-size:10.5pt;">38</span><span style="font-family:Calibri;font-size:10.5pt;"><font>个</font>SMT<font>焊盘管脚，</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>以下</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>章节</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>将</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>详细阐述</font></span><span style="font-family:'宋体';font-size:10.5pt;">Air720<font>各</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>接口的功能</font></span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3</span><span style="font-family:Arial;font-weight:bold;font-size:14pt;">.1. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>管脚描述</font></span></b></h2>

<h2><img src="http://oldask.openluat.com/image/show/attachments-2018-08-TmZLsdzK5b82d3119add2.png" class="img-responsive" style="width:318.5px;" alt="attachments-2018-08-TmZLsdzK5b82d3119add2.png" /><img src="http://oldask.openluat.com/image/show/attachments-2018-08-tHOzU8MQ5b82d3172567a.png" class="img-responsive" style="width:363px;" alt="attachments-2018-08-tHOzU8MQ5b82d3172567a.png" /></h2>

<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">3</span><span style="font-family:Calibri;font-size:10pt;"><font>：</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>管脚描述</font></span></p>

<table class="MsoNormalTable"><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">电源</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">VBAT</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">59,60,57,58</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">PI</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">模块主电源<font>VBAT=3.</font></span><span style="font-family:'宋体';font-size:9pt;">3</span><span style="font-family:Calibri;font-size:9pt;">V~4.</span><span style="font-family:Calibri;font-size:9pt;">2</span><span style="font-family:Calibri;font-size:9pt;">V</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">Vmax= 4.</span><span style="font-family:Calibri;font-size:9pt;">2</span><span style="font-family:Calibri;font-size:9pt;">V</span></p><p><span style="font-family:Calibri;font-size:9pt;">Vmin=3.</span><span style="font-family:'宋体';font-size:9pt;">3</span><span style="font-family:Calibri;font-size:9pt;">V</span></p><p><span style="font-family:Calibri;font-size:9pt;">Vnorm=</span><span style="font-family:Calibri;font-size:9pt;">3.8</span><span style="font-family:Calibri;font-size:9pt;">V</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">模块在突发模式下的最大负载电流有<font>1.</font></span><span style="font-family:'宋体';font-size:9pt;">8</span><span style="font-family:Calibri;font-size:9pt;">A</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">VDD</span><span style="font-family:'宋体';font-size:9pt;">_EXT</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">7</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">PO</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">输出 </span><span style="font-family:'宋体';font-size:9pt;">1</span><span style="font-family:Calibri;font-size:9pt;">.8V<font>，</font></span><span style="font-family:'宋体';font-size:9pt;">50</span><span style="font-family:Calibri;font-size:9pt;">mA</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">Vmax=</span><span style="font-family:'宋体';font-size:9pt;">1.8</span><span style="font-family:Calibri;font-size:9pt;">V</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">1.<font>如果不用则悬空</font></span></p><p><span style="font-family:Calibri;font-size:9pt;">2.<font>如果用这个管脚给外部供电，推荐并联一个</font><font>2~4.7uF</font><font>的去耦电容</font></span><span style="font-family:Calibri;font-size:9pt;">，负载电流不要超过</span><span style="font-family:'宋体';font-size:9pt;">5</span><span style="font-family:Calibri;font-size:9pt;">0mA</span></p><p> </p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">GND</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">8,9,19,22,36,46,48,50~54,56,72,85~112</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">GND</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">模块地</span></p></td><td><p> </p></td><td><p> </p></td></tr><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">开机键</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">PWRKEY</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">21</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">I</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">内部上拉，把管脚拉低</span><span style="font-family:'宋体';font-size:9pt;">1</span><span style="font-family:Calibri;font-size:9pt;">s<font>以上模块开机</font></span><span style="font-family:'宋体';font-size:9pt;">；把管脚拉低<font>1.5s</font><font>以上模块关机</font></span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:9pt;">VBAT<font>电压域</font></span></p></td></tr><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">模块网络指示</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">NET_</span><span style="font-family:'宋体';font-size:9pt;">STATUS</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">64</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">6</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">O</span></p><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">网络状态指示</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.35v</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=</span><span style="font-family:'宋体';font-size:9pt;">0.45v</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">不用则悬空</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">NET_MODE</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">65</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">5</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">O</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">网络注册状态指示</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.35v</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=</span><span style="font-family:'宋体';font-size:9pt;">0.45v</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">不用则悬空</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">STATUS</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">79</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">61</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">O</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">模块运行状态指示</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.35v</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=</span><span style="font-family:'宋体';font-size:9pt;">0.45v</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">不用则悬空</span></p></td></tr><tr><td><p><b><span style="font-family:'宋体';font-size:11pt;">USB<font>接口</font></span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">USB_VBUS</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">71</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">I</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">USB<font>插入检测</font></span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">Vmax=</span><span style="font-family:'宋体';font-size:9pt;">5.25V</span></p><p><span style="font-family:Calibri;font-size:9pt;">Vmin=</span><span style="font-family:'宋体';font-size:9pt;">3.0V</span></p><p><span style="font-family:Calibri;font-size:9pt;">V</span><span style="font-family:'宋体';font-size:9pt;">nom</span><span style="font-family:Calibri;font-size:9pt;">=</span><span style="font-family:'宋体';font-size:9pt;">5.0V</span></p></td><td><p> </p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">USB_DP</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">69</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">IO</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">USB<font>差分数据</font><font>+</font></span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">USB2.0</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">90<font>欧姆差分阻抗控制</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">USB_DM</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">70</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">IO</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">USB<font>差分数据</font><font>-</font></span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">USB2.0</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">90<font>欧姆差分阻抗控制</font></span></p></td></tr><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">主串口</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">TXD</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">58</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">67</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">O</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">模块发送数据</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">VILmin=-0.3V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VILmax=</span><span style="font-family:'宋体';font-size:9pt;">0.45V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.2V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmax=</span><span style="font-family:'宋体';font-size:9pt;">2.0V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.35V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=</span><span style="font-family:'宋体';font-size:9pt;">0.45V</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">1.8V<font>电压域，不用则悬空</font></span></p><p> </p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">RXD</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">57</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">9</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">I</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">模块接收数据</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">R</span><span style="font-family:Calibri;font-size:9pt;">TS</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">55</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">6</span><span style="font-family:'宋体';font-size:9pt;">4</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">O</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">清除发送</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">C</span><span style="font-family:Calibri;font-size:9pt;">TS</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">59</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">) </span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">65</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">I</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">DTE<font>请求发送数据给模块</font></span></p></td></tr><tr><td><p><b><span style="font-family:'宋体';font-size:11pt;">调试串口</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">DBG_TXD</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">52</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">12</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">O</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">模块数据收发</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">VILmin=-0.3V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VILmax=</span><span style="font-family:'宋体';font-size:9pt;">0.45V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.2V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmax=</span><span style="font-family:'宋体';font-size:9pt;">2.0V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.35V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=</span><span style="font-family:'宋体';font-size:9pt;">0.45V</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">1.8V<font>电压域，不用则悬空</font></span></p><p> </p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">DBG_RXD</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_5</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">1</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">11</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">I</span></p></td></tr><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">I2C</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">I2C</span><span style="font-family:Calibri;font-size:9pt;">_</span><span style="font-family:'宋体';font-size:9pt;">SCL</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">53</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">41</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">O</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">I2C<font>接口，使用时需要外加上拉电阻</font></span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:9pt;">内部集成<font>1.8V</font><font>上拉。</font></span><span style="font-family:Calibri;font-size:9pt;">不用则悬空</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">I2C_SDA</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">54</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">42</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">O</span></p></td></tr><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">SPI</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">PCM_IN</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">28</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">24</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">I</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">PCM</span><span style="font-family:Calibri;font-size:9pt;"> 接口</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">VILmin=-0.3V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VILmax=</span><span style="font-family:'宋体';font-size:9pt;">0.6V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.2V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmax=</span><span style="font-family:'宋体';font-size:9pt;">2.0V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.35V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=</span><span style="font-family:'宋体';font-size:9pt;">0.45V</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">这<font>4</font><font>个</font><font>GPIO</font><font>的电压域是</font><font>VMMC</font><font>，如果要使用这</font><font>4</font><font>个</font><font>GPIO</font><font>，必须先打开</font><font>VMMC</font><font>；</font></span></p><p> </p><p><span style="font-family:Calibri;font-size:9pt;">不用则悬空；</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">PCM_OUT</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">27</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">25</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">O</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">PCM_SUNC</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">26</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">26</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">I</span><span style="font-family:Calibri;font-size:9pt;">O</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">PCM_CLK</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">25</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">27</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">I</span><span style="font-family:'宋体';font-size:9pt;">O</span></p></td></tr><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">SIM<font>卡接口</font></span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">USIM_GND</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">10</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:9pt;">USIM<font>卡专用地</font></span><span style="font-family:Calibri;font-size:9pt;"> </span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">模块自动选择<font>1.8V</font><font>或</font><font>3.0V</font></span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">模块</span><span style="font-family:Calibri;font-size:9pt;">自动识别</span><span style="font-family:'宋体';font-size:9pt;">1.8V<font>或</font><font>3.0V USIM</font><font>卡</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">USIM_VDD</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">14</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">P</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">USIM<font>卡供电</font></span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">3V:</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=0.36</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=0.9×SIM_VDD</span></p><p><span style="font-family:Calibri;font-size:9pt;">1.8V:</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=0.2×SIM_VDD</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=0.9×SIM_VDD</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">U</span><span style="font-family:Calibri;font-size:9pt;">SIM_DAT</span><span style="font-family:'宋体';font-size:9pt;">A</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">15</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">I/O</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">U</span><span style="font-family:Calibri;font-size:9pt;">SIM<font>卡数据线</font></span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">3V<font>：</font></span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=0.4</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin= SIM_VDD-0.4</span></p><p><span style="font-family:Calibri;font-size:9pt;">1.8V<font>：</font></span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=0.15×SIM_VDD</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=SIM_VDD-0.4</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">U</span><span style="font-family:Calibri;font-size:10.5pt;">SIM_CLK</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">16</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">O</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">U</span><span style="font-family:Calibri;font-size:9pt;">SIM<font>卡时钟线</font></span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">3V<font>：</font></span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=0.4</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=0.9×SIM_VDD</span></p><p><span style="font-family:Calibri;font-size:9pt;">1.8V<font>：</font></span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=0.12×SIM_VDD</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=0.9×SIM_VDD</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">USIM_RST</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">17</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">O</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">USIM<font>卡复位线</font></span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">3V<font>：</font></span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=0.4</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=0.9×SIM_VDD</span></p><p><span style="font-family:Calibri;font-size:9pt;">1.8V<font>：</font></span></p><p><span style="font-family:Calibri;font-size:9pt;">VOLmax=0.12×SIM_VDD</span></p><p><span style="font-family:Calibri;font-size:9pt;">VOHmin=0.9×SIM_VDD</span></p></td><td><p> </p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">USIM_PRESENCE</span></p><p><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">(GPIO_</span><span style="font-family:'宋体';color:rgb(255,0,0);font-size:9pt;">23</span><span style="font-family:Calibri;color:rgb(255,0,0);font-size:9pt;">)</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">13</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">I</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">USIM<font>卡在位检测</font></span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">VILmin=-0.3V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VILmax=</span><span style="font-family:'宋体';font-size:9pt;">0.6V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.2V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmax=</span><span style="font-family:'宋体';font-size:9pt;">2.0V</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">不用则悬空</span></p></td></tr><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">A</span></b><b><span style="font-family:Calibri;font-size:11pt;">DC</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">ADC0</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">45</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">I</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">模数转换器</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">输入范围<font>0~1.</font></span><span style="font-family:'宋体';font-size:9pt;">4</span><span style="font-family:Calibri;font-size:9pt;">V</span></p><p><span style="font-family:Calibri;font-size:9pt;">1</span><span style="font-family:'宋体';font-size:9pt;">2</span><span style="font-family:Calibri;font-size:9pt;">bit</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">不用则悬空</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">ADC1</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">44</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">I</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">模数转换器</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">输入范围<font>0~1.</font></span><span style="font-family:'宋体';font-size:9pt;">4</span><span style="font-family:Calibri;font-size:9pt;">V</span></p><p><span style="font-family:Calibri;font-size:9pt;">1</span><span style="font-family:'宋体';font-size:9pt;">2</span><span style="font-family:Calibri;font-size:9pt;">bit</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">不用则悬空</span></p></td></tr><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">射频接口</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">ANT</span><span style="font-family:'宋体';font-size:9pt;">_DIV</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">35</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">I/O</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">分集天线接口</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">50<font>欧姆特性阻抗</font></span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">不用则悬空</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">ANT</span><span style="font-family:'宋体';font-size:9pt;">_MAIN</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">49</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">主天线接口</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">50<font>欧姆特性阻抗</font></span></p></td><td><p> </p></td></tr><tr><td><p><b><span style="font-family:'宋体';font-size:11pt;">GPIO</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">WAKEUP_IN</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">1</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">I</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">唤醒模块</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">VILmin=-0.3V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VILmax=</span><span style="font-family:'宋体';font-size:9pt;">0.6V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.2V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmax=</span><span style="font-family:'宋体';font-size:9pt;">2.0V</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">拉低</span><span style="font-family:Calibri;font-size:9pt;">唤醒模块</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">W_DISABLE#</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">4</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">I</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">飞行模式控制</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">VILmin=-0.3V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VILmax=</span><span style="font-family:'宋体';font-size:9pt;">0.6V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.2V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmax=</span><span style="font-family:'宋体';font-size:9pt;">2.0V</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">低电平模块进入飞行模式</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">AP_READY</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">2</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">I</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">MCU<font>睡眠状态检测</font></span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">VILmin=-0.3V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VILmax=</span><span style="font-family:'宋体';font-size:9pt;">0.6V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmin=</span><span style="font-family:'宋体';font-size:9pt;">1.2V</span></p><p><span style="font-family:Calibri;font-size:9pt;">VIHmax=</span><span style="font-family:'宋体';font-size:9pt;">2.0V</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">不用则悬空</span></p></td></tr><tr><td><p><b><span style="font-family:'宋体';font-size:11pt;">保留管脚</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚名</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚号</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">I/O</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">管脚描述</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">电气特性</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">备注</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">TBD</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:9pt;">I</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">保留管脚</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:9pt;">不要连接，保持悬空</span></p></td></tr></table>

<p><b> </b></p>



<p><b> </b></p>



<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.2. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>工作模式</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>下表简要的叙述了接下来几章提到的各种工作模式。</font></span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.3. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>电源供电</font></span></b></h2>



<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.3.1. </span><b><span style="font-family:Calibri;font-size:12pt;"><font>模块电源工作特性</font></span></b></h3>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>在模块应用设计中，电源设计是很重要的一部分。由于</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>射频</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>发射时会在短时间有一个较大电流的的突发脉冲。在突发脉冲阶段内，电源必须能够提供高的峰值电流</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>，</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>不然就会引起供电电压的跌落</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>，</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>跌落情况在</font></span><span style="font-family:'宋体';font-size:10.5pt;">2G<font>网络下比较明显，</font><font>3G</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>和</font></span><span style="font-family:'宋体';font-size:10.5pt;">4G<font>会比</font><font>2G</font><font>跌落小。</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-96IMHAmm5b82d4847edd9.png" class="img-responsive" style="width:325px;" alt="attachments-2018-08-96IMHAmm5b82d4847edd9.png" /><span style="font-family:'宋体';font-size:10.5pt;"><font><br /></font></span></p>







<p><br /></p>

<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.3.2. </span><b><span style="font-family:Calibri;font-size:12pt;"><font>减小电压跌落</font></span></b></h3>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>模块电源</font>VBAT<font>电压输入范围为</font><font>3.</font></span><span style="font-family:'宋体';font-size:10.5pt;">3</span><span style="font-family:Calibri;font-size:10.5pt;">V~4.2V<font>，但是模块在射频发射时通常会在</font><font>VBAT</font><font>电源上产生电源电压跌落现象，这是由于电源</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>或者</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>走线路径上的阻抗导致，一般难以避免。因此在设计上要特别注意模块的电源设计，。在</font>VBAT<font>输入端，建议并联一个低</font><font>ESR(ESR=0.7</font></span><span style="font-family:Calibri;font-size:10.5pt;">Ω</span><span style="font-family:Calibri;font-size:10.5pt;">)<font>的</font><font>100uF</font><font>的钽电容，以及</font><font>100nF</font><font>、</font><font>33pF</font><font>、</font><font>10pF</font><font>滤波电容（</font><font>0603</font><font>封装），</font><font>VBAT</font><font>输入端参考电路如图</font><font>4</font><font>所示。并且建议</font><font>VBAT</font><font>的</font><font>PCB</font><font>走线尽量短且足够宽，减小</font><font>VBAT</font><font>走线的等效阻抗，确保在最大发射功率时大电流下不会产生太大的电压跌落。建议</font><font>VBAT</font><font>走线宽度不少于</font><font>2mm</font><font>，并且走线越长，线宽越宽。</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font><br /></font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font><br /></font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-EpA39SsW5b82d50f8ab7c.png" class="img-responsive" style="width:179.5px;" alt="attachments-2018-08-EpA39SsW5b82d50f8ab7c.png" /></p>

<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.3.3. </span><b><span style="font-family:Calibri;font-size:12pt;"><font>供电参考电路</font></span></b></h3>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>电源设计对模块的供电至关重要，必须选择能够提供至少</font>2A<font>电流能力的电源。若输入电压跟模块的供电电压的压差不是很大，建议选择</font><font>LDO</font><font>作为供电电源。若输入输出之间存在比较大的压差，则使用开关电源转换器。</font></span></p>

<p><b><span style="font-family:Calibri;font-size:11pt;">LDO<font>供电：</font></span></b></p>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>下图是</font>5V<font>供电的参考设计，采用了</font><font>Micrel</font><font>公司的</font><font>LDO</font><font>，型号为</font><font>MIC29302WU</font><font>。它的输出电压是</font><font>4.16V</font><font>，负载电流峰值到</font><font>3A</font><font>。为确保输出电源的稳定，建议在输出端预留一个稳压管，并且靠近模块</font><font>VBAT</font><font>管脚摆放。建议选择反向击穿电压为</font><font>5.1V</font><font>，耗散功率为</font><font>1W</font><font>以上的稳压管。</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-6dONjz9r5b82d58d6e5f3.png" class="img-responsive" style="width:480px;" alt="attachments-2018-08-6dONjz9r5b82d58d6e5f3.png" /></p>

<p><b><span style="font-family:Calibri;font-size:11pt;">DCDC<font>供电：</font></span></b></p>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>下图是</font>DCDC<font>开关电源的参考设计，采用的是杰华特公司的</font><font>JW5033</font></span><span style="font-family:'宋体';font-size:10.5pt;">S</span><span style="font-family:Calibri;font-size:10.5pt;"> <font>开关电源芯片，它的最大输出电流在</font>2A<font>，同时输入电压范围</font><font>4.7V~20V</font><font>。注意</font><font>C25</font><font>的选型要根据输入电压来选择耐压值。</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-gwsJlRJn5b82d5c0b36b0.png" class="img-responsive" style="width:640.5px;" alt="attachments-2018-08-gwsJlRJn5b82d5c0b36b0.png" /></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.4. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>开关机</font></span></b></h2>



<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.4.1. </span><b><span style="font-family:Calibri;font-size:12pt;"><font>开机</font></span></b></h3>



<p><span style="font-family:Calibri;font-size:10.5pt;">Air720<font>模块可以通过</font><font>PWRKEY</font><font>管脚开机。关机状态下长按开机键</font><font>2s</font><font>以上，模块会进入开机流程，软件会检测</font><font>VBAT</font><font>管脚电压若</font><font>VBAT</font><font>管脚电压大于软件设置的开机电压（默认</font><font>3.55V</font><font>），会继续开机动作直至系统开机完成；否则，会停止执行开机动作，系统会关机。</font></span></p>



<p> </p>

<p><b><span style="font-family:Calibri;font-size:10.5pt;">3.4.1.1</span></b><b><span style="font-family:Calibri;font-size:10.5pt;">PWRKEY<font>管脚开机</font></span></b></p>







<p><span style="font-family:Calibri;font-size:10.5pt;">VBAT<font>上电后，</font><font>PWRKEY</font><font>管脚可以启动模块，把</font><font>PWRKEY</font><font>管脚拉低持续</font></span><span style="font-family:'宋体';font-size:10.5pt;">1</span><span style="font-family:Calibri;font-size:10.5pt;">s<font>之后开机，开机成功后</font><font>PWRKEY</font><font>管脚可以释放。可以通过检测</font><font>VDDIO</font><font>管脚的电平来判别模块是否开机。推荐使用开集驱动电路来控制</font><font>PWRKEY</font><font>管脚。下图为参考电路：</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-oCCuygQG5b82d60b8e305.png" class="img-responsive" style="width:347.5px;" alt="attachments-2018-08-oCCuygQG5b82d60b8e305.png" /></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>另一种控制</font>PWRKEY<font>管脚的方法是直接使用一个按钮开关。按钮附近需放置一个 </font><font>TVS</font><font>管用以</font><font>ESD</font><font>保护。下图为参考电路：</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-z927uAuu5b82d62b790fe.png" class="img-responsive" style="width:200.5px;" alt="attachments-2018-08-z927uAuu5b82d62b790fe.png" /></p>

<p><b><span style="font-family:Calibri;font-size:10.5pt;"><font>3.4.1.2 上电</font></span></b><b><span style="font-family:Calibri;font-size:10.5pt;"><font>开机</font></span></b></p>





<p><span style="font-family:Calibri;font-size:11pt;"><font>将</font></span><span style="font-family:Calibri;font-size:10.5pt;">PWRKEY<font>管脚直接接地可以实现上电自动开机功能。需要注意，在上电开机模式下，将无法关机，只要</font><font>VBAT</font><font>管脚的电压大于开机电压即使软件调用关机接口，模块仍然会再开机起来。另外，在此模式下，要想成功开机起来</font><font>VBAT</font><font>管脚电压任然要大于软件设定的开机电压值，如果不满足，模块会关闭，就会出现反复开关机的情况。</font></span></p>

<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.4.2. </span><b><span style="font-family:Calibri;font-size:12pt;"><font>关机</font></span></b></h3>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>以下的方式可以关闭模块：</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>正常关机：使用</font>PWRKEY<font>管脚关机</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;"><font>正常关机：通过</font>AT<font>指令</font><font>AT+</font></span><span style="font-family:'宋体';font-size:10.5pt;">C</span><span style="font-family:'宋体';font-size:10.5pt;">POWD<font>关机</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>低压自动关机：模块检测到低压时关机</font></span></p>

<p><b><span style="font-family:Calibri;font-size:10.5pt;">3.4.2.1 </span></b><b><span style="font-family:Calibri;font-size:10.5pt;">PWRKEY<font>管脚关机</font></span></b></p>



<p><span style="font-family:Calibri;font-size:10.5pt;">PWRKEY<font>管脚拉低</font></span><span style="font-family:'宋体';font-size:10.5pt;">1.5</span><span style="font-family:Calibri;font-size:10.5pt;">s<font>以上时间，模块会执行关机动作。</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>关机过程中，模块需要注销网络，注销时间与当前网络状态有关，经测定用时约</font>2s~12s<font>，因此建议延长</font><font>12s</font><font>后再进行断电或重启，以确保在完全断电之前让软件保存好重要数据。</font></span></p>

<p><b><span style="font-family:Calibri;font-size:10.5pt;">3.4.2.2 </span></b><b><span style="font-family:Calibri;font-size:10.5pt;"><font>低电压自动关机</font></span></b></p>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>模块在运行状态时当</font>VBAT<font>管脚电压低于软件设定的关机电压时（默认设置</font><font>3.4V</font><font>），软件会执行关机动作关闭模块，以防低电压状态下运行出现各种异常。</font></span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.5. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>省电技术</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>根据系统需求，有两种方式可以使模块进入到低功耗的状态。对于</font>AT<font>版本使用</font><font>“AT+CFUN”</font><font>命令可以使模块进入最少功能状态。</font><font>Luat</font><font>版本调用</font><font>misc.setflymode(true)</font><font>进入飞行模式，调用</font><font>misc.setflymode(false)</font><font>退出飞行模式</font></span></p>

<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.5.1. </span><b><span style="font-family:Calibri;font-size:12pt;"><font>最少功能模式</font></span></b></h3>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>最少功能模式可以将模块功能减少到最小程度，此模式可以通过发送</font>“AT+CFUN=”<font>命令来设置。</font><font>参数可以选择</font><font>0</font><font>，</font><font>1</font><font>，</font><font>4</font><font>。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">0<font>：最少功能（关闭</font><font>RF</font><font>和</font><font>SIM</font><font>卡）；</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">1<font>：全功能（默认）；</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">4<font>：关闭</font><font>RF</font><font>发送和接收功能；</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>如果使用</font>“AT+CFUN=0”<font>将模块设置为最少功能模式，射频部分和</font><font>SIM</font><font>卡部分的功能将会关闭。而串口依然有效，但是与射频部分以及</font><font>SIM</font><font>卡部分相关的</font><font>AT</font><font>命令则不可用。</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>如果使用</font>“AT+CFUN=4”<font>设置模块，</font><font>RF</font><font>部分功能将会关闭，而串口依然有效。所有与</font><font>RF</font><font>部分相关的</font><font>AT</font><font>命令不可用。</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>模块通过</font>“AT+CFUN=0”<font>或者</font><font>“AT+CFUN=4”</font><font>设置以后，可以通过</font><font>“AT+CFUN=1”</font><font>命令设置返回到全功能状态。</font></span></p>

<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.5.2. </span><b><span style="font-family:Calibri;font-size:12pt;"><font>睡眠模式（慢时钟模式）</font></span></b></h3>



<p><span style="font-family:Calibri;font-size:10.5pt;">Air720<font>支持睡眠模式，对于</font><font>AT</font><font>版本，通过</font></span><span style="font-family:'宋体';font-size:10.5pt;">WAKEUP_IN</span><span style="font-family:Calibri;font-size:10.5pt;"> pin<font>脚来控制休眠，</font></span><span style="font-family:'宋体';font-size:10.5pt;">WAKEUP_IN</span><span style="font-family:Calibri;font-size:10.5pt;"><font>高电平时允许模块休眠，当</font></span><span style="font-family:'宋体';font-size:10.5pt;">WAKEUP_IN</span><span style="font-family:Calibri;font-size:10.5pt;"><font>为高时，模块在没有动作的情况下会在</font>30s<font>左右进入休眠模式；</font><font>DTR</font><font>由高电平变为低电平时将模块唤醒，同时，主串口连续发送</font><font>AT</font><font>指令也可以唤醒模块，但是前面一些</font><font>AT</font><font>指令会丢失。</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>对于</font>Luat<font>版本一般情况下，用户是不需要写代码去控制进入或者退出休眠状态，系统自动控制进入和退出休眠</font></span></p>

<p><span style="font-family:'宋体';color:rgb(255,0,0);font-size:10.5pt;"><font>注意：</font>AT<font>版本默认状态不会进入休眠，需要发指令</font><font>AT+CSCLK=1</font><font>或</font><font>AT+CSCLK=2</font><font>才能是模块进入休眠。详细请参考《</font><font>AirM2M</font><font>无线模块</font><font>AT</font><font>命令手册》</font></span></p>



<p> </p>

<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.5.3. </span><b><span style="font-family:Calibri;font-size:12pt;"><font>睡眠唤醒</font></span></b></h3>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>当模块处于睡眠模式，以下方法可以唤醒模块。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">AT<font>版本将</font></span><span style="font-family:'宋体';font-size:10.5pt;">WAKEUP_IN</span><span style="font-family:Calibri;font-size:10.5pt;"><font>管脚拉低可以唤醒模块。</font></span><span style="font-family:'宋体';font-size:10.5pt;">WAKEUP_IN</span><span style="font-family:Calibri;font-size:10.5pt;"><font>管脚拉低</font>20ms<font>后，串口被激活。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">GPIO<font>中断。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>接收来电或者</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>网络</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>数据以唤醒模块。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>接收短信以唤醒模块。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span></p>



<p> </p>



<p> </p>



<p> </p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.6. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>模式切换汇总</font></span></b></h2>

<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">5</span><span style="font-family:Calibri;font-size:10pt;"><font>：模式切换汇总</font></span></p>

<table class="MsoNormalTable"><tr><td><p><span style="font-family:Calibri;font-size:11pt;">当前模式</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:11pt;">下一模式</span></p></td></tr><tr><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">关机</span></p></td><td><p><span style="font-family:Calibri;font-size:11pt;">正常模式</span></p></td><td><p><span style="font-family:Calibri;font-size:11pt;">睡眠模式</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">关机</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">使用<font>PWRKEY</font><font>开机</font></span></p></td><td><p> </p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">正常模式</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">使用<font>PWRKEY</font><font>管脚，或</font><font>VBAT</font><font>电压低于关机电压</font></span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">软件调用睡眠接口，<font>AT</font><font>版本不做动作</font><font>30s</font><font>自动休眠</font></span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:11pt;">睡眠模式</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">使用<font>PWRKEY</font><font>或</font><font>VBAT</font><font>电压低于关机电压</font></span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">GPIO<font>管脚中断、定时器、接收短信或</font></span><span style="font-family:'宋体';font-size:9pt;">网络</span><span style="font-family:Calibri;font-size:9pt;">数据</span></p></td><td><p> </p></td></tr></table>



<p> </p>

<p><span style="font-family:Calibri;font-size:10pt;"><font><br /></font></span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.7. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>串口</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>模块提供了两个通用异步收发器：主串口</font>UART</span><span style="font-family:'宋体';font-size:10.5pt;">2</span><span style="font-family:Calibri;font-size:10.5pt;"><font>和</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>调试</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>串口。模块支持固定波特率和自适应波特率。自适应波特率支持范围</font>4800bps<font>到</font><font>115200bps</font><font>。</font></span></p>



<p> </p>

<p><span style="font-family:Calibri;font-size:11pt;"><font>主串口</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">TXD<font>：发送数据到</font><font>DTE</font><font>设备的</font><font>RXD</font><font>端</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">RXD<font>：从</font><font>DTE</font><font>设备</font><font>TXD</font><font>端接收数据</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">RTS<font>：</font><font>DTE</font><font>请求发送数据给</font><font>DCE</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">CTS<font>：清除发送</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>在默认情况下，模块的硬件流控是关闭的。当客户需要硬件流控时，管脚</font></span><b><span style="font-family:Calibri;font-size:10.5pt;">RTS,CTS</span></b><span style="font-family:Calibri;font-size:10.5pt;"><font>必须连接到客户端，</font></span><b><span style="font-family:Calibri;font-size:10.5pt;">AT</span></b><span style="font-family:Calibri;font-size:10.5pt;"><font>命令</font></span><b><span style="font-family:Calibri;font-size:10.5pt;">“AT+IFC=2,2”</span></b><span style="font-family:Calibri;font-size:10.5pt;"><font>可以用来打开硬件流控。</font></span><b><span style="font-family:Calibri;font-size:10.5pt;">AT</span></b><span style="font-family:Calibri;font-size:10.5pt;"><font>命令</font></span><b><span style="font-family:Calibri;font-size:10.5pt;">“AT+IFC=0,0”</span></b><span style="font-family:Calibri;font-size:10.5pt;"><font>可以用来关闭流控。具体请参考</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>《</font>AirM2M<font>无线模块</font><font>AT</font><font>命令手册》</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>。</font></span></p>



<p> </p>

<p><span style="font-family:'宋体';font-size:11pt;"><font>调试</font></span><span style="font-family:Calibri;font-size:11pt;"><font>串口</font></span></p>



<p> </p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">DBG</span><span style="font-family:Calibri;font-size:10.5pt;">_TXD<font>：发送数据到</font><font>DTE</font><font>的串口</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;">DBG</span><span style="font-family:Calibri;font-size:10.5pt;">_RXD<font>：从</font><font>DTE</font><font>的串口接收数据</font></span></p>



<p> </p>



<p> </p>

<p><font><span style="font-size:13.3333px;">表格6：串口管脚定义</span></font></p>

<p><font><span style="font-size:13.3333px;">接口名称管脚作用</span></font></p>

<p><font><span style="font-size:13.3333px;">主串口</span></font></p>

<p><font><span style="font-size:13.3333px;">UART2TXD67串口发送数据</span></font></p>

<p><font><span style="font-size:13.3333px;">RXD68串口接收数据</span></font></p>

<p><font><span style="font-size:13.3333px;">RTS64DTE请求发送数据给DCE</span></font></p>

<p><font><span style="font-size:13.3333px;">CTS65清除发送</span></font></p>

<p><font><span style="font-size:13.3333px;">辅串口</span></font></p>

<p><font><span style="font-size:13.3333px;">UART1DBG_RXD11串口接收数据</span></font></p>

<p><font><span style="font-size:13.3333px;">DBG _TXD12串口发送数据</span></font></p>

<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.7.1. </span><b><span style="font-family:Calibri;font-size:12pt;"><font>主串口</font></span></b></h3>



<p><b><span style="font-family:Calibri;font-size:10.5pt;">3.7.1.1</span></b><b><span style="font-family:Calibri;font-size:10.5pt;"><font>主串口特点</font></span></b></p>



<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>包括数据线</font>TXD<font>和</font><font>RXD</font><font>，硬件流控控制线</font><font>RTS</font><font>和</font><font>CTS</font><font>。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">8<font>个数据位，无奇偶校验，一个停止位。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>硬件流控默认关闭。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>用以</font>AT<font>命令传送，数传等。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>支持波特率如下：</font>1200,2400,4800,9600,14400,19200,28800,38400,57600,115200,230400,460800,921600</span><span style="font-family:'宋体';font-size:10.5pt;">,3000000bps</span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">AT<font>指令版本默认情况下模块是自适应波特率</font><font>(AT+IPR=0)</font><font>，在自适应波特率模式下，开机后初始化信息（开头是</font><font>“RDY”</font><font>）不会回发给主控机。在模块开机</font><font>2-3</font><font>秒后，可以给模块发送</font><font>AT</font><font>命令。主控机需首先发送</font><font>“AT”</font><font>字符给模块来训练主控机的波特率，此时模块会上报初始化信息，表明训练成功。用户可以发送一个</font><font>“AT+IPR=x :&amp;W”</font><font>命令给模块（</font><font>x</font><font>是波特率，比如</font><font>9600</font><font>），此命令的作用是设置一个固定的波特率并保存，在完成这些配置之后，每次模块开机以后，会自动串口返回</font><font>URC</font><font>初始化信息（开头是</font><font>“RDY”</font><font>）。</font></span></p>



<p> </p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>为了更好的使用自适应波特率功能，以下的使用条件需要注意：</font></span></p>



<p><b> </b></p>



<p><b><span style="font-family:Calibri;font-size:10.5pt;"><font>模块和上位机</font></span></b><span style="font-family:Calibri;font-size:10.5pt;"><font>之间同步：</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>自适应波特率功能开启情况下，当模块上电，在发送</font>“AT”<font>字符前最好等待 </font><font>2~3</font><font>秒钟。当模块上报开机初始化信息，表明波特率训练成功，和上位机完成了同步。</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>在自适应波特率模式下，主控器如果需要开机信息，必须首先进行同步。否则开机初始化信息将</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>不会上报</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>。</font></span></p>

<p><b><span style="font-family:Calibri;font-size:10.5pt;"><font>自适应波特率操作配置：</font></span></b></p>



<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>串口配置为</font>8<font>位数据位，无奇偶校验位，</font><font>1</font><font>位停止位（出厂配置）</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>模块开机时只有字符串</font>“AT”<font>可以训练波特率。</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>（</font>“at”</span><span style="font-family:Calibri;font-size:10.5pt;"><font>、</font></span><span style="font-family:Calibri;font-size:10.5pt;">“At”<font>或者</font><font>“aT”</font><font>无法被识别）</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>波特率训练成功后，可以识别大写、小写或大小写组合的</font>AT<font>命令。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>自适应波特率模式下，如果模块开机没有先同步，如</font>“RDY”<font>，</font><font>“+CFUN:  1”</font><font>和</font><font>“+CPIN: READY”</font><font>这样的</font><font>URC</font><font>信息将不会上报。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>不推荐在固定波特率模式时切换到自适应波特率模式。</font></span></p>



<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>在自适应波特率模式下，不推荐切换到软件多路复用模式。</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font><br /></font></span></p>

<p><b><span style="font-family:Calibri;font-size:10.5pt;">3.7.1.2</span></b><b><span style="font-family:Calibri;font-size:10.5pt;"><font>主串口连接方式</font></span></b></p>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>主串口的连接方式较为灵活，如下是三种常用的连接方式。</font></span></p>



<p> </p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>三线制的串口请参考如下的连接方式：</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-9Rj2lcTp5b82d7b20b78e.png" class="img-responsive" style="width:227px;" alt="attachments-2018-08-9Rj2lcTp5b82d7b20b78e.png" /></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>带流控的串口连接请参考如下电路连接，此连接方式可提高大数据量传输的可靠性，防止数据丢失。</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-rm8Zxadt5b82d89fe2482.png" class="img-responsive" style="width:338.5px;" alt="attachments-2018-08-rm8Zxadt5b82d89fe2482.png" /></p>



<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.7.2. </span><b><span style="font-family:Calibri;font-size:12pt;"><font>调试串口</font></span></b></h3>

<p></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>数据线：</font></span><span style="font-family:'宋体';font-size:10.5pt;">DBG</span><span style="font-family:Calibri;font-size:10.5pt;">_</span><span style="font-family:Calibri;font-size:10.5pt;">TXD<font>和</font></span><span style="font-family:'宋体';font-size:10.5pt;">DBG</span><span style="font-family:Calibri;font-size:10.5pt;">_RXD</span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>调试口仅用作软件调试，波特率配置为</font></span><span style="font-family:'宋体';font-size:10.5pt;">115200</span><span style="font-family:Calibri;font-size:10.5pt;">bps</span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>串口会自动向外面输出</font>log<font>信息</font></span></p>



<p> </p>



<p> </p>

<p><span style="font-family:Calibri;font-size:11pt;"><font>调试串口连线参考如下方式连接：</font></span></p>

<p><span style="font-family:Calibri;font-size:10pt;"><font><br /></font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-T6Ee2WaD5b87208a6c061.png" class="img-responsive" style="width:391.5px;" alt="attachments-2018-08-T6Ee2WaD5b87208a6c061.png" /><span style="font-family:Calibri;font-size:10pt;"><font><br /></font></span></p>

<p><span style="font-family:Calibri;font-size:10pt;"><font>图表</font></span><span style="font-family:Calibri;font-size:10pt;">10</span><span style="font-family:Calibri;font-size:10pt;"><font>：</font></span><span style="font-size:10.5pt;font-family:Calibri;"><font>软件调试连线</font></span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.8. </span><b><span style="font-family:'黑体';font-size:14pt;">USB<font>接口</font></span></b></h2>



<p><span style="font-family:'宋体';font-size:11pt;">Air720<font>的</font><font>USB</font><font>符合</font><font>USB2.0</font><font>规范，支持高速（</font><font>480Mbps</font><font>）和全速（</font><font>12Mbps</font><font>）模式。该接口可用于</font><font>AT</font><font>命令传送，数据传输，软件调试和软件升级</font></span></p>

<p><span style="font-family:'宋体';font-size:11pt;"><font><br /></font></span></p>

<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">7</span><span style="font-family:Calibri;font-size:10pt;"><font>：</font></span><span style="font-family:'黑体';font-size:10pt;">USB</span><span style="font-family:Calibri;font-size:10pt;"><font>管脚定义</font></span></p>

<table class="MsoNormalTable"><tr><td><p><b><span style="font-family:Calibri;font-size:10.5pt;">接口</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:10.5pt;">名称</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:10.5pt;">管脚</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:10.5pt;">作用</span></b></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">USB</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">USB_DP</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">69</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">USB<font>差分数据正，需</font><font>90</font><font>欧姆差分阻抗</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">USB_DM</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">70</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">USB<font>差分数据负，需</font><font>90</font><font>欧姆差分阻抗</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">USB_VBUS</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">71</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">USB<font>电源，用于</font><font>USB</font><font>检测。</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">GND</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">72</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">地</span></p></td></tr></table>

<p><span style="font-family:'宋体';font-size:11pt;">USB<font>接口</font></span><span style="font-family:Calibri;font-size:11pt;"><font>参考设计软性如下：</font></span></p>



<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-9VCNIedL5b82daaece34a.png" class="img-responsive" style="width:571.47px;height:295.421px;" alt="attachments-2018-08-9VCNIedL5b82daaece34a.png" /><span style="font-family:Calibri;font-size:10pt;"><font><br /></font></span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.9. </span><b><span style="font-family:Calibri;font-size:14pt;">SIM<font>卡接口</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10.5pt;">SIM<font>卡接口支持</font></span><span style="font-family:'宋体';font-size:10.5pt;">ETSI<font>和</font><font>IMT-2000</font><font>卡</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>范的</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>，</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>支持</font>1.8V<font>和</font><font>3.0V</font></span><span style="font-family:'宋体';font-size:10.5pt;"> USIM<font>卡</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>。</font></span></p>

<h3><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.9.1. </span><b><span style="font-family:Calibri;font-size:12pt;">SIM<font>接口</font></span></b></h3>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>下表介绍了</font>SIM<font>的接口管脚定义。</font></span></p>

<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">8</span><span style="font-family:Calibri;font-size:10pt;"><font>：</font>SIM<font>卡接口管脚定义</font></span></p>

<table class="MsoNormalTable"><tr><td><p><b><span style="font-family:Calibri;font-size:12pt;">管脚名</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:12pt;">管脚号</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:12pt;">作用</span></b></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10pt;">U</span><span style="font-family:Calibri;font-size:10pt;">SIM_VDD</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">14</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">U</span><span style="font-family:Calibri;font-size:10pt;">SIM<font>卡供电电源。自动侦测</font><font>SIM</font><font>卡工作电压。精度</font><font>3.0V±10%</font><font>和</font><font>1.8V±10%</font><font>。最大供电电流</font><font>10mA</font><font>。</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10pt;">U</span><span style="font-family:Calibri;font-size:10pt;">SIM_RST</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">17</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">U</span><span style="font-family:Calibri;font-size:10pt;">SIM<font>卡复位脚</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10pt;">U</span><span style="font-family:Calibri;font-size:10pt;">SIM_DATA</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">15</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">U</span><span style="font-family:Calibri;font-size:10pt;">SIM<font>卡数据线</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10pt;">U</span><span style="font-family:Calibri;font-size:10pt;">SIM_CLK</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">16</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">U</span><span style="font-family:Calibri;font-size:10pt;">SIM<font>卡时钟线</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10pt;">USIM_PRESENCE</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">13</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">USIM<font>卡插拔检测</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10pt;">USIM_GND</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">10</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">地</span></p></td></tr></table>

<p><span style="font-family:Calibri;font-size:10pt;"><font><br /></font></span></p>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>下图是</font>SIM<font>接口的参考电路，使用</font><font>6pin</font><font>的</font><font>SIM</font><font>卡座。</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-jezUFYgb5b82db18c5b11.png" class="img-responsive" style="width:423.5px;" alt="attachments-2018-08-jezUFYgb5b82db18c5b11.png" /></p>

<p><span style="font-family:'宋体';font-size:10.5pt;"><font>如果</font></span><span style="font-family:Arial;font-size:10.5pt;"><font>需要用到</font></span><span style="font-family:'宋体';font-size:10.5pt;">sim<font>卡在位检测，推荐电路如下。</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-UW7YOjmx5b82db61b0d0d.png" class="img-responsive" style="width:509.5px;" alt="attachments-2018-08-UW7YOjmx5b82db61b0d0d.png" /><span style="text-align:center;font-family:Calibri;font-size:11pt;"><font>        图表</font></span><span style="text-align:center;font-family:Calibri;font-size:11pt;"> </span><span style="text-align:center;font-family:Calibri;font-size:11pt;">13</span><span style="text-align:center;font-family:Calibri;font-size:11pt;"><font>：</font></span><span style="text-align:center;font-family:Calibri;font-size:11pt;"><font>使用</font></span><span style="text-align:center;font-family:'宋体';font-size:11pt;"><font>带检测</font>PIN</span><span style="text-align:center;font-family:Calibri;font-size:11pt;"> SIM</span><span style="text-align:center;font-family:Calibri;font-size:11pt;"><font>卡座参考电路图</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>在</font>SIM<font>卡接口的电路设计中，为了确保</font><font>SIM</font><font>卡的良好的功能性能和不被损坏，在电路设计中建议遵循以下设计原则：</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">SIM<font>卡座与模块距离摆件不能太远，越近越好，尽量保证</font><font>SIM</font><font>卡信号线布线不超过</font><font>20cm</font><font>。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;">SIM<font>卡信号线布线远离</font><font>RF</font><font>线和</font><font>VBAT</font><font>电源线。。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>为了防止可能存在的</font>SIM_CLK<font>信号对</font><font>SIM_DATA</font><font>信号的串扰，两者布线不要太靠近，在两条走线之间增加地屏蔽。且对</font><font>SIM_RST</font><font>信号也需要地保护。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>为了保证良好的</font>ESD<font>保护，建议加</font><font>TVS</font><font>管，并靠近</font><font>SIM</font><font>卡座摆放。选择的</font><font>ESD</font><font>器件寄生电容不大于</font><font>50pF</font><font>。在模块和</font><font>SIM</font><font>卡之间也可以串联</font><font>22</font><font>欧姆的电阻用以抑制杂散</font><font>EMI</font><font>，增强</font><font>ESD</font><font>防护。</font><font>SIM</font><font>卡的外围电路必须尽量靠近</font><font>SIM</font><font>卡座。</font></span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">3.10. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>网络状态指示</font></span></b></h2>



<p><span style="font-family:'宋体';font-size:10.5pt;">Air720 <font>分别</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>用两个管脚</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>信号来指示网络的状态。</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>如下</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>两表分别描述了管脚定义和不同网络状态下的逻辑电平变化：</font></span></p>

<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">9</span><span style="font-family:Calibri;font-size:10pt;"><font>：网络</font></span><span style="font-family:'黑体';font-size:10pt;"><font>指示</font></span><span style="font-family:Calibri;font-size:10pt;"><font>管脚定义</font></span></p>

<table class="MsoNormalTable"><tr><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">管脚名</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">管脚号</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">作用</span></b></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10pt;">NET_MODE</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">5</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">指示模块的网络注册状态</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10pt;">NET_STATUS</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">6</span></p></td><td><p><span style="font-family:'宋体';font-size:10pt;">指示模块的网络运行状态</span></p></td></tr></table>

<p><span style="font-family:Calibri;font-size:10pt;"><a><font>表格</font></a></span><span style="font-family:Calibri;font-size:10pt;">10</span><span style="font-family:Calibri;font-size:10pt;"><font>：</font></span><span style="font-family:'黑体';font-size:10pt;"><font>指示</font></span><span style="font-family:Calibri;font-size:10pt;"><font>网络管脚</font></span><span style="font-family:Calibri;font-size:10pt;"><font>的工作状态</font></span></p>

<table class="MsoNormalTable"><tr><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:11pt;">状态</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:'宋体';font-size:11pt;">管脚工作状态</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:'宋体';font-size:11pt;">网络</span></b><b><span style="font-family:Calibri;font-size:11pt;">状态</span></b></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:11pt;">NET_MODE</span></p></td><td><p><span style="font-family:'宋体';font-size:11pt;">高</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">注册<font>LTE</font><font>网络</font></span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">低</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">其他</span></p></td></tr><tr><td><p> </p><p style="text-align:center;"><span style="font-family:'宋体';font-size:11pt;">NET_STATUS</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">亮<font>0.</font></span><span style="font-family:'宋体';font-size:10.5pt;">2</span><span style="font-family:Calibri;font-size:10.5pt;">秒，灭</span><span style="font-family:'宋体';font-size:10.5pt;">1</span><span style="font-family:Calibri;font-size:10.5pt;">.</span><span style="font-family:'宋体';font-size:10.5pt;">8</span><span style="font-family:Calibri;font-size:10.5pt;">秒</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">搜</span><span style="font-family:Calibri;font-size:10.5pt;">网状态</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">亮</span><span style="font-family:'宋体';font-size:10.5pt;">1.8</span><span style="font-family:Calibri;font-size:10.5pt;">秒，灭<font>0.</font></span><span style="font-family:'宋体';font-size:10.5pt;">2</span><span style="font-family:Calibri;font-size:10.5pt;">秒</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">待机</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">亮<font>0.</font></span><span style="font-family:'宋体';font-size:10.5pt;">125</span><span style="font-family:Calibri;font-size:10.5pt;">秒，灭</span><span style="font-family:'宋体';font-size:10.5pt;">0.125</span><span style="font-family:Calibri;font-size:10.5pt;">秒</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">数据</span><span style="font-family:Calibri;font-size:10.5pt;">传输</span></p></td></tr></table>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>参考电路如下图</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>：</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-07vPVKjN5b82dc1360b40.png" class="img-responsive" style="width:294.386px;height:256.401px;" alt="attachments-2018-08-07vPVKjN5b82dc1360b40.png" /><span style="font-family:Calibri;font-size:10.5pt;"><font><br /></font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font><br /></font></span></p>

<h1><span style="font-family:Arial;font-weight:bold;font-size:15pt;">4. </span><b><span style="font-family:Calibri;font-size:16pt;"><font>射频接口</font></span></b></h1>



<p><span style="font-family:'宋体';font-size:10.5pt;"><font>主天线和分集天线接口管脚定义如下：</font></span></p>



<p> <span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">11</span><span style="font-family:Calibri;font-size:10pt;"><font>：</font>RF_ANT<font>管脚定义</font></span></p>



<p> </p>

<table class="MsoNormalTable"><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">管脚名称</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">管脚号</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">作用</span></b></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">ANT_MAIN</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">49</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">主天线接口</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">ANT_DIV</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">35</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">分集天线接口</span></p></td></tr></table>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">4.1. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>射频参考电路</font></span></b></h2>

<h2><b><span style="font-family:Calibri;font-size:14pt;"><font><br /></font></span></b></h2>

<h2><img src="http://oldask.openluat.com/image/show/attachments-2018-08-6kt7bAiv5b82dc4cae0e3.png" class="img-responsive" style="width:402.386px;height:349.483px;" alt="attachments-2018-08-6kt7bAiv5b82dc4cae0e3.png" /></h2>

<p><span style="font-family:'宋体';font-size:10.5pt;"><font>注意：</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:'宋体';font-size:10.5pt;"><font>要</font></span><span style="font-family:Calibri;font-size:10.5pt;"><font>保证主天线和分集天线的距离合适以提高接收灵敏度</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Arial;font-size:10.5pt;"><font>连接到模块</font></span><span style="font-family:Arial;font-size:10.5pt;">RF</span><span style="font-family:Arial;font-size:10.5pt;"><font>天线焊盘的</font></span><span style="font-family:Arial;font-size:10.5pt;">RF</span><span style="font-family:Arial;font-size:10.5pt;"><font>走线必须使用微带线或者其他类型的</font></span><span style="font-family:Arial;font-size:10.5pt;"> RF</span><span style="font-family:Arial;font-size:10.5pt;"><font>走线，阻抗必须控制在</font></span><span style="font-family:Arial;font-size:10.5pt;">50</span><span style="font-family:Arial;font-size:10.5pt;"><font>欧姆左右</font></span><span style="font-family:'宋体';font-size:10.5pt;"><font>。</font></span><span style="font-family:Calibri;font-size:10.5pt;"> </span></p>



<p> </p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">4.2. </span><b><span style="font-family:Calibri;font-size:14pt;">RF<font>输出功</font></span></b><b><span style="font-family:Calibri;font-size:15pt;"><font>率</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">12</span><span style="font-family:Calibri;font-size:10pt;"><font>：</font>RF<font>传导功率</font></span></p>

<table class="MsoNormalTable"><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">频段</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">最大</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">最小</span></b></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">E</span><span style="font-family:Calibri;font-size:10.5pt;">GSM</span><span style="font-family:'宋体';font-size:10.5pt;">900</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">3</span><span style="font-family:'宋体';font-size:10.5pt;">3</span><span style="font-family:Calibri;font-size:10.5pt;"> dBm+-</span><span style="font-family:'宋体';font-size:10.5pt;">2</span><span style="font-family:Calibri;font-size:10.5pt;">dB</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">5dBm±5dB</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">DCS1800</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">30</span><span style="font-family:Calibri;font-size:10.5pt;">dBm +-</span><span style="font-family:'宋体';font-size:10.5pt;">2</span><span style="font-family:Calibri;font-size:10.5pt;">dB</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">0</span><span style="font-family:Calibri;font-size:10.5pt;">dBm±5dB</span></p><p> </p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">GSM</span><span style="font-family:'宋体';font-size:10.5pt;">900(8-psk)</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">27</span><span style="font-family:Calibri;font-size:10.5pt;">dBm +-</span><span style="font-family:'宋体';font-size:10.5pt;">3</span><span style="font-family:Calibri;font-size:10.5pt;">dB</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">5</span><span style="font-family:Calibri;font-size:10.5pt;">dBm±5dB</span></p><p> </p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">DCS1800(8-psk)</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">26</span><span style="font-family:Calibri;font-size:10.5pt;"> dBm +-</span><span style="font-family:'宋体';font-size:10.5pt;">3</span><span style="font-family:Calibri;font-size:10.5pt;">dB</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">0dBm±5dB</span></p><p> </p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">WCDMA B1/B2/B4/B5/B5</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">24dBm </span><span style="font-family:Calibri;font-size:10.5pt;">+</span><span style="font-family:'宋体';font-size:10.5pt;">1/</span><span style="font-family:Calibri;font-size:10.5pt;">-</span><span style="font-family:'宋体';font-size:10.5pt;">3</span><span style="font-family:Calibri;font-size:10.5pt;">dB</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">&lt;-50dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">TD-SCDMA B34/B39</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">24dBm </span><span style="font-family:Calibri;font-size:10.5pt;">+</span><span style="font-family:'宋体';font-size:10.5pt;">1/</span><span style="font-family:Calibri;font-size:10.5pt;">-</span><span style="font-family:'宋体';font-size:10.5pt;">3</span><span style="font-family:Calibri;font-size:10.5pt;">dB</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">&lt;-50dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">LTE FDD B1/B2/B3/B4/B5/B7/B8/B12/B17/B20</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">23dBm </span><span style="font-family:Calibri;font-size:10.5pt;">+-</span><span style="font-family:'宋体';font-size:10.5pt;">2</span><span style="font-family:Calibri;font-size:10.5pt;">dB</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">&lt;-44dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">LTE TDD B38/B39/B40/B41</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">23dBm </span><span style="font-family:Calibri;font-size:10.5pt;">+-</span><span style="font-family:'宋体';font-size:10.5pt;">2</span><span style="font-family:Calibri;font-size:10.5pt;">dB</span></p></td><td><p><span style="font-family:'宋体';font-size:10.5pt;">&lt;-44dBm</span></p></td></tr></table>



<p> </p>





<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">4.3. </span><b><span style="font-family:Calibri;font-size:14pt;">RF<font>传导灵敏度</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">13</span><span style="font-family:Calibri;font-size:10pt;"><font>：</font>RF<font>传导灵敏度</font></span></p>

<table class="MsoNormalTable"><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">频段</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">接收灵敏度</span></b></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">E</span><span style="font-family:Calibri;font-size:10.5pt;">GSM</span><span style="font-family:'宋体';font-size:10.5pt;">90</span><span style="font-family:Calibri;font-size:10.5pt;">0</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">&lt; -1</span><span style="font-family:'宋体';font-size:10.5pt;">10</span><span style="font-family:Calibri;font-size:10.5pt;">dBm</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">DCS </span><span style="font-family:'宋体';font-size:10.5pt;">18</span><span style="font-family:Calibri;font-size:10.5pt;">00</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">&lt; -1</span><span style="font-family:'宋体';font-size:10.5pt;">10</span><span style="font-family:Calibri;font-size:10.5pt;">dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">WCDMA B2</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">&lt; -1</span><span style="font-family:'宋体';font-size:10.5pt;">11</span><span style="font-family:Calibri;font-size:10.5pt;">dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">WCDMA B4</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">&lt; -1</span><span style="font-family:'宋体';font-size:10.5pt;">11</span><span style="font-family:Calibri;font-size:10.5pt;">dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">WCDMA B5</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">&lt; -1</span><span style="font-family:'宋体';font-size:10.5pt;">12</span><span style="font-family:Calibri;font-size:10.5pt;">dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">LTE FDD B2</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">&lt; -</span><span style="font-family:'宋体';font-size:10.5pt;">95</span><span style="font-family:Calibri;font-size:10.5pt;">dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">LTE FDD B4</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">&lt; -</span><span style="font-family:'宋体';font-size:10.5pt;">95</span><span style="font-family:Calibri;font-size:10.5pt;">dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">LTE FDD B5</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">&lt; -</span><span style="font-family:'宋体';font-size:10.5pt;">98</span><span style="font-family:Calibri;font-size:10.5pt;">dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">LTE FDD B2</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">&lt; -</span><span style="font-family:'宋体';font-size:10.5pt;">98</span><span style="font-family:Calibri;font-size:10.5pt;">dBm</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:10.5pt;">LTE FDD B2</span></p></td><td><p><span style="font-family:Calibri;font-size:10.5pt;">&lt; -</span><span style="font-family:'宋体';font-size:10.5pt;">98</span><span style="font-family:Calibri;font-size:10.5pt;">dBm</span></p></td></tr></table>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">4.4. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>推荐</font>RF<font>焊接方式</font></span></b></h2>





<p><span style="font-family:Calibri;font-size:10.5pt;"><font>如果连接外置天线的射频连接器是通过焊接方式与模块相连的，请务必注意连接线的剥线方式及焊接方法，尤其是地要焊接充分，请按照下图中正确的焊接方式进行操作，以避免因焊接不良引起线损增大。</font></span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-5fGBEoYP5b82dc9e0b874.png" class="img-responsive" style="width:407px;" alt="attachments-2018-08-5fGBEoYP5b82dc9e0b874.png" /><span style="font-family:Calibri;font-size:10.5pt;"><font><br /></font></span></p>

<h1><span style="font-family:Arial;font-weight:bold;font-size:15pt;">5. </span><b><span style="font-family:Calibri;font-size:15pt;"><font>电器特性，可靠性，射频特性</font></span></b></h1>



<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">5.1. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>绝对最大值</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>下表所示是模块数字、模拟管脚的电源供电电压电流最大耐受值。</font></span></p>

<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">14</span><span style="font-family:Calibri;font-size:10pt;"><font>：绝对最大值</font></span></p>

<table class="MsoNormalTable"><tr><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">参数</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">最小</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">最大</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">单位</span></b></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">V</span><span style="font-family:Calibri;font-size:10.5pt;">BAT</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">-0.3</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">4.</span><span style="font-family:Calibri;font-size:10.5pt;">7</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">V</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">USB_VBUS</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">-0.3</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">5.5</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">V</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">电源供电峰值电流</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">0</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">2</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">A</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">电源供电平均电流（<font>TDMA</font><font>一帧时间）</font></span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">0</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">0.7</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">A</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">数字管脚处电压</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">-0.3</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">VDDIO+0.3</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">V</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">模拟管脚处电压</span><span style="font-family:'宋体';font-size:10.5pt;">(GPADC)</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">-0.3</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">6</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">V</span></p></td></tr></table>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">5.2. </span><b><span style="font-family:'黑体';font-size:14pt;"><font>推荐工作条件</font></span></b></h2>





<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">15</span><span style="font-family:Calibri;font-size:10pt;"><font>：</font></span><span style="font-family:'黑体';font-size:10pt;"><font>推荐</font></span><span style="font-family:Calibri;font-size:10pt;"><font>工作条件</font></span></p>

<table class="MsoNormalTable"><tr><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">参数</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">最小</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">典型</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">最大</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:12pt;">单位</span></b></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">V</span><span style="font-family:Calibri;font-size:10.5pt;">BAT</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">3.3</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">3.8</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">4.</span><span style="font-family:'宋体';font-size:10.5pt;">3</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">V</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">USB_VBUS</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">3.0</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">5.0</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">5.25</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">V</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">电源供电峰值电流</span></p></td><td><p> </p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:10.5pt;">1.8</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">2</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">A</span></p></td></tr></table>



<p> </p>

<h2><span style="font-family:Arial;font-size:14pt;">5.3. </span><span style="font-family:Calibri;font-size:14pt;"><font>工作温度</font></span></h2>



<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">16</span><span style="font-family:Calibri;font-size:10pt;"><font>：工作温度</font></span></p>

<table class="MsoNormalTable"><tr><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:11pt;">温度</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:11pt;">最低</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:11pt;">典型</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:11pt;">最高</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:11pt;">单位</span></b></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">正常工作温度</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:9pt;">-</span><span style="font-family:'宋体';font-size:9pt;">35</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:9pt;">25</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:9pt;">75</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:9pt;">℃</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">受限工作温度</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:9pt;">-40~-35</span></p></td><td><p> </p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:9pt;">75~85</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:9pt;">℃</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">存储温度</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:9pt;">-45</span></p></td><td><p> </p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:9pt;">90</span></p></td><td><p style="text-align:center;"><span style="font-family:'宋体';font-size:9pt;">℃</span></p></td></tr></table>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">5.4. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>电</font></span></b><b><span style="font-family:'黑体';font-size:14pt;"><font>源</font></span></b><b><span style="font-family:Calibri;font-size:14pt;"><font>额度值</font></span></b></h2>





<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">17</span><span style="font-family:Calibri;font-size:10pt;"><font>：模块电源额度值</font></span></p>

<table class="MsoNormalTable"><tr><td><p><b><span style="font-family:Calibri;font-size:11pt;">参数</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">描述</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">条件</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">最小</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">典型</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">最大</span></b></p></td><td><p><b><span style="font-family:Calibri;font-size:11pt;">单位</span></b></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">V</span><span style="font-family:Calibri;font-size:10.5pt;">BAT</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">供电电压</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">电压必须在该范围之内，包括电压跌落，纹波和尖峰时</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">3.3</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">3.8</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">4.3</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">V</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">突发发射时的电压跌落</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">GSM850/GSM900<font>最大发射功率等级时</font></span></p></td><td><p> </p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:9pt;">400</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">mV</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:10.5pt;">I</span><span style="font-family:Calibri;font-size:10.5pt;">VBAT</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">平均供电电流</span></p></td><td><p><span style="font-family:Calibri;font-size:9pt;">关机模式</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:9pt;">30</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">uA</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">待机电流</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">GSM </span><span style="font-family:Calibri;font-size:9pt;">DRX=</span><span style="font-family:Calibri;font-size:9pt;">2</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">3.5</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">GSM </span><span style="font-family:Calibri;font-size:9pt;">DRX=5</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">2.6</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">GSM </span><span style="font-family:Calibri;font-size:9pt;">DRX=</span><span style="font-family:Calibri;font-size:9pt;">9</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">2.0</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">WCDMA DRX=6</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">3.0</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">WCDMA DRX=9</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">1.4</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">LTE DRX=5</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">5.5</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">LTE DRX=9</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">1.8</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">飞行模式        <font>AT+CFUN=4</font></span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">1.0</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">最小功能模式    <font>AT+CFUN=0</font></span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:9pt;">0.9</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:Calibri;font-size:9pt;">GPRS<font>模式  </font></span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">E</span><span style="font-family:Calibri;font-size:9pt;">GSM</span><span style="font-family:'宋体';font-size:9pt;">900 4D/1U </span><b><span style="font-family:'宋体';font-size:9pt;">PCL=5</span></b></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">268</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">E</span><span style="font-family:Calibri;font-size:9pt;">GSM</span><span style="font-family:'宋体';font-size:9pt;">900 3D/2U </span><b><span style="font-family:'宋体';font-size:9pt;">PCL=5</span></b></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">420</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">E</span><span style="font-family:Calibri;font-size:9pt;">GSM</span><span style="font-family:'宋体';font-size:9pt;">900 2D/3U </span><b><span style="font-family:'宋体';font-size:9pt;">PCL=5</span></b></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">523</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">E</span><span style="font-family:Calibri;font-size:9pt;">GSM</span><span style="font-family:'宋体';font-size:9pt;">900 1D/4U </span><b><span style="font-family:'宋体';font-size:9pt;">PCL=5</span></b></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">589</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">DCS1800 4D/1U PCL=0</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">228</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">DCS1800 3D/2U PCL=0</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">330</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">DCS1800 2D/3U PCL=0</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">293</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">DCS1800 1D/4U PCL=0</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">455</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">EDGE</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">E</span><span style="font-family:Calibri;font-size:9pt;">GSM</span><span style="font-family:'宋体';font-size:9pt;">900 4D/1U PCL=8</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">201</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">E</span><span style="font-family:Calibri;font-size:9pt;">GSM</span><span style="font-family:'宋体';font-size:9pt;">900 3D/2U PCL=8</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">286</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">E</span><span style="font-family:Calibri;font-size:9pt;">GSM</span><span style="font-family:'宋体';font-size:9pt;">900 2D/3U PCL=8</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">404</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">E</span><span style="font-family:Calibri;font-size:9pt;">GSM</span><span style="font-family:'宋体';font-size:9pt;">900 1D/4U PCL=8</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">496</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">DCS1800 4D/1U PCL=2</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">197</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">DCS1800 3D/2U PCL=2</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">275</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">DCS1800 2D/3U PCL=2</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">350</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">DCS1800 1D/4U PCL=2</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">429</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">WCDMA</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">B1 HSDPA</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">541</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">B1 HSUPA</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">535</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">B8 HSDPA</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">447</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">B8 HSUPA</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">432</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">LTE</span></p></td><td><p><span style="font-family:'宋体';font-size:9pt;">B1</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">647</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">B3</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">710</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">B38</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">427</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">B39</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">347</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">B40</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">408</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr><tr><td><p><span style="font-family:'宋体';font-size:9pt;">B41</span></p></td><td><p> </p></td><td><p><span style="font-family:Calibri;font-size:11pt;">440</span></p></td><td><p> </p></td><td><p><span style="font-family:'宋体';font-size:11pt;">mA</span></p></td></tr></table>



<p><b> </b></p>

<p></p>

<p><span style="font-family:Calibri;font-size:9pt;"><br /></span></p>



<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">5.5. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>静电防护</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>在模块应用中，由于人体静电，微电子间带电摩擦等产生的静电，通过各种途径放电给模块，可能会对模块造成一定的损坏，所以</font> ESD<font>保护必须要重视，不管是在生产组装、测试，研发等过程，尤其在产品设计中，都应采取防 </font><font>ESD</font><font>保护措施。如电路设</font></span><font style="font-size:10.5pt;">在接口处或易受</font><span style="font-family:Calibri;font-size:10.5pt;"> ESD</span><font style="font-size:10.5pt;">点增加 </font><font style="font-family:Calibri;font-size:10.5pt;">ESD</font><font style="font-size:10.5pt;">保护，生产中带防</font><font style="font-family:Calibri;font-size:10.5pt;">ESD</font><font style="font-size:10.5pt;">手套等。</font></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>下表为模块重点</font>PIN<font>脚的</font><font>ESD</font><font>耐受电压情况。</font></span></p>

<p>    </p>



<p><span style="font-family:Calibri;font-size:10pt;"><font>表格</font></span><span style="font-family:Calibri;font-size:10pt;">18</span><span style="font-family:Calibri;font-size:10pt;"><font>：</font></span><span style="font-family:Calibri;font-size:10.5pt;">ESD<font>性能参数（温度：</font><font>25</font></span><span style="font-family:'宋体';font-size:10.5pt;">℃</span><span style="font-family:Calibri;font-size:10.5pt;">, <font>湿度：</font><font>45%</font><font>）</font></span></p>

<table class="MsoNormalTable"><tr><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:14pt;">管脚名</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:14pt;">接触放电</span></b></p></td><td><p style="text-align:center;"><b><span style="font-family:Calibri;font-size:14pt;">空气放电</span></b></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">VBAT,GND</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">±5KV</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">±10KV</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">RF_ANT</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">±5KV</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">±10KV</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">TXD, RXD</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">±2KV</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">±4KV</span></p></td></tr><tr><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">Others</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">±0.5KV</span></p></td><td><p style="text-align:center;"><span style="font-family:Calibri;font-size:10.5pt;">±1KV</span></p></td></tr></table>

<p> </p>

<h1><span style="font-family:Arial;font-weight:bold;font-size:15pt;">6. </span><b><span style="font-family:Calibri;font-size:15pt;"><font>机械尺寸</font></span></b></h1>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>该章节描述模块的机械尺寸以及客户使用该模块设计的推荐封装尺寸。</font></span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">6.1. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>模块机械尺寸</font></span></b></h2>





<p> <img src="http://oldask.openluat.com/image/show/attachments-2018-08-qdv7ubt45b872454f3e7a.png" class="img-responsive" style="width:326.5px;" alt="attachments-2018-08-qdv7ubt45b872454f3e7a.png" /><span style="text-align:center;font-family:Calibri;font-size:10pt;">       图表</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">17</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">：</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">Air72</span><span style="text-align:center;font-family:'黑体';font-size:10pt;">0背</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">视图（单位：毫米）</span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">6.2. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>推荐</font>PCB<font>封装</font></span></b></h2>





<p> <img src="http://oldask.openluat.com/image/show/attachments-2018-08-uJJOXE0g5b87246160c3a.png" class="img-responsive" style="width:391px;" alt="attachments-2018-08-uJJOXE0g5b87246160c3a.png" /></p>



<p><span style="text-align:center;">              </span><span style="text-align:center;font-family:Calibri;font-size:10pt;">图表</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">18</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">：背视图</span><span style="text-align:center;font-family:'黑体';font-size:10pt;">，</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">推荐封装（单位：毫米）</span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>注意：保证</font></span><b><span style="font-family:Calibri;font-size:10.5pt;">PCB</span></b><span style="font-family:Calibri;font-size:10.5pt;"><font>板上模块和其他元器件之间间距至少</font></span><b><span style="font-family:Calibri;font-size:10.5pt;">3mm</span></b><span style="font-family:Calibri;font-size:10.5pt;"><font>。</font></span></p>



<p> </p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">1.3. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>模块正视图</font></span></b></h2>





<p> <img src="http://oldask.openluat.com/image/show/attachments-2018-08-w5be5ESR5b87248a4ad8d.png" class="img-responsive" style="width:252.386px;height:273.104px;" alt="attachments-2018-08-w5be5ESR5b87248a4ad8d.png" /></p>



<p>     <span style="text-align:center;font-family:Calibri;font-size:10pt;">图表</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">19</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">：模块正视图</span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">1.4. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>模块底视图</font></span></b></h2>





<p> </p>



<p> <img src="http://oldask.openluat.com/image/show/attachments-2018-08-8or5eOcT5b87249d2a86b.png" class="img-responsive" style="width:268.369px;height:294.509px;" alt="attachments-2018-08-8or5eOcT5b87249d2a86b.png" /><span style="text-align:center;font-family:Calibri;font-size:10pt;">     图表</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">20</span><span style="text-align:center;font-family:Calibri;font-size:10pt;">：模块底视图</span></p>



<p> </p>

<h1><span style="font-family:Arial;font-weight:bold;font-size:15pt;">7. </span><b><span style="font-family:Calibri;font-size:15pt;"><font>存储和生产</font></span></b></h1>



<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">7.1. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>存储</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10.5pt;">Air720<font>以真空密封袋的形式出货。模块的存储需遵循如下条件：</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>环境温度低于</font>40<font>摄氏度，空气湿度小于</font><font>90%</font><font>情况下，模块可在真空密封袋中存放</font><font>12</font><font>个月。</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>当真空密封袋打开后，若满足以下条件，模块可直接进行回流焊或其它高温流程：</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>模块环境温度低于</font>30<font>摄氏度，空气湿度小于</font><font>60%</font><font>，工厂在</font><font>72</font><font>小时以内完成贴片。</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>空气湿度小于</font>10%</span></p>



<p> </p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>若模块处于如下条件，需要在贴片前进行烘烤：</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>当环境温度为</font>23<font>摄氏度（允许上下</font><font>5</font><font>摄氏度的波动）时，湿度指示卡显示湿度大于</font><font>10%</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>当真空密封袋打开后，模块环境温度低于</font>30<font>摄氏度，空气湿度小于</font><font>60%</font><font>，但工厂未能在</font><font>72</font><font>小时以内完成贴片</font></span></p>

<p><span style="font-family:Symbol;font-size:10.5pt;">¨ </span><span style="font-family:Calibri;font-size:10.5pt;"><font>当真空密封袋打开后，模块存储空气湿度大于</font>10%</span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>如果模块需要烘烤，请在</font>125<font>摄氏度下（允许上下</font><font>5</font><font>摄氏度的波动）烘烤</font><font>48</font><font>小时。</font></span></p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>注意：模块的包装无法承受如此高温，在模块烘烤之前，请移除模块包装。如果只需要短时间的烘烤，请参考</font></span><b><span style="font-family:Calibri;font-size:10.5pt;">IPC/JEDECJ-STD-033</span></b><span style="font-family:Calibri;font-size:10.5pt;"><font>规范。</font></span></p>

<h2><span style="font-family:Arial;font-weight:bold;font-size:14pt;">7.2. </span><b><span style="font-family:Calibri;font-size:14pt;"><font>生产焊接</font></span></b></h2>



<p><span style="font-family:Calibri;font-size:10.5pt;"><font>用印刷刮板在网板上印刷锡膏，使锡膏通过网板开口漏印到</font> PCB<font>上，印刷刮板力度需调整合适，为保证模块印膏质量，</font><font>Air720</font><font>模块焊盘部分对应的钢网厚度应为 </font><font>0.2mm</font><font>。</font></span></p>



<p> <img src="http://oldask.openluat.com/image/show/attachments-2018-08-AtyBy6Z95b8724d56c604.png" class="img-responsive" style="width:277.5px;" alt="attachments-2018-08-AtyBy6Z95b8724d56c604.png" /></p>

<p><span style="font-family:Calibri;font-size:10pt;"><font>图表</font></span><span style="font-family:Calibri;font-size:10pt;">21</span><span style="font-family:Calibri;font-size:10pt;"><font>：印膏图</font></span></p>



<p> </p>



<p>  </p>

<p><span style="font-family:Calibri;font-size:10.5pt;"><font>为避免模块反复受热损伤，建议客户</font> PCB<font>板第一面完成回流焊后再贴模块。推荐的炉温曲线图如下图所示：</font></span></p>



<p> <img src="http://oldask.openluat.com/image/show/attachments-2018-08-6G8OE5wu5b8724ea6bf28.png" class="img-responsive" style="width:408px;" alt="attachments-2018-08-6G8OE5wu5b8724ea6bf28.png" /></p>



<p> </p>

<p><span style="font-family:Calibri;font-size:10pt;"><font>图表</font></span><span style="font-family:Calibri;font-size:10pt;">22</span><span style="font-family:Calibri;font-size:10pt;"><font>：炉温曲线</font></span></p>



<p> </p>



<p> </p>



<p> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/27/405/" data-id="ckkfmdgg600favkcghw335hb0" data-title="Air720模块硬件设计手册V1.03" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/56/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/55/">55</a><a class="page-number" href="/page/56/">56</a><span class="page-number current">57</span><a class="page-number" href="/page/58/">58</a><a class="page-number" href="/page/59/">59</a><a class="extend next" rel="next" href="/page/58/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2032/01/">一月 2032</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2032/01/01/608/">【置顶】合宙模块资料汇总</a>
          </li>
        
          <li>
            <a href="/2022/12/31/638/">Air系列模块常见问题列表</a>
          </li>
        
          <li>
            <a href="/2021/01/27/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2021/01/27/2420/">ECMAScript(ES6)基本语法介绍（一）</a>
          </li>
        
          <li>
            <a href="/2021/01/26/2417/">Air720S系列_luat二次开发固件（ 底层软件+上层脚本）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 chenxuuu<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>