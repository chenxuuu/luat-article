<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Luat doc 社区文章静态页面镜像</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Luat doc 社区文章静态页面镜像">
<meta property="og:type" content="website">
<meta property="og:title" content="Luat doc 社区文章静态页面镜像">
<meta property="og:url" content="https://doc.luatos.wiki/page/58/index.html">
<meta property="og:site_name" content="Luat doc 社区文章静态页面镜像">
<meta property="og:description" content="Luat doc 社区文章静态页面镜像">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="chenxuuu">
<meta property="article:tag" content="lua">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Luat doc 社区文章静态页面镜像" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Luat doc 社区文章静态页面镜像</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://doc.luatos.wiki"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-404" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/26/404/" class="article-date">
  <time class="dt-published" datetime="2018-08-26T13:20:44.000Z" itemprop="datePublished">2018-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/26/404/">Air202/Air800通话或录音出现电流噪音（TDD噪音）问题分析与讨论</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>        Air202/Air800支持语音和通话应用，因此我们在开发拥有语音或通话的相关应用时，时常会遇到且难以绕开的问题：出现电流噪音。本文从噪音产生的原因，如何消除，如何防护这几方面进行详细讨论，希望对读者在开发时遇到类似问题有帮助。</p>

<p>        1.什么是TDD噪音。</p>

<p>        由于GSM在每个间隔200KHz频道上共用8个物理信道，即在同一个频率上进行8个用户的时分复用，因此对于每一个用户来说，只有1/8的时间在通话，而其余的7/8的时间空闲，它重复出现的频率大概是216.7Hz。因此模块射频功放每隔4.6mS还有一个发射信号产生，在该信号中包含900MHz/1800MHz，或者是1900MHz的2GGSM信号以及PA的包络线，我们所听到的嗡嗡声就是PA在发射时产生的包络线杂音，因为人耳的听觉频率范围为20Hz~20KHz，216.7Hz就落在人耳可听到的范围内。这种TDD噪音出现的情景有：1.本地通话过程中，喇叭一直能听到明显的嗡嗡电流音。2.对方听到嗡嗡电流音。3.录音的时候听到嗡嗡的电流音。4.TTS语音播报时听到电流音。</p>

<p>        2.TDD噪音产生的主要途径</p>

<p>        TDD噪音主要有两种传播方式：传导和辐射。容易引入音频干扰的三个途径：地，电源，射频信号。</p>

<p>        辐射的传播方式主要是由于天线的辐射对音频信号的干扰。天线在工作时会对周围发射电磁波，如果这是天线的功率较大就会影响到周围的器件，如LCD连接器，电池连接器等都可能成为辐射源。如果这些器件没有保护好，比如一个悬浮的金属，这个金属就会成为一个217HZ的天线，然后影响到附近的SPK或者MIC信号，形成干扰。</p>

<p>        传导方式主要是通过电源途径干扰到音频信号。PA在每次发射是都会有一个突发脉冲大电流需求，由于突然的对电源进行大电流的抽载，由于电源走线等原因或多或少会存在内阻，导致电源上出现纹波，而这个扰动的纹波最终会传导到地平面上，如果主板的地平面设计不良导致地平面阻抗增加，导致地皮面上不同的位置上存在电势差，而音频信号的参考点是以地平面做参考，导致地平面的电势差会叠加到音频信号上导致TDD噪音。</p>

<p>        3.TDD噪音问题的定位</p>

<p>        要解决TDD噪音问题，首先就要定位噪音是从何处引入，定位到干扰源才能对症下药。定位通常用排除方分析。</p>

<p>        天线：把天线用同轴连接线引到外部远离设备，看看干扰是否消除，用以确定是否是天线辐射导致干扰。</p>

<p>        MIC：如果通话电流音是对方听到，而且去掉mic后干扰音消失，可以判断是由MIC受到干扰导致。</p>

<p>        喇叭：将mic静音如果喇叭还能听到电流音则说明干扰由喇叭引入。</p>

<p>        电源：将天线远离主板，发现天线离主板的远近并不影响干扰音的大小，可以判断是有电源传导导致。<br /></p>

<p>        <span> </span><span>4.TDD噪音产生的处理方法</span></p>

<p>        对于音频线路被天线辐射耦合干扰的情况，可以采取滤波的方式改善，可以在音频的差分走线上并联33pf滤波电容到地，将辐射的能量传导到地平面上，同时在两个差分线直接并联100pf电容用于滤除共模的残余能量，而正常差模的正常信号不被影响。注意对于33pf滤波电容如果滤波效果不佳需要进行调整，因为电容的封装，材质，温度等都会影响电容的谐振点，因此就要调整33pf附件的容值去调试，以期望电容的谐振点落在900MHZ附近。</p>

<p>        如果音频线离天线太近，滤波电容不足以完全滤除噪音，还需要常用隔离保护的措施。如果喇叭或MIC的焊接线较长，需要将两根线拧成双绞线紧密缠绕，必要的时候需要包裹导电布在线的表面，同时导电布要连接主板的地。<span><br /></span>        如果是地平面噪声导致干扰，则需要增强地的连通性，可以用铜箔覆盖主板并且铜箔四周与地连接，以增强地的连通性，最终要通过更改PCB解决，优化走线多打地孔，必要的时候要用多层板。</p>

<p>        5.TDD噪音的预防</p>

<p>        如果出现的问题再去调试处理，往往费时费力，效果还不一定好，因此要在设计阶段要进行预防处理杜绝问题发生。</p>

<p>        在产品的布局阶就要区分好电源部分，高速线部分，射频部分，和音频部分，各个部分尽量有一定的隔离度，喇叭mic的放置位置要远离天线。</p>

<p>        在音频走线上要严格差分方式走线，同时两边用地保护，同时两边要有均匀地孔。同时音频走线对面层不能有其他高速线平行，同时同层的高速线也要远离。音频走线上要预留滤波网络并且靠近接收端。</p>

<p>        电源部分要做好设计，最小话走线引入的阻抗，减少纹波，同时电源走线避免走成环状，避免天线效应。</p>

<p>        6.总结</p>

<p>        对于TDD噪音问题最重要的是在设计阶段就要重视这个问题，要做相关的预防措施，同时预留调试的器件，方案，要做到防患于未然。<br /></p>

<p><br /></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/26/404/" data-id="ckkfmdgb5004tvkcggn8v1ro2" data-title="Air202/Air800通话或录音出现电流噪音（TDD噪音）问题分析与讨论" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-403" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/26/403/" class="article-date">
  <time class="dt-published" datetime="2018-08-26T09:08:32.000Z" itemprop="datePublished">2018-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/26/403/">Air202/Air800模块异常掉电重启问题分析不完全指南</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>        在使用Air202/Air800模块进行项目开发时，各种不定时异常重启是常见而且非常影响用户体验的事情。异常重启有软件代码的原因也有硬件上的原因，软件重启通过调试信息比较容易查找到原因，本文不做过多讨论。而硬件原因造成的重启通过调试信息无法找到原因，因而比较难以定位。其中又以模块电源掉电引起的重启较为常见，本文重点讨论<span>射频发射时模块供电管脚（VBAT）电压跌落过大造成重启的问题分析</span></p>

<p>        1.射频发射时模块供电管脚（VBAT）电压跌落的原因：</p>

<p>        通常大部分的硬件重启都是由这个原因造成。设备表现为在平时表现正常，只在数据传输过程中会有几率出现，而且某些地方复现不到而某些地方缺很容易出现。造成了在生产或测试过程中可能没有测出这个问题，一旦投放到市场就出现很多重启的问题。为什么射频发射会导致电源电压跌落呢？这样要从GSM原理说起，GSM是一个时分复用的系统，在一个信道上上下行通信是通过时间来区分，通常一帧的周期为4.615ms，而一帧中划分8个时隙，通常在数传中上行的占用的时隙通常1到2个，这个是由当地基站根据网络状况决定。下行的接收时隙射频PA不需要工作，而上行放射时隙PA就要参与工作。而GSM协议规定GSM终端发射功率的范围为EGSM900MHz ：<span style="font-family:Calibri, sans-serif;font-size:10.5pt;">5dBm±5dB到</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">3</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">3</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;"> dBm+-</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">2</span><span style="font-size:10.5pt;font-family:Calibri, sans-serif;">dB，其中有10个功率等级，</span><span>GSM终端发射功率等级是由基站根据模块上报的当地GSM信号强度动态调节，因此在</span><span>GSM终端信号强度较弱时，PA会以较大的功率等级进行放射，当PA以最大功率等级发射时（PCL=5），发射功率在2W左右，此时模块的电源端的电流会达到1.6A到1.8A左右，持续时间在577us左右，如下图：</span></p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-9HBbWQjh5b822d5e0b4fa." style="width:265.5px;" class="img-responsive" alt="attachments-2018-08-9HBbWQjh5b822d5e0b4fa." /><span><br /></span></p>

<p>        由于这个电流是一个突发脉冲电流，就会导致模块电源端VBAT电压的跌落。通常在VBAT管脚端测量到的跌落波形如下：</p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-MLaV9g8W5b826bc7215f2." style="width:223.5px;" class="img-responsive" alt="attachments-2018-08-MLaV9g8W5b826bc7215f2." /><br /></p>

<p>        由于电源走线或者焊接点引入的接触阻抗或者寄生电感导致这种跌落较难以完全避免，通常我们认为400mV左右的跌落之内的幅度是可以接受的，但是大于400mV的跌落就要检查一下电源的设计是否合理了。</p>

<p>        <span>2.发生掉电现象时如何分析和调试：</span><br /></p>

<p>        通常我们可以从如下方面检查电源部分的设计是否合理：1.对于开关电源，我们要先找到是哪里造成的跌落。用示波器分别测量开关电源的输入端和输出端，看看输入端和输出端是否都存着跌落现象，如果在输入端电压就已经跌落，则源头在于输入端电源的供电问题，这时再对开关电源进行调整都作用不大，这是时个很容易忽略的问题。如果输入端无跌落而输出端跌落明显，则说明开关电源部分出了问题。2.对于输入端跌落的问题，我们首先保证要保证输入端的供电能力要大于2A的电流，然后要检测电源到开关电源输入端这段连接走线或者连接器是否存在较大的阻抗。首先外部连接到主板的电源线不能太长，线越长阻抗越大，如果线无法缩短，就要加粗线径或者增加线的数量来减小阻抗。如果用的连接器则检查连接器的接触阻抗。3.对于输出端跌落，则需要检查开关电源的设计问题。首先保证开关电源芯片能够有2A以上的输出能力，其次检查主要器件的参数，输入输出电容容值是否足够，布局位置是否靠近电源芯片；检查功率电感参数是否合适，饱和电流值<span>（isat）</span><span>是否大于2.5A（通常要预留余量），温升电流值</span><span>（irms）</span><span>大于2.5A。4. 检查输出端到模块端的电源走线线宽是否足够，通常要保证1.5MM以上，走线越长，线宽相应增加。5，地平面是否完整，地线回流路径线宽是否足够。这个是个比较容易忽略的问题，通常我们会注重电源的走线设计等，去容易忽略地部分的设计，因为地是电流的回流路径，如果地的回流路径阻抗较大也会影响电压的跌落。在PCB设计中在板上空余的地方都铺上地铜箔，在走线分割严重的地方要多加地孔保证地的连接性。6.加大VBAT管脚电源上的电容，加大到1000uf到2000uf之间，有助于缓解电压跌落现象，建议在主板空间富裕的情况下都应该加上1000uf电容去增加容错性，增加系统的稳定性。</span></p>

<p>        3.在前期的研发测试时如何测试发现这个问题：<span><br /></span></p>

<p>        我们可以根据产生跌落的原理出发，创造一个让设备大功率发射的条件。如果有设备条件，可以通过综测仪（如CMU200,8960等）连接设备，将<span>综测仪模拟成基站，可以将终端设置为PCL=5的功率等级，做GPRS测试，观察设备的表现或者测量VBAT的跌落；如果没有设备可以</span><span>人为的制造一个弱信号的条件，</span><span>可以在楼道间，地下室等墙体比较多的地方，如果没有条件可以在板子上入手，可以去掉天线，或者焊接一个短导线代替天线等方式，总之让CSQ值处于10左右或者以下，且还可以勉强连接网络，这时做数传操作，此情况下终端设备会以大功率或者接近最大功率发射，此时观察设备是否有掉电重启的现象，或者用示波器抓取VBAT电压波形，看电压跌落值是否在合理的范围内。</span></p>

<p>        <span><br /></span></p>

<p><br /></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/26/403/" data-id="ckkfmdgb4004svkcg40g2deie" data-title="Air202/Air800模块异常掉电重启问题分析不完全指南" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-402" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/25/402/" class="article-date">
  <time class="dt-published" datetime="2018-08-25T09:06:49.000Z" itemprop="datePublished">2018-08-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/25/402/">Air202，Air800等GPRS模块无法下载问题分析步骤</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>    模块无法下载或者下载失败有很多原因，如果是初次使用air2XX系列air8XX系列模块建议先按照开发板下载使用说明的步骤检查操作是否有问题，这类问题这里就不多说，这里只针对一些非操作原因列举一些常用的检测手法以供参考：</p>

<p>    1.  首先检查模块是否正常开机，可以通过测量模块的VDDIO管脚电压是否为2.9V左右来判断模块是否处于开机状态。如果拉低PWRKEY管脚仍不能开机或者一松开PWRKEY管脚VDDIO电压就跌落，则要检测供电电压是否在3.55V以上（模块开机检测电压设定为3.55V，如果低于这个值，模块检测电压后会关机），建议供电在4V左右不超过4.2V</p>

<p>    2. 检查模块串口连接是否正确。air2XX或者air8XX系列模块下载只能从下载串口下载（HOST_UART），三线连接即可（HOST_TX HOST_RX GND）,下载口为TTL3.3V串口，波特率固定为921600,因此在选择串转USB下载线时需要符合TTL3.3V的电平（如果选用TTL5V的串口线也是无法通信的）。其次串口线必须支持921600的波特率。</p>

<p>    3.检查下载串口通信是否正常。下载《luat调试工具1.x.x》（在官网的产品中心里任意一个2G模块里的资料下载中有连接），设置好工具后（参考工具操作说明），串口线连接好后模块上电开机，这是观察是否有调试信息打印出来，如果有而且无乱码说明模块的TX通路通信正常，工具可以收到打印信息。这时点击工具上的重启模块按钮，看是否模块能正常重启，如果正常重启说明RX也是OK的，这样就可以判断串口通信正常。如果并没有调试信息出来，说明串口通信异常。常见的影响串口通信的因数有如下几点：1.串口断路或者短路，这个可以通过目检或者用万用表测量来检测。2，下载串口外围器件的影响。很多用户为了做ESD保护在串口上串联K级别的电阻，实际并没有必要，因为模块内部已经串联了1K电阻，外部再串联的话容易导致串口的阻抗过大影响通信，所以下载串口通路上不要串联0欧姆以上的电阻。3.模块下载串口ESD损坏。判断方法：现在保证串口下载线不要连接在下载口上，下载口保持悬空，模块上电开机，开机后，测量模块的HOST_TX和HOST_RX管脚电压是否为2.9V左右如果差别较大，如2V或者1.5V，就可以判断模块的下载口大概率被损坏。</p>

<p>    4.PC端串口环境问题。可以通过更换USB接口，或者重新插拔串口线的方式去排除一些环境问题。或者点击下载调试工具的重启串口按钮，重新初始换串口。</p>

<p>    5.检查是否模块供电外部供电跌落问题引起下载失败。这种情况通常表现为可以触发下载，但是在下载过程中不定点不定时随机下载失败，这是可以用示波器测量模块的供电端在下载过程中是否存在跌落引起的模块掉电关机。</p>

<p>    6.最后只能通过更换模块去对比是否是模块本身不良导致无法下载。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/25/402/" data-id="ckkfmdgb4004rvkcg3r1n3jhg" data-title="Air202，Air800等GPRS模块无法下载问题分析步骤" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-401" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/25/401/" class="article-date">
  <time class="dt-published" datetime="2018-08-25T03:40:10.000Z" itemprop="datePublished">2018-08-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/25/401/">Luat系列教程：5、socket代码详解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>阅读本文需要具有的技能：<br>看过该系列前几篇文章或明白前几篇文章内容的<br>熟悉lua语法，尤其是数组部分<br>可以明白字符串、字节码之间的区别<br>可以自己实践操作<br>对tcp/udp通讯有基本的了解<br>用过这东西</p>
</blockquote>
<p>各位想看mqtt解释的，请等待下一篇文章，不过也可以顺便看看这一篇嘛，二者都差不多的</p>
<h1 id="Socket-TCP-UDP"><a href="#Socket-TCP-UDP" class="headerlink" title="Socket(TCP/UDP)"></a>Socket(TCP/UDP)</h1><p>TCP和UDP除了在lua代码声明时有一些不同，<strong>其他地方完全一样</strong>，所以下面的代码将以TCP长连接的数据收发作为示例，<strong>如果需要UDP连接，只需要改声明对象时的三个字母即可</strong>。</p>
<h2 id="先定义一个假装能用来测试的TCP协议（需求）"><a href="#先定义一个假装能用来测试的TCP协议（需求）" class="headerlink" title="先定义一个假装能用来测试的TCP协议（需求）"></a>先定义一个假装能用来测试的TCP协议（需求）</h2><ul>
<li>客户端<strong>每10秒</strong>发送一条字符串<code>heart beat</code></li>
<li>客户端接收到<code>back</code>开头的数据要<strong>回复相同的数据</strong></li>
<li>客户端收到<code>bin</code>要<strong>回复二进制数组</strong><code>0x11 0x22 0x33</code></li>
<li>客户端收到<code>time</code>要回复当前时间的<strong>时间戳字符串</strong></li>
</ul>
<p>示例时序如下：</p>
<p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-5jS7Adof5b80ced3d77c1.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-5jS7Adof5b80ced3d77c1.png"></a></p>
<h2 id="代码详解"><a href="#代码详解" class="headerlink" title="代码详解"></a>代码详解</h2><h3 id="官方demo提供的示例代码"><a href="#官方demo提供的示例代码" class="headerlink" title="官方demo提供的示例代码"></a>官方demo提供的示例代码</h3><p>官方代码可以在<a target="_blank" rel="noopener" href="https://github.com/openLuat/Luat_2G_RDA_8955/">github</a>的<code>Luat_2G_RDA_8955/script_LuaTask/demo/socket/longConnection</code>目录或luatools的<code>LuaTools 1.x.x\script\script_LuaTask\demo\socket\longConnection</code>目录找到</p>
<p>如果你能看懂官方例程，<strong>那么可以直接去使用，不需要再看本文了</strong></p>
<h3 id="socket连接代码的拆解分析"><a href="#socket连接代码的拆解分析" class="headerlink" title="socket连接代码的拆解分析"></a>socket连接代码的拆解分析</h3><p>这一部分会将官方demo的代码拆开来，只保留基础部分，放到一个文件中来解释</p>
<h4 id="建立文件"><a href="#建立文件" class="headerlink" title="建立文件"></a>建立文件</h4><p>首先先新建两个文件，用于测试这个工程</p>
<p>main.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PROJECT = <span class="string">&quot;SOCKET-TEST&quot;</span></span><br><span class="line">VERSION = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--根据固件判断模块类型</span></span><br><span class="line">moduleType = <span class="built_in">string</span>.<span class="built_in">find</span>(rtos.get_version(),<span class="string">&quot;8955&quot;</span>) <span class="keyword">and</span> <span class="number">2</span> <span class="keyword">or</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">LOG_LEVEL = <span class="built_in">log</span>.LOGLEVEL_TRACE</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;sys&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--每1分钟查询一次GSM信号强度,每1分钟查询一次基站信息</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;net&quot;</span></span><br><span class="line">net.startQueryAll(<span class="number">60000</span>, <span class="number">60000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载硬件看门狗功能模块</span></span><br><span class="line"><span class="comment">--如果用的是720 4g模块，请注释掉这两行</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;wdt&quot;</span></span><br><span class="line">wdt.setup(pio.P0_30, pio.P0_31)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载网络指示灯功能模块</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;netLed&quot;</span></span><br><span class="line">netLed.setup(<span class="literal">true</span>,moduleType == <span class="number">2</span> <span class="keyword">and</span> pio.P1_1 <span class="keyword">or</span> pio.P2_0,moduleType == <span class="number">2</span> <span class="keyword">and</span> <span class="literal">nil</span> <span class="keyword">or</span> pio.P2_1)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;longlink&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动系统框架</span></span><br><span class="line">sys.init(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">sys.run()</span><br></pre></td></tr></table></figure>
<p>longlink.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(...,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;socket&quot;</span></span><br><span class="line"><span class="comment">--下面代码一会儿写</span></span><br></pre></td></tr></table></figure>
<h4 id="找一个测试用的服务器"><a href="#找一个测试用的服务器" class="headerlink" title="找一个测试用的服务器"></a>找一个测试用的服务器</h4><p>2G模块socket测试和wifi有着本质的区别：没法使用内网来调试，必须要使用一个公网服务器来调试</p>
<p>为了解决这个问题，luat官方提供了一个tcp测试实验室网站服务：<a target="_blank" rel="noopener" href="http://tcplab.openluat.com/" title="http://tcplab.openluat.com/">http://tcplab.openluat.com/</a><br>这个工具有一个坏处，就是三分钟没有客户端连接的话就会被强行关闭服务。我们可以在本地用一个tcp调试工具提前连上，就不会被强制关闭服务了。</p>
<p>打开后可以直接获取从服务器分配的ip、端口，还能接收客户端数据、主动发送数据<br>记住自己获取到的ip和端口，在下面的代码中会被使用到</p>
<h4 id="建立socket线程"><a href="#建立socket线程" class="headerlink" title="建立socket线程"></a>建立socket线程</h4><p>一般来说，socket连接都是异步运行的，何时应该发送数据，何时应该接收数据，这些逻辑应该让socket收发的进程自己进行控制</p>
<p>所以我们在<code>longlink.lua</code>中添加一个新的线程（看不懂的回去看前几篇文章），文件改成如下（<code>注意要自己改东西！</code>）：</p>
<p>longlink.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(...,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;socket&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--测试用的服务器信息，上一部分获取到的那个</span></span><br><span class="line"><span class="keyword">local</span> testip,testport = <span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动socket客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="comment">--该区域的代码会永久循环运行（除非出现语法错误）</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h4 id="进行socket连接"><a href="#进行socket连接" class="headerlink" title="进行socket连接"></a>进行socket连接</h4><p>一般来说，我们会在模块成功获取基站分配的ip后，才会进行网络的连接操作，所以我们需要使用<code>socket.isReady()</code>函数来判断是否连接网络，然后再进行网络操作</p>
<p>在成功获取ip后，我们才能新建一个tcp对象，对其进行联网操作，socket客户端线程代码改为如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动socket客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="comment">--新建一个socket对象，如果是udp只需要把tcp改成udp即可</span></span><br><span class="line">            <span class="keyword">local</span> socketClient = socket.tcp()</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> socketClient:connect(testip,testport) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)</span><br><span class="line">                <span class="comment">--连接失败</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网，原地等待一秒，一秒后会循环回去重试</span></span><br><span class="line">            sys.wait(<span class="number">1000</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h4 id="对连接失败的处理"><a href="#对连接失败的处理" class="headerlink" title="对连接失败的处理"></a>对连接失败的处理</h4><p>上述代码只是一个简单的连接服务器的代码，并且连上之后没有进行任何的其他操作</p>
<p>为了增加代码的稳健性，我们可以利用<code>sys.waitUntil()</code>函数，设置五分钟内没有获取到ip就开启飞行模式几秒，再关闭，让模块重新去获取GPRS连接：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动socket客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="comment">--新建一个socket对象，如果是udp只需要把tcp改成udp即可</span></span><br><span class="line">            <span class="keyword">local</span> socketClient = socket.tcp()</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> socketClient:connect(testip,testport) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)</span><br><span class="line">                <span class="comment">--连接失败</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<p>同样，我们也可以给<code>socketClient:connect(testip,testport)</code>的连接加上错误次数的判断，连接错误超过五次，强制断开socket连接,等待五秒后重试：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动socket客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="comment">--新建一个socket对象，如果是udp只需要把tcp改成udp即可</span></span><br><span class="line">            <span class="keyword">local</span> socketClient = socket.tcp()</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> socketClient:connect(testip,testport) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)</span><br><span class="line">                <span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            socketClient:<span class="built_in">close</span>()    <span class="comment">--断开socket连接</span></span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span>  <span class="comment">--失败次数大于五次了</span></span><br><span class="line">                link.shut()         <span class="comment">--强制断开TCP/UDP连接</span></span><br><span class="line">                retryConnectCnt=<span class="number">0</span>   <span class="comment">--失败次数清零</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            retryConnectCnt = <span class="number">0</span>     <span class="comment">--没连上网，失败次数清零</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h4 id="添加发送-接收处理函数"><a href="#添加发送-接收处理函数" class="headerlink" title="添加发送/接收处理函数"></a>添加发送/接收处理函数</h4><p>到了这一步，整个的socket线程只剩下<code>循环处理接收和发送的数据</code>这一部分与demo不同了，我们直接把这两句话加到socket线程的代码中吧：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动socket客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="comment">--新建一个socket对象，如果是udp只需要把tcp改成udp即可</span></span><br><span class="line">            <span class="keyword">local</span> socketClient = socket.tcp()</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> socketClient:connect(testip,testport) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">--循环处理接收和发送的数据</span></span><br><span class="line">                <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> inMsgProcess(socketClient) <span class="keyword">then</span>  <span class="comment">--接收消息处理函数</span></span><br><span class="line">                        <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;longlink.inMsgProcess error&quot;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> outMsgprocess(socketClient) <span class="keyword">then</span> <span class="comment">--发送消息处理函数</span></span><br><span class="line">                        <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;longlink.outMsgprocess error&quot;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)</span><br><span class="line">                <span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            socketClient:<span class="built_in">close</span>()    <span class="comment">--断开socket连接</span></span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span>  <span class="comment">--失败次数大于五次了</span></span><br><span class="line">                link.shut()         <span class="comment">--强制断开TCP/UDP连接</span></span><br><span class="line">                retryConnectCnt=<span class="number">0</span>   <span class="comment">--失败次数清零</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            retryConnectCnt = <span class="number">0</span>     <span class="comment">--没连上网，失败次数清零</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到，在接收和发送函数不返回false的情况下，接收和发送循环会一直进行下去；只有当两个函数之一返回false时，才会触发break导致退出该接收和发送循环</p>
<h5 id="inMsgProcess-socketClient-函数"><a href="#inMsgProcess-socketClient-函数" class="headerlink" title="inMsgProcess(socketClient)函数"></a>inMsgProcess(socketClient)函数</h5><p>这段的代码相对来说比较简单，我们可以直接使用<code>socketClient:recv(毫秒数)</code>来接收我们的tcp消息。<br>我们在合适的地方，新建一个<code>inMsgProcess(socketClient)</code>函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inMsgProcess</span><span class="params">(socketClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = socketClient:recv(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span>  <span class="comment">--接收成功</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;longlink.inMsgProcess&quot;</span>,data)</span><br><span class="line">            <span class="comment">--处理data数据，现在还没代码，空着</span></span><br><span class="line">        <span class="keyword">else</span>    <span class="comment">--接收失败</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">--返回结果，处理成功返回true，处理出错返回false</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这段代码就是循环获取socket消息，如果没获取到，<code>socketClient:recv(2000)</code>就会返回<code>false,&quot;timeout&quot;</code>；如果获取到了，就会返回<code>true,获取到的数据字符串</code>；如果返回了<code>false,不为&quot;timeout&quot;</code>，则表示数据处理出错，说明socket连接有了什么问题</p>
<p>细心的读者可能看出来了，如果接收函数一直在2秒内有接收到数据，那么这段函数会永远无限循环下去，没办法到达<code>outMsgprocess(socketClient)</code>函数进行发送数据的操作，所以我们先去讲<code>outMsgprocess(socketClient)</code>函数的实现过程，再回来改进<code>inMsgProcess(socketClient)</code>函数</p>
<h5 id="outMsgprocess-socketClient-函数"><a href="#outMsgprocess-socketClient-函数" class="headerlink" title="outMsgprocess(socketClient)函数"></a>outMsgprocess(socketClient)函数</h5><p>由于发送函数在socket线程中是一个循环的小部分，所以我们要建立一个消息发送的队列：有要发送的发数据时，将数据放到这个队列中；等运行到<code>outMsgprocess(socketClient)</code>函数时，将队列中的数据一个一个发出去</p>
<p>首先我们要建一个放这种队列的数组，在合适位置声明一下这个数组：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--数据发送的消息队列</span></span><br><span class="line"><span class="keyword">local</span> msgQuene = &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>接着我们构造一个可以往数组里插入数据的函数，<code>table.insert()</code>可以向数组添加数据，所以我们新建一个<code>insertMsg</code>函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">insertMsg</span><span class="params">(data)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(msgQuene,data)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>还记得上面说过的<code>消息接收函数函数会永远无限循环下去</code>的问题吗？我们在合适的地方新建一个判断发送消息队列是否为空的函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waitForSend</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> #msgQuene &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在数组有数据时，这个函数会返回true，我们可以将<code>inMsgProcess(socketClient)</code>接收到数据后的代码添加一行判断发送队列是否有数据的代码，当检测到发送队列有数据时，就立即退出接收函数，转而去进行发送动作，接收函数最终改为了这样：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inMsgProcess</span><span class="params">(socketClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = socketClient:recv(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span>  <span class="comment">--接收成功</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;longlink.inMsgProcess&quot;</span>,data)</span><br><span class="line">            <span class="comment">--处理data数据，现在还没代码，空着</span></span><br><span class="line">            <span class="comment">--如果msgQuene中有等待发送的数据，则立即退出本循环</span></span><br><span class="line">            <span class="keyword">if</span> waitForSend() <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span>    <span class="comment">--接收失败</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">--返回结果，处理成功返回true，处理出错返回false</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>最后我们终于可以开始写消息发送函数了，整体的函数就是检查队列是否为空，不为空的话就发一条消息并将其从队列中删除，然后重复这一操作，函数代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">outMsgprocess</span><span class="params">(socketClient)</span></span></span><br><span class="line">    <span class="comment">--队列中有消息</span></span><br><span class="line">    <span class="keyword">while</span> #msgQuene&gt;<span class="number">0</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--获取消息，并从队列中删除</span></span><br><span class="line">        <span class="keyword">local</span> outMsg = <span class="built_in">table</span>.<span class="built_in">remove</span>(msgQuene,<span class="number">1</span>)</span><br><span class="line">        <span class="comment">--发送这条消息，并获取发送结果</span></span><br><span class="line">        <span class="keyword">local</span> result = socketClient:send(outMsg)</span><br><span class="line">        <span class="comment">--发送失败的话立刻返回nil（等同于false）</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="完成基本的socket线程"><a href="#完成基本的socket线程" class="headerlink" title="完成基本的socket线程"></a>完成基本的socket线程</h4><p>经过上述的更改，最终，<code>longlink.lua</code>已经实现了连接服务器并自动处理错误的功能，并且预留了消息接收以及向发送队列添加数据的接口，文件的所有代码如下：</p>
<p>longlink.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(...,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;socket&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--测试用的服务器信息</span></span><br><span class="line"><span class="keyword">local</span> testip,testport = <span class="string">&quot;180.97.81.180&quot;</span>,<span class="string">&quot;50798&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--数据发送的消息队列</span></span><br><span class="line"><span class="keyword">local</span> msgQuene = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">insertMsg</span><span class="params">(data)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(msgQuene,data)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waitForSend</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> #msgQuene &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">outMsgprocess</span><span class="params">(socketClient)</span></span></span><br><span class="line">    <span class="comment">--队列中有消息</span></span><br><span class="line">    <span class="keyword">while</span> #msgQuene&gt;<span class="number">0</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--获取消息，并从队列中删除</span></span><br><span class="line">        <span class="keyword">local</span> outMsg = <span class="built_in">table</span>.<span class="built_in">remove</span>(msgQuene,<span class="number">1</span>)</span><br><span class="line">        <span class="comment">--发送这条消息，并获取发送结果</span></span><br><span class="line">        <span class="keyword">local</span> result = socketClient:send(outMsg)</span><br><span class="line">        <span class="comment">--发送失败的话立刻返回nil（等同于false）</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inMsgProcess</span><span class="params">(socketClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = socketClient:recv(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span>  <span class="comment">--接收成功</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;longlink.inMsgProcess&quot;</span>,data)</span><br><span class="line">            <span class="comment">--处理data数据，现在还没代码，空着</span></span><br><span class="line">            <span class="comment">--如果msgQuene中有等待发送的数据，则立即退出本循环</span></span><br><span class="line">            <span class="keyword">if</span> waitForSend() <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span>    <span class="comment">--接收失败</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">--返回结果，处理成功返回true，处理出错返回false</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动socket客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="comment">--新建一个socket对象，如果是udp只需要把tcp改成udp即可</span></span><br><span class="line">            <span class="keyword">local</span> socketClient = socket.tcp()</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> socketClient:connect(testip,testport) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">--循环处理接收和发送的数据</span></span><br><span class="line">                <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> inMsgProcess(socketClient) <span class="keyword">then</span>  <span class="comment">--接收消息处理函数</span></span><br><span class="line">                        <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;longlink.inMsgProcess error&quot;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> outMsgprocess(socketClient) <span class="keyword">then</span> <span class="comment">--发送消息处理函数</span></span><br><span class="line">                        <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;longlink.outMsgprocess error&quot;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)</span><br><span class="line">                <span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            socketClient:<span class="built_in">close</span>()    <span class="comment">--断开socket连接</span></span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span>  <span class="comment">--失败次数大于五次了</span></span><br><span class="line">                link.shut()         <span class="comment">--强制断开TCP/UDP连接</span></span><br><span class="line">                retryConnectCnt=<span class="number">0</span>   <span class="comment">--失败次数清零</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            retryConnectCnt = <span class="number">0</span>     <span class="comment">--没连上网，失败次数清零</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<p>烧录到模块中，可以得到正常的连接结果：</p>
<p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-BEW4mw2z5b83d0723287a.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-BEW4mw2z5b83d0723287a.png"></a></p>
<h3 id="实现协议需求"><a href="#实现协议需求" class="headerlink" title="实现协议需求"></a>实现协议需求</h3><h4 id="心跳包需求"><a href="#心跳包需求" class="headerlink" title="心跳包需求"></a>心跳包需求</h4><p>这个需求极其简单，只需要建立一个新的线程，在联网后往消息队列中添加数据即可，代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动心跳包任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span>    <span class="comment">--连上网再开始运行</span></span><br><span class="line">            insertMsg(<span class="string">&quot;heart beat&quot;</span>) <span class="comment">--队列里塞个消息</span></span><br><span class="line">            sys.wait(<span class="number">10000</span>)         <span class="comment">--等待10秒</span></span><br><span class="line">        <span class="keyword">else</span>    <span class="comment">--没连上网别忘了延时！不然会陷入while true死循环，导致模块无法运行其他代码</span></span><br><span class="line">            sys.wait(<span class="number">1000</span>)          <span class="comment">--等待1秒</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h4 id="收到back开头的数据要回复相同的数据"><a href="#收到back开头的数据要回复相同的数据" class="headerlink" title="收到back开头的数据要回复相同的数据"></a>收到back开头的数据要回复相同的数据</h4><p>这一条功能十分简单，只需要在<code>inMsgProcess()</code>函数中，写了<code>--处理data数据，现在还没代码，空着</code>这段注释的地方添加相应代码即可，代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--处理data数据</span></span><br><span class="line"><span class="keyword">if</span> data:<span class="built_in">sub</span>(<span class="number">1</span>,<span class="number">4</span>) == <span class="string">&quot;back&quot;</span> <span class="keyword">then</span> <span class="comment">--收到back开头的数据要回复相同的数据</span></span><br><span class="line">    insertMsg(data)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="客户端收到bin要回复二进制数组0x11-0x22-0x33"><a href="#客户端收到bin要回复二进制数组0x11-0x22-0x33" class="headerlink" title="客户端收到bin要回复二进制数组0x11 0x22 0x33"></a>客户端收到bin要回复二进制数组0x11 0x22 0x33</h4><p>这个功能和上面差不多，返回的东西不一样而已，拼接字节码我们可以用pack，也可以直接用fromHex，下面两种方法都示范一下：</p>
<p>pack方式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> data == <span class="string">&quot;bin&quot;</span> <span class="keyword">then</span> <span class="comment">--收到bin要回复二进制数组0x11 0x22 0x33</span></span><br><span class="line">    insertMsg(pack.pack(<span class="string">&quot;&gt;bbb&quot;</span>,<span class="number">0x11</span>,<span class="number">0x22</span>,<span class="number">0x33</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>fromHex方式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> data == <span class="string">&quot;bin&quot;</span> <span class="keyword">then</span> <span class="comment">--收到bin要回复二进制数组0x11 0x22 0x33</span></span><br><span class="line">    insertMsg(<span class="built_in">string</span>.fromHex(<span class="string">&quot;112233&quot;</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="收到time要回复当前时间的时间戳字符串"><a href="#收到time要回复当前时间的时间戳字符串" class="headerlink" title="收到time要回复当前时间的时间戳字符串"></a>收到time要回复当前时间的时间戳字符串</h4><p>进行这个操作，要在开机的时候先同步一下时间，我们可以使用demo中的同步ntp来实现。在main.lua中的<code>启动系统框架</code>上方添加两行同步代码即可：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;ntp&quot;</span></span><br><span class="line">ntp.timeSync()</span><br></pre></td></tr></table></figure>
<p>接着和上面一样，在消息接收处返回需要的数据即可：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> data == <span class="string">&quot;time&quot;</span> <span class="keyword">then</span> <span class="comment">--收到time要回复当前时间的时间戳字符串</span></span><br><span class="line">    insertMsg(<span class="built_in">tostring</span>(<span class="built_in">os</span>.<span class="built_in">time</span>()))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><p>经过上面的删删改改，功能以及基本实现了，整个文件的代码如下：</p>
<p>longlink.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(...,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;socket&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--测试用的服务器信息</span></span><br><span class="line"><span class="keyword">local</span> testip,testport = <span class="string">&quot;180.97.81.180&quot;</span>,<span class="string">&quot;50798&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--数据发送的消息队列</span></span><br><span class="line"><span class="keyword">local</span> msgQuene = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">insertMsg</span><span class="params">(data)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(msgQuene,data)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waitForSend</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> #msgQuene &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">outMsgprocess</span><span class="params">(socketClient)</span></span></span><br><span class="line">    <span class="comment">--队列中有消息</span></span><br><span class="line">    <span class="keyword">while</span> #msgQuene&gt;<span class="number">0</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--获取消息，并从队列中删除</span></span><br><span class="line">        <span class="keyword">local</span> outMsg = <span class="built_in">table</span>.<span class="built_in">remove</span>(msgQuene,<span class="number">1</span>)</span><br><span class="line">        <span class="comment">--发送这条消息，并获取发送结果</span></span><br><span class="line">        <span class="keyword">local</span> result = socketClient:send(outMsg)</span><br><span class="line">        <span class="comment">--发送失败的话立刻返回nil（等同于false）</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inMsgProcess</span><span class="params">(socketClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = socketClient:recv(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span>  <span class="comment">--接收成功</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;longlink.inMsgProcess&quot;</span>,data)</span><br><span class="line">            <span class="comment">--处理data数据</span></span><br><span class="line">            <span class="keyword">if</span> data:<span class="built_in">sub</span>(<span class="number">1</span>,<span class="number">4</span>) == <span class="string">&quot;back&quot;</span> <span class="keyword">then</span> <span class="comment">--收到back开头的数据要回复相同的数据</span></span><br><span class="line">                insertMsg(data)</span><br><span class="line">            <span class="keyword">elseif</span> data == <span class="string">&quot;bin&quot;</span> <span class="keyword">then</span> <span class="comment">--收到bin要回复二进制数组0x11 0x22 0x33</span></span><br><span class="line">                insertMsg(<span class="built_in">string</span>.fromHex(<span class="string">&quot;112233&quot;</span>))</span><br><span class="line">            <span class="keyword">elseif</span> data == <span class="string">&quot;time&quot;</span> <span class="keyword">then</span> <span class="comment">--收到time要回复当前时间的时间戳字符串</span></span><br><span class="line">                insertMsg(<span class="built_in">tostring</span>(<span class="built_in">os</span>.<span class="built_in">time</span>()))</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--如果msgQuene中有等待发送的数据，则立即退出本循环</span></span><br><span class="line">            <span class="keyword">if</span> waitForSend() <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span>    <span class="comment">--接收失败</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">--返回结果，处理成功返回true，处理出错返回false</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动socket客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="comment">--新建一个socket对象，如果是udp只需要把tcp改成udp即可</span></span><br><span class="line">            <span class="keyword">local</span> socketClient = socket.tcp()</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> socketClient:connect(testip,testport) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">--循环处理接收和发送的数据</span></span><br><span class="line">                <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> inMsgProcess(socketClient) <span class="keyword">then</span>  <span class="comment">--接收消息处理函数</span></span><br><span class="line">                        <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;longlink.inMsgProcess error&quot;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> outMsgprocess(socketClient) <span class="keyword">then</span> <span class="comment">--发送消息处理函数</span></span><br><span class="line">                        <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;longlink.outMsgprocess error&quot;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;longlink.socketClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)</span><br><span class="line">                <span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            socketClient:<span class="built_in">close</span>()    <span class="comment">--断开socket连接</span></span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span>  <span class="comment">--失败次数大于五次了</span></span><br><span class="line">                link.shut()         <span class="comment">--强制断开TCP/UDP连接</span></span><br><span class="line">                retryConnectCnt=<span class="number">0</span>   <span class="comment">--失败次数清零</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            retryConnectCnt = <span class="number">0</span>     <span class="comment">--没连上网，失败次数清零</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--启动心跳包任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span>    <span class="comment">--连上网再开始运行</span></span><br><span class="line">            insertMsg(<span class="string">&quot;heart beat&quot;</span>) <span class="comment">--队列里塞个消息</span></span><br><span class="line">            sys.wait(<span class="number">10000</span>)         <span class="comment">--等待10秒</span></span><br><span class="line">        <span class="keyword">else</span>    <span class="comment">--没连上网别忘了延时！不然会陷入while true死循环，导致模块无法运行其他代码</span></span><br><span class="line">            sys.wait(<span class="number">1000</span>)          <span class="comment">--等待1秒</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<p>main.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PROJECT = <span class="string">&quot;SOCKET-TEST&quot;</span></span><br><span class="line">VERSION = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">LOG_LEVEL = <span class="built_in">log</span>.LOGLEVEL_TRACE</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;sys&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--每1分钟查询一次GSM信号强度,每1分钟查询一次基站信息</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;net&quot;</span></span><br><span class="line">net.startQueryAll(<span class="number">60000</span>, <span class="number">60000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载硬件看门狗功能模块</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;wdt&quot;</span></span><br><span class="line">wdt.setup(pio.P0_30, pio.P0_31)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载网络指示灯功能模块</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;netLed&quot;</span></span><br><span class="line">netLed.setup(<span class="literal">true</span>,pio.P1_1)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;longlink&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;ntp&quot;</span></span><br><span class="line">ntp.timeSync()</span><br><span class="line"></span><br><span class="line"><span class="comment">--启动系统框架</span></span><br><span class="line">sys.init(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">sys.run()</span><br></pre></td></tr></table></figure>
<h2 id="验证功能"><a href="#验证功能" class="headerlink" title="验证功能"></a>验证功能</h2><p>把最终代码烧录进去，按需求测试即可：</p>
<p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-sY7XgR6O5b83d08d9439d.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-sY7XgR6O5b83d08d9439d.png"></a></p>
<p>很明显，功能符合预期。</p>
<p>如有错误或疑问请在下方留言，谢谢！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/25/401/" data-id="ckkfmdgec00covkcgcj3117og" data-title="Luat系列教程：5、socket代码详解" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-400" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/25/400/" class="article-date">
  <time class="dt-published" datetime="2018-08-25T03:33:09.000Z" itemprop="datePublished">2018-08-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/25/400/">Luat系列教程：4、学会使用并看懂luatools的trace信息</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>适合阅读本文的人需要：<br>理解或已经学习了前几章的内容<br>熟悉lua语法<br>有实际模块，可以自己实践验证<br>能耐心阅读完本文<br>有问题会在文章下方进行留言</p>
</blockquote>
<p>由于luat这个架构并不能直接连接仿真器进行调试，所以也无法在程序中设置断点来检查自己代码是否有问题，所以在开发过程中，一般我们都是靠各种print来输出trace获取程序运行的各种状态的。<br>并且由于lua是脚本文件，烧录时并没有进行编译，所以就算是报错，报错信息也可以准确地把错误所在行的具体位置详细指出来，方便我们进行排查问题</p>
<h1 id="trace的几个基本部分"><a href="#trace的几个基本部分" class="headerlink" title="trace的几个基本部分"></a>trace的几个基本部分</h1><p>首先我们随便烧录一个程序，就只包含下面一个main.lua和自带的LuaTask库文件好了：<br>main.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">PROJECT = <span class="string">&quot;LOG-TEST&quot;</span></span><br><span class="line">VERSION = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--加载日志功能模块，并且设置日志输出等级</span></span><br><span class="line"><span class="comment">--如果关闭调用log模块接口输出的日志，等级设置为log.LOG_SILENT即可</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">LOG_LEVEL = <span class="built_in">log</span>.LOGLEVEL_TRACE</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;sys&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="comment">--每1分钟查询一次GSM信号强度</span></span><br><span class="line"><span class="comment">--每1分钟查询一次基站信息</span></span><br><span class="line">net.startQueryAll(<span class="number">60000</span>, <span class="number">60000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载硬件看门狗功能模块</span></span><br><span class="line"><span class="comment">--根据自己的硬件配置决定：1、是否加载此功能模块；2、配置Luat模块复位单片机引脚和互相喂狗引脚</span></span><br><span class="line"><span class="comment">--合宙官方出售的Air201开发板上有硬件看门狗，所以使用官方Air201开发板时，必须加载此功能模块</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;wdt&quot;</span></span><br><span class="line">wdt.setup(pio.P0_30, pio.P0_31)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--加载网络指示灯功能模块</span></span><br><span class="line"><span class="comment">--根据自己的项目需求和硬件配置决定：1、是否加载此功能模块；2、配置指示灯引脚</span></span><br><span class="line"><span class="comment">--合宙官方出售的Air800和Air801开发板上的指示灯引脚为pio.P0_28，其他开发板上的指示灯引脚为pio.P1_1</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;netLed&quot;</span></span><br><span class="line">netLed.setup(<span class="literal">true</span>,pio.P1_1)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载错误日志管理功能模块【强烈建议打开此功能】</span></span><br><span class="line"><span class="comment">--如下2行代码，只是简单的演示如何使用errDump功能，详情参考errDump的api</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;errDump&quot;</span></span><br><span class="line">errDump.request(<span class="string">&quot;udp://ota.airm2m.com:9072&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--启动系统框架</span></span><br><span class="line">sys.init(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">sys.run()</span><br></pre></td></tr></table></figure>
<p>程序中除了必要的<code>声明软件版本和名称</code>、<code>初始化看门狗</code>、<code>初始化网络灯</code>、<code>加载错误日志管理功能模块</code>、<code>启动系统框架</code>之外，没有进行其他任何操作（lib库文件和lod底层里进行的各种操作除外）<br>我们可以将这个文件烧录到开发板中，查看trace的各种信息（这里用的是S9开发板）：</p>
<p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-zqejrkLg5b80ccf881f86.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-zqejrkLg5b80ccf881f86.png"></a><br><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-MRIMreS55b80cd1353c4c.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-MRIMreS55b80cd1353c4c.png"></a><br>↑显示烧录成功后，最好立即关闭烧录界面，以免错过一些开头的trace信息。实际开发中一般错过了也没事，反正开头的一些东西也没什么用</p>
<p>我们可以看到trace中输出了一些信息：<br><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-bwJsOQOb5b80cd25ac9f6.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-bwJsOQOb5b80cd25ac9f6.png"></a></p>
<blockquote>
<p>由于trace中大多数的信息是由lib库文件打印出来的，随时可能会有更改，所以下面也就讲个大概，具体要以实际为准</p>
</blockquote>
<p>为了更好地观察，我们可以点击<code>停止打印</code>按钮，以免刷新新的log信息导致滚动条回到最低端：<br><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-5Qp0X2s15b80cd3f7b0fe.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-5Qp0X2s15b80cd3f7b0fe.png"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[时间]: CDFU_LoadSection: %d-%d</span><br><span class="line"></span><br><span class="line">[时间]: CDFU_LoadSection: %d-%d</span><br><span class="line"></span><br><span class="line">[时间]: &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[时间]: INTR VER :Luat_V0027_8955_SSL_UI</span><br><span class="line">[时间]: BASE VER :B5431</span><br><span class="line">[时间]: SCRIPT ADDR :0x002b0000</span><br><span class="line">[时间]: SCRIPT SIZE :0x000b0000</span><br><span class="line">[时间]: BASE   ADDR :0x00220000</span><br><span class="line">[时间]: BASE   SIZE :0x00090000</span><br><span class="line">[时间]: &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[时间]: [cust_task_main]: Enter message loop</span><br><span class="line">[时间]: INTEGRITY file not exist!</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;wdt.lua,len&#x3D;589,offset&#x3D;29006</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;utils.lua,len&#x3D;2526,offset&#x3D;26455</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;sys.lua,len&#x3D;5472,offset&#x3D;20956</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;sim.lua,len&#x3D;1084,offset&#x3D;19847</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;ril.lua,len&#x3D;7790,offset&#x3D;12032</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;pins.lua,len&#x3D;946,offset&#x3D;11061</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;patch.lua,len&#x3D;1186,offset&#x3D;9849</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;netLed.lua,len&#x3D;2601,offset&#x3D;7221</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;net.lua,len&#x3D;5141,offset&#x3D;2052</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;main.lua,len&#x3D;280,offset&#x3D;1747</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;log.lua,len&#x3D;1174,offset&#x3D;547</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;clib.lua,len&#x3D;472,offset&#x3D;50</span><br><span class="line">[时间]: parse_luadb_data:delupdpack&#x3D;0,err&#x3D;0,section&#x3D;1,wrFile&#x3D;0</span><br><span class="line">[时间]: INTEGRITY file write begin!</span><br><span class="line">[时间]: lualibc_fopen &#x2F;integrity.bin wb 601 1 2</span><br><span class="line">[时间]: INTEGRITY file write success!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;main.lua 2!</span><br><span class="line">[时间]: RUN main.lua</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;main.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;log.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;log.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;sys.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;sys.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;utils.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;utils.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;patch.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;patch.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;clib.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;clib.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;net.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;net.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;ril.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;ril.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;sim.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;sim.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;wdt.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;wdt.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;pins.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;pins.lua 2!</span><br><span class="line">[时间]: [I]-[wdt.taskWdt]	AirM2M --&gt; WATCHDOG : OK</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;netLed.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;netLed.lua 2!</span><br><span class="line">&#x2F;******************************温馨提示**************************************&#x2F;</span><br><span class="line">软件开机,如果是意外重启,请去http:&#x2F;&#x2F;wiki.openluat.com&#x2F;doc&#x2F;luatApi&#x2F;#rtospoweron,查看</span><br><span class="line">&#x2F;******************************提示结束**************************************&#x2F;</span><br></pre></td></tr></table></figure>
<p>开头的这一些代码表示读取到了上述的这些文件，可以用于后续的运行</p>
<blockquote>
<p>注意：<br>我们烧录进模块的lua文件一般都在<code>/lua/</code>路径下<br>而烧录的其他文件如png图片、mp3音乐，则会在<code>/ldata/</code>路径下</p>
</blockquote>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [I]-[poweron reason:]	3	LOG-TEST	1.0.0	2.0.8	Luat_V0027_8955_SSL_UI</span><br></pre></td></tr></table></figure>
<p>这一行代表了<code>上次关机的原因</code>、<code>脚本工程里定义的名称（main.lua第1行写的）</code>、<code>脚本工程里定义的版本号（main.lua第2行写的）</code>、<code>LuaTask库文件的版本号（1.x.x是旧版的lua script，2.x.x是LuaTask）</code>、<code>lod固件的版本号</code></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[时间]: LJD VSIM sim_SetNextVoltage:1048,sim_present&#x3D;0,IsVsim&#x3D;0</span><br><span class="line">[时间]: LJD VSIM sim_ProcessInstruction:2784,sim_present&#x3D;1,IsVsim&#x3D;1</span><br></pre></td></tr></table></figure>
<p>这两行的IsVsim=1代表了当前模块拥有虚拟sim卡，sim_present=1代表没检测到外置sim卡，所以就使用内置的虚拟sim卡（可能是吧，我猜的）</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [I]-[ril.defrsp]	AT+CMEE&#x3D;0	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CREG&#x3D;2</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CREG&#x3D;2	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CREG?</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CREG: 2,0</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CREG?	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CENG&#x3D;1,1</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CSQ</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CSQ: 0,0</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CENG?</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CENG:1,1</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CENG:0,&quot;0000, 0, 0,000,00,00,0000,00,00,0000,00&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CSQ</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CSQ: 0,0</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CENG?</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CENG:1,1</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CENG:0,&quot;0000, 0, 0,000,00,00,0000,00,00,0000,00&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CSIMTYPE: 0,0</span><br><span class="line">[时间]: [I]-[ril.defurc]	+CSIMTYPE: 0,0</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	+ENCRET: 0</span><br><span class="line">[时间]: [I]-[ril.defurc]	+ENCRET: 0</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CPIN: READY</span><br></pre></td></tr></table></figure>
<p>上面这些就是lua脚本底层里，调用AT接口来对模块进行的操作了。熟悉AT指令的人会一下子就明白这些，不熟悉的人可以无视，只要知道这些是调用的AT指令就可以，操作基本都由底层和lib库来完成，一般情况下不用接触</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [I]-[wdt.taskWdt]	AirM2M --&gt; WATCHDOG : OK</span><br><span class="line">[时间]: [I]-[wdt.taskWdt]	AirM2M &lt;-- WatchDog : OK</span><br></pre></td></tr></table></figure>
<p>这是看门狗的喂狗操作。。。我觉得我不用解释了吧。。。</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [I]-[ril.defrsp]	AT+CIPSTATUS	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	STATE: IP INITIAL</span><br><span class="line">[时间]: [I]-[link.STATE]	IP STATUS	IP INITIAL</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 0,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 0,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 1,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 1,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 2,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 2,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 3,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 3,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 4,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 4,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 5,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 5,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 6,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 6,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 7,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 7,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CSTT&#x3D;&quot;CMIOT&quot;,&quot;&quot;,&quot;&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CSTT&#x3D;&quot;CMIOT&quot;,&quot;&quot;,&quot;&quot;	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CIICR</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CIICR	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	STATE: IP GPRSACT</span><br><span class="line">[时间]: [I]-[link.STATE]	IP STATUS	IP GPRSACT</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CIFSR</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	010.007.081.239</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CIFSR	true	nil	010.007.081.239</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CIPSTATUS</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CIPSTATUS	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	STATE: IP STATUS</span><br><span class="line">[时间]: [I]-[link.STATE]	IP STATUS	IP STATUS</span><br><span class="line">[时间]: [I]-[ril.proatc]</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 0,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 0,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 1,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 1,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 2,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 2,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 3,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 3,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 4,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 4,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 5,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 5,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 6,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 6,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 7,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 7,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br></pre></td></tr></table></figure>
<p>熟悉AT的各位如果看到这两大串，一定又明白了，这模块连上GPRS网络了。不明白的大概了解一下就好，可以在测试时作为参考</p>
<hr>
<p>基本的trace就讲到这里，具体的自己去研究吧</p>
<h1 id="自定义输出trace（LuaTask格式）"><a href="#自定义输出trace（LuaTask格式）" class="headerlink" title="自定义输出trace（LuaTask格式）"></a>自定义输出trace（LuaTask格式）</h1><p>在第一版lua script时代，输出的trace基本都是直接使用<code>print(xxxxx)</code>这种格式，这个输出习惯的效果不怎么样，也不利于排查问题<br>于是在稀饭放姜大佬写的LuaTask版本中，使用了<code>log</code>语句，输出整齐具有区分度较高格式的trace</p>
<p>老套路，我们在上面的main.lua中稍作修改，在<code>--启动系统框架</code>的上方添加如下代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;logtest&quot;</span></span><br></pre></td></tr></table></figure>
<p>并且新建一个lua文件，名为<code>logtest.lua</code>，文件内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;common&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">log</span>.info(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出info级别的日志&quot;</span>))</span><br><span class="line">	<span class="built_in">log</span>.<span class="built_in">debug</span>(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出debug级别的日志&quot;</span>))</span><br><span class="line">	<span class="built_in">log</span>.trace(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出trace级别的日志&quot;</span>))</span><br><span class="line">	<span class="built_in">log</span>.warn(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出warn级别的日志&quot;</span>))</span><br><span class="line">	<span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出error级别的日志&quot;</span>))</span><br><span class="line">	<span class="built_in">log</span>.fatal(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出fatal级别的日志&quot;</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：<br>由于vscode新建文件默认都为utf8编码格式<img src="http://oldask.openluat.com/image/show/attachments-2018-08-KLoZibqN5b80cd9de7be9.png">，<br>所以我们在代码中输出的中文字符也都为utf8编码格式。但是luatools使用的却是GB2312格式，所以为了输出正确不乱码的中文，我们需要对中文进行转码，使用<code>common.utf8ToGb2312()</code>函数就可以解决这个编码问题<br>输出英文没有类似问题，无需转码</p>
</blockquote>
<p>我们把<code>logtest.lua</code>文件添加到烧录工程中，将程序烧录进去，可以得到如下的输出结果（需要自己在luatools往上翻地找）：</p>
<p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-SetlMIpl5b80cdc199d09.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-SetlMIpl5b80cdc199d09.png"></a></p>
<p>同时，log输出也可以改成如下语句：</p>
<p>testlog.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line">	<span class="keyword">local</span> b = <span class="literal">true</span></span><br><span class="line">	<span class="keyword">local</span> c = <span class="string">&quot;test&quot;</span></span><br><span class="line">	<span class="built_in">log</span>.info(<span class="string">&quot;logtest.test&quot;</span>,<span class="string">&quot;mixed output&quot;</span>,a,b,c)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [I]-[logtest.test]	mixed output	1	true	test</span><br></pre></td></tr></table></figure>
<p>这些输出日志方便了我们调试的过程，我们可以在程序必要处添加这些log输出，以便通过trace掌握程序运行的状态</p>
<h1 id="语法错误输出"><a href="#语法错误输出" class="headerlink" title="语法错误输出"></a>语法错误输出</h1><p>为了演示，我们可以再次更改<code>testlog.lua</code>文件的内容如下：</p>
<p>testlog.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">local</span> a</span><br><span class="line">	<span class="keyword">local</span> b = <span class="number">10</span></span><br><span class="line">	b = a + b</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>显而易见，这是会产生语法错误的，没看懂的也不要紧，烧录到模块中，可以看一下trace输出了什么：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [E]-[errDump.luaErr]	&#x2F;lua&#x2F;logtest.lua:4: attempt to perform arithmetic on local &#39;a&#39; (a nil value)</span><br><span class="line"></span><br><span class="line">程序运行错误，请根据上方提示,找到对应lua文件修改程序</span><br><span class="line">[时间]: stack traceback:</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:4: in function &#39;test&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:7: in main chunk</span><br><span class="line">[时间]: 	[C]: in function &#39;require&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;main.lua:34: in main chunk</span><br><span class="line">[时间]: 	[C]: ?</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;logtest.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;logtest.lua 2!</span><br><span class="line">[时间]: lualibc_fopen &#x2F;luaerrinfo.txt w 601 1 2</span><br><span class="line">[时间]: lua: &#x2F;lua&#x2F;logtest.lua:4: attempt to perform arithmetic on local &#39;a&#39; (a nil value)</span><br><span class="line">程序运行错误，请根据上方提示,找到对应lua文件修改程序</span><br><span class="line">[时间]: stack traceback:</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:4: in function &#39;test&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:7: in main chunk</span><br><span class="line">[时间]: 	[C]: in function &#39;require&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;main.lua:34: in main chunk</span><br><span class="line">[时间]: 	[C]: ?</span><br><span class="line">[时间]: [lua_shell_main]: lua exit status 1</span><br></pre></td></tr></table></figure>
<p>第一行的<code>/lua/logtest.lua:4: attempt to perform arithmetic on local &#39;a&#39; (a nil value)</code>代表了这个错误的具体原因，我们可以直接到错误的行数寻找，同时错误信息也写得十分明确：a是个nil值，无法进行算术计算</p>
<p>如果你觉得这个报错十分准确的话，那你就错了，如果真是这样我就不会在下面再加一段解释了</p>
<p>再次修改<code>testlog.lua</code>文件的内容如下：</p>
<p>testlog.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;utils&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">local</span> a = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="built_in">log</span>.info(<span class="string">&quot;logtest.test&quot;</span>,<span class="built_in">string</span>.toHex(a))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>报错信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[时间]: lua: &#x2F;lua&#x2F;utils.lua:19: attempt to index local &#39;str&#39; (a nil value)</span><br><span class="line">程序运行错误，请根据上方提示,找到对应lua文件修改程序</span><br><span class="line">[时间]: stack traceback:</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;utils.lua:19: in function &#39;toHex&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:5: in function &#39;test&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:8: in main chunk</span><br><span class="line">[时间]: 	[C]: in function &#39;require&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;main.lua:34: in main chunk</span><br><span class="line">[时间]: 	[C]: ?</span><br><span class="line">[时间]: [lua_shell_main]: lua exit status 1</span><br></pre></td></tr></table></figure>
<p>可能有人看到这个报错就凌乱了：utils.lua？这文件不是我写的啊？</p>
<p>确实，<code>utils.lua</code>这个文件是lib文件夹中的库文件，库文件中的函数报错也会导致trace中显示这个文件的错误位置<br>我们可以在错误报告中找到<code>/lua/logtest.lua:5 : in function &#39;test&#39;</code>这一段，在检查后发现，确实是<code>logtest.lua</code>文件的第五行导致了错误：对<code>nil</code>进行转成16进制字符串的处理是非法的</p>
<hr>
<p>以上就是luatools中trace解析的基本解释，很多trace信息还需要各位自己来摸索，用的多了也就熟悉了这些信息了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/25/400/" data-id="ckkfmdgec00cnvkcg7blabrqt" data-title="Luat系列教程：4、学会使用并看懂luatools的trace信息" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-399" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/25/399/" class="article-date">
  <time class="dt-published" datetime="2018-08-25T03:20:56.000Z" itemprop="datePublished">2018-08-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/25/399/">Luat系列教程：3、LUAT程序的基本时序</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;">适合阅读本文的人<br /></span><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;">至少用过一款单片机的<br /></span><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;">接触、了解过或听说过rtos、ucos等多线程系统<br /></span><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;">前几篇文章所提内容都已经懂了的<br /></span><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;">有耐心看完本文的<br /></span><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;">对lua语法熟悉的，如不熟悉请移步<br /></span><a target="_blank" rel="noopener" href="http://www.runoob.com/lua/lua-tutorial.html">http://www.runoob.com/lua/lua-tutorial.html<br /></a><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;">或<br /></span><a target="_blank" rel="noopener" href="https://www.lua.org/manual/5.1/manual.html">https://www.lua.org/manual/5.1/manual.html<br /></a><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;">进行学习。</span>
</blockquote>

<p><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;"><br /></span></p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">本文只会介绍LuaTask中多线程任务的基本用法，不会过多的讨论原理，如果需要深入研究，请查看wiki页的详细介绍：http://wiki.openluat.com/doc/run/</p>

<h1>简单定时器函数的使用</h1>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">上一章里的点亮led小灯，最后一步是让led灯闪烁起来。习惯了c语言写代码的人可能会发现，这个lua程序中好像没有delay之类的函数。</p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">我们把上一章的代码简化一下，像如下这样：</p>

<div><pre><span style="color:rgb(25,144,184);">function</span> <span style="color:rgb(47,156,10);">sayHello</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(95,99,100);">)</span>
    <span style="color:rgb(47,156,10);">print</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(47,156,10);">"hello"</span><span style="color:rgb(95,99,100);">)</span>
    sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">timerStart</span><span style="color:rgb(95,99,100);">(</span>sayHello<span style="color:rgb(95,99,100);">,</span><span style="color:rgb(201,44,44);">1000</span><span style="color:rgb(95,99,100);">)</span><span style="color:rgb(125,139,153);">--一秒后执行指定函数</span>
    <span style="color:rgb(47,156,10);">print</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(47,156,10);">"bye"</span><span style="color:rgb(95,99,100);">)</span>
<span style="color:rgb(25,144,184);">end</span>

<p><span style="color:rgb(47,156,10);">sayHello</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(95,99,100);">)</span></p>
<p><span style="color:rgb(95,99,100);">…..</span>其他代码<br></pre><div><div><span style="color:rgb(187,187,187);font-size:.8em;">Lua</span></div><div><a>Copy</a></div></div></div></p>
<p style="font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><font color="#4b4b4b">这里使用了定时器的接口：</font><font color="#e76363" style="background-color:rgb(247,247,247);">sys.timerStart(fnc, ms, ...)</font><font color="#4b4b4b">，用过js之类语言的可能会感到特别熟悉。在luat中，一般不在主线程中使用类似c一样用死循环阻塞式地来延时，取而代之的是这种定时器的结构，流程图如下：</font></p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-2RFA4bxN5b80c9f706619.png" style="width:860.5px;" class="img-responsive" alt="attachments-2018-08-2RFA4bxN5b80c9f706619.png" /></p>

<p style="font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><font color="#4b4b4b">其实实现上述定时器循环执行某函数的功能，可以直接使用</font><font color="#e76363" style="background-color:rgb(247,247,247);">sys.timerLoopStart(fnc, ms, ...)</font><font color="#4b4b4b">接口，改成如下样式：</font></p>

<div><pre><span style="color:rgb(25,144,184);">function</span> <span style="color:rgb(47,156,10);">sayHello</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(95,99,100);">)</span>
    <span style="color:rgb(47,156,10);">print</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(47,156,10);">"hello"</span><span style="color:rgb(95,99,100);">)</span>
<span style="color:rgb(25,144,184);">end</span>

<p>sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">timerLoopStart</span><span style="color:rgb(95,99,100);">(</span>sayHello<span style="color:rgb(95,99,100);">,</span><span style="color:rgb(201,44,44);">1000</span><span style="color:rgb(95,99,100);">)</span></p>
<p><span style="color:rgb(95,99,100);">…..</span>其他代码<br></pre><div><div><span style="color:rgb(187,187,187);font-size:.8em;">Lua</span></div><div><a>Copy</a></div></div></div></p>
<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">整个流程图便变成了如下的顺序：</p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-Lxds7UjR5b80ca16eadd6.png" style="width:842.5px;" class="img-responsive" alt="attachments-2018-08-Lxds7UjR5b80ca16eadd6.png" /><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;"><br /></span></p>

<p style="font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><font color="#4b4b4b">为了使函数更简洁，我们可以直接把函数名改成</font><font color="#e76363" style="background-color:rgb(247,247,247);">function() ..... end</font><font color="#4b4b4b">的形式，在函数变量中直接定义要使用的函数：</font></p>

<div><pre>sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">timerLoopStart</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(25,144,184);">function</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(95,99,100);">)</span>
                       <span style="color:rgb(47,156,10);">print</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(47,156,10);">"hello"</span><span style="color:rgb(95,99,100);">)</span>
                   <span style="color:rgb(25,144,184);">end</span><span style="color:rgb(95,99,100);">,</span><span style="color:rgb(201,44,44);">1000</span><span style="color:rgb(95,99,100);">)</span>
</pre><div><div><span style="color:rgb(187,187,187);font-size:.8em;">Lua</span></div><div><a>Copy</a></div></div></div>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">甚至可以写成一行：</p>

<div><pre>sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">timerLoopStart</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(25,144,184);">function</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(95,99,100);">)</span> <span style="color:rgb(47,156,10);">print</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(47,156,10);">"hello"</span><span style="color:rgb(95,99,100);">)</span> <span style="color:rgb(25,144,184);">end</span><span style="color:rgb(95,99,100);">,</span><span style="color:rgb(201,44,44);">1000</span><span style="color:rgb(95,99,100);">)</span>
</pre><div><div><span style="color:rgb(187,187,187);font-size:.8em;">Lua</span></div><div><a>Copy</a></div></div></div>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">上述两段代码的功能与一开始的timerLoopStart示例代码的运行结果完全相同</p>

<h1>协程</h1>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">在wiki页中，给出了这样一段简洁的代码，我们为了照顾不熟悉lua语言的人，稍微改一下代码：</p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">test.lua</p>

<div><pre><span style="color:rgb(25,144,184);">function</span> <span style="color:rgb(47,156,10);">test</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(95,99,100);">)</span>
    <span style="color:rgb(25,144,184);">while</span> <span style="color:rgb(25,144,184);">true</span> <span style="color:rgb(25,144,184);">do</span>
        <span style="color:rgb(47,156,10);">print</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(47,156,10);">"ss function test"</span><span style="color:rgb(95,99,100);">)</span>
        sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">wait</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(201,44,44);">1000</span><span style="color:rgb(95,99,100);">)</span>          <span style="color:rgb(125,139,153);">-- 挂起1000ms，同理为每隔1000ms运行一次</span>
    <span style="color:rgb(25,144,184);">end</span>
<span style="color:rgb(25,144,184);">end</span>

<p>sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">taskInit</span><span style="color:rgb(95,99,100);">(</span>test<span style="color:rgb(95,99,100);">)</span></p>
<p><span style="color:rgb(95,99,100);">…..</span>其他代码<br></pre><div><div><span style="color:rgb(187,187,187);font-size:.8em;">Lua</span></div><div><a>Copy</a></div></div></div></p>
<p style="font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><font color="#4b4b4b">在这里，</font><font color="#e76363" style="background-color:rgb(247,247,247);">sys.taskInit</font><font color="#4b4b4b">的作用可以理解为创建了一个新的线程，这个线程运行的内容就是</font><font color="#e76363" style="background-color:rgb(247,247,247);">test()</font><font color="#4b4b4b">函数</font></p>

<p style="font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><font color="#4b4b4b">在</font><font color="#e76363" style="background-color:rgb(247,247,247);">test()</font><font color="#4b4b4b">进行</font><font color="#e76363" style="background-color:rgb(247,247,247);">while true</font><font color="#4b4b4b">这样的死循环时，并不会使其他程序被阻塞运行，反而是多线程运行的</font></p>

<p style="font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><font color="#4b4b4b">在</font><font color="#e76363" style="background-color:rgb(247,247,247);">LuaTask</font><font color="#4b4b4b">架构下，协程内的函数可以直接使用</font><font color="#e76363" style="background-color:rgb(247,247,247);">sys.wait(ms)</font><font color="#4b4b4b">函数进行延时操作，延时途中只是将cpu让给了其他需要运行的程序，在倒计时完成后继续该进程的运行，从而实现了延时操作</font></p>

<p style="font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><font color="#4b4b4b">我们一般会把</font><font color="#e76363" style="background-color:rgb(247,247,247);">sys.taskInit</font><font color="#4b4b4b">内的函数直接写在其中，像下面这样：</font></p>

<div><pre>sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">taskInit</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(25,144,184);">function</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(95,99,100);">)</span>
    <span style="color:rgb(25,144,184);">while</span> <span style="color:rgb(25,144,184);">true</span> <span style="color:rgb(25,144,184);">do</span>
        <span style="color:rgb(47,156,10);">print</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(47,156,10);">"ss function test"</span><span style="color:rgb(95,99,100);">)</span>
        sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">wait</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(201,44,44);">1000</span><span style="color:rgb(95,99,100);">)</span>          <span style="color:rgb(125,139,153);">-- 挂起1000ms，同理为每隔1000ms运行一次</span>
    <span style="color:rgb(25,144,184);">end</span>
<span style="color:rgb(25,144,184);">end</span><span style="color:rgb(95,99,100);">)</span>

<p><span style="color:rgb(95,99,100);">…..</span>其他代码<br></pre><div><div><span style="color:rgb(187,187,187);font-size:.8em;">Lua</span></div><div><a>Copy</a></div></div></div></p>
<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">相信各位已经可以理解这种写法了（如果从文章开头看到这里了的话），协程的运行流程图如下</p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-VchwfAC35b80ca5330f35.png" style="width:774.5px;" class="img-responsive" alt="attachments-2018-08-VchwfAC35b80ca5330f35.png" /><span style="color:rgb(75,75,75);font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;font-size:17px;"><br /></span></p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">我们可以同时开多个线程，使用方法都是一样的</p>

<h1>程序注册</h1>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">LuaTask可以使用订阅和发布，使某个程序等待另一个程序完成后才继续运行</p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">我们来看最简单的一个示例代码：</p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-rxZWfyuj5b80cc9fbd240.png" style="width:466px;" class="img-responsive" alt="attachments-2018-08-rxZWfyuj5b80cc9fbd240.png" /><br /></p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">程序定义了一个5秒后的定时器，并运行了一个包含了时间订阅等待的函数，整体流程运行如下：</p>

<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-v0MVTubI5b80ca9a053cb.png" style="width:500.5px;" class="img-responsive" alt="attachments-2018-08-v0MVTubI5b80ca9a053cb.png" /></p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">这种用法经常用在http、socket等操作和其他需要等待的操作中，利用回调函数可实现等待功能。</p>

<p style="font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><font color="#e76363" style="background-color:rgb(247,247,247);">sys.publish</font><font color="#4b4b4b">也可传递参数：</font></p>

<div><pre>sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">timerStart</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(25,144,184);">function</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(95,99,100);">)</span>
                   sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">publish</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(47,156,10);">"TEST"</span><span style="color:rgb(95,99,100);">,</span><span style="color:rgb(201,44,44);">123</span><span style="color:rgb(95,99,100);">)</span>
               <span style="color:rgb(25,144,184);">end</span><span style="color:rgb(95,99,100);">,</span><span style="color:rgb(201,44,44);">3000</span><span style="color:rgb(95,99,100);">)</span><span style="color:rgb(125,139,153);">--三秒后执行发布"TEST"消息的函数</span>

<p><span style="color:rgb(25,144,184);">function</span> <span style="color:rgb(47,156,10);">sub</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(95,99,100);">)</span><br>    <span style="color:rgb(47,156,10);">print</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(47,156,10);">“start”</span><span style="color:rgb(95,99,100);">)</span><br>    result<span style="color:rgb(95,99,100);">,</span>data <span style="color:rgb(166,127,89);">=</span> sys<span style="color:rgb(95,99,100);">.</span><span style="color:rgb(47,156,10);">waitUntil</span><span style="color:rgb(95,99,100);">(</span><span style="color:rgb(47,156,10);">“TEST”</span><span style="color:rgb(95,99,100);">)</span><br>    <span style="color:rgb(47,156,10);">print</span><span style="color:rgb(95,99,100);">(</span>result<span style="color:rgb(95,99,100);">,</span>data<span style="color:rgb(95,99,100);">)</span><br><span style="color:rgb(25,144,184);">end</span></p>
<p><span style="color:rgb(47,156,10);">sys.taskInit(sub</span><span style="color:rgb(95,99,100);">)</span><br></pre><div><div><span style="color:rgb(187,187,187);font-size:.8em;">Lua</span></div><div><a>Copy</a></div></div></div></p>
<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">上述代码将会输出：</p>

<pre>true    123
</pre>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">同时，luat在库中自带了许多系统消息，部分如下：</p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-kHOv44o75b80caf440093.png" style="width:435.5px;" class="img-responsive" alt="attachments-2018-08-kHOv44o75b80caf440093.png" /></p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">三种线程控制的使用方法全部介绍完毕了，如果需要了解原理，请去研读http://wiki.openluat.com/doc/run/的说明与解释<br /></p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;">如有错误和疑问请在下方留言指出，谢谢</p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><br /></p>

<p style="color:rgb(75,75,75);font-size:17px;font-family:'Microsoft YaHei', 'Helvetica Neue', Helvetica, STXihei, sans-serif;"><br /></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/25/399/" data-id="ckkfmdgec00cmvkcg46xgh8n9" data-title="Luat系列教程：3、LUAT程序的基本时序" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-398" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/24/398/" class="article-date">
  <time class="dt-published" datetime="2018-08-24T13:33:58.000Z" itemprop="datePublished">2018-08-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/24/398/">Luat系列教程：2、控制LED小灯</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>适合阅读本文的人群：<br>看过上一章luatool工具使用的/会使用的<br>有至少一款单片机开发基础的<br>接触过编程的<br>有耐心看完全篇文章的</p>
</blockquote>
<blockquote>
<p>本教程使用的开发板为S9开发板，使用其他开发板的请使用杜邦线连接相关的引脚，代码也请根据需要自行修改</p>
</blockquote>
<p>接触过单片机的人应该都知道，使用一款单片机，第一件事就是学会如何点亮LED灯，学会了控制LED灯，就相当于学会了最基础的GPIO高低电平控制操作</p>
<h1 id="准备一个代码编辑器"><a href="#准备一个代码编辑器" class="headerlink" title="准备一个代码编辑器"></a>准备一个代码编辑器</h1><p>代码编辑器有很多可供选择，比如notepad++、Sublime Text</p>
<blockquote>
<p>如果你已经可以熟练掌握了某一个代码编辑器，那么你可以直接跳过这一章，直接看代码编写。如果你想试试我推荐的编辑器，那么也可以看下去</p>
</blockquote>
<h3 id="详细的安装和配置，请参考这篇文章vscode-lua开发推荐配置"><a href="#详细的安装和配置，请参考这篇文章vscode-lua开发推荐配置" class="headerlink" title="详细的安装和配置，请参考这篇文章vscode lua开发推荐配置"></a>详细的安装和配置，请参考这篇文章<a target="_blank" rel="noopener" href="http://doc.openluat.com/article/594/0">vscode lua开发推荐配置</a></h3><h1 id="新建一个最基本的工程"><a href="#新建一个最基本的工程" class="headerlink" title="新建一个最基本的工程"></a>新建一个最基本的工程</h1><p>在你觉得适当的位置，新建一个文件夹，名为<code>LUAT-LED</code>，使用你的代码编辑器打开该文件夹，vscode如下图所示操作：<br><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-j0k4s1nt5b800abd3c5ba.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-j0k4s1nt5b800abd3c5ba.png"></a></p>
<p>打开后，在编辑器左侧的文件夹中，右击空白处，新建文件，输入文件名<code>main.lua</code>，回车键保存：<br><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-SRWSpjPq5b800ad3d0255.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-SRWSpjPq5b800ad3d0255.png"></a></p>
<p>接着，在新建的文件夹中添加如下代码，完成最主要的<code>main.lua</code>文件的编写：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--必须在这个位置定义PROJECT和VERSION变量</span></span><br><span class="line"><span class="comment">--PROJECT：ascii string类型，可以随便定义，只要不使用,就行</span></span><br><span class="line"><span class="comment">--VERSION：ascii string类型，如果使用Luat物联云平台固件升级的功能，必须按照&quot;X.X.X&quot;定义，X表示1位数字；否则可随便定义</span></span><br><span class="line">PROJECT = <span class="string">&quot;LED-TEST&quot;</span></span><br><span class="line">VERSION = <span class="string">&quot;0.0.1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--根据固件判断模块类型</span></span><br><span class="line">moduleType = <span class="built_in">string</span>.<span class="built_in">find</span>(rtos.get_version(),<span class="string">&quot;8955&quot;</span>) <span class="keyword">and</span> <span class="number">2</span> <span class="keyword">or</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--加载日志功能模块，并且设置日志输出等级</span></span><br><span class="line"><span class="comment">--如果关闭调用log模块接口输出的日志，等级设置为log.LOG_SILENT即可</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">LOG_LEVEL = <span class="built_in">log</span>.LOGLEVEL_TRACE</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;sys&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="comment">--每1分钟查询一次GSM信号强度</span></span><br><span class="line"><span class="comment">--每1分钟查询一次基站信息</span></span><br><span class="line">net.startQueryAll(<span class="number">60000</span>, <span class="number">60000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载硬件看门狗功能模块</span></span><br><span class="line"><span class="comment">--根据自己的硬件配置决定：1、是否加载此功能模块；2、配置Luat模块复位单片机引脚和互相喂狗引脚</span></span><br><span class="line"><span class="comment">--合宙官方出售的Air201开发板上有硬件看门狗，所以使用官方Air201开发板时，必须加载此功能模块</span></span><br><span class="line"><span class="comment">--如果用的是720 4g模块，请注释掉这两行</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;wdt&quot;</span></span><br><span class="line">wdt.setup(pio.P0_30, pio.P0_31)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--加载网络指示灯功能模块</span></span><br><span class="line"><span class="comment">--根据自己的项目需求和硬件配置决定：1、是否加载此功能模块；2、配置指示灯引脚</span></span><br><span class="line"><span class="comment">--合宙官方出售的Air800和Air801开发板上的指示灯引脚为pio.P0_28，其他开发板上的指示灯引脚为pio.P1_1</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;netLed&quot;</span></span><br><span class="line">netLed.setup(<span class="literal">true</span>,moduleType == <span class="number">2</span> <span class="keyword">and</span> pio.P1_1 <span class="keyword">or</span> pio.P2_0,moduleType == <span class="number">2</span> <span class="keyword">and</span> <span class="literal">nil</span> <span class="keyword">or</span> pio.P2_1)<span class="comment">--自动判断2/4g默认网络灯引脚配置</span></span><br><span class="line"><span class="comment">--网络指示灯功能模块中，默认配置了各种工作状态下指示灯的闪烁规律，参考netLed.lua中ledBlinkTime配置的默认值</span></span><br><span class="line"><span class="comment">--如果默认值满足不了需求，此处调用netLed.updateBlinkTime去配置闪烁时长</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--加载错误日志管理功能模块【强烈建议打开此功能】</span></span><br><span class="line"><span class="comment">--如下2行代码，只是简单的演示如何使用errDump功能，详情参考errDump的api</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;errDump&quot;</span></span><br><span class="line">errDump.request(<span class="string">&quot;udp://ota.airm2m.com:9072&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载远程升级功能模块【强烈建议打开此功能】</span></span><br><span class="line"><span class="comment">--如下3行代码，只是简单的演示如何使用update功能，详情参考update的api以及demo/update</span></span><br><span class="line"><span class="comment">-- PRODUCT_KEY = &quot;xxxxxx&quot;</span></span><br><span class="line"><span class="comment">-- require &quot;update&quot;</span></span><br><span class="line"><span class="comment">-- update.request()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动系统框架</span></span><br><span class="line">sys.init(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">sys.run()</span><br></pre></td></tr></table></figure>
<p>我们将main.lua和基本的task库文件烧录到开发板中（不烧录会的请看第一章），会发现：并没有什么事情发生<br>因为代码基本是空的啊2333</p>
<h1 id="模块化编程"><a href="#模块化编程" class="headerlink" title="模块化编程"></a>模块化编程</h1><p>在编写lua功能时，我们一般会把相似功能的代码放到同一个文件中，写完后只需要在<code>main.lua</code>中添加<code>require</code>语句即可，所以我们需要将<code>main.lua</code>结尾改成如下形式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">....上面一堆代码省略</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载远程升级功能模块【强烈建议打开此功能】</span></span><br><span class="line"><span class="comment">--如下3行代码，只是简单的演示如何使用update功能，详情参考update的api以及demo/update</span></span><br><span class="line"><span class="comment">-- PRODUCT_KEY = &quot;xxxxxx&quot;</span></span><br><span class="line"><span class="comment">-- require &quot;update&quot;</span></span><br><span class="line"><span class="comment">-- update.request()</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;ledtest&quot;</span>    <span class="comment">--新加上的代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动系统框架</span></span><br><span class="line">sys.init(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">sys.run()</span><br></pre></td></tr></table></figure>
<p>添加完后，使用和新建<code>main.lua</code>文件相同的方式，新建一个新的文件<code>ledtest.lua</code></p>
<p>我们在<code>ledtest.lua</code>的第一行可以先加上如下一句话：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(..., <span class="built_in">package</span>.<span class="built_in">seeall</span>)  <span class="comment">--使得文件中的函数在何处都可调用</span></span><br></pre></td></tr></table></figure>
<h1 id="连接硬件"><a href="#连接硬件" class="headerlink" title="连接硬件"></a>连接硬件</h1><blockquote>
<p>注意：这里演示用的是2g模块，<code>4g模块</code>请<strong>详细阅读</strong>下面代码注释中的信息进行修改，<strong>代码不可以直接拿去用！！</strong></p>
</blockquote>
<p>由于我这里使用的是普通的S9开发板，和一个配套的LED灯小主板，所以我直接将其连接到了双排针上，插入方式如下图：<br><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-dFQTv3VK5b800af7e5562.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-dFQTv3VK5b800af7e5562.png"></a><br>为了照顾其他未使用S9开发板的读者，我将led的电气连接在下方进行标识，有条件的可以手动按下文进行连接（用的是Air202模块，其他模块请根据情况自行修改）：</p>
<table>
<thead>
<tr>
<th align="center">引脚名称</th>
<th align="center">灯序号</th>
<th align="center">另一端连接哪里</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SPI1_CLK/GPIO_8</td>
<td align="center">LED1</td>
<td align="center">GND</td>
</tr>
<tr>
<td align="center">SPI1_DO/GPIO_11</td>
<td align="center">LED2</td>
<td align="center">GND</td>
</tr>
<tr>
<td align="center">SPI1_DI/GPIO_12</td>
<td align="center">LED3</td>
<td align="center">GND</td>
</tr>
<tr>
<td align="center">UART1_CTS/GPIO_3</td>
<td align="center">LED4</td>
<td align="center">GND</td>
</tr>
<tr>
<td align="center">UART1_RTS/GPIO_2</td>
<td align="center">LED5</td>
<td align="center">GND</td>
</tr>
</tbody></table>
<p>可以看到，每个管脚都有各种复用功能，我们本文之将其作为普通GPIO口使用</p>
<h1 id="点亮LED小灯"><a href="#点亮LED小灯" class="headerlink" title="点亮LED小灯"></a>点亮LED小灯</h1><p>模块中几乎所有的函数都可以在wiki中找到，所以我们也去wiki中进行搜索<br>打开openluat的wiki页：<a target="_blank" rel="noopener" href="http://wiki.openluat.com/" title="http://wiki.openluat.com/">http://wiki.openluat.com/</a><br>在网页左边选择<code>Luat API接口</code>，可以看到所有接口都被整理好放到了这里，点击<code>LuaTask</code>–<code>pins</code>可以找到我们需要的函数接口：<br><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-lhU9G8GF5b800b1502db4.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-lhU9G8GF5b800b1502db4.png"></a></p>
<p>这样我们就明白这个改如何点亮LED小灯了，我们将<code>ledtest.lua</code>改成如下代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(..., <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;pins&quot;</span>  <span class="comment">--用到了pin库，该库为luatask专用库，需要进行引用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- GPIO 0到GPIO 31表示为pio.P0_0到pio.P0_31 。</span></span><br><span class="line"><span class="comment">-- GPIO 32到GPIO XX表示为pio.P1_0到pio.P1_(XX-32)，例如GPIO33 表示为pio.P1_1</span></span><br><span class="line"><span class="keyword">if</span> moduleType == <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">    pmd.ldoset(<span class="number">5</span>,pmd.LDO_VMMC)  <span class="comment">--使用某些GPIO时，必须在脚本中写代码打开GPIO所属的电压域，配置电压输出输入等级，这些GPIO才能正常工作</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--注意！！！4G模块无需设置电压域！</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--设置led的GPIO口</span></span><br><span class="line"><span class="keyword">local</span> led1 = pins.setup(pio.P0_8,<span class="number">0</span>)<span class="comment">--如果你用的是4G模块，请更改这个gpio编号</span></span><br><span class="line"><span class="keyword">local</span> led2 = pins.setup(pio.P0_11,<span class="number">0</span>)<span class="comment">--如果你用的是4G模块，请更改这个gpio编号</span></span><br><span class="line"><span class="keyword">local</span> led3 = pins.setup(pio.P0_12,<span class="number">0</span>)<span class="comment">--如果你用的是4G模块，请更改这个gpio编号</span></span><br><span class="line"><span class="keyword">local</span> led4 = pins.setup(pio.P0_3,<span class="number">0</span>)<span class="comment">--如果你用的是4G模块，请更改这个gpio编号</span></span><br><span class="line"><span class="keyword">local</span> led5 = pins.setup(pio.P0_2,<span class="number">0</span>)<span class="comment">--如果你用的是4G模块，请更改这个gpio编号</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--将gpio口都置为高电平</span></span><br><span class="line">led1(<span class="number">1</span>)</span><br><span class="line">led2(<span class="number">1</span>)</span><br><span class="line">led3(<span class="number">1</span>)</span><br><span class="line">led4(<span class="number">1</span>)</span><br><span class="line">led5(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>更改完保存后，将改好的文件全部烧入模块中，查看效果<br>如果一切正常的话，五个灯都会正常被点亮<br>将<code>led1(1)</code>改为<code>led1(0)</code>即可熄灭第一个灯，以此类推，可以多尝试更改着玩一下，再看下一部分</p>
<h1 id="让LED灯闪烁起来"><a href="#让LED灯闪烁起来" class="headerlink" title="让LED灯闪烁起来"></a>让LED灯闪烁起来</h1><p>LED灯已经可以点亮了，那么我们就要让它动起来<br>我们可以在wiki页查到，开启一个定时器函数为<code>sys.timerStart(fnc, ms, ...)</code>，那么我们可以将代码改成如下样式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(..., <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;pins&quot;</span>  <span class="comment">--用到了pin库，该库为luatask专用库，需要进行引用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- GPIO 0到GPIO 31表示为pio.P0_0到pio.P0_31 。</span></span><br><span class="line"><span class="comment">-- GPIO 32到GPIO XX表示为pio.P1_0到pio.P1_(XX-32)，例如GPIO33 表示为pio.P1_1</span></span><br><span class="line"><span class="keyword">if</span> moduleType == <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">    pmd.ldoset(<span class="number">5</span>,pmd.LDO_VMMC)  <span class="comment">--使用某些GPIO时，必须在脚本中写代码打开GPIO所属的电压域，配置电压输出输入等级，这些GPIO才能正常工作</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--注意！！！4G模块无需设置电压域！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--设置led的GPIO口</span></span><br><span class="line"><span class="keyword">local</span> led1 = pins.setup(pio.P0_8,<span class="number">0</span>)<span class="comment">--如果你用的是4G模块，请更改这个gpio编号</span></span><br><span class="line"><span class="keyword">local</span> led2 = pins.setup(pio.P0_11,<span class="number">0</span>)<span class="comment">--如果你用的是4G模块，请更改这个gpio编号</span></span><br><span class="line"><span class="keyword">local</span> led3 = pins.setup(pio.P0_12,<span class="number">0</span>)<span class="comment">--如果你用的是4G模块，请更改这个gpio编号</span></span><br><span class="line"><span class="keyword">local</span> led4 = pins.setup(pio.P0_3,<span class="number">0</span>)<span class="comment">--如果你用的是4G模块，请更改这个gpio编号</span></span><br><span class="line"><span class="keyword">local</span> led5 = pins.setup(pio.P0_2,<span class="number">0</span>)<span class="comment">--如果你用的是4G模块，请更改这个gpio编号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ledon = <span class="literal">false</span> <span class="comment">--led是否开启</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">changeLED</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> ledon <span class="keyword">then</span></span><br><span class="line">        led1(<span class="number">1</span>)</span><br><span class="line">        led2(<span class="number">1</span>)</span><br><span class="line">        led3(<span class="number">1</span>)</span><br><span class="line">        led4(<span class="number">1</span>)</span><br><span class="line">        led5(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        led1(<span class="number">0</span>)</span><br><span class="line">        led2(<span class="number">0</span>)</span><br><span class="line">        led3(<span class="number">0</span>)</span><br><span class="line">        led4(<span class="number">0</span>)</span><br><span class="line">        led5(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    ledon = <span class="keyword">not</span> ledon</span><br><span class="line">    sys.timerStart(changeLED,<span class="number">1000</span>)<span class="comment">--一秒后执行指定函数</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">changeLED() <span class="comment">--开机后立刻运行该函数</span></span><br></pre></td></tr></table></figure>
<p>保存后烧入程序即可，如果不出意外，五个LED灯就应该一秒亮一秒灭了</p>
<p>既然学会了延时、点亮LED、熄灭LED，那么就可以自己尝试编写一个流水灯了，这里不再赘述，请大家自己尝试</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/24/398/" data-id="ckkfmdgb4004qvkcg3xade8n1" data-title="Luat系列教程：2、控制LED小灯" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-397" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/24/397/" class="article-date">
  <time class="dt-published" datetime="2018-08-23T16:17:32.000Z" itemprop="datePublished">2018-08-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/24/397/">怎样创业可以保证不死？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">首先给两个创业的点子，这两个点子可以保证会有一定的收入，但是不会做大，想拿VC做成独角兽的同学，可以忽略这篇文章。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">一、GPRS DTU</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">这个产品，已经存在了至少10年了，但是仍然不断的有新的公司加入进来推出此类产品。这个产品的需求量不是很大，因为一个客户通常也就买十来个，买100个算是大客户了。但是需求量又很大，因为需要这个产品的企业实在是太多太多了，多到数不清。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">所以，你要是创业做这个产品，如果能做好的话，肯定是不愁销路的，而且利润相当好，但是销售额不会非常大，不可能让你的企业变成大企业。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">这个产品的功能一般是这样的，提供一个金属盒子，盒子外面有个GPRS天线，里面有个带有GPRS模块的通信板，有一个串口出来跟外部的设备通信。通常长这样：</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;"><br /></p>

<div><div><div><img src="https://upload-images.jianshu.io/upload_images/4830067-98dd09353552333e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" style="height:auto;" alt="600" /></div></div></div>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">也就是说，只要外部设备支持串口（当然也可以是类似485之类的接口转到串口），就可以把数据传给这个盒子，把数据传到云端去，实现设备联网的目的，这就是物联网了。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">也就是说，有了这个DTU，传统的设备，无论是挖掘机，还是机床， 还是收割机，只要通过串口接上了DTU，就变成一个物联网设备了。你说是不是很刚需。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">但是，这么简单功能的小产品， 是不容易做好的，简单说有如下一些难点：</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">第一，无线信号的环境说多变的，信号强弱变化之间，通信的质量就会跌宕起伏，这对于传统设备是受不了的，所以你的DTU要针对这些多变的无线信号环境做好异常处理和防呆处理，不能影响到设备的正常通信，比如你数据发送一半，网络不好了，那么未发送的数据，记录在哪里，以便于下次重发，来保证通信的完整性。因为传统设备是没有针对无线通信这种场景的应用层的，只能DTU自己处理；</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">第二，传统设备是不会做通信的参数配置的，比如说对端的域名或者IP，通信端口，传输的心跳包的间隔，这些参数对于传统设备来说就是天书，所以你要在设备安装上之后，要很方便的设置好，后续要有很低成本的方式去修改这些参数。所谓低成本，就是你不能每次都上门去配置，客户没时间去让你配置，你也耗不起这个人工费。所以，DTU 的后台管理系统，就要很方便的对DTU进行配置，让用户用起来舒心；</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">第三，DTU 的抗干扰性能要好，天线信号要足够强，这也是为什么大多数DTU都是金属外壳，并且天线外置的原因。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">总结下，GPRS DTU 产品单价高，利润高，但是单个客户的采购量小，研发难度大，对研发工程师的要求高，但是研发的投入不大，不需要特别多的工程师，也不需要过多的专业设备，外壳在淘宝就能买到，产品打样难度也很小。所以尽管做这个产品的企业众多，但是因为需求一直在增长，所以个体户或者小团队创业做DTU的话，只要产品过硬，肯定是能生存的，如果生存不了， 只能说你的产品确实用户体验不过关。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">最近几个月，Luat用户群里面，寻找DTU产品的，至少也有20多个了。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">二、微信支付宝支付系统</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">很多传统企业想通过微信支付宝收款，很多很多，前几年投币的各种机器，都有改成扫码支付的需求，很多小卖店也有非常多的扫码支付的</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">需求。但是，这些企业不懂通信，不懂软件开发，怎么办? 只能找合作伙伴来开发。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">整个系统的工作原理是这样的，首先，申请一个微信和支付宝的开发者账号，你自己的云后台对接微信支付宝账号；其次，GPRS模块里面的软件，需要对接自己的云后台。第三，用户扫码支付后，微信支付宝后台给你的云后台一个回调，通知某某用户对xxx这个设备付了10元钱，第四，你的云后台通知你的设备，10元钱收到了，可以执行任务了。流程到此结束。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">你创业做什么呢？你买一个GPRS模块，再搭建一个云服务器，把上述的四个步骤全部实现了，然后给不同的客户帮忙申请不同的支付账号，再帮客户生成不同的二维码贴在客户的设备上，客户的设备，就具备联网支付功能，从而进行共享（zu lin）式运营了。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">这一类需求也是非常非常的多，所以你要把整个系统做的傻瓜化，让用户不去关心研发的事情，只要去赚钱就行了。只要能做好，肯定会有收入的。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">以上的两个创业点子，其实有很多很多的企业再做了， 但是因为需求是如此之大，只要你的技术水平不差，多用心关注用户体验，肯定会有一席之地的。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">创业点子分享完毕。下面说一下物联网的发展趣事。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">首先说一下这几年的物联网发展的有趣的现象。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">大约三年前，一个叫做智能插座的小设备火起来了，里面有WIFI模块，可以用它来遥控家里的电器，还可以加个USB接口用来给手机充电。到了今天， 电源插座上基本上都标配了USB充电接口，但是WIFI遥控家用电器的功能，证明是个伪需求，而之前只是顺带附加的USB充电功能，证明是个真实需求。<br /></p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">我们团队也跟风做过一款WIFI智能插座，给一个好朋友的企业定制的，做了10个月才量产，品质不算差，但是就是销量一般。<br /></p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">同样是2014年，google是收购了创业不到4年的智能家居硬件公司NEST，收购金额是 32亿美元。NEST 当时的产品在今天看来比较小儿科，但是在当时用苹果的设计风格，带无线遥控技术的产品，掀起了一股智能家居的风潮。收购两年多后，尽管google不愿意承认，但是事实上NEST已经不具备太大的商业价值。因为产品体验不够牛逼，想出来的牛逼体验，现有的技术又做不出来。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">我们团队前两年也做了物联网的智能家居模块，配合APP和后台，给华南的家电企业做智能化的服务，推广一段时间后发现，即使是很知名的企业，下单量可能也就是几百个模块而已，投入产出非常难看，跟媒体分析的预期差距实在是太大了。<br /></p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">前几天有个Luat 的用户来聊天，他们团队运营了2年半了，十几个人的规模，面向企业做物联网的方案设计DTU的服务，DTU终端和云后台都帮客户做好，使得传统的企业，无需再考虑物联网的技术，只要用了他们的方案，就直接能联网运营了。这种跟传统行业共生的经营模式，虽然赚不到大钱，但是一个小团队的生存是不用发愁了。<br /></p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">还有个好朋友，开始是做纯软件的外包设计，做了两年之后，发现在中国做纯软件收钱挺难的，外行的客户总感觉软件没有成本，不愿意多付钱，但是工程师的工资是一种在涨的。于是这哥们毅然转行到软硬结合的模式，把硬件的供应链外包，自己做硬件设计，嵌入式软件开发，以及后台的运营软件的服务，不仅延续了自己的软件优势，跟客户收钱也理直气壮了。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">再看看近两年热的发烫的VR概念，机器人概念，到现在也搞不清楚到底哪个公司靠这玩意儿真的赚钱了。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">所以，我们可以得出一个结论，物联网这个行业，水太深， 如果只是跟风，听信媒体的话，做一头找风的猪，一头扎进风口，变成死猪的概率真的是太高太高了。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">相反，做个笨猪，不要去找风口，只是老老实实的找猪草吃，还可能会活得更久。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/24/397/" data-id="ckkfmdgb3004pvkcg6dh1cyq9" data-title="怎样创业可以保证不死？" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-396" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/23/396/" class="article-date">
  <time class="dt-published" datetime="2018-08-23T14:22:48.000Z" itemprop="datePublished">2018-08-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/23/396/">AT指令即将完成历史使命</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">了解 GPRS 模块的同学都知道，AT指令就是模块的交互界面， 相当于手机的 MMI。AT 指令几乎就是模块的代名词。另外， 申明一点，下文中提到的 GSM 模块和 GPRS 模块，说的是一个东西，只是书写习惯不同而已。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">为什么会有 AT 指令呢？ AT 指令是在早期，还是通过电话线拨号上网的时候(上网速率只有可怜的 14.4kbps)，电脑和modem之间交互的一个界面。电脑通过串口发送 AT 字符开头的指令， 去配置 modem 的上网参数，然后通过AT指令拨号连接网络服务商(ISP)的服务器，达到计费上网的目的。<br /></p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">GSM 无线网络出现之后，无线的 modem 基本上都是用 GPRS 模块作为核心部件做成的。因为使用方法和电话线的modem类似，也是用PPP协议拨号上网的方式，因此 AT 指令的形式延续了下来。并且，AT 指令还被写入了 GSM 规范，这就是大名鼎鼎的 GSM 07.05 和 07.07，以及 07.10 协议。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">我国第一代的 GSM 手机，无论是波导， 熊猫，科健，还是 TCL，刚开始的几款机型，因为缺乏通信产品的开发经验，都是采购国外的 GSM 模块，配上一个 MCU的系统架构，用 MCU 控制屏幕来显示人机界面(MMI)，网络部分由MCU发送 AT 指令给GSM模块，去调用电话，短信，电话本等服务。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">从2004年开始，中国出现了一种叫做无线固话的产品形态，也是采用上述的MCU+GSM模块的架构，利用无线网络，用座机电话机的产品形态，实现手机的无线通话功能。这个产品非常受消费者尤其是老年人和小商贩的欢迎，因此中国移动集中采购的量极大。厂家为了降低成本，同时提高产品稳定性，逐步把电话机的MMI软件移植到了GSM模块内部，省掉了外围的MCU，这是 GSM 模块的一次技术革命。值得一提的是，把无线固话的MMI软件移植到模块内部的都是国产模块厂家, 正是通过这个革新，国产品牌的市场份额得到了质的飞跃。有代表性的厂家按照时间顺序分别是Simcom，龙尚和艾特维，其中，Simcom 和龙尚主要靠GSM模块奠定地位，艾特维则基本上垄断了 TD 无线座机模块市场。比较有趣的是，艾特维的英文名字是ATWin，意思是模块的赢家，因为AT就是模块。但是艾特维出货的模块，大多是当做带有MMI软件的单模块来用，AT指令反而用的很少。这个现象已经值得模块行业深思。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">当然，在手机行业，随着中国厂家的实力增强，用模块做手机的架构很快就消失了，手机的软件也是越来越绚丽多彩，这都是Soc架构的功劳，用MCU+GSM模块的架构，是无论如何做不出来如此丰富多彩的功能机的。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">再来看看波澜壮阔的物联网应用的发展，直到今天，涉及到 GPRS 模块的使用场景，AT 指令仍然扮演了相当主流的角色。尽管各个模块厂家都推出了OpenCPU 的单模块应用的软件架构，但是单模块的应用比例仍然不高，大多数研发物联网设备的用户，仍然是在用 MCU发送 AT 指令给 GPRS 模块的方式来进行通信，这是为什么呢？</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">第一个原因，开发物联网设备的软件工程师，大多数都有自己熟悉的单片机（MCU）， 这些 MCU 大多是 ARM 架构，开发工具和编程习惯是类似的，这么多年得到了比较稳固的延续；</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">第二个原因， GPRS 模块的软件架构，因为涉及了复杂的无线通信环境，就相对比较复杂，让 MCU 工程师去熟悉模块的软件架构，再开发应用，大多数工程师不愿意花费太多的时间和精力，宁愿去把产品做到尽快量产出货，才是更高性价比的做法。<br /></p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">第三个原因，因为 GPRS 的模块价格相对比较高，从2000年初的1000多元，下降到了这些年的几十元左右。但是一个MCU可能只需要几块钱 RMB，所以把主控权放在 MCU， 模块的选择就会比较灵活，哪一款模块性价比高就用哪一款模块，反正都支持 AT 指令，切换起来不是很困难。<br /></p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">但是，时间来到了今天，已经有越来越多的工程师和企业家意识到，随着国内物联网应用的爆发，单模块开发应用势在必行，并且 GPRS 模块的价格，今年已经是 20 元左右，市场需要提供极简软件架构的 GPRS 模块，来实现比 MCU 更加快速的应用开发，做出更好体验的产品，提供中国制造的口碑。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">还好， Luat 来了。</p>

<p style="color:rgb(47,47,47);font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;">Luat 是合宙研发团队使用了十余年的软件架构，从2017年初开始，无偿开放出来回报社会。使用 Luat 的 GPRS 模块的软件架构，只需要1个小时，就可以完成你的应用开发。Luat让你聚焦在产品的用户体验本身，无需再去熟悉艰深的软件代码。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/23/396/" data-id="ckkfmdgb3004ovkcg3f2khpsm" data-title="AT指令即将完成历史使命" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-395" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/19/395/" class="article-date">
  <time class="dt-published" datetime="2018-08-19T09:38:13.000Z" itemprop="datePublished">2018-08-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/19/395/">Air602物联网Wi-Fi模块介绍</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3><font>1.模块内置MCU主频是多少，是什么内核：</font></h3>

<pre><span style="font-size:12pt;font-family:'宋体';">目前</span><span style="font-size:12pt;font-family:'宋体';">主频</span><span style="font-size:12pt;font-family:'Times New Roman';">80M</span><span style="font-size:12pt;font-family:'宋体';">，支持切换到</span><span style="font-size:12pt;font-family:'Times New Roman';">40M，内核为Cortex-M3</span><span style="font-size:12pt;font-family:'宋体';">。</span></pre>

<p><span style="font-size:12pt;font-family:'宋体';"><br /></span></p>

<h3>2.模块RAM空间地址使用情况：</h3>

<p><span style="font-size:12pt;font-family:'宋体';">整个</span><span style="font-size:12pt;font-family:'Times New Roman';">RAM</span><span style="font-size:12pt;font-family:'宋体';">空间为</span><span style="font-size:12pt;font-family:'Times New Roman';">288Kbyte</span><span style="font-size:12pt;font-family:'宋体';">，当前的</span><span style="font-size:12pt;font-family:'Times New Roman';">RAM</span><span style="font-size:12pt;font-family:'宋体';">空间划分:</span><br /></p>

<blockquote><table class="table table-bordered"><tr><td><span style="font-family:'宋体';font-size:16px;text-align:justify;">分类</span><br /></td><td><span style="font-family:'宋体';font-size:16px;text-align:justify;">起始地址</span><br /></td><td><span style="font-size:16px;text-align:justify;font-family:'宋体';">大小（</span><span style="font-family:'Times New Roman';font-size:16px;text-align:justify;">Kbyte</span><span style="font-size:16px;text-align:justify;font-family:'宋体';">）</span><br /></td></tr><tr><td><span style="font-family:'宋体';font-size:16px;text-align:justify;">可用空间</span><br /></td><td><span style="font-family:'Times New Roman';font-size:16px;text-align:justify;">0x20000000</span><br /></td><td><span style="font-family:'Times New Roman';font-size:16px;text-align:justify;">240</span><br /></td></tr><tr><td><span style="font-family:'Times New Roman';font-size:16px;text-align:justify;">Wi-Fi</span><span style="font-size:16px;text-align:justify;font-family:'宋体';">使用空间</span><br /></td><td><span style="font-family:'Times New Roman';font-size:16px;text-align:justify;">0x2003C000</span><br /></td><td><span style="font-family:'Times New Roman';font-size:16px;text-align:justify;">48</span></td></tr></table></blockquote>

<p><br /></p>

<h3>3.模块的内置Flash空间分配情况:</h3>

<p>内置Flash总容量为1MBytes，具体分配方式如下</p>

<blockquote><table class="table table-bordered"><tr><td><span style="font-size:12pt;font-family:'宋体';">分类</span><br /></td><td><span style="font-size:12pt;font-family:'宋体';">起始地址</span><br /></td><td><span style="font-size:12pt;font-family:'宋体';">大小（</span><span style="font-size:12pt;font-family:'Times New Roman';">Kbyte</span><span style="font-size:12pt;font-family:'宋体';">）</span><br /></td></tr><tr><td><span style="font-size:12pt;font-family:'宋体';">系统参数</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">0x8000000</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">8</span><br /></td></tr><tr><td><span style="font-size:12pt;font-family:'宋体';">二级</span><span style="font-size:12pt;font-family:'Times New Roman';">BOOT</span><span style="font-size:12pt;font-family:'宋体';">区域</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">0x8002000</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">32</span><br /></td></tr><tr><td><span style="font-size:12pt;font-family:'Times New Roman';">IMAGE1</span><span style="font-size:12pt;font-family:'宋体';">头</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">0x800A000</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">4</span><br /></td></tr><tr><td><span style="font-size:12pt;font-family:'Times New Roman';">IMAGE2</span><span style="font-size:12pt;font-family:'宋体';">头</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">0x800B000</span><br /></td><td>4</td></tr><tr><td><span style="font-size:12pt;font-family:'宋体';">参数</span><span style="font-size:12pt;font-family:'Times New Roman';">1</span><span style="font-size:12pt;font-family:'宋体';">区域</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">0x800C000</span><br /></td><td>4</td></tr><tr><td><span style="font-size:12pt;font-family:'宋体';">参数</span><span style="font-size:12pt;font-family:'Times New Roman';">2</span><span style="font-size:12pt;font-family:'宋体';">区域</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">0x800D000</span><br /></td><td>4</td></tr><tr><td><span style="font-size:12pt;font-family:'Times New Roman';">IMAGE</span><span style="font-size:12pt;font-family:'宋体';">运行区域</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">0x800E000</span><br /></td><td>450</td></tr><tr><td><span style="font-size:12pt;font-family:'Times New Roman';">IMAGE</span><span style="font-size:12pt;font-family:'宋体';">升级区域</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">0x807E800</span><br /></td><td>450</td></tr><tr><td><span style="font-size:12pt;font-family:'宋体';">用户区域</span><br /></td><td><span style="font-size:12pt;font-family:'Times New Roman';">0x80EF000</span><br /></td><td>64</td></tr></table><font>注：从</font>0x<span style="font-family:'Times New Roman';font-size:16px;">80</span>FF000地址开始的4K空间请勿使用！</blockquote>



<p><br /></p>

<h3>4.模块的CSDK开发环境是什么：</h3>

<pre>CSDK使用Keil的MDK开发环境，官方推荐使用MDK5.22版本。解压CSDK包后，使用MDK打开CSDK的目录下的工程文件“Tools/Keil/Project/WM_W600.uvproj”，点击MDK菜单Project-&gt;build target完成编译。</pre>

<p><br /></p>

<h3>5.模块的如何烧写编译后的文件：</h3>

<pre>使用官方的luatools进行，当编译成功后，会在CSDK包目录“Bin”下生成一个名为“WM_W600_SEC.img”的img文件，使用这个文件烧写成功后，重启模块即可运行用户自己的代码。烧写通过串口uart0烧写，开发板上的位置为usb转串口。</pre>

<p><span style="font-size:12pt;font-family:'宋体';"><br /></span></p>

<h3>6.CSDK使用的操作系统：</h3>

<pre><span style="font-size:12pt;font-family:'宋体';">目前C</span><span style="font-size:12pt;font-family:'Times New Roman';">SDK使用的</span><span style="font-size:12pt;font-family:'宋体';">系统为FreeRTOS，</span><span style="font-size:12pt;font-family:'Times New Roman';">RTOS tick</span><span style="font-size:12pt;font-family:'宋体';">值是</span><span style="font-size:12pt;font-family:'Times New Roman';">2ms</span><span style="font-size:12pt;font-family:'宋体';">。</span></pre>

<p><span style="font-size:12pt;font-family:'宋体';"><br /></span></p>

<h3>7.出厂AT指令的串口使用：</h3>

<pre>默认波特率是115200，使用UART0进行通信</pre>

<p><br /></p>

<h3>8.Luatools下载地址：</h3>

<pre><a target="_blank" rel="noopener" href="http://www.openluat.com/Product/file/rda8955/luatools-redirect.html">http://www.openluat.com/Product/file/rda8955/luatools-redirect.html</a></pre>

<h3><span style="color:rgb(51,51,51);font-size:14px;font-family:inherit;"><br /></span></h3>

<p><br /></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://doc.luatos.wiki/2018/08/19/395/" data-id="ckkfmdgb3004nvkcghihs85d1" data-title="Air602物联网Wi-Fi模块介绍" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/57/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/56/">56</a><a class="page-number" href="/page/57/">57</a><span class="page-number current">58</span><a class="page-number" href="/page/59/">59</a><a class="extend next" rel="next" href="/page/59/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2032/01/">一月 2032</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2032/01/01/608/">【置顶】合宙模块资料汇总</a>
          </li>
        
          <li>
            <a href="/2022/12/31/638/">Air系列模块常见问题列表</a>
          </li>
        
          <li>
            <a href="/2021/01/27/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2021/01/27/2420/">ECMAScript(ES6)基本语法介绍（一）</a>
          </li>
        
          <li>
            <a href="/2021/01/26/2417/">Air720S系列_luat二次开发固件（ 底层软件+上层脚本）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 chenxuuu<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>