<!DOCTYPE html>

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <title>Luat系列教程：4、学会使用并看懂luatools的trace信息 [ Luat doc 社区文章静态页面 ]</title>

    <!-- stylesheets list from config.yml -->

      <link rel="stylesheet" href="/css/iLiKE.css">




<meta name="generator" content="Hexo 5.3.0"></head>
<body>
    <div class="header">
        <div class="container">
    <div class="menu">
      <div class="menu-left">
        <a href="/">
          <img src="https://iot.openluat.com/assets/img/logo.jpg"></img>
        </a>
      </div>
      <div class="menu-right">







          <a href="/">首页</a>







          <a href="/archives">归档</a>







          <a href="https://luatdoc.papapoi.com/wiki/">关于</a>

      </div>
    </div>
</div>
    </div>
    <div class="container">
        <h1 class="post-title">Luat系列教程：4、学会使用并看懂luatools的trace信息</h1>
<article class="post markdown-style">
  <blockquote>
<p>适合阅读本文的人需要：<br>理解或已经学习了前几章的内容<br>熟悉lua语法<br>有实际模块，可以自己实践验证<br>能耐心阅读完本文<br>有问题会在文章下方进行留言</p>
</blockquote>
<p>由于luat这个架构并不能直接连接仿真器进行调试，所以也无法在程序中设置断点来检查自己代码是否有问题，所以在开发过程中，一般我们都是靠各种print来输出trace获取程序运行的各种状态的。<br>并且由于lua是脚本文件，烧录时并没有进行编译，所以就算是报错，报错信息也可以准确地把错误所在行的具体位置详细指出来，方便我们进行排查问题</p>
<h1 id="trace的几个基本部分"><a href="#trace的几个基本部分" class="headerlink" title="trace的几个基本部分"></a>trace的几个基本部分</h1><p>首先我们随便烧录一个程序，就只包含下面一个main.lua和自带的LuaTask库文件好了：<br>main.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">PROJECT = <span class="string">&quot;LOG-TEST&quot;</span></span><br><span class="line">VERSION = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--加载日志功能模块，并且设置日志输出等级</span></span><br><span class="line"><span class="comment">--如果关闭调用log模块接口输出的日志，等级设置为log.LOG_SILENT即可</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">LOG_LEVEL = <span class="built_in">log</span>.LOGLEVEL_TRACE</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;sys&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="comment">--每1分钟查询一次GSM信号强度</span></span><br><span class="line"><span class="comment">--每1分钟查询一次基站信息</span></span><br><span class="line">net.startQueryAll(<span class="number">60000</span>, <span class="number">60000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载硬件看门狗功能模块</span></span><br><span class="line"><span class="comment">--根据自己的硬件配置决定：1、是否加载此功能模块；2、配置Luat模块复位单片机引脚和互相喂狗引脚</span></span><br><span class="line"><span class="comment">--合宙官方出售的Air201开发板上有硬件看门狗，所以使用官方Air201开发板时，必须加载此功能模块</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;wdt&quot;</span></span><br><span class="line">wdt.setup(pio.P0_30, pio.P0_31)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--加载网络指示灯功能模块</span></span><br><span class="line"><span class="comment">--根据自己的项目需求和硬件配置决定：1、是否加载此功能模块；2、配置指示灯引脚</span></span><br><span class="line"><span class="comment">--合宙官方出售的Air800和Air801开发板上的指示灯引脚为pio.P0_28，其他开发板上的指示灯引脚为pio.P1_1</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;netLed&quot;</span></span><br><span class="line">netLed.setup(<span class="literal">true</span>,pio.P1_1)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载错误日志管理功能模块【强烈建议打开此功能】</span></span><br><span class="line"><span class="comment">--如下2行代码，只是简单的演示如何使用errDump功能，详情参考errDump的api</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;errDump&quot;</span></span><br><span class="line">errDump.request(<span class="string">&quot;udp://ota.airm2m.com:9072&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--启动系统框架</span></span><br><span class="line">sys.init(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">sys.run()</span><br></pre></td></tr></table></figure>
<p>程序中除了必要的<code>声明软件版本和名称</code>、<code>初始化看门狗</code>、<code>初始化网络灯</code>、<code>加载错误日志管理功能模块</code>、<code>启动系统框架</code>之外，没有进行其他任何操作（lib库文件和lod底层里进行的各种操作除外）<br>我们可以将这个文件烧录到开发板中，查看trace的各种信息（这里用的是S9开发板）：</p>
<p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-zqejrkLg5b80ccf881f86.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-zqejrkLg5b80ccf881f86.png"></a><br><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-MRIMreS55b80cd1353c4c.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-MRIMreS55b80cd1353c4c.png"></a><br>↑显示烧录成功后，最好立即关闭烧录界面，以免错过一些开头的trace信息。实际开发中一般错过了也没事，反正开头的一些东西也没什么用</p>
<p>我们可以看到trace中输出了一些信息：<br><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-bwJsOQOb5b80cd25ac9f6.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-bwJsOQOb5b80cd25ac9f6.png"></a></p>
<blockquote>
<p>由于trace中大多数的信息是由lib库文件打印出来的，随时可能会有更改，所以下面也就讲个大概，具体要以实际为准</p>
</blockquote>
<p>为了更好地观察，我们可以点击<code>停止打印</code>按钮，以免刷新新的log信息导致滚动条回到最低端：<br><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-5Qp0X2s15b80cd3f7b0fe.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-5Qp0X2s15b80cd3f7b0fe.png"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[时间]: CDFU_LoadSection: %d-%d</span><br><span class="line"></span><br><span class="line">[时间]: CDFU_LoadSection: %d-%d</span><br><span class="line"></span><br><span class="line">[时间]: &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[时间]: INTR VER :Luat_V0027_8955_SSL_UI</span><br><span class="line">[时间]: BASE VER :B5431</span><br><span class="line">[时间]: SCRIPT ADDR :0x002b0000</span><br><span class="line">[时间]: SCRIPT SIZE :0x000b0000</span><br><span class="line">[时间]: BASE   ADDR :0x00220000</span><br><span class="line">[时间]: BASE   SIZE :0x00090000</span><br><span class="line">[时间]: &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[时间]: [cust_task_main]: Enter message loop</span><br><span class="line">[时间]: INTEGRITY file not exist!</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;wdt.lua,len&#x3D;589,offset&#x3D;29006</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;utils.lua,len&#x3D;2526,offset&#x3D;26455</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;sys.lua,len&#x3D;5472,offset&#x3D;20956</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;sim.lua,len&#x3D;1084,offset&#x3D;19847</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;ril.lua,len&#x3D;7790,offset&#x3D;12032</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;pins.lua,len&#x3D;946,offset&#x3D;11061</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;patch.lua,len&#x3D;1186,offset&#x3D;9849</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;netLed.lua,len&#x3D;2601,offset&#x3D;7221</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;net.lua,len&#x3D;5141,offset&#x3D;2052</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;main.lua,len&#x3D;280,offset&#x3D;1747</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;log.lua,len&#x3D;1174,offset&#x3D;547</span><br><span class="line">[时间]: FH:file&#x3D;&#x2F;lua&#x2F;clib.lua,len&#x3D;472,offset&#x3D;50</span><br><span class="line">[时间]: parse_luadb_data:delupdpack&#x3D;0,err&#x3D;0,section&#x3D;1,wrFile&#x3D;0</span><br><span class="line">[时间]: INTEGRITY file write begin!</span><br><span class="line">[时间]: lualibc_fopen &#x2F;integrity.bin wb 601 1 2</span><br><span class="line">[时间]: INTEGRITY file write success!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;main.lua 2!</span><br><span class="line">[时间]: RUN main.lua</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;main.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;log.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;log.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;sys.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;sys.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;utils.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;utils.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;patch.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;patch.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;clib.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;clib.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;net.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;net.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;ril.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;ril.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;sim.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;sim.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;wdt.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;wdt.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;pins.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;pins.lua 2!</span><br><span class="line">[时间]: [I]-[wdt.taskWdt]	AirM2M --&gt; WATCHDOG : OK</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;netLed.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;netLed.lua 2!</span><br><span class="line">&#x2F;******************************温馨提示**************************************&#x2F;</span><br><span class="line">软件开机,如果是意外重启,请去http:&#x2F;&#x2F;wiki.openluat.com&#x2F;doc&#x2F;luatApi&#x2F;#rtospoweron,查看</span><br><span class="line">&#x2F;******************************提示结束**************************************&#x2F;</span><br></pre></td></tr></table></figure>
<p>开头的这一些代码表示读取到了上述的这些文件，可以用于后续的运行</p>
<blockquote>
<p>注意：<br>我们烧录进模块的lua文件一般都在<code>/lua/</code>路径下<br>而烧录的其他文件如png图片、mp3音乐，则会在<code>/ldata/</code>路径下</p>
</blockquote>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [I]-[poweron reason:]	3	LOG-TEST	1.0.0	2.0.8	Luat_V0027_8955_SSL_UI</span><br></pre></td></tr></table></figure>
<p>这一行代表了<code>上次关机的原因</code>、<code>脚本工程里定义的名称（main.lua第1行写的）</code>、<code>脚本工程里定义的版本号（main.lua第2行写的）</code>、<code>LuaTask库文件的版本号（1.x.x是旧版的lua script，2.x.x是LuaTask）</code>、<code>lod固件的版本号</code></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[时间]: LJD VSIM sim_SetNextVoltage:1048,sim_present&#x3D;0,IsVsim&#x3D;0</span><br><span class="line">[时间]: LJD VSIM sim_ProcessInstruction:2784,sim_present&#x3D;1,IsVsim&#x3D;1</span><br></pre></td></tr></table></figure>
<p>这两行的IsVsim=1代表了当前模块拥有虚拟sim卡，sim_present=1代表没检测到外置sim卡，所以就使用内置的虚拟sim卡（可能是吧，我猜的）</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [I]-[ril.defrsp]	AT+CMEE&#x3D;0	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CREG&#x3D;2</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CREG&#x3D;2	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CREG?</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CREG: 2,0</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CREG?	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CENG&#x3D;1,1</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CSQ</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CSQ: 0,0</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CENG?</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CENG:1,1</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CENG:0,&quot;0000, 0, 0,000,00,00,0000,00,00,0000,00&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CSQ</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CSQ: 0,0</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CENG?</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CENG:1,1</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CENG:0,&quot;0000, 0, 0,000,00,00,0000,00,00,0000,00&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CSIMTYPE: 0,0</span><br><span class="line">[时间]: [I]-[ril.defurc]	+CSIMTYPE: 0,0</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	+ENCRET: 0</span><br><span class="line">[时间]: [I]-[ril.defurc]	+ENCRET: 0</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	+CPIN: READY</span><br></pre></td></tr></table></figure>
<p>上面这些就是lua脚本底层里，调用AT接口来对模块进行的操作了。熟悉AT指令的人会一下子就明白这些，不熟悉的人可以无视，只要知道这些是调用的AT指令就可以，操作基本都由底层和lib库来完成，一般情况下不用接触</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [I]-[wdt.taskWdt]	AirM2M --&gt; WATCHDOG : OK</span><br><span class="line">[时间]: [I]-[wdt.taskWdt]	AirM2M &lt;-- WatchDog : OK</span><br></pre></td></tr></table></figure>
<p>这是看门狗的喂狗操作。。。我觉得我不用解释了吧。。。</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [I]-[ril.defrsp]	AT+CIPSTATUS	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	STATE: IP INITIAL</span><br><span class="line">[时间]: [I]-[link.STATE]	IP STATUS	IP INITIAL</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 0,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 0,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 1,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 1,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 2,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 2,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 3,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 3,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 4,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 4,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 5,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 5,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 6,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 6,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 7,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 7,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CSTT&#x3D;&quot;CMIOT&quot;,&quot;&quot;,&quot;&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CSTT&#x3D;&quot;CMIOT&quot;,&quot;&quot;,&quot;&quot;	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CIICR</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CIICR	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	STATE: IP GPRSACT</span><br><span class="line">[时间]: [I]-[link.STATE]	IP STATUS	IP GPRSACT</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CIFSR</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	010.007.081.239</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CIFSR	true	nil	010.007.081.239</span><br><span class="line">[时间]: [I]-[ril.sendat]	AT+CIPSTATUS</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	OK</span><br><span class="line">[时间]: [I]-[ril.defrsp]	AT+CIPSTATUS	true	OK	nil</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	STATE: IP STATUS</span><br><span class="line">[时间]: [I]-[link.STATE]	IP STATUS	IP STATUS</span><br><span class="line">[时间]: [I]-[ril.proatc]	</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 0,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 0,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 1,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 1,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 2,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 2,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 3,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 3,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 4,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 4,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 5,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 5,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 6,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 6,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.proatc]	C: 7,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br><span class="line">[时间]: [I]-[ril.defurc]	C: 7,,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;INITIAL&quot;</span><br></pre></td></tr></table></figure>
<p>熟悉AT的各位如果看到这两大串，一定又明白了，这模块连上GPRS网络了。不明白的大概了解一下就好，可以在测试时作为参考</p>
<hr>
<p>基本的trace就讲到这里，具体的自己去研究吧</p>
<h1 id="自定义输出trace（LuaTask格式）"><a href="#自定义输出trace（LuaTask格式）" class="headerlink" title="自定义输出trace（LuaTask格式）"></a>自定义输出trace（LuaTask格式）</h1><p>在第一版lua script时代，输出的trace基本都是直接使用<code>print(xxxxx)</code>这种格式，这个输出习惯的效果不怎么样，也不利于排查问题<br>于是在稀饭放姜大佬写的LuaTask版本中，使用了<code>log</code>语句，输出整齐具有区分度较高格式的trace</p>
<p>老套路，我们在上面的main.lua中稍作修改，在<code>--启动系统框架</code>的上方添加如下代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;logtest&quot;</span></span><br></pre></td></tr></table></figure>
<p>并且新建一个lua文件，名为<code>logtest.lua</code>，文件内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;common&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">log</span>.info(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出info级别的日志&quot;</span>))</span><br><span class="line">	<span class="built_in">log</span>.<span class="built_in">debug</span>(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出debug级别的日志&quot;</span>))</span><br><span class="line">	<span class="built_in">log</span>.trace(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出trace级别的日志&quot;</span>))</span><br><span class="line">	<span class="built_in">log</span>.warn(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出warn级别的日志&quot;</span>))</span><br><span class="line">	<span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出error级别的日志&quot;</span>))</span><br><span class="line">	<span class="built_in">log</span>.fatal(<span class="string">&quot;logtest.test&quot;</span>,common.utf8ToGb2312(<span class="string">&quot;输出fatal级别的日志&quot;</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：<br>由于vscode新建文件默认都为utf8编码格式<img src="http://oldask.openluat.com/image/show/attachments-2018-08-KLoZibqN5b80cd9de7be9.png">，<br>所以我们在代码中输出的中文字符也都为utf8编码格式。但是luatools使用的却是GB2312格式，所以为了输出正确不乱码的中文，我们需要对中文进行转码，使用<code>common.utf8ToGb2312()</code>函数就可以解决这个编码问题<br>输出英文没有类似问题，无需转码</p>
</blockquote>
<p>我们把<code>logtest.lua</code>文件添加到烧录工程中，将程序烧录进去，可以得到如下的输出结果（需要自己在luatools往上翻地找）：</p>
<p><a target="_blank" rel="noopener" href="http://oldask.openluat.com/image/show/attachments-2018-08-SetlMIpl5b80cdc199d09.png"><img src="http://oldask.openluat.com/image/show/attachments-2018-08-SetlMIpl5b80cdc199d09.png"></a></p>
<p>同时，log输出也可以改成如下语句：</p>
<p>testlog.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line">	<span class="keyword">local</span> b = <span class="literal">true</span></span><br><span class="line">	<span class="keyword">local</span> c = <span class="string">&quot;test&quot;</span></span><br><span class="line">	<span class="built_in">log</span>.info(<span class="string">&quot;logtest.test&quot;</span>,<span class="string">&quot;mixed output&quot;</span>,a,b,c)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [I]-[logtest.test]	mixed output	1	true	test</span><br></pre></td></tr></table></figure>
<p>这些输出日志方便了我们调试的过程，我们可以在程序必要处添加这些log输出，以便通过trace掌握程序运行的状态</p>
<h1 id="语法错误输出"><a href="#语法错误输出" class="headerlink" title="语法错误输出"></a>语法错误输出</h1><p>为了演示，我们可以再次更改<code>testlog.lua</code>文件的内容如下：</p>
<p>testlog.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">local</span> a</span><br><span class="line">	<span class="keyword">local</span> b = <span class="number">10</span></span><br><span class="line">	b = a + b</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>显而易见，这是会产生语法错误的，没看懂的也不要紧，烧录到模块中，可以看一下trace输出了什么：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[时间]: [E]-[errDump.luaErr]	&#x2F;lua&#x2F;logtest.lua:4: attempt to perform arithmetic on local &#39;a&#39; (a nil value)</span><br><span class="line"></span><br><span class="line">程序运行错误，请根据上方提示,找到对应lua文件修改程序</span><br><span class="line">[时间]: stack traceback:</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:4: in function &#39;test&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:7: in main chunk</span><br><span class="line">[时间]: 	[C]: in function &#39;require&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;main.lua:34: in main chunk</span><br><span class="line">[时间]: 	[C]: ?</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;logtest.lua 2!</span><br><span class="line">[时间]: [fopen_ext]: &#x2F;lua&#x2F;logtest.lua 2!</span><br><span class="line">[时间]: lualibc_fopen &#x2F;luaerrinfo.txt w 601 1 2</span><br><span class="line">[时间]: lua: &#x2F;lua&#x2F;logtest.lua:4: attempt to perform arithmetic on local &#39;a&#39; (a nil value)</span><br><span class="line">程序运行错误，请根据上方提示,找到对应lua文件修改程序</span><br><span class="line">[时间]: stack traceback:</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:4: in function &#39;test&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:7: in main chunk</span><br><span class="line">[时间]: 	[C]: in function &#39;require&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;main.lua:34: in main chunk</span><br><span class="line">[时间]: 	[C]: ?</span><br><span class="line">[时间]: [lua_shell_main]: lua exit status 1</span><br></pre></td></tr></table></figure>
<p>第一行的<code>/lua/logtest.lua:4: attempt to perform arithmetic on local &#39;a&#39; (a nil value)</code>代表了这个错误的具体原因，我们可以直接到错误的行数寻找，同时错误信息也写得十分明确：a是个nil值，无法进行算术计算</p>
<p>如果你觉得这个报错十分准确的话，那你就错了，如果真是这样我就不会在下面再加一段解释了</p>
<p>再次修改<code>testlog.lua</code>文件的内容如下：</p>
<p>testlog.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;utils&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">local</span> a = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="built_in">log</span>.info(<span class="string">&quot;logtest.test&quot;</span>,<span class="built_in">string</span>.toHex(a))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>报错信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[时间]: lua: &#x2F;lua&#x2F;utils.lua:19: attempt to index local &#39;str&#39; (a nil value)</span><br><span class="line">程序运行错误，请根据上方提示,找到对应lua文件修改程序</span><br><span class="line">[时间]: stack traceback:</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;utils.lua:19: in function &#39;toHex&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:5: in function &#39;test&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;logtest.lua:8: in main chunk</span><br><span class="line">[时间]: 	[C]: in function &#39;require&#39;</span><br><span class="line">[时间]: 	&#x2F;lua&#x2F;main.lua:34: in main chunk</span><br><span class="line">[时间]: 	[C]: ?</span><br><span class="line">[时间]: [lua_shell_main]: lua exit status 1</span><br></pre></td></tr></table></figure>
<p>可能有人看到这个报错就凌乱了：utils.lua？这文件不是我写的啊？</p>
<p>确实，<code>utils.lua</code>这个文件是lib文件夹中的库文件，库文件中的函数报错也会导致trace中显示这个文件的错误位置<br>我们可以在错误报告中找到<code>/lua/logtest.lua:5 : in function &#39;test&#39;</code>这一段，在检查后发现，确实是<code>logtest.lua</code>文件的第五行导致了错误：对<code>nil</code>进行转成16进制字符串的处理是非法的</p>
<hr>
<p>以上就是luatools中trace解析的基本解释，很多trace信息还需要各位自己来摸索，用的多了也就熟悉了这些信息了</p>

</article>

    <div class="pagenator post-pagenator">


        <a class="extend prev post-prev" href="/401/">上一篇</a>



    <p>上次更新 2021-01-28</p>


        <a class="extend next post-next" href="/399/">下一篇</a>

    </div>

    </div>
    <div class="footer">
        <div class="container">
    <div class="social">
	<ul class="social-list">





				<li>
					<a href="https://luatdoc.papapoi.com/wiki/" title="stack-overflow" target="_self">
					<i class="fa fa-stack-overflow"></i>
					</a>
				</li>












				<li>
					<a href="https://github.com/openluat" title="github" target="_self">
					<i class="fa fa-github"></i>
					</a>
				</li>
















	</ul>
</div>
    <div class="copyright">
        <span>



                © 仅供搜索引擎收录使用 2017 - 2021

        </span>
    </div>
    <div class="power">
        <span>
            Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/CaiChenghan/iLiKE">iLiKE Theme</a>
        </span>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <!--page counter part-->
<script>
function addCount (Counter) {
    url=$('.article-date').attr('href').trim();
    title = $('.article-title').text().trim();
    var query = new AV.Query(Counter);
    //use url as unique idnetfication
    query.equalTo("url",url);
    query.find({
        success: function(results) {
            if (results.length>0) {
                var counter=results[0];
                counter.fetchWhenSave(true); //get recent result
                counter.increment("time");
                counter.save();
            } else {
                var newcounter=new Counter();
                newcounter.set("title",title);
                newcounter.set("url",url);
                newcounter.set("time",1);
                newcounter.save(null,{
                    success: function(newcounter) {
                        //alert('New object created');
                    }, error: function(newcounter,error) {
                        alert('Failed to create');
                    }
                })
            }
        },
        error: function(error) {
            //find null is not a error
            alert('Error:'+error.code+" "+error.message);
        }
    });
}
$(function() {
    var Counter=AV.Object.extend("Counter");
    //only increse visit counting when intering a page
    if ($('.article-title').length == 1) {
       addCount(Counter);
    }
    var query=new AV.Query(Counter);
    query.descending("time");
    // the sum of popular posts
    query.limit(10);
    query.find({
        success: function(results) {
                for(var i=0;i<results.length;i++) {
                    var counter=results[i];
                    title=counter.get("title");
                    url=counter.get("url");
                    time=counter.get("time");
                    // add to the popularlist widget
                    showcontent=title+" ("+time+")";
                    //notice the "" in href
                    $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                }
            },
        error: function(error) {
            alert("Error:"+error.code+" "+error.message);
        }
    });
});
</script>
</div>
    </div>
</body>
</html>
