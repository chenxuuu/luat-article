<!DOCTYPE html>

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <title>Luat系列教程：6、mqtt代码详解 [ Luat doc 社区文章静态页面 ]</title>

    <!-- stylesheets list from config.yml -->

      <link rel="stylesheet" href="/css/iLiKE.css">




<meta name="generator" content="Hexo 5.3.0"></head>
<body>
    <div class="header">
        <div class="container">
    <div class="menu">
      <div class="menu-left">
        <a href="/">
          <img src="https://iot.openluat.com/assets/img/logo.jpg"></img>
        </a>
      </div>
      <div class="menu-right">







          <a href="/">首页</a>







          <a href="/archives">归档</a>







          <a href="https://luatdoc.papapoi.com/wiki/">关于</a>

      </div>
    </div>
</div>
    </div>
    <div class="container">
        <h1 class="post-title">Luat系列教程：6、mqtt代码详解</h1>
<article class="post markdown-style">
  <blockquote>
<p>写在前面：<br>由于本人并未学习过具体原理，所以本文可能会有多处常识性错误，如有发现请留言指出，谢谢！</p>
</blockquote>
<hr>
<blockquote>
<p>阅读本文需要具有的技能：<br>看过该系列前几篇文章或明白前几篇文章内容的<br>熟悉lua语法，尤其是数组部分<br>可以明白字符串、字节码之间的区别<br>可以自己实践操作<br>对mqtt通讯有基本的了解<br>用过这东西</p>
</blockquote>
<h2 id="官方demo代码"><a href="#官方demo代码" class="headerlink" title="官方demo代码"></a>官方demo代码</h2><p>官方代码可以在github(<a target="_blank" rel="noopener" href="https://github.com/openLuat/Luat_2G_RDA_8955/)%E7%9A%84%60Luat_2G_RDA_8955/script_LuaTask/demo/mqtt%60%E7%9B%AE%E5%BD%95%E6%88%96luatools%E7%9A%84%60LuaTools">https://github.com/openLuat/Luat_2G_RDA_8955/)的`Luat_2G_RDA_8955/script_LuaTask/demo/mqtt`目录或luatools的`LuaTools</a> 1.x.x\script\script_LuaTask\demo\mqtt`目录找到</p>
<p>如果你能看懂官方例程，<strong>那么可以直接去使用，不需要再看本文了</strong></p>
<h1 id="先定义一个假装能用来测试的mqtt需求"><a href="#先定义一个假装能用来测试的mqtt需求" class="headerlink" title="先定义一个假装能用来测试的mqtt需求"></a>先定义一个假装能用来测试的mqtt需求</h1><p>客户端订阅主题：<br>/d/test/#</p>
<p>设备订阅主题：<br>/s/test/设备的imei值</p>
<ul>
<li>设备联网后向<code>/d/test/设备的imei值</code>的topic发送payload为当前设备ICCID的字符串</li>
<li>服务器收到后向<code>/s/test/设备的imei值</code>的topic发送payload为<code>ok</code>两个字节的字符串</li>
<li>设备收到topic为<code>/s/test/设备的imei值</code>，payload为<code>ok</code>的数据后，再次向<code>/d/test/设备的imei值</code>的topic发送payload为<code>done</code>四个字节的字符串</li>
</ul>
<p>需求十分简单：</p>
<p><img src="http://oldask.openluat.com/image/show/attachments-2018-08-Iyg9g3vU5b83d12d58d3d.png"></p>
<p>如果你知道mqtt是什么，肯定能明白</p>
<h1 id="建立文件"><a href="#建立文件" class="headerlink" title="建立文件"></a>建立文件</h1><p>首先先新建两个文件，用于测试这个工程</p>
<p>main.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PROJECT = <span class="string">&quot;MQTT-TEST&quot;</span></span><br><span class="line">VERSION = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--根据固件判断模块类型</span></span><br><span class="line">moduleType = <span class="built_in">string</span>.<span class="built_in">find</span>(rtos.get_version(),<span class="string">&quot;8955&quot;</span>) <span class="keyword">and</span> <span class="number">2</span> <span class="keyword">or</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">LOG_LEVEL = <span class="built_in">log</span>.LOGLEVEL_TRACE</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;sys&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--每1分钟查询一次GSM信号强度,每1分钟查询一次基站信息</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;net&quot;</span></span><br><span class="line">net.startQueryAll(<span class="number">60000</span>, <span class="number">60000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载硬件看门狗功能模块</span></span><br><span class="line"><span class="comment">--如果用的是720 4g模块，请注释掉这两行</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;wdt&quot;</span></span><br><span class="line">wdt.setup(pio.P0_30, pio.P0_31)</span><br><span class="line"></span><br><span class="line"><span class="comment">--加载网络指示灯功能模块</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;netLed&quot;</span></span><br><span class="line">netLed.setup(<span class="literal">true</span>,moduleType == <span class="number">2</span> <span class="keyword">and</span> pio.P1_1 <span class="keyword">or</span> pio.P2_0,moduleType == <span class="number">2</span> <span class="keyword">and</span> <span class="literal">nil</span> <span class="keyword">or</span> pio.P2_1)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;mqttTest&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动系统框架</span></span><br><span class="line">sys.init(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">sys.run()</span><br></pre></td></tr></table></figure>
<p>mqttTest.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(...,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;misc&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;mqtt&quot;</span></span><br><span class="line"><span class="comment">--下面代码一会儿写</span></span><br></pre></td></tr></table></figure>

<h1 id="建立mqtt线程"><a href="#建立mqtt线程" class="headerlink" title="建立mqtt线程"></a>建立mqtt线程</h1><p>一般来说，mqtt连接都是异步运行的，何时应该发送数据，何时应该接收数据，这些逻辑应该让mqtt收发的进程自己进行控制</p>
<p>所以我们在<code>mqttTest.lua</code>中添加一个新的线程（看不懂的回去看前几篇文章），文件改成如下（<code>注意改一下测试服务器信息</code>）：</p>
<p>mqttTest.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>(...,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;misc&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;mqtt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--测试用的服务器信息，按需求自己改</span></span><br><span class="line"><span class="keyword">local</span> mqttip,mqttport,mqttuser,mqttpassword,mqttheartbeat = <span class="string">&quot;x.x.x.x&quot;</span>,<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;user&quot;</span>,<span class="string">&quot;password&quot;</span>,<span class="number">600</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="comment">--该区域的代码会永久循环运行（除非出现语法错误）</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h1 id="进行mqtt连接"><a href="#进行mqtt连接" class="headerlink" title="进行mqtt连接"></a>进行mqtt连接</h1><p>一般来说，我们会在模块成功获取基站分配的ip后，才会进行网络的连接操作，所以我们需要使用<code>socket.isReady()</code>函数来判断是否连接网络，然后再进行网络操作</p>
<p>在成功获取ip后，我们才能新建一个mqtt对象，对其进行联网操作，mqtt客户端线程代码改为如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)</span><br><span class="line">                <span class="comment">--连接失败</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网，原地等待一秒，一秒后会循环回去重试</span></span><br><span class="line">            sys.wait(<span class="number">1000</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h1 id="对连接失败的处理"><a href="#对连接失败的处理" class="headerlink" title="对连接失败的处理"></a>对连接失败的处理</h1><p>上述代码只是一个简单的连接服务器的代码，并且连上之后没有进行任何的其他操作</p>
<p>为了增加代码的稳健性，我们可以利用<code>sys.waitUntil()</code>函数，设置五分钟内没有获取到ip就开启飞行模式几秒，再关闭，让模块重新去获取GPRS连接：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)</span><br><span class="line">                <span class="comment">--连接失败</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<p>同样，我们也可以给<code>mqttClient:connect(mqttip,mqttport,&quot;tcp&quot;)</code>的连接加上错误次数的判断，连接错误超过五次，强制断开socket连接,等待五秒后重试：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)<span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--断开MQTT连接</span></span><br><span class="line">            mqttClient:disconnect()</span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">                link.shut()</span><br><span class="line">                retryConnectCnt=<span class="number">0</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h1 id="添加发送-接收处理函数，订阅主题"><a href="#添加发送-接收处理函数，订阅主题" class="headerlink" title="添加发送/接收处理函数，订阅主题"></a>添加发送/接收处理函数，订阅主题</h1><p>到了这一步，整个的mqtt线程只剩下<code>循环处理接收和发送的数据</code>这一部分和订阅topic部分与demo不同了，我们直接把这两部分加到mqtt线程的代码中吧：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line">                <span class="comment">--订阅主题</span></span><br><span class="line">                <span class="keyword">if</span> mqttClient:subscribe(&#123;[<span class="string">&quot;/s/test/&quot;</span>..imei]=<span class="number">0</span>&#125;) <span class="keyword">then</span></span><br><span class="line">                    <span class="comment">--循环处理接收和发送的数据</span></span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttInMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttInMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttOutMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttOutMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)<span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--断开MQTT连接</span></span><br><span class="line">            mqttClient:disconnect()</span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">                link.shut()</span><br><span class="line">                retryConnectCnt=<span class="number">0</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到，在接收和发送函数不返回false的情况下，接收和发送循环会一直进行下去；只有当两个函数之一返回false时，才会触发break导致退出该接收和发送循环</p>
<h1 id="mqttInMsgProc-mqttClient-函数"><a href="#mqttInMsgProc-mqttClient-函数" class="headerlink" title="mqttInMsgProc(mqttClient)函数"></a>mqttInMsgProc(mqttClient)函数</h1><p>这段的代码相对来说比较简单，我们可以直接使用<code>mqttClient:receive(毫秒数)</code>来接收我们的tcp消息。<br>我们在合适的地方，新建一个<code>mqttInMsgProc(mqttClient)</code>函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttInMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = mqttClient:receive(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttInMsgProc&quot;</span>,data.topic,<span class="built_in">string</span>.toHex(data.payload))</span><br><span class="line">            <span class="comment">--TODO：根据需求自行处理data.payload</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这段代码就是循环获取mqtt消息，如果没获取到，<code>mqttClient:receive(2000)</code>就会返回<code>false,&quot;timeout&quot;</code>；如果获取到了，就会返回<code>true,获取到的数据字符串</code>；如果返回了<code>false,不为&quot;timeout&quot;</code>，则表示数据处理出错，说明mqtt连接有了什么问题</p>
<p>细心的读者可能看出来了，如果接收函数一直在2秒内有接收到数据，那么这段函数会永远无限循环下去，没办法到达<code>mqttOutMsgProc(mqttClient)</code>函数进行发送数据的操作，所以我们先去讲<code>mqttOutMsgProc(mqttClient)</code>函数的实现过程，再回来改进<code>mqttInMsgProc(mqttClient)</code>函数</p>
<h1 id="mqttOutMsgProc-mqttClient-函数"><a href="#mqttOutMsgProc-mqttClient-函数" class="headerlink" title="mqttOutMsgProc(mqttClient)函数"></a>mqttOutMsgProc(mqttClient)函数</h1><p>由于发送函数在mqtt线程中是一个循环的小部分，所以我们要建立一个消息发送的队列：有要发送的发数据时，将数据放到这个队列中；等运行到<code>mqttOutMsgProc(mqttClient)</code>函数时，将队列中的数据一个一个发出去</p>
<p>首先我们要建一个放这种队列的数组，在合适位置声明一下这个数组：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--数据发送的消息队列</span></span><br><span class="line"><span class="keyword">local</span> msgQuene = &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>接着我们构造一个可以往数组里插入数据的函数，<code>table.insert()</code>可以向数组添加数据，所以我们新建一个<code>insertMsg</code>函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">insertMsg</span><span class="params">(topic,payload,qos,user)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(msgQuene,&#123;t=topic,p=payload,q=qos,user=user&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>还记得上面说过的<code>消息接收函数函数会永远无限循环下去</code>的问题吗？我们在合适的地方新建一个判断发送消息队列是否为空的函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waitForSend</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> #msgQuene &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在数组有数据时，这个函数会返回true，我们可以将<code>mqttInMsgProc(mqttClient)</code>接收到数据后的代码添加一行判断发送队列是否有数据的代码，当检测到发送队列有数据时，就立即退出接收函数，转而去进行发送动作，接收函数最终改为了这样：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttInMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = mqttClient:receive(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttInMsgProc&quot;</span>,data.topic,<span class="built_in">string</span>.toHex(data.payload))</span><br><span class="line">            <span class="comment">--TODO：根据需求自行处理data.payload</span></span><br><span class="line">            <span class="comment">--如果msgQuene中有等待发送的数据，则立即退出本循环</span></span><br><span class="line">            <span class="keyword">if</span> waitForSend() <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>最后我们终于可以开始写消息发送函数了，整体的函数就是检查队列是否为空，不为空的话就发一条消息并将其从队列中删除，然后重复这一操作，函数代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttOutMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">while</span> #msgQuene&gt;<span class="number">0</span> <span class="keyword">do</span>    <span class="comment">--数组大于零？</span></span><br><span class="line">        <span class="keyword">local</span> outMsg = <span class="built_in">table</span>.<span class="built_in">remove</span>(msgQuene,<span class="number">1</span>)<span class="comment">--取出并删除一个元素</span></span><br><span class="line">        <span class="keyword">local</span> result = mqttClient:publish(outMsg.t,outMsg.p,outMsg.q)<span class="comment">--推送对应的mqtt消息</span></span><br><span class="line">        <span class="keyword">if</span> outMsg.user <span class="keyword">and</span> outMsg.user.cb <span class="keyword">then</span>  <span class="comment">--如果存在回调函数</span></span><br><span class="line">            outMsg.user.cb(result,outMsg.user.para)<span class="comment">--执行回调函数</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>outMsg.user</code>即为消息队列数组中的，消息数组中的，包含了回调函数的，数组（反正挺绕的）</p>
</blockquote>
<blockquote>
<p>具体就像下面这样用：</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">insertMsg(<span class="string">&quot;/d/test/123&quot;</span>,<span class="string">&quot;done&quot;</span>,&#123;cb=testcb&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">testcb</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">&quot;test.testcb&quot;</span>,<span class="string">&quot;test message sent&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样，该条消息发送后就会执行指定的回调函数</p>
</blockquote>
<h1 id="完成基本的mqtt线程"><a href="#完成基本的mqtt线程" class="headerlink" title="完成基本的mqtt线程"></a>完成基本的mqtt线程</h1><p>经过上述的更改，最终，<code>mqttTest.lua</code>已经实现了连接服务器并自动处理错误的功能，并且预留了消息接收以及向发送队列添加数据的接口，文件的所有代码如下：</p>
<p>mqttTest.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;misc&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;mqtt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--测试用的服务器信息，按需求自己改</span></span><br><span class="line"><span class="keyword">local</span> mqttip,mqttport,mqttuser,mqttpassword,mqttheartbeat = <span class="string">&quot;x.x.x.x&quot;</span>,<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;user&quot;</span>,<span class="string">&quot;password&quot;</span>,<span class="number">600</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--数据发送的消息队列</span></span><br><span class="line"><span class="keyword">local</span> msgQuene = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">insertMsg</span><span class="params">(topic,payload,qos,user)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(msgQuene,&#123;t=topic,p=payload,q=qos,user=user&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waitForSend</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> #msgQuene &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttOutMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">while</span> #msgQuene&gt;<span class="number">0</span> <span class="keyword">do</span>    <span class="comment">--数组大于零？</span></span><br><span class="line">        <span class="keyword">local</span> outMsg = <span class="built_in">table</span>.<span class="built_in">remove</span>(msgQuene,<span class="number">1</span>)<span class="comment">--取出并删除一个元素</span></span><br><span class="line">        <span class="keyword">local</span> result = mqttClient:publish(outMsg.t,outMsg.p,outMsg.q)<span class="comment">--推送对应的mqtt消息</span></span><br><span class="line">        <span class="keyword">if</span> outMsg.user <span class="keyword">and</span> outMsg.user.cb <span class="keyword">then</span>  <span class="comment">--如果存在回调函数</span></span><br><span class="line">            outMsg.user.cb(result,outMsg.user.para)<span class="comment">--执行回调函数</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttInMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = mqttClient:receive(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttInMsgProc&quot;</span>,data.topic,<span class="built_in">string</span>.toHex(data.payload))</span><br><span class="line">            <span class="comment">--TODO：根据需求自行处理data.payload</span></span><br><span class="line">            <span class="comment">--如果msgQuene中有等待发送的数据，则立即退出本循环</span></span><br><span class="line">            <span class="keyword">if</span> waitForSend() <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line">                <span class="comment">--订阅主题</span></span><br><span class="line">                <span class="keyword">if</span> mqttClient:subscribe(&#123;[<span class="string">&quot;/s/test/&quot;</span>..imei]=<span class="number">0</span>&#125;) <span class="keyword">then</span></span><br><span class="line">                    <span class="comment">--循环处理接收和发送的数据</span></span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttInMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttInMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttOutMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttOutMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)<span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--断开MQTT连接</span></span><br><span class="line">            mqttClient:disconnect()</span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">                link.shut()</span><br><span class="line">                retryConnectCnt=<span class="number">0</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h1 id="实现协议需求"><a href="#实现协议需求" class="headerlink" title="实现协议需求"></a>实现协议需求</h1><h2 id="设备联网后向-d-test-设备的imei值的topic发送payload为当前设备ICCID的字符串"><a href="#设备联网后向-d-test-设备的imei值的topic发送payload为当前设备ICCID的字符串" class="headerlink" title="设备联网后向/d/test/设备的imei值的topic发送payload为当前设备ICCID的字符串"></a>设备联网后向<code>/d/test/设备的imei值</code>的topic发送payload为当前设备ICCID的字符串</h2><p>我们只需要在连接成功处添加代码即可，在<code>if mqttClient:subscribe(&#123;[&quot;/s/test/&quot;..imei]=0&#125;) then</code>所在代码下一行添加：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insertMsg(<span class="string">&quot;/d/test/&quot;</span>..misc.getImei(),sim.getIccid())</span><br></pre></td></tr></table></figure>
<h2 id="设备收到topic为-s-test-设备的imei值，payload为ok的数据后，再次向-d-test-设备的imei值的topic发送payload为done四个字节的字符串"><a href="#设备收到topic为-s-test-设备的imei值，payload为ok的数据后，再次向-d-test-设备的imei值的topic发送payload为done四个字节的字符串" class="headerlink" title="设备收到topic为/s/test/设备的imei值，payload为ok的数据后，再次向/d/test/设备的imei值的topic发送payload为done四个字节的字符串"></a>设备收到topic为<code>/s/test/设备的imei值</code>，payload为<code>ok</code>的数据后，再次向<code>/d/test/设备的imei值</code>的topic发送payload为<code>done</code>四个字节的字符串</h2><p>我们只需要在接收处理消息处添加代码即可，在<code>--TODO：根据需求自行处理data.payload</code>所在代码下一行添加：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> data.topic == <span class="string">&quot;/s/test/&quot;</span>..misc.getImei() <span class="keyword">and</span> data.payload == <span class="string">&quot;ok&quot;</span> <span class="keyword">then</span></span><br><span class="line">    insertMsg(<span class="string">&quot;/d/test/&quot;</span>..misc.getImei(),<span class="string">&quot;done&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p>经过上面的删删改改，功能以及基本实现了，整个文件的代码如下：</p>
<p>mqttTest.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span><span class="string">&quot;misc&quot;</span></span><br><span class="line"><span class="built_in">require</span><span class="string">&quot;mqtt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--测试用的服务器信息，按需求自己改</span></span><br><span class="line"><span class="keyword">local</span> mqttip,mqttport,mqttuser,mqttpassword,mqttheartbeat = <span class="string">&quot;x.x.x.x&quot;</span>,<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;user&quot;</span>,<span class="string">&quot;password&quot;</span>,<span class="number">600</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--数据发送的消息队列</span></span><br><span class="line"><span class="keyword">local</span> msgQuene = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">insertMsg</span><span class="params">(topic,payload,qos,user)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(msgQuene,&#123;t=topic,p=payload,q=qos,user=user&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waitForSend</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> #msgQuene &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttOutMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">while</span> #msgQuene&gt;<span class="number">0</span> <span class="keyword">do</span>    <span class="comment">--数组大于零？</span></span><br><span class="line">        <span class="keyword">local</span> outMsg = <span class="built_in">table</span>.<span class="built_in">remove</span>(msgQuene,<span class="number">1</span>)<span class="comment">--取出并删除一个元素</span></span><br><span class="line">        <span class="keyword">local</span> result = mqttClient:publish(outMsg.t,outMsg.p,outMsg.q)<span class="comment">--推送对应的mqtt消息</span></span><br><span class="line">        <span class="keyword">if</span> outMsg.user <span class="keyword">and</span> outMsg.user.cb <span class="keyword">then</span>  <span class="comment">--如果存在回调函数</span></span><br><span class="line">            outMsg.user.cb(result,outMsg.user.para)<span class="comment">--执行回调函数</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqttInMsgProc</span><span class="params">(mqttClient)</span></span></span><br><span class="line">    <span class="keyword">local</span> result,data</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        result,data = mqttClient:receive(<span class="number">2000</span>)</span><br><span class="line">        <span class="comment">--接收到数据</span></span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttInMsgProc&quot;</span>,data.topic,<span class="built_in">string</span>.toHex(data.payload))</span><br><span class="line">            <span class="comment">--TODO：根据需求自行处理data.payload</span></span><br><span class="line">            <span class="keyword">if</span> data.topic == <span class="string">&quot;/s/test/&quot;</span>..misc.getImei() <span class="keyword">and</span> data.payload == <span class="string">&quot;ok&quot;</span> <span class="keyword">then</span></span><br><span class="line">                insertMsg(<span class="string">&quot;/d/test/&quot;</span>..misc.getImei(),<span class="string">&quot;done&quot;</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--如果msgQuene中有等待发送的数据，则立即退出本循环</span></span><br><span class="line">            <span class="keyword">if</span> waitForSend() <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">or</span> data==<span class="string">&quot;timeout&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--启动mqtt客户端任务</span></span><br><span class="line">sys.taskInit(</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> retryConnectCnt = <span class="number">0</span>   <span class="comment">--失败次数统计</span></span><br><span class="line">        <span class="comment">--是否获取到了分配的ip(是否连上网)</span></span><br><span class="line">        <span class="keyword">if</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> imei = misc.getImei()</span><br><span class="line">            <span class="comment">--新建一个mqtt对象</span></span><br><span class="line">            <span class="keyword">local</span> mqttClient = mqtt.client(imei,mqttheartbeat,mqttuser,mqttpassword)</span><br><span class="line">            <span class="comment">--尝试连接指定服务器</span></span><br><span class="line">            <span class="keyword">if</span> mqttClient:connect(mqttip,mqttport,<span class="string">&quot;tcp&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--连接成功</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect success&quot;</span>)</span><br><span class="line">                retryConnectCnt = <span class="number">0</span> <span class="comment">--失败次数清零</span></span><br><span class="line">                <span class="comment">--订阅主题</span></span><br><span class="line">                <span class="keyword">if</span> mqttClient:subscribe(&#123;[<span class="string">&quot;/s/test/&quot;</span>..imei]=<span class="number">0</span>&#125;) <span class="keyword">then</span></span><br><span class="line">                    insertMsg(<span class="string">&quot;/d/test/&quot;</span>..misc.getImei(),sim.getIccid())</span><br><span class="line">                    <span class="comment">--循环处理接收和发送的数据</span></span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttInMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttInMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> mqttOutMsgProc(mqttClient) <span class="keyword">then</span></span><br><span class="line">                            <span class="built_in">log</span>.<span class="built_in">error</span>(<span class="string">&quot;mqttTest.mqttOutMsgProc error&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">&quot;mqttTest.mqttClient&quot;</span>,<span class="string">&quot;connect fail&quot;</span>)<span class="comment">--连接失败</span></span><br><span class="line">                retryConnectCnt = retryConnectCnt+<span class="number">1</span> <span class="comment">--失败次数加一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">--断开MQTT连接</span></span><br><span class="line">            mqttClient:disconnect()</span><br><span class="line">            <span class="keyword">if</span> retryConnectCnt&gt;=<span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">                link.shut()</span><br><span class="line">                retryConnectCnt=<span class="number">0</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            sys.wait(<span class="number">5000</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">--没连上网</span></span><br><span class="line">            <span class="comment">--等待网络环境准备就绪，超时时间是5分钟</span></span><br><span class="line">            sys.waitUntil(<span class="string">&quot;IP_READY_IND&quot;</span>,<span class="number">300000</span>)</span><br><span class="line">            <span class="comment">--等完了还没连上？</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> socket.isReady() <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--进入飞行模式，20秒之后，退出飞行模式</span></span><br><span class="line">                net.switchFly(<span class="literal">true</span>)</span><br><span class="line">                sys.wait(<span class="number">20000</span>)</span><br><span class="line">                net.switchFly(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>
<h1 id="验证功能"><a href="#验证功能" class="headerlink" title="验证功能"></a>验证功能</h1><p>我没条件测试这玩意儿。。。谁有空帮我测试下的？</p>

</article>

    <div class="pagenator post-pagenator">


        <a class="extend prev post-prev" href="/407/">上一篇</a>



    <p>上次更新 2021-01-28</p>


        <a class="extend next post-next" href="/405/">下一篇</a>

    </div>

    </div>
    <div class="footer">
        <div class="container">
    <div class="social">
	<ul class="social-list">





				<li>
					<a href="https://luatdoc.papapoi.com/wiki/" title="stack-overflow" target="_self">
					<i class="fa fa-stack-overflow"></i>
					</a>
				</li>












				<li>
					<a href="https://github.com/openluat" title="github" target="_self">
					<i class="fa fa-github"></i>
					</a>
				</li>
















	</ul>
</div>
    <div class="copyright">
        <span>



                © 仅供搜索引擎收录使用 2017 - 2021

        </span>
    </div>
    <div class="power">
        <span>
            Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/CaiChenghan/iLiKE">iLiKE Theme</a>
        </span>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <!--page counter part-->
<script>
function addCount (Counter) {
    url=$('.article-date').attr('href').trim();
    title = $('.article-title').text().trim();
    var query = new AV.Query(Counter);
    //use url as unique idnetfication
    query.equalTo("url",url);
    query.find({
        success: function(results) {
            if (results.length>0) {
                var counter=results[0];
                counter.fetchWhenSave(true); //get recent result
                counter.increment("time");
                counter.save();
            } else {
                var newcounter=new Counter();
                newcounter.set("title",title);
                newcounter.set("url",url);
                newcounter.set("time",1);
                newcounter.save(null,{
                    success: function(newcounter) {
                        //alert('New object created');
                    }, error: function(newcounter,error) {
                        alert('Failed to create');
                    }
                })
            }
        },
        error: function(error) {
            //find null is not a error
            alert('Error:'+error.code+" "+error.message);
        }
    });
}
$(function() {
    var Counter=AV.Object.extend("Counter");
    //only increse visit counting when intering a page
    if ($('.article-title').length == 1) {
       addCount(Counter);
    }
    var query=new AV.Query(Counter);
    query.descending("time");
    // the sum of popular posts
    query.limit(10);
    query.find({
        success: function(results) {
                for(var i=0;i<results.length;i++) {
                    var counter=results[i];
                    title=counter.get("title");
                    url=counter.get("url");
                    time=counter.get("time");
                    // add to the popularlist widget
                    showcontent=title+" ("+time+")";
                    //notice the "" in href
                    $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                }
            },
        error: function(error) {
            alert("Error:"+error.code+" "+error.message);
        }
    });
});
</script>
</div>
    </div>
</body>
</html>
