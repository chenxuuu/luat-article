3.1.12 网络注册与信号强度
=========================

作者：朱天华

一. 概念解析
------------

​先简单介绍几个概念：

​\ **位置区**\ ：一般是若干个相邻基站区的覆盖区域的总和，位置区识别码叫做LAC（4G网络下叫做TAC，若无特殊说明，本文以下章节，LAC等价于TAC）；

​\ **基站区**\ ：一座基站的覆盖范围，一般包含3个小区，即一座基站区等于3个小区的覆盖总和；

​\ **小区**\ ：最小的区域单位，小区识别码叫做CI；

​一个位置区一般有多个基站，一个基站一般包含3个或者多个小区，一个小区对应一个小区识别码CI，小区识别码和人的名字一样有重复，加上位置区识别码LAC之后就确定了唯一性。

​\ **频段**\ ：这个概念太过抽象，直接以中国的三大运营商为例来阐述：

​中国的三大运营商，建设了全球最多的4G基站。同时，工信部也分配了不同的频段给运营商作为4G覆盖使用。三大运营商的4G频段，都有相对的高、中、低频段。中国电信就有B1、B3、B5，中国联通有B1、B3、B8，中国移动则是TD-LTE/FDD-LTE混合组网，有最多的频段，包括B3、B8、B34、B38、B39、B40、B41。下图是4G频段表以及上下行频率范围（可能不准确，仅供参考）：
|image1|
​运营商在建设自己的4G基站时，根据工信部分配的频段，可以决定某个基站是支持分配的全部频段还是部分频段；例如中国移动在某个地区建设自己的基站，可以配置这个基站支持B3、B8、B34、B38、B39、B40、B41全部频段，也可以仅支持B3、B8频段，完全取决于运营商。

​Air724UX系列模块，支持B1、B3、B5、B8、B34、B38、B39、B40、B41频段，是支持中国4G网络全频段的纯4G模块（不支持2G和3G网络）。

​\ **信号强度**\ ：运营商的基站建设好之后，一旦开始工作，基站就对外发射信号。此时，终端设备（模块产品、手机产品等）一开机，就开始搜索信号；信号强度就表示：终端设备接收到的基站发射出的信号强度。

​基站发射的信号，通常都是经过折射、反射、衍射、散射等方式才被终端设备接收到，接收到的信号强度和终端设备的天线灵敏度、基站的距离、终端设备所处的环境等有关系，如下图所示：
|image2|

二. 网络注册
------------

2.1 网络注册流程
~~~~~~~~~~~~~~~~

网络注册，是指从开机搜网到注册到网络的过程，或者从退出飞行模式到注册到网络的过程，此过程（仅供参考，省去N多细节，欲知详情，请自行搜索
LTE注网流程 了解）可以概括为如下几步：

1、 终端设备开机或者退出飞行模式后，读取PLMN

-  公共陆地移动网（Public Land Mobile
   Network，简称：PLMN），由政府或它所批准的经营者，为公众提供陆地移动通信业务目的而建立和经营的网络
-  PLMN=MCC+MNC，以中国大陆的运营商为例，有中国移动、中国电信、中国联通三大运营商，MCC都是460，中国移动的MNC有00、02、07（后续可能还会扩充）
-  从SIM卡中以及模块固件的配置文件中读取PLMN列表

2、终端设备根据自己支持的频段，扫描基站信号，找到支持的PLMN

3、根据小区选择标准（S标准），选择一个最优的小区

4、驻留在最优小区

Air724UX系列模块，整个网络注册流程，自动完成，不需要人为参与。 ### 2.2
AT版本网络注册说明

Air724UX系列模块，仅支持4G网络，所以本章节仅描述和4G网络有关的命令AT+CEREG。

这个命令最常使用的两种功能是：\ **设置命令AT+CEREG=**\ 和\ **查询命令AT+CEREG?**

语法规则如下图所示：

|image3|
AT版本可以通过的值来判断网络注册状态，1和5表示注册上网络，其余都表示未注册上网络
### 2.3 Luat版本网络注册说明

Luat版本通过api接口\ **net.getState()**\ 获取网络注册状态，此接口的返回值意义如下：
- “INIT”表示正在初始化 - “REGISTERED”表示已注册 - “UNREGISTER”表示未注册

三. 信号强度
------------

3.1 参考指标
~~~~~~~~~~~~

信号强度有两种不同的参考指标：

**rssi**\ ：接收信号强度指示；是一种传统的信号强度参数，过去一直用于2G网络的信号强度指示；很多用户仍然习惯使用这个参数来表示4G网络的信号强度；在合宙4G
Cat.1模块中，rssi的取值范围为0到31，99；\ **AT+CSQ**\ 命令可以查询rssi

**rsrp**\ ：参考信号接收功率；是4G网络特有的测量参数，相对于rssi来说，可以更精确的测量4G网络的信号强度；rsrp等级的取值范围为0到97，255；\ **AT+CESQ**\ 命令可以查询rsrp

rsrp等级和rsrp功率的对应关系表如下：

======== ===========================
rsrp等级 rsrp功率
======== ===========================
0        rsrp < -140 dBm
1        -140 dBm <= rsrp < -139 dBm
2        -139 dBm <= rsrp < -138 dBm
\        ……
95       -46 dBm <= rsrp < -45 dBm
96       -45 dBm<= rsrp < -44 dBm
97       -44 dBm <= rsrp
255      未知或不可测
======== ===========================

这个表格是3GPP协议的标准规范，rsrp等级和rsrp功率是简单的线性关系；

实际测试，在实网中，rsrp功率只要大于-71dBm，对应的rsrp等级大于等于70，信号就已经很好，实网环境很难出现大于70的情况

rsrp等级和rssi等级的转换关系，算法并不是简单的线性关系，实际网络下，rssi的计算方式和多个网络参数有关，计算比较复杂，此处不再列举算式。下表离散采样了几个值来简单描述二者的对应关系，仅供参考

======== ========
rsrp等级 rssi等级
======== ========
>69      31
66       30
63       28
58       26
54       24
50       22
44       19
40       17
35       15
30       12
26       10
19       9
15       7
9        7
======== ========

信号强度仅仅表示当前驻留小区的网络覆盖程度，一般来说，信号强度和网络通信稳定率是正比关系。信号强度差，网络数据通信相对就不稳定；但不能绝对的认为信号强度好，网络数据通信就一定稳定，和网络是否拥堵等其他因素也有关系；经验值如下：

-  rsrp等级小于等于15或者rssi等级小于等于7，可以认为网络很差，不足以支撑网络通信

-  rsrp等级小于等于26或者rssi等级小于等于10，可以认为网络不太稳定，不足以支撑正常的网络通信，会概率性掉线、丢包

-  rsrp等级大于26或者rssi等级大于10，可以认为网络较好

3.2 AT版本信号强度说明
~~~~~~~~~~~~~~~~~~~~~~

Air724UX系列模块，仅支持4G网络，所以本章节仅4G网络信号强度。

**AT+CESQ**\ 可以查询\ **rsrp**

语法规则如下图所示： |image4|

**AT+CSQ**\ 可以查询\ **rssi**

语法规则如下图所示： |image5|

**注意：AT+CESQ查询出的rsrp比AT+CSQ查询出的rssi更能准确的反映信号强度，在条件允许的情况下，建议使用AT+CESQ**

3.3 Luat版本信号强度说明
~~~~~~~~~~~~~~~~~~~~~~~~

Luat版本通过api接口\ **net.getRssi()**\ 获取rssi表示的信号强度，此接口的返回值意义如下：
- rssi,当前信号强度(取值范围0-31)

四. 常见问题
------------

4.1 没有sim卡，可以查询到信号强度吗？
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

可以；即使没有sim卡，模块也能搜索到基站发射出的信号，能搜索到就能感知到信号；只是无法驻留到小区

4.2 如何判断主板信号接收性能？
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

参考：\ `如何判主板的4G/2G信号接收性能的好坏 <https://doc.luatos.wiki/660/>`__

.. |image1| image:: http://openluat-luatcommunity.oss-cn-hangzhou.aliyuncs.com/images/20200531073312985_11385343fbf2b21161191097c271af3d0dd78e2f.jpeg
.. |image2| image:: http://openluat-luatcommunity.oss-cn-hangzhou.aliyuncs.com/images/20200531073332475_信号接收过程.jpeg
.. |image3| image:: http://openluat-luatcommunity.oss-cn-hangzhou.aliyuncs.com/images/20200701234802040_cereg.png
.. |image4| image:: http://openluat-luatcommunity.oss-cn-hangzhou.aliyuncs.com/images/20200701235528205_cesq.png
.. |image5| image:: http://openluat-luatcommunity.oss-cn-hangzhou.aliyuncs.com/images/20200701235617076_csq.png
